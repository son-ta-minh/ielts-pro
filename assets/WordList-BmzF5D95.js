import{r,G as ue,K as z,M as he,j as T,w as pe,x as ge,N as we,O as fe,P as Se,Q as me,U as ye,I as We,Y as Ce,_ as Ee,$ as Ie}from"./index-DslJiicI.js";import{W as be}from"./WordTable-BQQ9O8PG.js";import"./WordTable_UI-Bg5GfXF3.js";import"./TagBrowser-yV2AW7bC.js";import"./tag-CltrWNWf.js";import"./square-check-big-Cq_cWMW9.js";import"./chevron-left-CpRtvSZX.js";const ve="vocab_pro_library_filters_v2",Le=({user:E,onDelete:q,onBulkDelete:_,onUpdate:j,onStartSession:K,initialFilter:Q,onInitialFilterApplied:Pe,forceExpandAdd:Y,onExpandAddConsumed:N,onNavigate:F})=>{const[J,X]=r.useState([]),D=r.useMemo(()=>ue(ve,{}),[]),[k,x]=r.useState(D.page||0),[A,Z]=r.useState(D.pageSize||25),[$,H]=r.useState(0),[ee,G]=r.useState(!0),[O,te]=r.useState(D.query||""),[l,se]=r.useState({types:new Set(["all"]),refined:"all",status:"all",register:"all",source:"all",composition:"all",book:"all",specificBookId:""}),[B,oe]=r.useState(null),[U,I]=r.useState(null),[V,b]=r.useState(null),[ae,re]=r.useState([]),{id:v}=E,M=r.useCallback(()=>{const t="Uncategorized",i=z().filter(e=>e.userId===E.id),u=new Map;i.forEach(e=>u.set(e.word.toLowerCase(),e));const h=new Map,y=new Set,S=[];i.forEach(e=>{e.groups&&e.groups.length>0?e.groups.forEach(s=>{y.add(s),h.has(s)||h.set(s,new Set),h.get(s).add(e)}):S.push(e)});const o=new Map,W=e=>{o.has(e)||o.set(e,{name:e,children:new Set,parents:new Set})};y.forEach(e=>{const s=e.split("/");for(let a=0;a<s.length;a++){const d=s.slice(0,a+1).join("/");if(W(d),a>0){const g=s.slice(0,a).join("/");o.get(g).children.add(d),o.get(d).parents.add(g)}}}),o.forEach((e,s)=>{const a=u.get(s.toLowerCase());a!=null&&a.groups&&a.groups.forEach(d=>{const g=d.split("/");for(let f=0;f<g.length;f++){const C=g.slice(0,f+1).join("/");if(W(C),f>0){const w=g.slice(0,f).join("/");o.get(w).children.add(C),o.get(C).parents.add(w)}}o.get(d).children.add(s),e.parents.add(d)})});const m=new Map,P=e=>{var C;if(m.has(e))return m.get(e);const s=new Set,a=[e],d=new Set;for(;a.length>0;){const w=a.shift();d.has(w)||(d.add(w),s.add(w),(((C=o.get(w))==null?void 0:C.children)||new Set).forEach(R=>a.push(R)))}const g=new Set;s.forEach(w=>{(h.get(w)||new Set).forEach(R=>g.add(R.id))});const f=g.size;return m.set(e,f),f},p=e=>{const s=o.get(e),a=Array.from(s.children).sort();return{name:e.split("/").pop(),path:e,children:a.map(p),unitCount:P(e)}};let n=Array.from(o.keys()).filter(e=>{var s;return(((s=o.get(e))==null?void 0:s.parents.size)||0)===0}).sort().map(e=>p(e));S.length>0&&n.unshift({name:t,path:t,children:[],unitCount:S.length}),re(n)},[E.id]),L=r.useCallback(()=>{G(!0);try{const t=Array.from(l.types),{words:i,totalCount:u}=he(v,k,A,O,t,l.refined,l.status,l.register,l.source,B,l.composition,l.book,l.specificBookId);H(u),X(i)}catch(t){console.error("Failed to load words from store:",t)}finally{G(!1)}},[v,k,A,O,l,B]);r.useEffect(()=>{L(),M();const t=()=>{L(),M()};return window.addEventListener("datastore-updated",t),()=>{window.removeEventListener("datastore-updated",t)}},[L,M]);const ne=t=>{oe(t),x(0)},ie=async(t,i)=>{const u=we(t),h=[],y=i.has("idiom"),S=i.has("phrasal"),o=i.has("collocation"),W=i.has("phrase"),m=i.has("archive");let P=new Map;try{(await fe(u)).forEach(c=>{P.set(c.word.toLowerCase().trim(),c)})}catch(p){console.warn("Server lookup failed in WordList:",p)}for(const p of u){const c=await Se(v,p);if(c){const n={...c};n.isIdiom=y||c.isIdiom,n.isPhrasalVerb=S||c.isPhrasalVerb,n.isCollocation=o||c.isCollocation,n.isStandardPhrase=W||c.isStandardPhrase,n.isPassive=m,n.updatedAt=Date.now(),h.push(n)}else{const n=p.toLowerCase().trim();let e;if(P.has(n)){const s=P.get(n);e={...s,id:crypto.randomUUID?crypto.randomUUID():"id-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),userId:v,createdAt:Date.now(),updatedAt:Date.now(),quality:me.REFINED,source:"refine",nextReview:Date.now(),interval:0,easeFactor:2.5,consecutiveCorrect:0,forgotCount:0,lastReview:void 0,lastGrade:void 0,lastTestResults:{},isIdiom:y||s.isIdiom,isPhrasalVerb:S||s.isPhrasalVerb,isCollocation:o||s.isCollocation,isStandardPhrase:W||s.isStandardPhrase,isPassive:m},e.complexity=ye(e),e.masteryScore=We(e),e.gameEligibility=Ce(e)}else e=Ee(p,"","","","",[],y,S,o,W,m),e.userId=v;h.push(e)}}h.length>0&&await Ie(h)},ce=t=>{const i=z().filter(u=>t.has(u.id));K(i)},de=async t=>{await _(Array.from(t))},le=t=>{j(t),b(null)};return T.jsxs(T.Fragment,{children:[T.jsx(be,{user:E,words:J,total:$,loading:ee,page:k,pageSize:A,onPageChange:x,onPageSizeChange:Z,onSearch:te,onFilterChange:t=>{se({types:t.types,refined:t.refined,status:t.status,register:t.register,source:t.source,composition:t.composition,book:t.book,specificBookId:t.specificBookId}),x(0)},onAddWords:ie,onViewWord:I,onEditWord:b,onDelete:async t=>{await q(t.id)},onBulkDelete:_?de:void 0,onPractice:ce,settingsKey:"vocab_pro_word_table_settings",context:"library",initialFilter:Q,forceExpandAdd:Y,onExpandAddConsumed:N,showTagBrowserButton:!0,tagTree:ae,selectedTag:B,onSelectTag:ne,onOpenWordBook:()=>F&&F("WORDBOOK")}),U&&T.jsx(pe,{word:U,onClose:()=>I(null),onNavigateToWord:I,onEditRequest:t=>{I(null),b(t)},onUpdate:j,onGainXp:async()=>0}),V&&T.jsx(ge,{user:E,word:V,onSave:le,onClose:()=>b(null),onSwitchToView:t=>{b(null),I(t)}})]})};export{Le as default};
