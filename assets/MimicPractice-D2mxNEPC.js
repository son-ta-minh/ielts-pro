import{r as t,$ as Q,ah as $,bg as Ue,_ as ke,bz as V,bA as ze,t as De,k as Fe,aK as Oe,E as X,j as b,aA as je,bB as Le}from"./index-CVuXFKiQ.js";import{M as Qe}from"./MimicPractice_UI-BLI2fKYR.js";import"./ear-C7uxiMBl.js";import"./chevron-left-CWG49dzN.js";const Z="vocab_pro_mimic_practice_queue",Je=({scopedWord:ee,onClose:te})=>{const[a,q]=t.useState([]),[c,u]=t.useState(0),[se,N]=t.useState(!1),[i,A]=t.useState(0),[r,ne]=t.useState(10),[ae,m]=t.useState(!1),[C,E]=t.useState(null),[w,_]=t.useState(null),[f,oe]=t.useState(()=>Q("vocab_pro_mimic_autospeak",!1)),[d,re]=t.useState(()=>Q("vocab_pro_mimic_autoreveal",!0)),W=t.useRef(f);t.useEffect(()=>{$("vocab_pro_mimic_autospeak",f),W.current=f},[f]),t.useEffect(()=>{$("vocab_pro_mimic_autoreveal",d)},[d]);const s=a[c]||null,[g,U]=t.useState(!1),[B,J]=t.useState(!1),[K,R]=t.useState(""),[le,k]=t.useState(0),[z,G]=t.useState(null),[ce,ue]=t.useState("audio/webm"),[ie,D]=t.useState(null),[x,F]=t.useState(null),[v,h]=t.useState(!1),[fe,O]=t.useState(!1),[M,S]=t.useState(null),[de,$e]=t.useState(!1),j=t.useRef(new Ue),p=t.useRef(null),l=t.useRef(null),H=t.useRef(()=>{}),{showToast:I}=ke(),T=K.substring(le).trimStart();t.useEffect(()=>{if(g&&s&&T){const e=V(s.text,T);S(e)}},[T,g,s]);const y=e=>{q(e),$(Z,e),N(e.length===0)};t.useEffect(()=>{const e=Q(Z,[]);q(e),N(e.length===0),u(0)},[]),t.useEffect(()=>{const e=Math.ceil(a.length/r);i>=e&&e>0&&A(e-1)},[a.length,r]),t.useEffect(()=>{const e=Math.floor(c/r);e!==i&&A(e)},[c,r]);const pe=e=>{const o=[{id:`mimic-${Date.now()}`,text:e,sourceWord:"Manual",type:"Phrase"},...a];y(o),u(0),m(!1)},me=(e,n)=>{y(a.map(o=>o.id===e?{...o,text:n}:o)),m(!1),E(null)},ge=e=>{_(e)},he=()=>{if(!w)return;const e=a.filter(o=>o.id!==w.id);let n=c;n>=e.length&&(n=Math.max(0,e.length-1)),u(n),y(e),_(null),I("Phrase removed.","success")},Se=()=>{if(a.length<2)return;const e=[...a].sort(()=>Math.random()-.5);y(e),u(0),I("Queue shuffled!","success")},Ie=e=>{ne(e),A(0)},Te=()=>{E(null),m(!0)},ye=e=>{E(e),m(!0)},Ae=e=>{C?me(C.id,e):pe(e)},P=t.useCallback(async(e=!1)=>{l.current&&clearTimeout(l.current),U(!1),j.current.stop();try{const n=await ze();!e&&n&&(G(n.base64),ue(n.mimeType))}catch(n){console.error("Audio capture failed",n)}},[]);t.useEffect(()=>{H.current=P},[P]);const Re=t.useCallback(async()=>{if(s){if(x&&v){h(!1);return}if(x&&!v){h(!0);return}O(!0);try{const e=s.text.trim().toLowerCase(),n=De().find(o=>o.word.toLowerCase()===e);if(n&&n.ipaUs){F(n.ipaUs),h(!0),O(!1);return}else{const o=Fe(),L=Oe(o),Y=await fetch(`${L}/api/convert/ipa?text=${encodeURIComponent(s.text)}`);if(Y.ok){const _e=await Y.json();F(_e.ipa),h(!0)}else I("IPA server unavailable","error")}}catch{I("Failed to fetch IPA","error")}finally{O(!1)}}},[s,x,v,I]);t.useEffect(()=>{if(g&&P(!0),J(d),R(""),k(0),G(null),D(null),S(null),F(null),h(!1),p.current&&(p.current.pause(),p.current=null),W.current&&s){const e=setTimeout(()=>X(s.text),500);return()=>clearTimeout(e)}},[s==null?void 0:s.id,d]),t.useEffect(()=>()=>{j.current.stop(),l.current&&clearTimeout(l.current)},[]);const xe=async()=>{if(s)if(g){await P();const e=V(s.text,T);S(e);const n=a.map((o,L)=>L===c?{...o,lastScore:e.score}:o);y(n)}else{R(""),k(0),D(null),S(null);try{await Le(),U(!0),l.current&&clearTimeout(l.current),l.current=setTimeout(()=>H.current(),1e4),j.current.start((e,n)=>R(e+n),e=>R(e))}catch(e){console.error("Failed to start recording",e),U(!1)}}},ve=()=>{k(K.length),D(null),S(null)},Me=()=>s&&X(s.text),Pe=()=>{if(z){p.current&&p.current.pause();const e=new Audio(`data:${ce};base64,${z}`);p.current=e,e.play()}},be=()=>{a.length>0&&u(e=>(e+1)%a.length)},Ce=e=>{e>=0&&e<a.length&&u(e)},Ee=Math.ceil(a.length/r),we=a.slice(i*r,(i+1)*r);return b.jsxs(b.Fragment,{children:[b.jsx(Qe,{targetText:(s==null?void 0:s.text)||null,sourceWord:(s==null?void 0:s.sourceWord)||"",type:(s==null?void 0:s.type)||"",isRecording:g,isRevealed:B,userTranscript:T,matchStatus:ie,userAudioUrl:z,onToggleRecord:xe,onPlayTarget:Me,onPlayUser:Pe,onToggleReveal:()=>J(!B),onNext:be,onClearTranscript:ve,isEmpty:se,onClose:te,pagedItems:we,page:i,pageSize:r,totalPages:Ee,onPageChange:A,onPageSizeChange:Ie,onSelect:e=>Ce(i*r+e),currentAbsoluteIndex:c,autoSpeak:f,onToggleAutoSpeak:()=>oe(!f),autoReveal:d,onToggleAutoReveal:()=>re(!d),isGlobalMode:!ee,isAnalyzing:de,onAnalyze:()=>{},aiAnalysis:M?{isCorrect:M.score>80,score:M.score,feedbackHtml:""}:null,localAnalysis:M,onAddItem:Te,onEditItem:ye,onDeleteItem:ge,onRandomize:Se,isModalOpen:ae,editingItem:C,onCloseModal:()=>m(!1),onSaveItem:Ae,ipa:x,showIpa:v,isIpaLoading:fe,onToggleIpa:Re}),b.jsx(je,{isOpen:!!w,title:"Delete Phrase?",message:"Are you sure you want to remove this phrase from your pronunciation queue?",confirmText:"Delete",isProcessing:!1,onConfirm:he,onClose:()=>_(null),icon:null,confirmButtonClass:"bg-red-600 text-white hover:bg-red-700"})]})};export{Je as MimicPractice};
