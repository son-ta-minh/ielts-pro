import{k as Z,aK as ee,Y as te,r as l,j as t,X as R,aY as se,aT as S,b_ as ae,D as re,ai as U,at as F}from"./index-C3fhNz8e.js";import{T as ne}from"./tag-CNCrcfMZ.js";import{S as le}from"./server-DluSRbWP.js";import{L as I}from"./list-todo-Bcp8mCZS.js";import{M as Q}from"./music-CUtAfPh1.js";const xe=({isOpen:N,onClose:b,onSelect:v,type:n,title:D})=>{const Y=Z(),p=ee(Y),{showToast:c}=te(),[d,w]=l.useState("folders"),[L,_]=l.useState({}),[o,y]=l.useState(null),[i,k]=l.useState(""),[m,h]=l.useState([]),[K,u]=l.useState(!1),[x,g]=l.useState(""),[O,j]=l.useState(!1),X=l.useRef(null),C=l.useRef(null);l.useEffect(()=>{N&&(y(null),k(""),h([]),g(""),j(!1),n==="reading"||n==="planning"?(w("master"),q()):(w("folders"),M()))},[N,n]),l.useEffect(()=>{const e=s=>{C.current&&!C.current.contains(s.target)&&j(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);const M=async()=>{u(!0);try{const e=await fetch(`${p}/api/audio/mappings`);e.ok?_(await e.json()):c("Failed to connect to server","error")}catch{c("Server unreachable","error")}finally{u(!1)}},$=async(e,s="")=>{u(!0);try{const r=encodeURIComponent(s),a=await fetch(`${p}/api/${n==="audio"?"audio":"reading"}/files/${e}?path=${r}`);if(a.ok){const z=await a.json();let P=[];Array.isArray(z.items)&&(P=z.items),h(P),k(z.currentPath||"")}else c("Failed to load files","error")}catch{c("Connection error","error")}finally{u(!1)}},q=async()=>{u(!0);try{const s=await fetch(`${p}/api/${n==="planning"?"planning":"reading"}/master`);if(s.ok){const r=await s.json();let f=[];Array.isArray(r.items)&&(n==="planning"?f=r.items.map(a=>({name:a.id,type:"plan",displayName:a.displayName,data:{title:a.name,description:a.description,todos:a.todos}})):f=r.items.map(a=>({name:a.id,type:"unit",displayName:a.name,tags:Array.isArray(a.tags)?a.tags:[],data:{title:a.name,description:a.description,essay:a.essay,words:a.words,tags:a.tags}}))),h(f)}else c("Failed to load Master Library","error")}catch{c("Connection error","error")}finally{u(!1)}},B=e=>{y(e),$(e,"")},G=e=>{w(e),y(null),k(""),h([]),g(""),M()},H=e=>{if(!o)return;const s=i?`${i}/${e}`:e;$(o,s)},J=()=>{if(o)if(!i)y(null),h([]);else{const e=i.split("/");e.pop();const s=e.join("/");$(o,s)}},V=async e=>{if(d==="master"){e.data&&(v(e.data),b());return}if(o)if(n==="audio"){const s=i?`${i}/${e.name}`:e.name,r=`${p}/api/audio/stream/${o}/${s}`;v({url:r,filename:e.name,transcript:e.transcript,transcriptTitle:e.transcriptTitle,map:o,path:i}),b()}else{u(!0);try{const s=i?`${i}/${e.name}`:e.name,r=await fetch(`${p}/api/reading/content/${o}/${s}`);if(r.ok){const f=await r.json();v(f),b()}else c("Failed to load file content","error")}catch{c("Error reading file","error")}finally{u(!1)}}},T=l.useMemo(()=>{if(d!=="master"||!x)return m;const e=x.toLowerCase();return m.filter(s=>!!(s.displayName&&s.displayName.toLowerCase().includes(e)||s.tags&&s.tags.some(r=>r.toLowerCase().includes(e))))},[m,x,d]),A=l.useMemo(()=>{if(d!=="master")return[];const e=new Set;return m.forEach(s=>{s.tags&&Array.isArray(s.tags)&&s.tags.forEach(r=>e.add(r))}),Array.from(e).sort()},[m,d]),E=l.useMemo(()=>x?A.filter(e=>e.toLowerCase().includes(x.toLowerCase())).slice(0,8):[],[A,x]);if(!N)return null;const W=()=>n==="audio"?t.jsx(Q,{size:20}):n==="planning"?t.jsx(I,{size:20}):t.jsx(F,{size:20});return t.jsx("div",{className:"fixed inset-0 z-[250] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in",children:t.jsxs("div",{className:"bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[80vh]",children:[t.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex flex-col gap-4",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("h3",{className:"text-xl font-black text-neutral-900 flex items-center gap-2",children:[W(),D]}),t.jsx("button",{onClick:b,className:"p-2 -mr-2 text-neutral-400 hover:bg-neutral-100 rounded-full",children:t.jsx(R,{size:20})})]}),n==="reading"||n==="planning"?t.jsxs("div",{className:"relative",ref:C,children:[t.jsxs("div",{className:"relative",children:[t.jsx(se,{className:"absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400",size:14}),t.jsx("input",{ref:X,type:"text",value:x,onChange:e=>{g(e.target.value),j(!0)},onFocus:()=>j(!0),placeholder:n==="planning"?"Filter by title...":"Filter by tag or title...",className:"w-full pl-9 pr-4 py-2.5 bg-neutral-50 border border-neutral-200 rounded-xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-neutral-900 transition-all"}),x&&t.jsx("button",{onClick:()=>g(""),className:"absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400 hover:text-neutral-600",children:t.jsx(R,{size:12})})]}),O&&E.length>0&&n==="reading"&&t.jsx("div",{className:"absolute top-full left-0 right-0 mt-1 bg-white border border-neutral-100 rounded-xl shadow-xl z-20 overflow-hidden max-h-48 overflow-y-auto",children:E.map(e=>t.jsxs("button",{onClick:()=>{g(e),j(!1)},className:"w-full text-left px-4 py-2 text-xs font-medium hover:bg-neutral-50 flex items-center gap-2 text-neutral-700",children:[t.jsx(ne,{size:12,className:"text-neutral-400"}),e]},e))})]}):t.jsx("div",{className:"flex bg-neutral-100 p-1 rounded-xl",children:t.jsxs("button",{onClick:()=>G("folders"),className:`flex-1 flex items-center justify-center gap-2 py-2 rounded-lg text-xs font-bold transition-all ${d==="folders"?"bg-white shadow-sm text-neutral-900":"text-neutral-500 hover:text-neutral-700"}`,children:[t.jsx(S,{size:14})," Server Folders"]})})]}),d==="folders"&&t.jsxs("div",{className:"p-4 bg-neutral-50 border-b border-neutral-100 flex items-center gap-2 overflow-hidden",children:[o&&t.jsx("button",{onClick:J,className:"p-1.5 bg-white border border-neutral-200 rounded-lg hover:bg-neutral-100 transition-colors",children:t.jsx(ae,{size:14})}),t.jsx("div",{className:"flex-1 truncate text-xs font-mono font-medium text-neutral-600",children:o?`/${o}/${i}`:"Root"})]}),t.jsx("main",{className:"flex-1 overflow-y-auto p-4 custom-scrollbar",children:K?t.jsx("div",{className:"flex justify-center py-10",children:t.jsx(re,{size:24,className:"animate-spin text-neutral-300"})}):d==="folders"&&!o?t.jsxs("div",{className:"space-y-1",children:[t.jsx("p",{className:"text-[10px] font-black uppercase text-neutral-400 tracking-widest px-2 mb-2",children:"Mapped Folders"}),Object.keys(L).map(e=>t.jsxs("button",{onClick:()=>B(e),className:"w-full flex items-center gap-3 p-3 rounded-xl hover:bg-neutral-50 transition-colors text-left group",children:[t.jsx(S,{size:18,className:"text-indigo-400 group-hover:text-indigo-600"}),t.jsx("span",{className:"text-sm font-bold text-neutral-700",children:e}),t.jsx(U,{size:14,className:"ml-auto text-neutral-300"})]},e)),Object.keys(L).length===0&&t.jsx("p",{className:"text-center text-xs text-neutral-400 py-4",children:"No mappings found. Configure in Settings."})]}):t.jsxs("div",{className:"space-y-1",children:[T.map((e,s)=>t.jsxs("button",{onClick:()=>e.type==="directory"?H(e.name):V(e),className:"w-full flex items-center gap-3 p-3 rounded-xl transition-colors text-left group hover:bg-neutral-50",children:[e.type==="directory"?t.jsx(S,{size:18,className:"text-indigo-400"}):e.type==="unit"?t.jsx(le,{size:18,className:"text-emerald-500"}):e.type==="plan"?t.jsx(I,{size:18,className:"text-purple-500"}):n==="audio"?t.jsx(Q,{size:18,className:"text-emerald-500"}):t.jsx(F,{size:18,className:"text-blue-500"}),t.jsx("div",{className:"flex-1 overflow-hidden",children:e.displayName?t.jsxs("div",{className:"flex flex-col gap-1",children:[t.jsx("span",{className:"text-sm font-bold text-neutral-800 truncate",children:e.displayName}),e.tags&&e.tags.length>0&&t.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.tags.slice(0,3).map((r,f)=>t.jsx("span",{className:"px-1.5 py-0.5 bg-neutral-100 rounded text-[9px] font-medium text-neutral-500 border border-neutral-200",children:r.trim()},f)),e.tags.length>3&&t.jsxs("span",{className:"text-[9px] text-neutral-400 font-medium",children:["+",e.tags.length-3]})]})]}):t.jsxs("div",{className:"flex items-center justify-between gap-2",children:[t.jsx("span",{className:"text-xs font-medium text-neutral-700 truncate",children:e.name}),n==="audio"&&e.transcript&&t.jsxs("div",{className:"flex items-center gap-1 px-1.5 py-0.5 bg-emerald-50 text-emerald-600 rounded-md border border-emerald-100 shrink-0 animate-in fade-in",children:[t.jsx(F,{size:10}),t.jsx("span",{className:"text-[8px] font-black uppercase tracking-tighter",children:"Transcript"})]})]})}),e.type==="directory"&&t.jsx(U,{size:14,className:"text-neutral-300"})]},`${e.name}-${s}`)),T.length===0&&t.jsx("p",{className:"text-center text-xs text-neutral-400 py-4",children:"No matching items."})]})})]})})};export{xe as F};
