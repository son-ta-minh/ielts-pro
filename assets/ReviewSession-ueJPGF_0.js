import{w as fe,x as ke,y as Ee,j as e,z as ve,D as g,Z as ge,B as Te,R as Ce,E as ze,f as ye,H as Ie,I as Me,V as _e,J as re,M as Ae,i as Oe,K as Pe,N as De,O as We,Q as Le,U as Fe,X as Se,Y as Re,C as Ue,_ as Ge,$ as Ve,a0 as Qe,a1 as Ye,a2 as qe,a3 as He,a4 as Xe,r as a,a5 as Ne,a6 as be,a7 as xe,a8 as $e}from"./index-vTycAx8Y.js";import{T as Be}from"./trophy-BoOPn1Q7.js";const Je=(l,m,J)=>{if(J)return l?l==="GAVE_UP"?e.jsxs("span",{className:"flex items-center gap-1 px-2 py-0.5 rounded text-[9px] font-black uppercase bg-amber-100 text-amber-700",children:[e.jsx(He,{size:10})," Gave Up"]}):l==="PASS"||l===g.EASY?e.jsxs("span",{className:"flex items-center gap-1 px-2 py-0.5 rounded text-[9px] font-black uppercase bg-green-100 text-green-700",children:[e.jsx(Se,{size:10})," Pass"]}):e.jsxs("span",{className:"flex items-center gap-1 px-2 py-0.5 rounded text-[9px] font-black uppercase bg-rose-100 text-rose-600",children:[e.jsx(Re,{size:10})," Fail"]}):e.jsxs("span",{className:"flex items-center gap-1 px-2 py-0.5 rounded text-[9px] font-black uppercase bg-neutral-100 text-neutral-400",children:[e.jsx(qe,{size:10})," No Answer"]});if(!l)return e.jsx("span",{className:"px-2 py-0.5 rounded text-[9px] font-black uppercase bg-neutral-100 text-neutral-400",children:"Skipped"});if(m&&(l===g.EASY||l===g.LEARNED))return e.jsx("span",{className:"px-2 py-0.5 rounded text-[9px] font-black uppercase bg-cyan-100 text-cyan-700",children:"Learned"});switch(l){case g.FORGOT:return e.jsx("span",{className:"px-2 py-0.5 rounded text-[9px] font-black uppercase bg-rose-100 text-rose-600",children:"Forgot"});case g.HARD:return e.jsx("span",{className:"px-2 py-0.5 rounded text-[9px] font-black uppercase bg-orange-100 text-orange-600",children:"Hard"});case g.EASY:return e.jsx("span",{className:"px-2 py-0.5 rounded text-[9px] font-black uppercase bg-green-100 text-green-600",children:"Easy"});default:return null}},Ke=({score:l})=>{const v=2*Math.PI*16,L=v-l/100*v,F=l>=80?"text-green-500":l>=50?"text-yellow-500":l>0?"text-orange-500":"text-neutral-400";return e.jsxs("div",{className:"relative flex items-center justify-center",style:{width:36,height:36},children:[e.jsxs("svg",{className:"absolute",width:36,height:36,children:[e.jsx("circle",{className:"text-neutral-100",stroke:"currentColor",strokeWidth:4,fill:"transparent",r:16,cx:36/2,cy:36/2}),e.jsx("circle",{className:F,stroke:"currentColor",strokeWidth:4,fill:"transparent",r:16,cx:36/2,cy:36/2,strokeDasharray:v,strokeDashoffset:L,strokeLinecap:"round",style:{transform:"rotate(-90deg)",transformOrigin:"50% 50%",transition:"stroke-dashoffset 0.5s ease-out"}})]}),e.jsx("span",{className:`text-[10px] font-black ${F}`,children:l})]})},Ze=({word:l})=>{const m=l.masteryScore??0;return e.jsxs("div",{className:"relative group/score",children:[e.jsx(Ke,{score:m}),e.jsxs("div",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-3 py-1.5 bg-neutral-800 text-white text-[10px] font-black rounded-lg opacity-0 group-hover/score:opacity-100 transition-opacity pointer-events-none z-10 uppercase tracking-wider",children:["Mastery Score",e.jsx("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 w-2 h-2 bg-neutral-800 rotate-45"})]})]})},et=({complexity:l})=>e.jsxs("div",{className:"relative group/complexity",children:[e.jsxs("div",{className:"flex items-center gap-1 px-3 py-1.5 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 transition-all hover:bg-amber-100 shadow-sm",children:[e.jsx("span",{className:"text-[9px] font-black opacity-50",children:"CX"}),e.jsx("span",{className:"text-xs font-black",children:l})]}),e.jsxs("div",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max px-3 py-1.5 bg-neutral-800 text-white text-[10px] font-black rounded-lg opacity-0 group-hover/complexity:opacity-100 transition-opacity pointer-events-none z-10 uppercase tracking-wider",children:["Complexity Level",e.jsx("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 w-2 h-2 bg-neutral-800 rotate-45"})]})]}),tt=l=>{var de,ue;const{user:m,initialWords:J,sessionWords:c,sessionType:v,newWordIds:L,progress:F,setProgress:M,sessionOutcomes:K,sessionFinished:ne,wordInModal:Z,setWordInModal:_,onOpenWordDetails:ae,editingWordInModal:ee,setEditingWordInModal:A,isTesting:te,setIsTesting:U,currentWord:o,isNewWord:T,onUpdate:O,onComplete:C,nextItem:le,handleReview:S,handleTestComplete:y,handleRetry:R,handleEndSession:j,handleQuickReview:G,handleManualPractice:we,isQuickReviewMode:k}=l,{current:z,max:je}=F,b=v==="random_test",[oe,se]=fe.useState(null),V=fe.useRef(null),P=fe.useMemo(()=>{if(!o)return!1;const t=ke(o.lastTestResults||{}),i=Ee(o),B=new Set(Array.from(i).map(s=>s.split(":")[0]));return Object.entries(t).some(([s,n])=>{if(n!==!1)return!1;if(i.has(s))return!0;const d=s.split(":")[0];return B.has(d)})},[o]),ie=t=>{_(null),A(t)},Q=t=>{O(t),A(null)};if(J.length===0)return e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-6 py-20 text-center animate-in fade-in duration-500",children:[e.jsx("div",{className:"w-16 h-16 bg-green-50 text-green-600 rounded-full flex items-center justify-center shadow-inner",children:e.jsx(ve,{size:32})}),e.jsx("h2",{className:"text-xl font-bold text-neutral-900",children:"All clear!"}),e.jsx("button",{onClick:C,className:"px-6 py-2.5 bg-neutral-900 text-white rounded-xl font-semibold text-sm hover:bg-neutral-800 transition-colors",children:"Back to Dashboard"})]});if(ne){if(v==="new"||v==="due"||v==="new_study"||v==="custom"||b){const t=Object.values(K).filter(i=>i==="PASS"||i===g.EASY||i===g.LEARNED).length;return e.jsxs("div",{className:"max-w-2xl mx-auto py-10 text-center animate-in zoom-in-95 duration-500",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:`mx-auto w-20 h-20 rounded-full flex items-center justify-center mb-4 ${b?"bg-amber-100 text-amber-600":"bg-neutral-100 text-neutral-900"}`,children:b?e.jsx(ge,{size:40,fill:"currentColor"}):e.jsx(Te,{size:40})}),e.jsx("h2",{className:"text-3xl font-black text-neutral-900",children:b?"Test Result":"Session Recap"}),b&&e.jsxs("p",{className:"text-xs font-black text-neutral-400 uppercase tracking-[0.2em] mt-2",children:["Score: ",t," / ",c.length]}),e.jsx("p",{className:"text-neutral-500 mt-2 font-medium",children:"You've completed this focused session."})]}),e.jsx("div",{className:"bg-white p-4 rounded-[2rem] border border-neutral-200 shadow-sm mb-8 overflow-hidden",children:e.jsx("div",{className:"max-h-[40vh] overflow-y-auto pr-2 custom-scrollbar grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 p-2",children:c.map(i=>e.jsxs("div",{className:"flex justify-between items-center bg-neutral-50/70 p-2.5 rounded-xl border border-neutral-100",children:[e.jsx("span",{className:"font-bold text-neutral-800 text-xs truncate pr-2",children:i.word}),Je(K[i.id],L.has(i.id),b)]},i.id))})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsx("button",{onClick:C,className:"px-6 py-4 bg-white border border-neutral-200 text-neutral-500 rounded-2xl font-bold text-xs hover:bg-neutral-50 hover:border-neutral-900 transition-all active:scale-95 uppercase tracking-widest",children:"Finish Session"}),e.jsxs("button",{onClick:R,className:"px-6 py-4 bg-neutral-900 text-white rounded-2xl font-black text-xs flex items-center justify-center space-x-2 shadow-lg hover:bg-neutral-800 transition-all active:scale-95 uppercase tracking-widest",children:[e.jsx(Ce,{size:14}),e.jsx("span",{children:"Retry This Session"})]})]})]})}return e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-center animate-in zoom-in-95 duration-500",children:[e.jsx(Be,{size:64,className:"text-yellow-500 mb-4 animate-bounce"}),e.jsx("h2",{className:"text-3xl font-black text-neutral-900",children:"Session Complete!"}),e.jsx("p",{className:"text-neutral-500 mt-2 font-medium",children:"You have finished this review session."}),e.jsx("button",{onClick:C,className:"mt-8 px-10 py-3.5 bg-neutral-900 text-white rounded-2xl font-bold shadow-xl hover:scale-105 transition-all text-sm",children:"Return to Dashboard"})]})}if(!o)return null;const E=T?ze:ye,Y=T?"text-blue-500":"text-neutral-500",p=T?o.word:o.ipaUs||o.word,ce=((de=o.meaningVi)==null?void 0:de.trim())||((ue=o.meaning)==null?void 0:ue.trim())||"No Vietnamese meaning available",I=(o.prepositions||[]).filter(t=>!t.isIgnored),q=(o.collocationsArray||[]).filter(t=>!t.isIgnored),h=(o.paraphrases||[]).filter(t=>!t.isIgnored),H=(o.idiomsList||[]).filter(t=>!t.isIgnored),D=I.slice(0,6).map(t=>t.prep).join(`
`),w=q.slice(0,6).map(t=>t.text).join(`
`),X=h.slice(0,6).map(t=>t.word).join(`
`),W=H.slice(0,6).map(t=>t.text).join(`
`),$=!T&&!!o.ipaUs,pe=t=>{V.current=t.touches[0].clientX},me=t=>{if(V.current===null)return;const i=t.changedTouches[0].clientX-V.current,B=50;i>B?M(s=>({...s,current:(s.current-1+c.length)%c.length})):i<-B&&M(s=>({...s,current:(s.current+1)%c.length})),V.current=null};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"max-w-3xl mx-auto h-[calc(100vh-80px)] sm:h-[calc(100vh-100px)] flex flex-col animate-in fade-in duration-300 px-3 sm:px-0",children:[e.jsxs("div",{className:"px-6 shrink-0 pb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-1",children:[e.jsx("div",{className:"w-24"})," ",e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{size:14,className:Y}),e.jsxs("span",{className:"text-[10px] font-black text-neutral-400 uppercase tracking-widest",children:[z+1," / ",c.length]})]}),e.jsx("div",{className:"w-24 text-right",children:e.jsx("button",{onClick:j,className:"px-3 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-wider text-neutral-500 hover:bg-neutral-100 transition-colors",children:"End Session"})})]}),e.jsx("div",{className:"h-1 w-full bg-neutral-100 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-neutral-900 transition-all duration-300 ease-in-out",style:{width:`${(z+1)/c.length*100}%`}})})]}),e.jsxs("div",{className:"flex-1 flex items-center justify-center relative gap-2 sm:gap-4",children:[e.jsx("button",{onClick:()=>M(t=>({...t,current:(t.current-1+c.length)%c.length})),className:"hidden sm:block p-4 rounded-full text-neutral-300 hover:text-neutral-900 transition-all","aria-label":"Previous word",children:e.jsx(Ie,{size:28})}),e.jsx("div",{onTouchStart:pe,onTouchEnd:me,className:"w-full max-w-xl h-full bg-white rounded-3xl sm:rounded-[2.5rem] border border-neutral-200 shadow-sm flex flex-col relative overflow-hidden group select-none touch-pan-y",children:b?e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-8 sm:p-12 w-full text-center space-y-4",children:[e.jsx(Me,{className:"animate-spin text-neutral-200",size:32}),e.jsx("p",{className:"text-xs font-black text-neutral-400 uppercase tracking-widest",children:"Loading Next Test..."})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-6 sm:p-12 w-full text-center space-y-6 sm:space-y-8",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("h2",{className:`font-black text-neutral-900 tracking-tight text-3xl sm:text-4xl break-words ${$?"font-serif":""}`,children:p}),T?e.jsx(et,{complexity:o.complexity??0}):e.jsx(Ze,{word:o})]}),e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:t=>{t.stopPropagation(),re(o.word)},className:"p-3 text-neutral-400 bg-neutral-50 hover:bg-neutral-100 hover:text-neutral-900 rounded-full transition-colors",title:"Pronounce",children:e.jsx(_e,{size:22})}),e.jsx("button",{onClick:()=>se(o.word),className:"p-3 text-neutral-400 bg-neutral-50 hover:bg-neutral-100 hover:text-indigo-600 rounded-full transition-colors",title:"Simple Mimic",children:e.jsx(Ae,{size:20})}),e.jsxs("div",{className:"relative group/book",children:[e.jsx("button",{onClick:()=>re(ce,!1,"vi"),className:"p-3 text-neutral-400 bg-neutral-50 hover:bg-neutral-100 hover:text-amber-600 rounded-full transition-colors",children:e.jsx(ye,{size:20})}),e.jsxs("span",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[260px] px-3 py-2 bg-white text-neutral-900 text-[10px] font-semibold rounded-lg opacity-0 group-hover/book:opacity-100 transition-opacity pointer-events-none text-left leading-snug z-20 border border-neutral-200 shadow-lg",children:[e.jsx("div",{className:"text-[9px] font-black uppercase tracking-wider mb-1 text-neutral-500",children:"Meaning"}),ce,e.jsx("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 w-2 h-2 bg-white border-l border-t border-neutral-200 rotate-45"})]})]}),I.length>0&&e.jsxs("div",{className:"relative group/prep",children:[e.jsx("button",{className:"p-3 text-neutral-400 bg-neutral-50 hover:bg-neutral-100 hover:text-orange-600 rounded-full transition-colors",children:e.jsx(Oe,{size:20})}),e.jsxs("span",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[300px] px-3 py-2 bg-white text-neutral-900 text-[10px] font-semibold rounded-lg opacity-0 group-hover/prep:opacity-100 transition-opacity pointer-events-none text-left leading-snug z-20 whitespace-pre-line border border-neutral-200 shadow-lg",children:[e.jsx("div",{className:"text-[9px] font-black uppercase tracking-wider mb-1 text-neutral-500",children:"Prepositions"}),D.includes(`
`)?e.jsx("ul",{className:"list-disc pl-4 space-y-0.5",children:D.split(`
`).map((t,i)=>e.jsx("li",{children:t},i))}):D,e.jsx("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 w-2 h-2 bg-white border-l border-t border-neutral-200 rotate-45"})]})]}),q.length>0&&e.jsxs("div",{className:"relative group/col",children:[e.jsx("button",{onClick:()=>re(w.replace(/\n/g,", ")),className:"p-3 text-neutral-400 bg-neutral-50 hover:bg-neutral-100 hover:text-indigo-600 rounded-full transition-colors",children:e.jsx(Pe,{size:20})}),e.jsxs("span",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[300px] px-3 py-2 bg-white text-neutral-900 text-[10px] font-semibold rounded-lg opacity-0 group-hover/col:opacity-100 transition-opacity pointer-events-none text-left leading-snug z-20 whitespace-pre-line border border-neutral-200 shadow-lg",children:[e.jsx("div",{className:"text-[9px] font-black uppercase tracking-wider mb-1 text-neutral-500",children:"Collocations"}),w.includes(`
`)?e.jsx("ul",{className:"list-disc pl-4 space-y-0.5",children:w.split(`
`).map((t,i)=>e.jsx("li",{children:t},i))}):w,e.jsx("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 w-2 h-2 bg-white border-l border-t border-neutral-200 rotate-45"})]})]}),h.length>0&&e.jsxs("div",{className:"relative group/para",children:[e.jsx("button",{onClick:()=>re(X.replace(/\n/g,", ")),className:"p-3 text-neutral-400 bg-neutral-50 hover:bg-neutral-100 hover:text-cyan-600 rounded-full transition-colors",children:e.jsx(ge,{size:20})}),e.jsxs("span",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[300px] px-3 py-2 bg-white text-neutral-900 text-[10px] font-semibold rounded-lg opacity-0 group-hover/para:opacity-100 transition-opacity pointer-events-none text-left leading-snug z-20 whitespace-pre-line border border-neutral-200 shadow-lg",children:[e.jsx("div",{className:"text-[9px] font-black uppercase tracking-wider mb-1 text-neutral-500",children:"Paraphrases"}),X.includes(`
`)?e.jsx("ul",{className:"list-disc pl-4 space-y-0.5",children:X.split(`
`).map((t,i)=>e.jsx("li",{children:t},i))}):X,e.jsx("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 w-2 h-2 bg-white border-l border-t border-neutral-200 rotate-45"})]})]}),H.length>0&&e.jsxs("div",{className:"relative group/idiom",children:[e.jsx("button",{onClick:()=>re(W.replace(/\n/g,", ")),className:"p-3 text-neutral-400 bg-neutral-50 hover:bg-neutral-100 hover:text-emerald-600 rounded-full transition-colors",children:e.jsx(De,{size:20})}),e.jsxs("span",{className:"absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-[300px] px-3 py-2 bg-white text-neutral-900 text-[10px] font-semibold rounded-lg opacity-0 group-hover/idiom:opacity-100 transition-opacity pointer-events-none text-left leading-snug z-20 whitespace-pre-line border border-neutral-200 shadow-lg",children:[e.jsx("div",{className:"text-[9px] font-black uppercase tracking-wider mb-1 text-neutral-500",children:"Idioms"}),W.includes(`
`)?e.jsx("ul",{className:"list-disc pl-4 space-y-0.5",children:W.split(`
`).map((t,i)=>e.jsx("li",{children:t},i))}):W,e.jsx("span",{className:"absolute bottom-full left-1/2 -translate-x-1/2 w-2 h-2 bg-white border-l border-t border-neutral-200 rotate-45"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>ae(o),className:"flex items-center gap-2 px-6 py-3 bg-white border border-neutral-200 text-neutral-600 rounded-xl font-black text-[10px] hover:bg-neutral-50 transition-all active:scale-95 uppercase tracking-widest shadow-sm",children:[e.jsx(We,{size:14}),e.jsx("span",{children:"View Details"})]}),e.jsxs("button",{onClick:we,className:`flex items-center gap-2 px-6 py-3 text-white rounded-xl font-black text-[10px] transition-all active:scale-95 uppercase tracking-widest shadow-lg ${P?"bg-red-600 hover:bg-red-700 shadow-red-500/20":"bg-amber-500 hover:bg-amber-600 shadow-amber-500/20"}`,children:[e.jsx(Le,{size:14}),e.jsx("span",{children:"Practice"})]})]})]})}),e.jsx("button",{onClick:()=>M(t=>({...t,current:(t.current+1)%c.length})),className:"hidden sm:block p-4 rounded-full text-neutral-300 hover:text-neutral-900 transition-all","aria-label":"Next word",children:e.jsx(Fe,{size:28})})]}),e.jsx("div",{className:"shrink-0 pt-6 pb-2 mt-auto",children:T?e.jsxs("div",{className:"max-w-lg mx-auto grid grid-cols-3 items-stretch gap-4",children:[e.jsx("div",{})," ",e.jsxs("button",{onClick:()=>S(g.LEARNED),className:"py-5 bg-green-500 text-white rounded-2xl flex flex-col items-center justify-center space-y-1.5 shadow-lg shadow-green-500/20 hover:bg-green-600 transition-all active:scale-95",children:[e.jsx(Se,{size:20}),e.jsx("span",{className:"text-[9px] font-black uppercase",children:"LEARNED"})]}),e.jsx("div",{})," "]}):!b&&e.jsxs("div",{className:"max-w-xl mx-auto grid grid-cols-4 items-stretch gap-3",children:[e.jsxs("button",{onClick:()=>S(g.FORGOT),className:"py-5 bg-white border border-neutral-100 text-neutral-500 hover:text-red-600 hover:bg-red-50 rounded-2xl flex flex-col items-center justify-center space-y-1.5 transition-all",children:[e.jsx(Re,{size:20}),e.jsx("span",{className:"text-[9px] font-black uppercase",children:"FORGOT"})]}),e.jsxs("button",{onClick:()=>S(g.HARD),className:"py-5 bg-white border border-neutral-100 text-neutral-500 hover:text-orange-600 hover:bg-orange-50 rounded-2xl flex flex-col items-center justify-center space-y-1.5 transition-all",children:[e.jsx(Ue,{size:20}),e.jsx("span",{className:"text-[9px] font-black uppercase",children:"Hard"})]}),e.jsxs("button",{onClick:()=>S(g.EASY),className:"py-5 bg-white border border-neutral-100 text-neutral-500 hover:text-green-600 hover:bg-green-50 rounded-2xl flex flex-col items-center justify-center space-y-1.5 transition-all",children:[e.jsx(ve,{size:20}),e.jsx("span",{className:"text-[9px] font-black uppercase",children:"Easy"})]}),e.jsxs("button",{onClick:G,className:"py-5 bg-indigo-600 text-white rounded-2xl flex flex-col items-center justify-center space-y-1.5 transition-all hover:bg-indigo-700 shadow-md shadow-indigo-200",children:[e.jsx(ge,{size:20,fill:"currentColor"}),e.jsx("span",{className:"text-[9px] font-black uppercase",children:"Quick Review"})]})]})})]}),Z&&e.jsx(Ge,{word:Z,onUpdate:O,onClose:()=>_(null),onNavigateToWord:_,onEditRequest:ie,onGainXp:async()=>0,isViewOnly:!0}),ee&&e.jsx(Ve,{user:m,word:ee,onSave:Q,onClose:()=>A(null),onSwitchToView:t=>{A(null),_(ee)}}),te&&o&&e.jsx(Qe,{word:o,isQuickFire:b,sessionPosition:b?{current:z+1,total:c.length}:void 0,onPrevWord:()=>M(t=>({...t,current:Math.max(0,t.current-1)})),onClose:()=>{b?C():U(!1)},onComplete:y,skipSetup:k}),oe&&e.jsx(Ye,{target:oe,onClose:()=>se(null)})]})},nt=({user:l,sessionWords:m,sessionFocus:J,sessionType:c,onUpdate:v,onBulkUpdate:L,onComplete:F,onRetry:M})=>{const{showToast:K}=Xe(),ne=1500,Z=`vocab_pro_learn_queue_${l.id}`,_=`vocab_pro_learn_queue_date_${l.id}`,ae=new Date().toISOString().slice(0,10),[ee,A]=a.useState([]);a.useEffect(()=>{if(c==="new"||c==="new_study"){let s=[],n="";try{s=JSON.parse(sessionStorage.getItem(Z)||"[]"),n=sessionStorage.getItem(_)||""}catch{}let d=[];n===ae&&s.length>0?d=s.map(r=>m.find(u=>u.id===r)).filter(r=>r&&(!r.lastReview||r.lastGrade!=="LEARNED")):d=m.filter(u=>!u.lastReview||u.lastGrade!=="LEARNED").slice(0,20);const f=new Set(d.map(r=>r.id)),x=m.filter(r=>!r.lastReview||r.lastGrade!=="LEARNED");for(const r of x){if(d.length>=20)break;f.has(r.id)||d.push(r)}sessionStorage.setItem(Z,JSON.stringify(d.map(r=>r.id))),sessionStorage.setItem(_,ae),A(d)}else A(m)},[m,c]);const te=c==="new"||c==="new_study"?ee:m,U=a.useRef(null),[o,T]=a.useState(new Set),[O,C]=a.useState(()=>{const s=Ne("vocab_pro_session_progress",null);return s&&typeof s.current=="number"&&typeof s.max=="number"&&s.current<=s.max&&s.max<m.length?s:{current:0,max:0}}),[le,S]=a.useState(()=>Ne("vocab_pro_session_outcomes",{})),[y,R]=a.useState(new Map),j=a.useRef(null),{current:G,max:we}=O,[k,z]=a.useState(!1),[je,b]=a.useState(null),[oe,se]=a.useState(null),[V,P]=a.useState(c==="random_test"),[ie,Q]=a.useState(!1),E=a.useRef(new Map),Y=te[G],p=Y?y.get(Y.id)||E.current.get(Y.id)||Y:void 0,ce=a.useMemo(()=>!(p!=null&&p.lastReview),[p]),I=a.useRef(y);a.useEffect(()=>{I.current=y},[y]);const q=a.useRef(k);a.useEffect(()=>{q.current=k},[k]);const h=a.useRef(null),H=a.useRef(!1),D=a.useRef(null);a.useEffect(()=>{const s=m.map(n=>n.id).sort().join(",");(U.current===null||U.current!==s)&&(U.current=s,T(new Set(m.filter(n=>!n.lastReview).map(n=>n.id))),C({current:0,max:0}),S({}),z(!1),R(new Map),E.current.clear(),sessionStorage.removeItem("vocab_pro_session_progress"),sessionStorage.removeItem("vocab_pro_session_outcomes"))},[m]),a.useEffect(()=>{sessionStorage.setItem("vocab_pro_session_progress",JSON.stringify(O))},[O]),a.useEffect(()=>{sessionStorage.setItem("vocab_pro_session_outcomes",JSON.stringify(le))},[le]),a.useEffect(()=>{b(null),se(null),P(c==="random_test"),Q(!1)},[G,c]);const w=a.useCallback(()=>{if(H.current)return D.current||Promise.resolve();const s=Array.from(I.current.values());if(s.length===0)return Promise.resolve();R(f=>{const x=new Map(f);return s.forEach(r=>x.delete(r.id)),x});const n=s;if(n.length===0)return Promise.resolve();H.current=!0;const d=(async()=>{try{await L(n)}catch{R(x=>{const r=new Map(x);return n.forEach(u=>r.set(u.id,u)),r}),K("Auto-save failed, will retry.","error")}finally{H.current=!1,D.current=null,I.current.size>0&&!q.current&&(h.current&&window.clearTimeout(h.current),h.current=window.setTimeout(()=>{h.current=null,w()},ne))}})();return D.current=d,d},[L,K]),X=a.useCallback(async s=>{const n=I.current.get(s.id)||E.current.get(s.id)||s;h.current&&(window.clearTimeout(h.current),h.current=null),await w(),b(n)},[w]),W=a.useCallback(()=>{h.current&&window.clearTimeout(h.current),h.current=window.setTimeout(()=>{h.current=null,w()},ne)},[w]);a.useEffect(()=>{!k&&y.size>0&&W()},[y,k,W]),a.useEffect(()=>()=>{h.current&&(window.clearTimeout(h.current),h.current=null),!q.current&&I.current.size>0&&w()},[w]),a.useEffect(()=>{k&&y.size>0&&w()},[k,w,y.size]);const $=()=>{if(G<te.length-1){const s=G+1;C(n=>({current:s,max:Math.max(n.max,s)}))}else z(!0)},pe=async s=>{if(!p)return;S(r=>({...r,[p.id]:s}));let n,d;const f=y.get(p.id);f&&f.lastTestResults?(n={...f.lastTestResults},d=f.masteryScore):j.current?(n={...j.current},d=xe({...p,lastTestResults:j.current})):p.lastTestResults&&(n={...p.lastTestResults},d=p.masteryScore);let x=be(p,s);n&&(x={...x,lastTestResults:n,masteryScore:d}),E.current.set(x.id,x),R(r=>new Map(r).set(x.id,x)),j.current=null,$()},me=()=>{Q(!0),P(!0)},de=()=>{Q(!1),P(!0)},ue=(s,n)=>{const d=ke(n),f=$e(s.lastTestResults,d);return Object.entries(d).forEach(([x,r])=>{f[x]=r}),f},t=async(s,n,d=!1,f)=>{if(P(!1),!p)return;let x={...p};if(n&&(j.current=ue(x,n)),ie&&f){const r=f.tested-f.correct;let u=g.FORGOT;r===0?u=g.EASY:r===1&&(u=g.HARD),S(he=>({...he,[p.id]:u}));const N=be(x,u);n&&(N.lastTestResults=j.current),N.masteryScore=xe(N),E.current.set(N.id,N),R(he=>new Map(he).set(N.id,N)),Q(!1),$(),j.current=null;return}if(c==="random_test"){let r=d?"GAVE_UP":s===g.EASY?"PASS":"FAIL";S(N=>({...N,[p.id]:r}));const u=be(x,s);n&&(u.lastTestResults=j.current),u.masteryScore=xe(u),E.current.set(u.id,u),R(N=>new Map(N).set(u.id,u)),d?z(!0):$(),j.current=null}else{const r={...x};n&&(r.lastTestResults=j.current),r.masteryScore=xe(r),E.current.set(r.id,r),R(u=>new Map(u).set(r.id,r)),j.current=null}},i=()=>{U.current=null,M()},B=()=>{z(!0)};return e.jsx(tt,{user:l,initialWords:m,sessionWords:te,sessionType:c,newWordIds:o,progress:O,setProgress:C,sessionOutcomes:le,sessionFinished:k,wordInModal:je,setWordInModal:b,onOpenWordDetails:X,editingWordInModal:oe,setEditingWordInModal:se,isTesting:V,setIsTesting:P,currentWord:p,isNewWord:ce,onUpdate:v,onComplete:F,nextItem:$,handleReview:pe,handleTestComplete:t,handleRetry:i,handleEndSession:B,handleQuickReview:me,handleManualPractice:de,isQuickReviewMode:ie})};export{nt as default};
