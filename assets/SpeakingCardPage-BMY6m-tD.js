import{c as _e,r as t,Y as Ye,j as e,S as Ze,X as Ee,ad as Ke,ay as $e,as as ut,av as xt,aK as Be,k as De,aO as Et,aJ as zt,E as Ie,b as Mt,b1 as at,bK as Nt,at as gt,ac as $t,bL as Pt,aA as et,K as Ft,br as Lt,bM as Ut,H as Ot,V as Je,M as He,bN as kt,bh as We,aM as Ct,bg as St,ah as Oe,bD as Xe,az as Tt,ai as ft,bd as Bt,b3 as At,D as rt,be as lt,bO as qe,bA as ot,bB as it,bz as ct,bP as bt,_ as Rt,ag as It,bQ as _t,P as Qe,w as Vt,g as Gt,bR as Pe,A as Wt,bS as vt,h as qt,o as Dt,p as Ht,q as Kt,bT as Jt,bU as Yt,bV as Xt}from"./index-COTiwjpc.js";import{R as Qt,a as Zt}from"./ResourceActions-7KnVPos8.js";import{T as es}from"./TagBrowser-GhBSfHSL.js";import{V as ts}from"./ViewMenu-CVWOk6a6.js";import{U as st}from"./UniversalCard-DGm-bH_k.js";import{T as pt}from"./tag-D9I0Lm_b.js";import{F as ss}from"./FileSelector-DHGRL-ur.js";import{G as ns}from"./grip-vertical-DwS243qn.js";import{H as jt}from"./headphones-BJ6UaNri.js";import{L as as}from"./layout-grid-Bp5xE5wL.js";import{C as yt}from"./chevron-left-_b4zwDFE.js";import{E as rs,M as ls}from"./MimicPractice_UI-Coi93cwy.js";import{D as os}from"./list-todo-D8RRqmlD.js";import{L as is}from"./layout-list-BPNtDjcP.js";import{C as cs}from"./calendar-CGix8TEb.js";import"./filter-D7t28B9S.js";import"./server-B_LXtNNL.js";import"./music-CGwuyxzP.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=_e("ChevronsLeft",[["path",{d:"m11 17-5-5 5-5",key:"13zhaf"}],["path",{d:"m18 17-5-5 5-5",key:"h8a8et"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=_e("CircleUser",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}],["path",{d:"M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662",key:"154egf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const xs=_e("Highlighter",[["path",{d:"m9 11-6 6v3h9l3-3",key:"1a3l36"}],["path",{d:"m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4",key:"14a9rk"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ps=_e("MicVocal",[["path",{d:"m11 7.601-5.994 8.19a1 1 0 0 0 .1 1.298l.817.818a1 1 0 0 0 1.314.087L15.09 12",key:"80a601"}],["path",{d:"M16.5 21.174C15.5 20.5 14.372 20 13 20c-2.058 0-3.928 2.356-6 2-2.072-.356-2.775-3.369-1.5-4.5",key:"j0ngtp"}],["circle",{cx:"16",cy:"7",r:"5",key:"d08jfb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=_e("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dt=_e("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);function ms(o,_,i=[]){const s=i.map(I=>{const l=I.sentence.match(/\{(.*?)\}/);return l?`"${l[1]}"`:`"${I.anchor}"`}).join(", ");return`You are an expert English linguist and communication coach.
    
    TASK: Analyze a user's input/context to generate high-quality native expressions.
    
    ${s?`EXISTING EXPRESSIONS (DO NOT DUPLICATE THESE): [${s}]`:""}

    CONTEXT / CORE CONCEPT:
    "${o}"

    USER REQUEST: "${_||"Generate a variety of expressions."}"

    INSTRUCTIONS:
    1.  **Analyze**: Understand the core concept (e.g., "Disagreeing", "Showing excitement").
    2.  **Generate NEW Expressions**: Create 3-5 NEW, distinct, and natural expressions for this concept.
        -   **IMPORTANT**: If "EXISTING EXPRESSIONS" are provided, you MUST NOT repeat them. You must find *alternatives* or *variations*.
    3.  **Tones**: Try to provide a mix of 'casual', 'semi-academic', and 'academic' tones if possible.
    4.  **Format**:
        -   **Anchor (Situation/Context)**: A short, natural phrase describing the *specific situation* or *intent* where this expression is used (e.g., 'Disagreeing with a boss', 'Refusing an invitation').
            -   **DO NOT** put the expression itself here. This is the cue for the user to guess the expression.
            -   Use **English** for simple situations.
            -   Use **Vietnamese** if the situation is nuanced, abstract, or hard to describe simply in English.
        -   **Sentence**: Write a full example sentence containing the expression. Use curly braces \`{}\` to highlight the target expression.
        -   **Note**: Brief usage tip.
    5.  **Standard (Context) Field**: 
        -   Keep it **EXTREMELY CONCISE (MAX 8 WORDS)**.
        -   Make it descriptive and visual. Avoid long, explanatory sentences. 
        -   Example: Use "Sick and symptoms" instead of "Different ways to describe being sick or having a headache".
        -   If the core concept is simple, use **English**. If abstract/complex, use **Vietnamese**.

    STRICT JSON OUTPUT FORMAT:
    {
      "standard": "string (Concise Context/Title - Max 8 words)",
      "answers": [
        {
          "tone": "casual" | "semi-academic" | "academic",
          "anchor": "string (The situation cue - EN or VI)",
          "sentence": "string (e.g., 'Honestly, I'm {not buying it}.')",
          "note": "string"
        }
      ]
    }
    `}function gs(o){return`You are an expert IELTS coach and scenario designer.
    
    TASK: Generate a natural, realistic English conversation based on the topic: "${o}".
    
    CONSTRAINTS:
    1.  The conversation must involve 2 to 3 distinct speakers.
    2.  Assign each speaker a name and a sex (male or female).
    3.  The conversation should have 10 to 15 sentences in total.
    4.  The language should be appropriate for an IELTS candidate (ranging from casual to semi-formal depending on the topic).
    5.  Use high-value vocabulary and natural lexical chunks.
    6.  Assign an "icon" (emoji string) to EVERY single sentence representing the speaker's specific emotion or tone at that moment. Use emojis exclusively from the "Smiley and Emotion" fluent group.
    
    STRICT JSON OUTPUT FORMAT:
    Return a single JSON object. Do not include any text outside the JSON block.
    
    {
      "title": "string (A catchy title for the conversation)",
      "description": "string (Short context for the conversation)",
      "speakers": [
        { "name": "string (e.g., 'Alice')", "sex": "male" | "female" }
      ],
      "sentences": [
        { "speakerName": "string", "text": "string (verbatim what they say)", "icon": "string (emotional emoji)" }
      ],
      "tags": ["string (3-5 relevant IELTS tags)"]
    }
    `}function fs(o,_){return`You are an expert IELTS Speaking coach.
    
    TASK: Refine and upgrade the following speech draft to achieve a higher Band Score (8.0+).

    CURRENT DRAFT:
    "${o}"

    USER REQUEST: "${_||"Improve vocabulary, grammar, and flow."}"

    INSTRUCTIONS:
    1.  **Upgrade Vocabulary**: Replace simple words with more precise, less common lexical resources (idioms, collocations).
    2.  **Fix Grammar**: Ensure complex structures are used correctly.
    3.  **Improve Flow**: Use natural discourse markers and linking words.
    4.  **Maintain Voice**: Keep it sounding like a natural spoken response, not a written essay.

    STRICT JSON OUTPUT FORMAT:
    Return a single JSON object.
    {
      "content": "string (The fully rewritten, improved paragraph)"
    }
    `}const bs=({isOpen:o,onClose:_,onSave:i,initialData:s})=>{const[w,I]=t.useState(""),[l,f]=t.useState(""),[b,S]=t.useState(""),[A,p]=t.useState([]),[g,y]=t.useState(!1),{showToast:U}=Ye();t.useEffect(()=>{var M;o&&(I((s==null?void 0:s.standard)||""),S((s==null?void 0:s.note)||""),f(((M=s==null?void 0:s.tags)==null?void 0:M.join(", "))||""),p((s==null?void 0:s.answers)||[]))},[o,s]);const k=M=>{M.preventDefault(),w.trim()&&i({standard:w.trim(),tags:l.split(",").map(O=>O.trim()).filter(Boolean),note:b.trim(),answers:A})},Y=M=>{const O=M.result||M;O.answers&&Array.isArray(O.answers)?(p(q=>[...q,...O.answers]),O.standard&&!w&&I(O.standard),U(`Added ${O.answers.length} new expressions!`,"success"),y(!1)):U("AI response format invalid.","error")};return o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300",children:e.jsxs("form",{onSubmit:k,className:"bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:s?"Edit Expression":"New Expression"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Define context and generate expressions."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>y(!0),className:"p-2 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-100 transition-colors",title:"Refine/Expand with AI",children:e.jsx(Ze,{size:18})}),e.jsx("button",{type:"button",onClick:_,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full",children:e.jsx(Ee,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Context / Meaning"}),e.jsx("textarea",{value:w,onChange:M=>I(M.target.value),placeholder:"e.g., Disagreeing politely",rows:2,className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium focus:ring-2 focus:ring-neutral-900 outline-none resize-none",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(pt,{size:12})," Tags"]}),e.jsx("input",{value:l,onChange:M=>f(M.target.value),placeholder:"linking, academic...",className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium text-sm"})]}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Answers"}),e.jsx("button",{type:"button",onClick:()=>p([...A,{tone:"semi-academic",anchor:"",sentence:""}]),className:"p-1.5 bg-neutral-100 rounded-lg text-neutral-600 hover:bg-neutral-200 transition-colors",children:e.jsx(Ke,{size:14})})]}),A.map((M,O)=>e.jsxs("div",{className:"p-3 bg-neutral-50 rounded-xl border border-neutral-200 space-y-2 relative group",children:[e.jsx("button",{type:"button",onClick:()=>p(A.filter((q,u)=>u!==O)),className:"absolute top-2 right-2 text-neutral-300 hover:text-red-500 opacity-0 group-hover:opacity-100",children:e.jsx($e,{size:12})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:M.tone,onChange:q=>{const u=[...A];u[O].tone=q.target.value,p(u)},className:"px-2 py-1 bg-white border border-neutral-200 rounded-lg text-[10px] font-bold outline-none",children:[e.jsx("option",{value:"casual",children:"Casual"}),e.jsx("option",{value:"semi-academic",children:"Semi-Academic"}),e.jsx("option",{value:"academic",children:"Academic"})]}),e.jsx("input",{value:M.anchor,onChange:q=>{const u=[...A];u[O].anchor=q.target.value,p(u)},placeholder:"Situation / Context (e.g. Refusing politey)",className:"flex-1 px-2 py-1 bg-white border border-neutral-200 rounded-lg text-xs font-bold outline-none"})]}),e.jsx("textarea",{value:M.sentence,onChange:q=>{const u=[...A];u[O].sentence=q.target.value,p(u)},placeholder:"Example sentence with {curly braces}",className:"w-full p-2 bg-white border border-neutral-200 rounded-lg text-xs font-medium resize-none outline-none",rows:2}),e.jsx("input",{value:M.note||"",onChange:q=>{const u=[...A];u[O].note=q.target.value,p(u)},placeholder:"Note (optional)",className:"w-full px-2 py-1 bg-white border border-neutral-200 rounded-lg text-[10px] font-medium text-neutral-500 outline-none"})]},O))]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-6 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest",children:[e.jsx(ut,{size:14})," Save"]})})]})}),g&&e.jsx(xt,{isOpen:g,onClose:()=>y(!1),type:"REFINE_UNIT",title:"Expand Expressions",description:"Generate additional variations (duplicates are excluded).",initialData:{},onGeneratePrompt:M=>ms(w,M.request,A),onJsonReceived:Y,actionLabel:"Generate"})]}):null},vs=({isOpen:o,onClose:_,onSave:i,initialData:s,onOpenAiGen:w})=>{const[I,l]=t.useState(""),[f,b]=t.useState(""),[S,A]=t.useState([]),[p,g]=t.useState([]),[y,U]=t.useState(""),[k,Y]=t.useState(null);t.useEffect(()=>{var u;if(o){l((s==null?void 0:s.title)||""),b((s==null?void 0:s.description)||""),A((s==null?void 0:s.speakers)||[]),g((s==null?void 0:s.sentences)||[]),U(((u=s==null?void 0:s.tags)==null?void 0:u.join(", "))||"");const C=Be(De());Et(C).then(Y).catch(()=>Y(null))}},[o,s]);const M=u=>{u.preventDefault(),I.trim()&&i({title:I.trim(),description:f,speakers:S,sentences:p,tags:y.split(",").map(C=>C.trim()).filter(Boolean)})},O=(u,C)=>{A(R=>R.map((v,te)=>te===u?{...v,...C}:v))},q=t.useMemo(()=>k?k.voices.filter(u=>u.language.startsWith("en")&&(u.name.toLowerCase().includes("enhanced")||u.name.toLowerCase().includes("premium"))):[],[k]);return o?e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("form",{onSubmit:M,className:"bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:s?"Edit Conversation":"New Conversation"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Create interactive multi-speaker dialogues."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:w,className:"p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors",title:"Generate with AI",children:e.jsx(Ze,{size:18})}),e.jsx("button",{type:"button",onClick:_,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(Ee,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black uppercase text-neutral-400",children:"Title"}),e.jsx("input",{value:I,onChange:u=>l(u.target.value),className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold focus:ring-2 focus:ring-neutral-900 outline-none",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black uppercase text-neutral-400",children:"Tags"}),e.jsx("input",{value:y,onChange:u=>U(u.target.value),className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium text-sm focus:ring-1 focus:ring-neutral-300 outline-none"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-bold text-neutral-500 uppercase flex items-center gap-2",children:[e.jsx(zt,{size:14})," Speakers (",S.length,"/3)"]}),e.jsx("button",{type:"button",onClick:()=>A([...S,{name:"",sex:"female"}]),disabled:S.length>=3,className:"p-1.5 bg-neutral-100 rounded-lg text-neutral-600 hover:bg-neutral-200 transition-colors disabled:opacity-50",children:e.jsx(Ke,{size:14})})]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:S.map((u,C)=>e.jsxs("div",{className:"p-4 bg-neutral-50 rounded-2xl border border-neutral-200 relative group animate-in zoom-in-95 grid grid-cols-1 sm:grid-cols-[1fr,auto,2fr] gap-4 items-center",children:[e.jsx("button",{type:"button",onClick:()=>A(S.filter((R,v)=>v!==C)),className:"absolute -top-1.5 -right-1.5 p-1 bg-white text-neutral-300 hover:text-red-500 border border-neutral-200 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity z-10",children:e.jsx(Ee,{size:10})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"Speaker Name"}),e.jsx("input",{value:u.name,onChange:R=>O(C,{name:R.target.value}),placeholder:"Name",className:"w-full bg-white border border-neutral-200 rounded-lg px-3 py-1.5 font-bold text-xs outline-none focus:border-neutral-900"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"Sex"}),e.jsxs("div",{className:"flex bg-white rounded-lg p-0.5 border border-neutral-200 h-[32px]",children:[e.jsx("button",{type:"button",onClick:()=>O(C,{sex:"male"}),className:`flex-1 px-3 py-1 text-[8px] font-black uppercase rounded ${u.sex==="male"?"bg-blue-50 text-white shadow-sm":"text-neutral-400"}`,children:"Male"}),e.jsx("button",{type:"button",onClick:()=>O(C,{sex:"female"}),className:`flex-1 px-3 py-1 text-[8px] font-black uppercase rounded ${u.sex==="female"?"bg-pink-50 text-white shadow-sm":"text-neutral-400"}`,children:"Female"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"High Quality Voice"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:u.voiceName||"",onChange:R=>{const v=q.find(te=>te.name===R.target.value);O(C,{voiceName:R.target.value,accentCode:v==null?void 0:v.accent}),R.target.value&&Ie(`Hello, this is ${R.target.value}`,!1,"en",R.target.value,v==null?void 0:v.accent)},className:"w-full bg-white border border-neutral-200 rounded-xl px-4 py-3 pr-10 text-[10px] font-bold outline-none focus:border-neutral-900 appearance-none",children:[e.jsx("option",{value:"",children:"Auto Select"}),q.map(R=>e.jsxs("option",{value:R.name,children:[R.name," (",R.accent,")"]},R.name))]}),e.jsx(Mt,{size:12,className:"absolute right-2 top-1/2 -translate-y-1/2 text-neutral-400 pointer-events-none"})]})]})]},C))})]}),e.jsxs("div",{className:"space-y-3 pt-4 border-t border-neutral-100",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-bold text-neutral-500 uppercase flex items-center gap-2",children:[e.jsx(at,{size:14})," Script (",p.length,")"]}),e.jsxs("button",{type:"button",onClick:()=>{var u;return g([...p,{speakerName:((u=S[0])==null?void 0:u.name)||"",text:""}])},disabled:S.length===0,className:"px-3 py-1.5 bg-neutral-900 text-white rounded-lg font-bold text-xs flex items-center gap-1.5 hover:bg-neutral-800 disabled:opacity-50 transition-colors",children:[e.jsx(Ke,{size:14})," Add Line"]})]}),e.jsx("div",{className:"space-y-2",children:p.map((u,C)=>e.jsxs("div",{className:"flex gap-2 items-start animate-in slide-in-from-top-2",children:[e.jsx("select",{value:u.speakerName,onChange:R=>{const v=[...p];v[C].speakerName=R.target.value,g(v)},className:"w-24 shrink-0 px-2 py-2 bg-neutral-50 border border-neutral-200 rounded-lg text-[10px] font-black uppercase tracking-wider outline-none focus:ring-1 focus:ring-neutral-900",children:S.map(R=>e.jsx("option",{value:R.name,children:R.name||"?"},R.name))}),e.jsxs("div",{className:"flex-1 flex flex-col gap-1",children:[e.jsx("textarea",{value:u.text,onChange:R=>{const v=[...p];v[C].text=R.target.value,g(v)},rows:2,placeholder:"Speech...",className:"w-full px-3 py-2 bg-neutral-50 border border-neutral-200 rounded-xl text-xs font-medium focus:ring-1 focus:ring-neutral-900 outline-none resize-none"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("label",{className:"text-[8px] font-black text-neutral-400 uppercase",children:"Emoji"}),e.jsx("input",{value:u.icon||"",onChange:R=>{const v=[...p];v[C].icon=R.target.value,g(v)},className:"bg-neutral-50 border border-neutral-100 rounded px-2 py-1 text-xs w-12",placeholder:"ðŸ˜Š"})]})]}),e.jsx("button",{type:"button",onClick:g.bind(null,p.filter((R,v)=>v!==C)),className:"p-2 text-neutral-300 hover:text-red-500",children:e.jsx($e,{size:14})})]},C))})]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-8 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest",children:[e.jsx(ut,{size:14})," Save Conversation"]})})]})}):null},js=({isOpen:o,onClose:_,onSave:i,initialData:s})=>{const[w,I]=t.useState(""),[l,f]=t.useState([]),[b,S]=t.useState(""),[A,p]=t.useState([]),[g,y]=t.useState(!1),[U,k]=t.useState(!1),[Y,M]=t.useState(null),[O,q]=t.useState(!1),{showToast:u}=Ye();t.useEffect(()=>{var E;o&&(I((s==null?void 0:s.title)||""),S(((E=s==null?void 0:s.tags)==null?void 0:E.join(", "))||""),p((s==null?void 0:s.audioLinks)||[]),s!=null&&s.scriptItems&&s.scriptItems.length>0?f(s.scriptItems):s!=null&&s.content?f([{id:Date.now().toString(),type:"script",content:s.content}]):f([{id:Date.now().toString(),type:"script",content:""}]))},[o,s]);const C=E=>{if(E.preventDefault(),!w.trim()){u("Title is required","error");return}const P=l.filter(Q=>Q.content.trim());if(P.length===0){u("At least one script item is required","error");return}const ee=P.filter(Q=>Q.type==="script").map(Q=>Q.content).join(`

`);i({title:w.trim(),content:ee,scriptItems:P,tags:b.split(",").map(Q=>Q.trim()).filter(Boolean),audioLinks:A})},R=E=>{f(P=>[...P,{id:Date.now().toString()+Math.random(),type:E,content:""}])},v=E=>{f(P=>P.filter((ee,Q)=>Q!==E))},te=(E,P)=>{f(ee=>ee.map((Q,pe)=>pe===E?{...Q,...P}:Q))},me=E=>{const P=E.result||E,ee=P.content||P.rewritten||P.text;ee&&typeof ee=="string"?(f([{id:Date.now().toString(),type:"script",content:ee}]),y(!1),u("Content refined!","success")):u("Could not parse AI response.","error")},oe=E=>{const{url:P,transcript:ee}=E;p(Q=>[...Q,P]),ee&&(M(ee),q(!0))},xe=()=>{Y&&f([{id:Date.now().toString(),type:"script",content:Y}]),M(null),q(!1)},le=E=>{p(P=>P.filter((ee,Q)=>Q!==E))};return o?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300",children:e.jsxs("form",{onSubmit:C,className:"bg-white w-full max-w-4xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:s?"Edit Free Talk":"New Free Talk"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Practice speaking natural paragraphs."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>y(!0),className:"p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors",title:"Refine with AI",children:e.jsx(Ze,{size:18})}),e.jsx("button",{type:"button",onClick:_,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full",children:e.jsx(Ee,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar flex-1 bg-neutral-50/30",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Title / Topic"}),e.jsx("input",{value:w,onChange:E=>I(E.target.value),placeholder:"e.g., My Hometown",className:"w-full px-4 py-3 bg-white border border-neutral-200 rounded-xl font-medium focus:ring-2 focus:ring-neutral-900 outline-none shadow-sm",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Reference Audio"}),e.jsxs("button",{type:"button",onClick:()=>k(!0),className:"flex items-center gap-1 text-[10px] font-bold text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded-lg transition-colors",children:[e.jsx(Ke,{size:12})," From Server"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[A.length===0&&e.jsx("p",{className:"text-[10px] text-neutral-400 italic px-2 col-span-full",children:"No reference audio attached."}),A.map((E,P)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-white rounded-lg border border-neutral-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(Nt,{size:14,className:"text-emerald-500 shrink-0"}),e.jsx("span",{className:"text-xs font-mono text-neutral-600 truncate",children:decodeURIComponent(E.split("/").pop()||"file")})]}),e.jsx("button",{type:"button",onClick:()=>le(P),className:"p-1 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-full",children:e.jsx(Ee,{size:14})})]},P))]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(gt,{size:12})," Content Blocks"]}),e.jsx("div",{className:"space-y-3",children:l.map((E,P)=>e.jsxs("div",{className:`group relative p-4 rounded-2xl border transition-all ${E.type==="note"?"bg-yellow-50/50 border-yellow-200":"bg-white border-neutral-200 shadow-sm"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"p-1.5 bg-neutral-100 rounded-md cursor-move text-neutral-400",children:e.jsx(ns,{size:12})}),e.jsxs("div",{className:"flex bg-neutral-100 p-0.5 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>te(P,{type:"script"}),className:`px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-all ${E.type==="script"?"bg-white shadow-sm text-neutral-900":"text-neutral-400 hover:text-neutral-600"}`,children:"Script"}),e.jsx("button",{type:"button",onClick:()=>te(P,{type:"note"}),className:`px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-all ${E.type==="note"?"bg-white shadow-sm text-yellow-600":"text-neutral-400 hover:text-neutral-600"}`,children:"Note"})]})]}),e.jsx("button",{type:"button",onClick:()=>v(P),className:"p-1.5 text-neutral-300 hover:text-red-500 hover:bg-red-50 rounded-lg opacity-0 group-hover:opacity-100 transition-all",children:e.jsx($e,{size:14})})]}),e.jsx("textarea",{value:E.content,onChange:ee=>te(P,{content:ee.target.value}),placeholder:E.type==="script"?"Enter speech text...":"Enter notes, cues, or reminders...",className:`w-full p-3 rounded-xl outline-none resize-none text-sm leading-relaxed min-h-[100px] ${E.type==="note"?"bg-yellow-50/50 placeholder:text-yellow-300/50 text-yellow-900 italic":"bg-neutral-50 focus:bg-white focus:ring-2 focus:ring-neutral-900 placeholder:text-neutral-300"}`})]},E.id))}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{type:"button",onClick:()=>R("script"),className:"flex-1 py-3 border-2 border-dashed border-neutral-200 rounded-xl text-neutral-400 font-bold text-xs hover:border-neutral-400 hover:text-neutral-600 transition-all flex items-center justify-center gap-2",children:[e.jsx($t,{size:14})," Add Script"]}),e.jsxs("button",{type:"button",onClick:()=>R("note"),className:"flex-1 py-3 border-2 border-dashed border-yellow-200 rounded-xl text-yellow-600/50 font-bold text-xs hover:border-yellow-400 hover:text-yellow-700 transition-all flex items-center justify-center gap-2 bg-yellow-50/30",children:[e.jsx(Pt,{size:14})," Add Note"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(pt,{size:12})," Tags"]}),e.jsx("input",{value:b,onChange:E=>S(E.target.value),placeholder:"part1, personal...",className:"w-full px-4 py-3 bg-white border border-neutral-200 rounded-xl font-medium text-sm shadow-sm"})]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-6 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-lg",children:[e.jsx(ut,{size:14})," Save"]})})]})}),g&&e.jsx(xt,{isOpen:g,onClose:()=>y(!1),type:"REFINE_UNIT",title:"Refine Free Talk",description:"Improve vocabulary and grammar for a higher band score.",initialData:{request:""},onGeneratePrompt:E=>fs(l.map(P=>P.content).join(`
`),E.request),onJsonReceived:me,actionLabel:"Refine",closeOnSuccess:!0}),e.jsx(ss,{isOpen:U,onClose:()=>k(!1),onSelect:oe,type:"audio",title:"Select Audio"}),e.jsx(et,{isOpen:O,title:"Replace Content?",message:"This audio file comes with a linked transcript. Do you want to replace your current content with it?",confirmText:"Replace",isProcessing:!1,onConfirm:xe,onClose:()=>q(!1),icon:e.jsx(gt,{size:40,className:"text-indigo-500"}),confirmButtonClass:"bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200"})]}):null},ys=({text:o})=>{const _=o.split(/({.*?}|\[.*?\]|<.*?>)/g);return e.jsx(e.Fragment,{children:_.map((i,s)=>i.startsWith("{")&&i.endsWith("}")?e.jsx("span",{className:"mx-0.5 px-1 py-0.5 rounded bg-amber-100 text-amber-800 font-bold font-mono text-[0.9em] border border-amber-200 inline-block shadow-sm",children:i.slice(1,-1)},s):i.startsWith("[")&&i.endsWith("]")?e.jsxs("span",{className:"mx-1 inline-flex items-center gap-1.5 text-[10px] text-sky-700 bg-sky-100 border border-sky-200 px-2 py-1 rounded-full font-medium",children:[e.jsx(Ct,{size:12}),i.slice(1,-1)]},s):e.jsx("span",{children:i},s))})},ws=({isOpen:o,onClose:_,item:i})=>{const[s,w]=t.useState(new Set),[I,l]=t.useState(null),f=t.useRef([]);if(!o||!i)return null;const b=g=>{w(y=>{const U=new Set(y);return U.has(g)?U.delete(g):U.add(g),U})},S=g=>{const y=g.replace(/{|}/g,"");l(y)},A=g=>{f.current.push(g)},p=async()=>{if(f.current.length>0){const g=Math.round(f.current.reduce((y,U)=>y+U,0)/f.current.length);await We({...i,bestScore:g,updatedAt:Date.now()})}_(),f.current=[]};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[85vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-center shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:i.standard}),e.jsx("p",{className:"text-xs text-neutral-500 font-bold mt-1",children:"Native Expressions Practice"})]}),e.jsx("button",{type:"button",onClick:p,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(Ee,{size:24})})]}),e.jsx("main",{className:"flex-1 overflow-y-auto p-8 space-y-4 custom-scrollbar bg-neutral-50/30",children:i.answers.map((g,y)=>{const U=s.has(y);return e.jsxs("div",{className:"bg-white p-5 rounded-3xl border border-neutral-200 shadow-sm space-y-3 relative overflow-hidden group",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[g.lastResult==="correct"&&e.jsx("div",{className:"bg-green-100 text-green-600 p-1 rounded-full",title:"Mastered in Game",children:e.jsx(Ft,{size:12})}),g.lastResult==="incorrect"&&e.jsx("div",{className:"bg-red-100 text-red-600 p-1 rounded-full",title:"Needs Practice",children:e.jsx(Lt,{size:12})}),e.jsx("span",{className:`px-2 py-0.5 rounded text-[8px] font-black uppercase border ${g.tone==="academic"?"bg-purple-50 text-purple-700 border-purple-100":g.tone==="semi-academic"?"bg-blue-50 text-blue-700 border-blue-100":"bg-neutral-50 text-neutral-600 border-neutral-100"}`,children:g.tone})]}),e.jsx("span",{className:"text-sm font-bold text-neutral-700 leading-snug",children:g.anchor})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>b(y),className:`p-2 rounded-lg transition-all ${U?"text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:U?e.jsx(Ut,{size:16}):e.jsx(Ot,{size:16})}),U&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Ie(g.sentence.replace(/{|}/g,"")),className:"p-2 text-neutral-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all",title:"Listen",children:e.jsx(Je,{size:16})}),e.jsx("button",{onClick:()=>S(g.sentence),className:"p-2 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all",title:"Practice Speaking",children:e.jsx(He,{size:16})})]})]})]}),e.jsx("div",{className:"min-h-[1.5rem] flex items-center pt-2 border-t border-neutral-50",children:U?e.jsx("div",{className:"text-base font-medium text-neutral-800 animate-in fade-in slide-in-from-top-1",children:e.jsx(ys,{text:g.sentence})}):e.jsxs("div",{className:"flex gap-1 items-center opacity-30 w-full",children:[e.jsx("div",{className:"h-2 w-12 bg-neutral-200 rounded-full"}),e.jsx("div",{className:"h-2 w-24 bg-neutral-200 rounded-full"}),e.jsx("div",{className:"h-2 w-8 bg-neutral-200 rounded-full"})]})}),g.note&&U&&e.jsxs("div",{className:"text-[10px] text-neutral-400 font-medium italic",children:['"',g.note,'"']})]},y)})}),e.jsx("footer",{className:"px-8 py-4 border-t border-neutral-100 bg-white rounded-b-[2.5rem] flex justify-end",children:e.jsx("button",{onClick:p,className:"px-6 py-2.5 bg-neutral-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-md",children:"Done"})})]}),I&&e.jsx(kt,{target:I,onClose:()=>l(null),onSaveScore:A})]})};function Ns(o){const _=o.numberOfChannels,i=o.length*_*2+44,s=new ArrayBuffer(i),w=new DataView(s),I=[];let l,f,b=0,S=0;for(p(1179011410),p(i-8),p(1163280727),p(544501094),p(16),A(1),A(_),p(o.sampleRate),p(o.sampleRate*2*_),A(_*2),A(16),p(1635017060),p(i-S-4),l=0;l<o.numberOfChannels;l++)I.push(o.getChannelData(l));for(;S<i;){for(l=0;l<_;l++)f=Math.max(-1,Math.min(1,I[l][b])),f=(f<0?f*32768:f*32767)|0,w.setInt16(S,f,!0),S+=2;b++}return new Blob([s],{type:"audio/wav"});function A(g){w.setUint16(S,g,!0),S+=2}function p(g){w.setUint32(S,g,!0),S+=4}}const ks=({isOpen:o,onClose:_,item:i})=>{const[s,w]=t.useState(0),[I,l]=t.useState(!1),[f,b]=t.useState(!1),[S,A]=t.useState(null),[p,g]=t.useState(!1),[y,U]=t.useState(!1),[k,Y]=t.useState(!0),[M,O]=t.useState(null),[q,u]=t.useState({}),[C,R]=t.useState({}),[v,te]=t.useState(!1),[me,oe]=t.useState(""),[xe,le]=t.useState(null),[E,P]=t.useState("audio/webm"),[ee,Q]=t.useState(!1),[pe,Ne]=t.useState(null),ie=t.useRef([]),[c,h]=t.useState(!1),[x]=t.useState(()=>De()),V=t.useRef(null),T=t.useRef({}),d=t.useRef(new St),F=t.useRef(null),{showToast:G}=Ye(),H=()=>{F.current&&(F.current.pause(),F.current.src="",F.current=null),lt()},he=async()=>{if(H(),d.current.stop(),i&&ie.current.length>0){const r=Math.round(ie.current.reduce((N,$)=>N+$,0)/ie.current.length);await qe({...i,bestScore:r,updatedAt:Date.now()})}R({}),u({}),le(null),ie.current=[],_()};t.useEffect(()=>{if(!(I||f)||!i)return;let r=!1;return(async()=>{if(s>=i.sentences.length||r)return;const $=i.sentences[s];if(!f&&S&&$.speakerName===S){l(!1),g(!0);return}const W=q[s];if(W&&f)H(),await new Promise(re=>{const B=new Audio(`data:${W.mime};base64,${W.base64}`);F.current=B,B.onended=()=>re(!0),B.onerror=()=>re(!1),B.play().catch(()=>re(!1)),r&&(B.pause(),re(!1))});else{const re=C[s];if(re)H(),await new Promise(B=>{const K=new Audio(`data:${re.mime};base64,${re.base64}`);F.current=K,K.onended=()=>B(!0),K.onerror=()=>B(!1),K.play().catch(()=>B(!1)),r&&(K.pause(),B(!1))});else{const B=i.speakers.find(ne=>ne.name===$.speakerName);let K=B==null?void 0:B.voiceName,de=B==null?void 0:B.accentCode;if(!K){const ne=(B==null?void 0:B.sex)==="male"?"male":"female",ae=x.audioCoach.coaches[ne];K=ae.enVoice,de=ae.enAccent}try{const ne=Be(x),ae={text:$.text,language:"en",accent:de,voice:K},be=await fetch(`${ne}/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ae)});if(be.ok){const Re=await be.blob(),ue=new FileReader,Ve=new Promise(a=>{ue.onloadend=()=>a(ue.result.split(",")[1])});ue.readAsDataURL(Re);const Ue=await Ve,Se=be.headers.get("Content-Type")||"audio/aiff";if(R(a=>({...a,[s]:{base64:Ue,mime:Se}})),!r){H();const a=new Audio(`data:${Se};base64,${Ue}`);F.current=a,await new Promise(j=>{a.onended=()=>j(!0),a.onerror=()=>j(!1),a.play().catch(()=>j(!1)),r&&(a.pause(),j(!1))})}}else await Ie($.text,!0,"en",K,de)}catch(ne){console.error("Playback error",ne)}}}!r&&(I||f)&&(s<i.sentences.length-1?w(re=>re+1):(l(!1),b(!1)))})(),()=>{r=!0}},[I,f,s,i,S]),t.useEffect(()=>{const r=T.current[s];r&&V.current&&r.scrollIntoView({behavior:"smooth",block:"center"})},[s,I,f,p,k]);const je=s>0||Object.keys(q).length>0,ce=r=>{je?O(r):L(r)},L=r=>{H(),l(!1),b(!1),g(!1),w(0),u({}),ie.current=[],A(r),O(null),G(r?`Role changed to ${r}. Practice reset.`:"Role changed to Spectator. Practice reset.","info")};if(!o||!i||!i.sentences||i.sentences.length===0)return null;const ge=i.sentences,fe=ge[s],Le=()=>{H(),g(!1),w(0)},ye=()=>{s>0&&(H(),g(!1),w(r=>r-1))},ze=()=>{s<ge.length-1&&(H(),g(!1),w(r=>r+1))},ke=async()=>{if(v){d.current.stop(),Q(!1);const r=await ot();r&&(le(r.base64),P(r.mimeType)),te(!1)}else{H(),oe(""),le(null);try{await it(),te(!0),Q(!0),d.current.start((r,N)=>oe(r+N),r=>oe(r))}catch(r){console.error("Failed to start recording",r),te(!1)}}},Te=r=>{const N=r!==void 0?q[r]:xe?{base64:xe,mime:E}:null;if(N){H();const $=new Audio(`data:${N.mime};base64,${N.base64}`);F.current=$,$.play()}},Me=()=>{if(xe&&(u(r=>({...r,[s]:{base64:xe,mime:E}})),fe)){const r=ct(fe.text,me);ie.current.push(r.score)}g(!1),oe(""),le(null),s<ge.length-1?(w(r=>r+1),l(!0)):l(!1)},ve=async(r,N)=>{H();const $=C[N];if($){const ne=new Audio(`data:${$.mime};base64,${$.base64}`);F.current=ne,ne.play();return}const W=i.speakers.find(ne=>ne.name===r.speakerName);let re=W==null?void 0:W.voiceName,B=W==null?void 0:W.accentCode;if(!re){const ne=(W==null?void 0:W.sex)==="male"?"male":"female",ae=x.audioCoach.coaches[ne];re=ae.enVoice,B=ae.enAccent}const K=Be(x),de={text:r.text,language:"en",accent:B,voice:re};try{const ne=await fetch(`${K}/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(de)});if(ne.ok){const ae=await ne.blob(),be=new FileReader;be.onloadend=()=>{const ue=be.result.split(",")[1],Ve=ne.headers.get("Content-Type")||"audio/aiff";R(Ue=>({...Ue,[N]:{base64:ue,mime:Ve}}))},be.readAsDataURL(ae);const Re=new Audio(URL.createObjectURL(ae));F.current=Re,Re.play()}else Ie(r.text,!1,"en",re,B)}catch{Ie(r.text,!1,"en",re,B)}},Ae=()=>{f?(b(!1),H()):(H(),l(!1),g(!1),b(!0),w(0))},Ce=async()=>{const r=new(window.AudioContext||window.webkitAudioContext),N=[];let $=!1;for(let K=0;K<i.sentences.length;K++){const de=q[K],ne=C[K],ae=de||ne;if(!ae)continue;$=!0;const be=atob(ae.base64),Re=new Uint8Array(be.length);for(let ue=0;ue<be.length;ue++)Re[ue]=be.charCodeAt(ue);try{const ue=await r.decodeAudioData(Re.buffer);N.push(ue)}catch(ue){console.warn(`Failed to decode segment ${K}`,ue)}}if(!$||N.length===0)return null;const W=N.reduce((K,de)=>K+de.length,0),re=r.createBuffer(N[0].numberOfChannels,W,N[0].sampleRate);let B=0;return N.forEach(K=>{for(let de=0;de<K.numberOfChannels;de++)re.getChannelData(de).set(K.getChannelData(de),B);B+=K.length}),re},Fe=async()=>{if(!c){h(!0),H();try{const r=await Ce();if(!r){G("No audio segments available to play.","info"),h(!1);return}const N=new(window.AudioContext||window.webkitAudioContext),$=N.createBufferSource();$.buffer=r,$.connect(N.destination),$.onended=()=>h(!1),$.start(0)}catch(r){console.error("Preview failed",r),G("Failed to preview audio.","error"),h(!1)}}},n=async()=>{if(!y){U(!0),G("Generating full audio file...","info");try{const r=await Ce();if(!r){G("No audio segments available to save.","info"),U(!1);return}const N=Ns(r),$=URL.createObjectURL(N),W=document.createElement("a");W.href=$,W.download=`Full_Dialogue_${i.title.replace(/\s+/g,"_")}.wav`,document.body.appendChild(W),W.click(),document.body.removeChild(W),URL.revokeObjectURL($),G("Audio file saved!","success")}catch(r){console.error("Save All failed",r),G("Error generating audio file.","error")}finally{U(!1)}}},m=Object.keys(q).length>0||Object.keys(C).length>0,D=k?[ge[s]]:ge,se=r=>{ie.current.push(r)};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-4xl rounded-[3rem] shadow-2xl border border-neutral-200 flex flex-col h-[85vh] overflow-hidden",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-center shrink-0 bg-white z-10",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900 tracking-tight leading-none",children:i.title}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1 text-[9px] font-black uppercase text-neutral-400",children:[e.jsx(us,{size:10})," Role Play:"]}),e.jsxs("div",{className:"flex bg-neutral-100 p-0.5 rounded-lg",children:[e.jsx("button",{onClick:()=>ce(null),className:`px-2 py-1 rounded-md text-[9px] font-black uppercase transition-all ${!S&&!f?"bg-white text-neutral-900 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,children:"Spectator"}),i.speakers.map(r=>e.jsxs("button",{onClick:()=>ce(r.name),className:`px-2 py-1 rounded-md text-[9px] font-black uppercase transition-all ${S===r.name?"bg-indigo-600 text-white shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,children:["Act as ",r.name]},r.name))]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl gap-1",children:[e.jsxs("button",{onClick:Ae,className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${f?"bg-indigo-600 text-white shadow-lg":"text-neutral-500 hover:text-neutral-900"}`,title:"Play whole conversation non-stop",children:[e.jsx(jt,{size:14}),f?"Stop":"Play All"]}),!f&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{H(),l(!0),b(!1)},className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${I?"bg-neutral-900 text-white shadow-lg":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Oe,{size:14,fill:"currentColor"})," Play"]}),e.jsxs("button",{onClick:()=>{l(!1),H()},className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${I?"text-neutral-500 hover:text-neutral-900":"bg-neutral-900 text-white shadow-lg"}`,children:[e.jsx(Xe,{size:14,fill:"currentColor"})," Pause"]})]})]}),e.jsx("button",{type:"button",onClick:he,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(Ee,{size:24})})]})]}),e.jsx("div",{className:"bg-neutral-50/50 py-6 px-8 border-b border-neutral-100 shrink-0",children:e.jsx("div",{className:"flex justify-center items-end gap-10 md:gap-20",children:i.speakers.map((r,N)=>{const $=fe.speakerName===r.name,W=S===r.name;return e.jsxs("div",{className:"flex flex-col items-center relative group",children:[$&&e.jsxs("div",{className:"absolute -top-12 left-1/2 -translate-x-1/2 bg-neutral-900 text-white px-3 py-1.5 rounded-xl text-lg animate-bounce shadow-xl whitespace-nowrap z-20",children:[fe.icon||"ðŸ’¬",e.jsx("div",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-neutral-900 rotate-45"})]}),e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center text-3xl md:text-4xl transition-all duration-300 ${$?"bg-white scale-110 shadow-2xl ring-4 ring-indigo-500/20":"bg-neutral-200/50 grayscale opacity-40"} ${W?"border-2 border-indigo-500":""}`,children:r.sex==="male"?"ðŸ‘¨":"ðŸ‘©"}),e.jsx("div",{className:`mt-2 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest transition-colors ${$?"bg-neutral-900 text-white":"text-neutral-400 bg-neutral-100"} ${W?"ring-1 ring-indigo-500":""}`,children:W?"YOU":r.name})]},N)})})}),e.jsxs("div",{className:"px-6 py-2 bg-white border-b border-neutral-100 flex items-center justify-between",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-lg gap-1",children:[e.jsxs("button",{onClick:()=>Y(!0),className:`px-3 py-1.5 rounded-md text-[9px] font-black uppercase flex items-center gap-1.5 transition-all ${k?"bg-white text-neutral-900 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,title:"Show current turn only",children:[e.jsx(Tt,{size:12})," Focus"]}),e.jsxs("button",{onClick:()=>Y(!1),className:`px-3 py-1.5 rounded-md text-[9px] font-black uppercase flex items-center gap-1.5 transition-all ${k?"text-neutral-400 hover:text-neutral-600":"bg-white text-neutral-900 shadow-sm"}`,title:"Show full script",children:[e.jsx(as,{size:12})," Script"]})]}),k&&e.jsxs("div",{className:"flex items-center gap-1 bg-neutral-50 p-1 rounded-lg border border-neutral-100 animate-in fade-in slide-in-from-right-2",children:[e.jsx("button",{onClick:Le,disabled:s===0||p,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(ds,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-neutral-200"}),e.jsx("button",{onClick:ye,disabled:s===0||p,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(yt,{size:16})}),e.jsx("button",{onClick:ze,disabled:s===ge.length-1||p,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(ft,{size:16})})]})]}),e.jsx("main",{ref:V,className:"flex-1 overflow-y-auto p-6 md:p-8 space-y-4 custom-scrollbar bg-white scroll-smooth pb-32",children:D.map((r,N)=>{const $=k?s:N,W=k?!0:N===s,re=S===r.speakerName,B=i.speakers.find(ae=>ae.name===r.speakerName),K=(B==null?void 0:B.sex)==="male",de=q[$]!==void 0,ne=p&&$===s;return e.jsxs("div",{ref:ae=>{W&&(T.current[$]=ae)},onClick:()=>{!I&&!f&&!p&&!k&&(w(N),H())},className:`flex items-start gap-4 p-4 rounded-[2rem] transition-all border-2 ${W?"bg-indigo-50/30 border-indigo-200 shadow-sm":"border-transparent hover:bg-neutral-50"} ${I||f||p||k?"cursor-default":"cursor-pointer"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-2xl shrink-0 flex items-center justify-center text-xl shadow-sm ${K?"bg-blue-100":"bg-pink-100"} ${W?"scale-110 ring-2 ring-white":""}`,children:re?"ðŸŒŸ":r.icon||(K?"ðŸ‘¨":"ðŸ‘©")}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`text-[10px] font-black uppercase tracking-widest ${W?"text-indigo-600":"text-neutral-400"}`,children:re?`YOU (as ${r.speakerName})`:r.speakerName}),e.jsxs("div",{className:"flex items-center gap-1",children:[de&&e.jsx("button",{onClick:ae=>{ae.stopPropagation(),Te($)},className:"p-2 bg-rose-50 text-rose-600 rounded-xl hover:bg-rose-100 transition-all",title:"Listen back to your attempt",children:e.jsx(He,{size:14})}),W&&!I&&!f&&!p&&e.jsxs("div",{className:"flex items-center gap-2 animate-in fade-in zoom-in-95",children:[e.jsx("button",{onClick:ae=>{ae.stopPropagation(),ve(r,$)},className:"p-2 bg-neutral-900 text-white rounded-xl hover:scale-105 transition-transform",children:e.jsx(Je,{size:14})}),e.jsx("button",{onClick:ae=>{ae.stopPropagation(),Ne(r.text)},className:"p-2 bg-rose-500 text-white rounded-xl hover:scale-105 transition-transform",children:e.jsx(He,{size:14})})]})]})]}),e.jsx("p",{className:`text-sm md:text-lg leading-relaxed font-bold transition-colors ${W?"text-neutral-900":"text-neutral-500"}`,children:r.text}),ne&&e.jsxs("div",{className:"mt-4 p-6 bg-white border-2 border-indigo-500 rounded-[2rem] shadow-xl animate-in zoom-in-95 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-600",children:[e.jsx(Bt,{size:18}),e.jsx("span",{className:"text-xs font-black uppercase tracking-widest",children:"Your Turn to Speak"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>ve(r,$),className:"p-2 bg-neutral-100 text-neutral-600 rounded-lg hover:text-neutral-900 transition-all",title:"Listen to Model",children:e.jsx(Je,{size:16})}),ee&&e.jsx("span",{className:"flex h-2 w-2 rounded-full bg-red-500 animate-ping"})]})]}),e.jsx("div",{className:"min-h-[60px] p-4 bg-neutral-50 rounded-2xl border border-neutral-100 flex flex-col items-center justify-center text-center",children:me?e.jsxs("p",{className:"text-sm font-medium italic text-neutral-800 leading-relaxed",children:['"',me,'"']}):e.jsx("p",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:"Tap mic and read the sentence aloud"})}),e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:ke,className:`w-14 h-14 rounded-full flex items-center justify-center transition-all transform active:scale-90 ${v?"bg-red-500 text-white animate-pulse ring-8 ring-red-100":"bg-neutral-900 text-white hover:bg-neutral-800"}`,children:v?e.jsx(At,{size:24,fill:"white"}):e.jsx(He,{size:24})}),xe&&e.jsx("button",{onClick:()=>Te(),className:"p-4 bg-white border border-neutral-200 text-neutral-600 rounded-2xl hover:text-indigo-600 hover:border-indigo-300 transition-all",children:e.jsx(Oe,{size:20,fill:"currentColor"})}),e.jsx("button",{onClick:Me,disabled:v,className:"px-6 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 disabled:opacity-50",children:"Confirm & Continue"})]})]})]})]},`${$}-${N}`)})}),e.jsxs("footer",{className:"px-8 py-6 border-t border-neutral-100 bg-white/80 backdrop-blur-md flex justify-between items-center shrink-0 absolute bottom-0 left-0 right-0 z-20",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:ye,disabled:s===0||p,className:"p-3 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all",children:e.jsx(yt,{size:20})}),e.jsxs("div",{className:"flex flex-col items-center min-w-[80px]",children:[e.jsx("span",{className:"text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-1",children:"Sentence"}),e.jsxs("span",{className:"text-sm font-black text-neutral-900",children:[s+1," / ",ge.length]})]}),e.jsx("button",{onClick:ze,disabled:s===ge.length-1||p,className:"p-3 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all",children:e.jsx(ft,{size:20})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[f?e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-2xl shadow-lg animate-in fade-in",children:[e.jsx(jt,{size:14}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Full Playback Mode"})]}):p?e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-indigo-50 rounded-2xl border border-indigo-100 animate-in slide-in-from-right-2",children:[e.jsx(Ze,{size:14,className:"text-indigo-600"}),e.jsx("span",{className:"text-[10px] font-black text-indigo-700 uppercase tracking-widest",children:"Waiting for User"})]}):!I&&e.jsxs("div",{className:"hidden sm:flex items-center gap-2 px-4 py-2 bg-neutral-50 rounded-2xl border border-indigo-100 animate-in fade-in",children:[e.jsx(Ct,{size:14,className:"text-neutral-400"}),e.jsx("span",{className:"text-[10px] font-bold text-neutral-500 uppercase tracking-widest",children:"Manual Mode Active"})]}),e.jsxs("button",{onClick:Fe,disabled:c||!m,className:`px-5 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all shadow-md active:scale-95 flex items-center gap-2 disabled:opacity-50 ${c?"bg-amber-100 text-amber-700":"bg-white border border-neutral-200 text-neutral-600 hover:bg-neutral-50"}`,title:"Listen to full audio without downloading",children:[c?e.jsx(rt,{size:14,className:"animate-spin"}):e.jsx(rs,{size:14}),e.jsx("span",{className:"hidden sm:inline",children:c?"Playing...":"Listen Full"})]}),e.jsxs("button",{onClick:n,disabled:y||!m,className:"px-5 py-3 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-lg active:scale-95 flex items-center gap-2 disabled:opacity-50",title:"Save all audio (User & AI) to one file",children:[y?e.jsx(rt,{size:14,className:"animate-spin"}):e.jsx(os,{size:14}),e.jsx("span",{className:"hidden sm:inline",children:"Save All"})]}),e.jsx("button",{onClick:he,className:"px-8 py-3 bg-neutral-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-lg active:scale-95",children:"Finish Session"})]})]})]}),pe&&e.jsx(kt,{target:pe,onClose:()=>Ne(null),onSaveScore:se}),e.jsx(et,{isOpen:!!M,title:"Switch Role?",message:"Changing roles will reset your current practice progress. Recordings will be lost.",confirmText:"Switch & Reset",isProcessing:!1,onConfirm:()=>L(M),onClose:()=>O(null)})]})},Cs=({isOpen:o,onClose:_,onConfirm:i,audioFiles:s,initialData:w})=>{const[I,l]=t.useState(""),[f,b]=t.useState(""),[S,A]=t.useState("");if(t.useEffect(()=>{if(o)if(w){const y=w.filename&&s.includes(w.filename)?w.filename:w.filename||(s.length>0?s[0]:"");l(y),b(w.start||""),A(w.duration||"")}else l(s.length>0?s[0]:""),b(""),A("")},[o,s,w]),!o)return null;const p=y=>{y.preventDefault(),i({filename:I,start:f.trim(),duration:S.trim()})},g=y=>decodeURIComponent(y.split("/").pop()||"");return e.jsx("div",{className:"fixed inset-0 z-[300] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in",children:e.jsxs("div",{className:"bg-white w-full max-w-sm rounded-2xl shadow-2xl border border-neutral-200 p-6",children:[e.jsxs("h3",{className:"text-lg font-black text-neutral-900 mb-4 flex items-center gap-2",children:[w?e.jsx(dt,{size:20,className:"text-indigo-600"}):e.jsx(Je,{size:20,className:"text-indigo-600"}),w?"Edit Audio Settings":"Mark Audio Segment"]}),e.jsxs("form",{onSubmit:p,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Source Audio (Optional)"}),e.jsxs("select",{value:I,onChange:y=>l(y.target.value),className:"w-full p-2 bg-neutral-50 border border-neutral-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-neutral-900 outline-none",children:[e.jsx("option",{value:"",children:"None (Use Text-to-Speech)"}),s.map((y,U)=>e.jsx("option",{value:y,children:g(y)},U))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Start (Sec)"}),e.jsx("input",{type:"number",step:"0.1",min:"0",value:f,onChange:y=>b(y.target.value),placeholder:"e.g. 5.5",className:"w-full p-2 bg-neutral-50 border border-neutral-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-neutral-900 outline-none"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Duration (Sec)"}),e.jsx("input",{type:"number",step:"0.1",min:"0",value:S,onChange:y=>A(y.target.value),placeholder:"e.g. 10",className:"w-full p-2 bg-neutral-50 border border-neutral-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-neutral-900 outline-none"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:_,className:"px-4 py-2 text-neutral-500 font-bold text-xs hover:bg-neutral-100 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-neutral-900 text-white font-bold text-xs rounded-lg hover:bg-neutral-800 transition-colors",children:"Apply"})]})]})]})})},Ss=({text:o})=>{const _=o.split(/({.*?}|\[.*?\]\(.*?\)|\[.*?\])/g);return e.jsx("span",{className:"leading-relaxed",children:_.map((i,s)=>i.startsWith("{")&&i.endsWith("}")?e.jsx("span",{className:"text-red-600 font-bold mx-0.5",children:i.slice(1,-1)},s):e.jsx("span",{children:i},s))})},Ts=({rawText:o,onUpdate:_,readOnly:i=!1,showDash:s=!0,audioLinks:w=[],onPlaySegment:I,fontSize:l="text-lg",compact:f=!1})=>{const[b,S]=t.useState(!1),[A,p]=t.useState(o);t.useEffect(()=>{p(o)},[o]);const g=()=>{_(A),S(!1)},y=()=>{p(o),S(!1)},U=t.useRef(null),[k,Y]=t.useState(null),[M,O]=t.useState(!1),[q,u]=t.useState(null),[C,R]=t.useState(null),v=t.useRef(null),te=t.useMemo(()=>{const c=[],h=/({[\s\S]*?}|\[[\s\S]*?\]\([\s\S]*?\)|\[[\s\S]*?\])/g;let x,V=0;for(;(x=h.exec(o))!==null;){x.index>V&&c.push({text:o.slice(V,x.index),type:"text",start:V,end:x.index});let T="text",d=x[0];if(x[0].startsWith("{"))T="highlight",d=x[0].slice(1,-1);else if(x[0].startsWith("["))if(T="audio",x[0].includes("](")){const F=x[0].match(/^\[(.*?)\]/);d=F?F[1]:"error"}else d=x[0].slice(1,-1);c.push({text:x[0],type:T,start:x.index,end:h.lastIndex,displayContent:d}),V=h.lastIndex}return V<o.length&&c.push({text:o.slice(V),type:"text",start:V,end:o.length}),c},[o]),me=()=>{var c;Y(null),(c=window.getSelection())==null||c.removeAllRanges(),S(!0)},oe=()=>{if(i||b)return;const c=window.getSelection(),h=T=>{if(!T)return null;let d=T.nodeType===3?T.parentElement:T;for(;d&&d!==U.current&&!d.hasAttribute("data-index");)d=d.parentElement;return d&&d.hasAttribute("data-index")?parseInt(d.getAttribute("data-index"),10):null};if(!c||!c.anchorNode||!c.focusNode||c.isCollapsed){Y(null);return}const x=h(c.anchorNode),V=h(c.focusNode);if(x===null||V===null){Y(null);return}if(x===V&&te[x].type==="text"){let T=c.anchorOffset,d=c.focusOffset;T>d&&([T,d]=[d,T]),Y({start:te[x].start+T,end:te[x].start+d,currentType:"text"})}else{const T=Math.min(x,V),d=Math.max(x,V);let F=!1;for(let G=T;G<=d;G++)te[G].type==="audio"&&(F=!0);Y(F?null:{start:te[T].start,end:te[d].end,currentType:"text"})}},xe=c=>{var V,T;if(!k)return;const{start:h,end:x}=k;if(c==="audio"){u(null),O(!0);return}if(c==="clear"){const d=o.slice(0,h),F=o.slice(h,x);let G=F;F.startsWith("{")?G=F.slice(1,-1):F.startsWith("[")&&(F.includes("](")?G=((V=F.match(/^\[(.*?)\]/))==null?void 0:V[1])||"":G=F.slice(1,-1));const H=o.slice(x);_(d+G+H)}else{const d=o.slice(0,h),F=o.slice(h,x),G=o.slice(x);_(`${d}{${F}}${G}`)}Y(null),(T=window.getSelection())==null||T.removeAllRanges()},le=()=>{if(!k||k.currentType!=="audio")return;const h=o.slice(k.start,k.end).match(/\((.*?)\)$/);if(h){const x=h[1].split("|");u({filename:x[0]||"",start:x[1]||"",duration:x[2]||""})}else u(null);O(!0)},E=c=>{var ce;if(!k)return;const{start:h,end:x,currentType:V}=k,T=o.slice(0,h);let d=o.slice(h,x);if(V==="audio"){const L=d.match(/^\[(.*?)\]/);L?d=L[1]:d=d.replace(/^\[/,"").replace(/\](\(.*?\))?$/,"")}const F=o.slice(x);let G=`[${d}]`;const H=c.filename,he=c.start,je=c.duration;if(H||he||je){const L=[];for(H?L.push(H):L.push(""),he?L.push(he):je&&L.push(""),je&&L.push(je);L.length>0&&!L[L.length-1];)L.pop();L.length>0&&(G+=`(${L.join("|")})`)}_(`${T}${G}${F}`),O(!1),u(null),Y(null),(ce=window.getSelection())==null||ce.removeAllRanges()},P=(c,h)=>{var V;if(c.stopPropagation(),h.text.includes("](")){const T=h.text.match(/\((.*?)\)$/);if(T){const d=T[1].split("|"),F=d[0]?d[0]:void 0,G=d[1]?parseFloat(d[1]):void 0,H=d[2]?parseFloat(d[2]):void 0,he=((V=h.displayContent)==null?void 0:V.replace(/[{}]/g,""))||"";I(F,G,H,he);return}}const x=(h.displayContent||h.text.slice(1,-1)).replace(/[{}]/g,"");Ie(x)},ee=(c,h,x)=>{if(i||x==="text")return;v.current&&(clearTimeout(v.current),v.current=null);const V=c.currentTarget.getBoundingClientRect();R(T=>(T==null?void 0:T.idx)===h?T:{idx:h,rect:V,type:x})},Q=()=>{i||(v.current=setTimeout(()=>{R(null)},600))},pe=()=>{v.current&&(clearTimeout(v.current),v.current=null)},Ne=()=>{v.current=setTimeout(()=>{R(null)},600)},ie=c=>{var V;if(!C)return;const h=te[C.idx],x={start:h.start,end:h.end,currentType:h.type};if(Y(x),R(null),c==="unmark"){const T=o.slice(0,h.start);let d=h.text;d.startsWith("{")?d=d.slice(1,-1):d.startsWith("[")&&(d.includes("](")?d=((V=d.match(/^\[(.*?)\]/))==null?void 0:V[1])||"":d=d.slice(1,-1));const F=o.slice(h.end);_(T+d+F),Y(null)}else if(c==="edit"){const T=h.text.match(/\((.*?)\)$/);if(T){const d=T[1].split("|");u({filename:d[0]||"",start:d[1]||"",duration:d[2]||""})}else u(null);O(!0)}};return e.jsxs("div",{className:"relative h-full flex flex-col group",children:[!i&&e.jsx("div",{className:`absolute top-4 right-6 z-10 flex items-center gap-2 transition-opacity duration-200 ${b?"opacity-100":"opacity-0 group-hover:opacity-100"}`,children:b?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:g,className:"px-4 py-2 text-xs font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors",children:"Save"}),e.jsx("button",{onClick:y,className:"px-4 py-2 text-xs font-bold text-neutral-700 bg-neutral-200 rounded-lg hover:bg-neutral-300 transition-colors",children:"Cancel"})]}):e.jsx("button",{onClick:me,className:"px-4 py-2 text-xs font-bold text-neutral-700 bg-neutral-100 rounded-lg hover:bg-neutral-200 transition-colors border border-neutral-200 shadow-sm",children:"Edit"})}),e.jsx(Cs,{isOpen:M,onClose:()=>{O(!1),u(null),Y(null)},onConfirm:E,audioFiles:w,initialData:q}),e.jsxs("div",{className:"sticky top-4 z-50 h-0 flex justify-center pointer-events-none overflow-visible gap-2",children:[(k==null?void 0:k.currentType)==="text"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:c=>{c.preventDefault(),xe("highlight")},className:"pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-neutral-900 text-white shadow-neutral-200 hover:scale-105 active:scale-95",children:[e.jsx(xs,{size:14}),e.jsx("span",{children:"Highlight"})]}),e.jsxs("button",{onClick:c=>{c.preventDefault(),xe("audio")},className:"pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-indigo-600 text-white shadow-indigo-200 hover:scale-105 active:scale-95",children:[e.jsx(Je,{size:14}),e.jsx("span",{children:"Mark Audio"})]})]}),(k==null?void 0:k.currentType)!=="text"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:c=>{c.preventDefault(),xe("clear")},className:`pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-white text-rose-600 shadow-rose-100 hover:bg-rose-50 ${k?"translate-y-0 opacity-100 scale-100":"-translate-y-4 opacity-0 scale-95 pointer-events-none"}`,children:[e.jsx(bt,{size:14}),e.jsx("span",{children:(k==null?void 0:k.currentType)==="highlight"?"Unhighlight":"Unmark Audio"})]}),(k==null?void 0:k.currentType)==="audio"&&e.jsxs("button",{onClick:c=>{c.preventDefault(),le()},className:`pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-white text-indigo-600 shadow-indigo-100 hover:bg-indigo-50 ${k?"translate-y-0 opacity-100 scale-100":"-translate-y-4 opacity-0 scale-95 pointer-events-none"}`,children:[e.jsx(dt,{size:14}),e.jsx("span",{children:"Edit Audio"})]})]})]}),C&&e.jsxs("div",{className:"fixed z-[60] flex items-center gap-1 p-1 bg-neutral-900 rounded-lg shadow-xl animate-in fade-in zoom-in-95",style:{top:C.rect.top-40,left:C.rect.left+C.rect.width/2-(C.type==="audio"?60:35)},onMouseEnter:pe,onMouseLeave:Ne,children:[C.type==="audio"&&e.jsx("button",{onClick:()=>ie("edit"),className:"p-2 text-white hover:bg-white/20 rounded-md transition-colors",title:"Edit",children:e.jsx(dt,{size:14})}),e.jsx("button",{onClick:()=>ie("unmark"),className:"p-2 text-rose-400 hover:bg-white/20 rounded-md transition-colors",title:"Unmark",children:e.jsx(bt,{size:14})}),e.jsx("div",{className:"absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-neutral-900"})]}),b?e.jsx("textarea",{value:A,onChange:c=>p(c.target.value),className:`flex-1 w-full font-mono bg-neutral-50 border-0 focus:ring-0 resize-none ${f?"p-4":"p-6"} ${l}`}):e.jsx("div",{ref:U,className:`font-medium text-neutral-800 leading-relaxed whitespace-pre-wrap select-text cursor-text font-mono ${f?"px-4 py-4":"px-6 pb-8 pt-8"} ${l}`,onMouseUp:oe,onKeyUp:oe,children:te.map((c,h)=>c.type==="highlight"?e.jsx("span",{"data-index":h,onMouseEnter:x=>ee(x,h,"highlight"),onMouseLeave:Q,className:"text-red-600 font-bold cursor-pointer hover:bg-red-50 transition-colors rounded mx-0.5 border border-transparent hover:border-red-100",children:c.displayContent},`${h}-${c.start}`):c.type==="audio"?e.jsx("span",{"data-index":h,onClick:x=>P(x,c),onMouseEnter:x=>ee(x,h,"audio"),onMouseLeave:Q,className:"text-indigo-900 cursor-pointer hover:bg-indigo-100 transition-colors mx-0.5 relative group/audio py-0.5 rounded",title:"Click to listen",children:e.jsx(Ss,{text:c.displayContent||"error"})},`${h}-${c.start}`):e.jsx("span",{"data-index":h,children:c.text},`${h}-${c.start}`))})]})},As=({isOpen:o,onClose:_,item:i})=>{const{showToast:s}=Ye(),[w,I]=t.useState("RECORDING"),[l,f]=t.useState(null);t.useEffect(()=>{o&&i?f(i):o||f(null)},[o,i==null?void 0:i.id]);const[b,S]=t.useState([]),[A,p]=t.useState(0),[g,y]=t.useState(0),[U,k]=t.useState(10),[Y,M]=t.useState(!1),[O,q]=t.useState(!1),[u,C]=t.useState(""),[R,v]=t.useState(null),[te,me]=t.useState(null),[oe,xe]=t.useState(!1),[le,E]=t.useState(()=>Rt("vocab_pro_mimic_autoreveal",!0)),[P,ee]=t.useState(null),[Q,pe]=t.useState(!1),[Ne,ie]=t.useState(!1),[c,h]=t.useState(!1),[x,V]=t.useState(0),[T,d]=t.useState(null),[F,G]=t.useState(null),[H,he]=t.useState(!1),[je,ce]=t.useState(!1),[L,ge]=t.useState(null),[fe,Le]=t.useState(null),[ye,ze]=t.useState(0),[ke,Te]=t.useState(0),Me=t.useRef(null),[ve,Ae]=t.useState([]),[Ce,Fe]=t.useState(null),n=t.useRef(new St),m=t.useRef(null),D=t.useRef(null);t.useEffect(()=>{It("vocab_pro_mimic_autoreveal",le)},[le]),t.useEffect(()=>{if(o&&l){let a=l.content;l.scriptItems&&l.scriptItems.length>0&&(a=l.scriptItems.filter(J=>J.type==="script").map(J=>J.content).join(`

`));const X=a.replace(/\[([\s\S]*?)\]\([\s\S]*?\)/g,"$1").replace(/\{([\s\S]*?)\}/g,"$1").replace(/\[([\s\S]*?)\]/g,"$1").split(/[.!?\n]+/g).filter(Boolean).map(J=>J.trim()).filter(Boolean).map((J,Z)=>{var we;return{id:`ft-${l.id}-${Z}`,text:J,sourceWord:l.title,type:"Free Talk",lastScore:(we=l.sentenceScores)==null?void 0:we[Z]}});S(X),p(0),y(0),Ae(l.userRecordings||[]),r()}else lt(),N(),n.current.stop(),D.current&&clearInterval(D.current),d(null),G(null)},[o,l==null?void 0:l.id]);const se=b[A]||null;t.useEffect(()=>{if(Y&&se&&u){const a=ct(se.text,u);me(a)}},[u,Y,se]),t.useEffect(()=>{if(w==="MIMIC"&&(r(),oe&&se)){const a=setTimeout(()=>Ie(se.text),500);return()=>clearTimeout(a)}},[se==null?void 0:se.id,w]),t.useEffect(()=>()=>{m.current&&(m.current.pause(),m.current.src="",m.current=null)},[]);const r=()=>{M(!1),q(le),C(""),v(null),me(null),ee(null),pe(!1)},N=()=>{m.current&&(m.current.pause(),m.current=null),ge(null),Le(null),ze(0),Te(0),Me.current=null,lt()},$=async a=>{if(!l)return;const j={};let z=0;a.forEach((Z,we)=>{const Ge=Z.lastScore||0;Z.lastScore!==void 0&&(j[we]=Z.lastScore),z+=Ge});const X=a.length>0?Math.round(z/a.length):0,J={...l,bestScore:X,sentenceScores:j,updatedAt:Date.now()};f(J),await Pe(J)},W=async()=>{if(se)if(Y){M(!1),n.current.stop();try{const a=await ot();a&&v(a.base64);const j=ct(se.text,u);me(j);const z=b.map((X,J)=>J===A?{...X,lastScore:j.score}:X);S(z),await $(z)}catch(a){console.error(a)}}else{r();try{await it(),M(!0),n.current.start((a,j)=>C(a+j),a=>C(a))}catch(a){console.error("Mic error",a),M(!1)}}},re=async()=>{if(se){if(P){pe(!Q);return}ie(!0);try{const a=De(),j=Be(a),z=await fetch(`${j}/api/convert/ipa?text=${encodeURIComponent(se.text)}`);if(z.ok){const X=await z.json();ee(X.ipa),pe(!0)}else s("IPA server unavailable","error")}catch{s("Failed to fetch IPA","error")}finally{ie(!1)}}},B=(a,j,z,X,J)=>{if((j&&L===j||z&&fe===z)&&(N(),!X&&!J))return;N();const Z=new Audio(a);m.current=Z,Z.addEventListener("loadedmetadata",()=>{Te(Z.duration),X&&(Z.currentTime=X)}),Z.addEventListener("timeupdate",()=>{ze(Z.currentTime),Me.current!==null&&Z.currentTime>=Me.current&&(Z.pause(),N())}),Z.addEventListener("ended",()=>{N()}),Z.addEventListener("error",()=>{s("Failed to play audio.","error"),N()}),j&&ge(j),z&&Le(z),X&&J&&(Me.current=X+J),Z.play().catch(we=>{console.error("Play error",we),N()})},K=a=>{const j=Number(a.target.value);ze(j),m.current&&(m.current.currentTime=j)},de=async()=>{if(c){D.current&&clearInterval(D.current),h(!1);try{const a=await ot();if(a){const j=atob(a.base64),z=new Array(j.length);for(let Z=0;Z<j.length;Z++)z[Z]=j.charCodeAt(Z);const X=new Uint8Array(z),J=new Blob([X],{type:a.mimeType});d(J),G(J)}}catch(a){console.error("Recording error",a),s("Failed to process recording.","error")}}else{N(),d(null),G(null);try{await it(),h(!0),V(0),D.current=setInterval(()=>{V(a=>a+1)},1e3)}catch{s("Could not access microphone.","error")}}},ne=()=>{d(null),G(null),V(0),ce(!1)},ae=async()=>{if(!(!F||!l)){he(!0);try{const a=De(),j=Be(a);let z="Recordings";try{const we=await fetch(`${j}/api/audio/mappings`);if(we.ok){const Ge=await we.json(),tt=Object.keys(Ge);tt.length>0&&(z=tt[0])}}catch{}const X=`rec_${Date.now()}.webm`,J=new FormData;J.append("mapName",z),J.append("filename",X),J.append("audio",F,X);const Z=await fetch(`${j}/api/audio/upload`,{method:"POST",body:J});if(Z.ok){const we=await Z.json(),Ge=x,ht=[{id:`rec-${Date.now()}`,url:`${j}/api/audio/stream/${z}/${X}`,mapName:z,filename:X,timestamp:Date.now(),duration:Ge},...ve];Ae(ht);const mt={...l,userRecordings:ht,updatedAt:Date.now()};f(mt),await Pe(mt),s("Recording saved!","success"),d(null),G(null),V(0)}else s("Upload failed.","error")}catch(a){console.error("Save error",a),s("Failed to save recording.","error")}finally{he(!1)}}},be=async()=>{if(!Ce||!l)return;const a=De(),j=Be(a);try{await fetch(`${j}/api/audio/file?mapName=${encodeURIComponent(Ce.mapName)}&filename=${encodeURIComponent(Ce.filename)}`,{method:"DELETE"})}catch{console.warn("Server delete failed, removing local reference anyway.")}const z=ve.filter(J=>J.id!==Ce.id);Ae(z);const X={...l,userRecordings:z,updatedAt:Date.now()};f(X),await Pe(X),s("Recording deleted.","success"),Fe(null)},Re=async(a,j)=>{if(!l)return;const z=l.scriptItems?[...l.scriptItems]:[];if(z[a]){z[a]={...z[a],content:j};const X={...l,scriptItems:z,updatedAt:Date.now()};f(X),await Pe(X)}},ue=(a,j,z,X)=>{if(a&&(l!=null&&l.audioLinks)){const J=l.audioLinks.find(Z=>Z.endsWith(a))||a;B(J,J,null,j,z)}else Ie(X)};if(!o||!l)return null;const Ve=Math.ceil(b.length/U),Ue=b.slice(g*U,(g+1)*U),Se=a=>{if(!a||isNaN(a))return"0:00";const j=Math.floor(a/60),z=Math.floor(a%60);return`${j}:${z.toString().padStart(2,"0")}`};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-6xl rounded-[3rem] shadow-2xl border border-neutral-200 flex flex-col h-[85vh] overflow-hidden relative",children:[e.jsxs("div",{className:"px-8 py-4 border-b border-neutral-100 flex items-center justify-between bg-white z-10",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl",children:[e.jsxs("button",{onClick:()=>{I("MIMIC"),N()},className:`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 ${w==="MIMIC"?"bg-white shadow-sm text-indigo-600":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(is,{size:14})," Mimic"]}),e.jsxs("button",{onClick:()=>{I("RECORDING"),N()},className:`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 ${w==="RECORDING"?"bg-white shadow-sm text-rose-600":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(ps,{size:14})," Essay"]}),e.jsxs("button",{onClick:()=>{I("PLAYBACK"),N()},className:`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 ${w==="PLAYBACK"?"bg-white shadow-sm text-emerald-600":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Oe,{size:14})," Playback"]})]}),e.jsx("h3",{className:"text-xs font-black text-neutral-900 truncate max-w-md hidden md:block",children:l.title})]}),e.jsxs("div",{className:"flex-1 overflow-hidden relative",children:[w==="MIMIC"&&e.jsx("div",{className:"h-full flex",children:e.jsx(ls,{targetText:(se==null?void 0:se.text)||null,sourceWord:l.title,type:"Free Talk",isEmpty:b.length===0,isRecording:Y,isRevealed:O,userTranscript:u,matchStatus:null,userAudioUrl:R,localAnalysis:te,aiAnalysis:null,isAnalyzing:!1,onAnalyze:()=>{},ipa:P,showIpa:Q,isIpaLoading:Ne,onToggleIpa:re,onToggleRecord:W,onPlayTarget:()=>se&&Ie(se.text),onPlayUser:()=>{R&&new Audio(`data:audio/webm;base64,${R}`).play()},onToggleReveal:()=>q(!O),onNext:()=>A<b.length-1&&p(a=>a+1),onClearTranscript:()=>C(""),onClose:_,pagedItems:Ue,page:g,pageSize:U,totalPages:Ve,onPageChange:y,onPageSizeChange:a=>{k(a),y(0)},onSelect:a=>p(g*U+a),currentAbsoluteIndex:A,autoSpeak:oe,onToggleAutoSpeak:()=>xe(!oe),autoReveal:le,onToggleAutoReveal:()=>E(!le),isGlobalMode:!0,onAddItem:()=>s("Editing not available in practice mode","info"),onEditItem:()=>{},onDeleteItem:()=>{},onRandomize:()=>{},isModalOpen:!1,editingItem:null,onCloseModal:()=>{},onSaveItem:()=>{}})}),w==="RECORDING"&&e.jsxs("div",{className:"h-full flex flex-col p-8 overflow-y-auto custom-scrollbar bg-neutral-50/50",children:[e.jsx("button",{onClick:_,className:"absolute top-4 right-4 p-2 text-neutral-400 hover:bg-neutral-100 rounded-full z-50",children:e.jsx(Ee,{size:20})}),e.jsxs("div",{className:"max-w-5xl mx-auto w-full space-y-6 pb-20",children:[e.jsx("div",{className:"bg-white rounded-2xl border border-neutral-200 shadow-sm overflow-hidden transition-all",children:T?je?e.jsxs("div",{className:"p-4 flex flex-col gap-4 animate-in fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-[10px] font-black uppercase text-neutral-400 tracking-widest",children:"Edit Recording"}),e.jsx("button",{onClick:()=>ce(!1),className:"text-xs font-bold text-neutral-500 hover:text-neutral-800",children:"Cancel"})]}),e.jsx("div",{className:"flex-1 min-h-[10rem]",children:e.jsx(_t,{audioBlob:T,onTrim:a=>{G(a),ce(!1),s("Trimmed!","success")},onCancel:()=>ce(!1)})})]}):e.jsxs("div",{className:"p-3 flex items-center gap-3 animate-in fade-in",children:[e.jsx("button",{onClick:()=>{if(L==="preview")N();else{const a=URL.createObjectURL(F||T);B(a,"preview",null)}},className:`p-2 rounded-full transition-all flex-shrink-0 ${L==="preview"?"bg-indigo-600 text-white":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:L==="preview"?e.jsx(Xe,{size:14,fill:"currentColor"}):e.jsx(Oe,{size:14,fill:"currentColor"})}),e.jsxs("div",{className:"flex-1 flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"text-[9px] font-mono font-bold text-neutral-400 w-8 text-right flex-shrink-0",children:Se(L==="preview"?ye:0)}),e.jsx("input",{type:"range",min:"0",max:L==="preview"?ke:x,value:L==="preview"?ye:0,onChange:K,className:"flex-1 h-1.5 bg-neutral-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 min-w-0",disabled:L!=="preview"}),e.jsx("span",{className:"text-[9px] font-mono font-bold text-neutral-400 w-8 text-left flex-shrink-0",children:Se(L==="preview"?ke:x)})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0 border-l border-neutral-100 pl-2 ml-1",children:[e.jsx("button",{onClick:()=>ce(!0),className:"p-2 text-neutral-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all",title:"Edit",children:e.jsx(Qe,{size:16})}),e.jsx("button",{onClick:ne,className:"p-2 text-neutral-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all",title:"Discard",children:e.jsx(hs,{size:16})}),e.jsx("button",{onClick:ae,disabled:H,className:"p-2 text-neutral-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all",title:"Save",children:H?e.jsx(rt,{size:16,className:"animate-spin"}):e.jsx(Vt,{size:16})})]})]}):e.jsxs("div",{className:"p-4 flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:de,className:`w-12 h-12 rounded-full flex items-center justify-center transition-all transform active:scale-95 shadow-lg ${c?"bg-rose-600 text-white animate-pulse ring-4 ring-rose-100":"bg-rose-600 text-white hover:bg-rose-700"}`,children:c?e.jsx(At,{size:16,fill:"currentColor"}):e.jsx(He,{size:20})}),e.jsx("div",{children:e.jsx("p",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:c?"Recording...":"Tap to Record"})})]}),c&&e.jsx("div",{className:"flex gap-1 h-4 items-end",children:[...Array(5)].map((a,j)=>e.jsx("div",{className:"w-1 bg-rose-400 rounded-full animate-bounce",style:{height:"100%",animationDelay:`${j*.1}s`}},j))})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-[10px] font-black uppercase text-neutral-400 tracking-widest flex items-center gap-2",children:[e.jsx(Gt,{size:14})," Script & Notes"]}),l.scriptItems&&l.scriptItems.length>0?e.jsx("div",{className:"space-y-4",children:l.scriptItems.map((a,j)=>e.jsxs("div",{className:`rounded-3xl border shadow-sm transition-all overflow-hidden ${a.type==="note"?"bg-yellow-50/50 border-yellow-100 text-yellow-900 italic relative":"bg-white border-neutral-200 text-neutral-800"}`,children:[a.type==="note"&&e.jsx("div",{className:"absolute top-0 left-0 w-1 h-full bg-yellow-300/50"}),a.type==="script"?e.jsx(Ts,{rawText:a.content,onUpdate:z=>Re(j,z),audioLinks:l.audioLinks||[],onPlaySegment:ue,showDash:!0,fontSize:"text-xs",compact:!0}):e.jsx("div",{className:"p-4 text-xs font-medium leading-relaxed whitespace-pre-wrap font-mono",children:a.content})]},a.id||j))}):e.jsx("div",{className:"bg-white p-4 rounded-3xl border border-neutral-200 shadow-sm",children:e.jsx("div",{className:"text-xs font-medium text-neutral-800 leading-relaxed whitespace-pre-wrap font-mono",children:l.content})})]})]})]}),w==="PLAYBACK"&&e.jsxs("div",{className:"h-full flex flex-col p-8 overflow-y-auto custom-scrollbar bg-neutral-50/50",children:[e.jsx("button",{onClick:_,className:"absolute top-4 right-4 p-2 text-neutral-400 hover:bg-neutral-100 rounded-full z-50",children:e.jsx(Ee,{size:20})}),e.jsxs("div",{className:"max-w-5xl mx-auto w-full space-y-8 pb-20",children:[l.audioLinks&&l.audioLinks.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-xs font-black uppercase text-neutral-500 tracking-widest flex items-center gap-2",children:[e.jsx(Nt,{size:16})," Reference Audio"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:l.audioLinks.map((a,j)=>{const z=L===a;return e.jsxs("div",{className:`rounded-2xl border transition-all overflow-hidden ${z?"bg-indigo-50 border-indigo-200 shadow-lg":"bg-white border-neutral-200 hover:border-neutral-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between p-3 gap-3",children:e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("button",{onClick:()=>B(a,a,null),className:`w-12 h-12 rounded-full transition-all flex-shrink-0 flex items-center justify-center ${z?"bg-indigo-600 text-white shadow-md":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:z?e.jsx(Xe,{size:20,fill:"currentColor"}):e.jsx(Oe,{size:20,fill:"currentColor"})}),e.jsx("span",{className:`text-sm font-bold truncate ${z?"text-indigo-800":"text-neutral-800"}`,children:decodeURIComponent(a.split("/").pop()||`Track ${j+1}`)})]})}),z&&e.jsxs("div",{className:"flex items-center gap-2 px-4 pb-3 pt-0 animate-in fade-in slide-in-from-top-1",children:[e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-right",children:Se(ye)}),e.jsx("input",{type:"range",min:"0",max:ke||100,value:ye,onChange:K,className:"flex-1 h-1.5 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600"}),e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-left",children:Se(ke)})]})]},j)})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-xs font-black uppercase text-neutral-500 tracking-widest flex items-center gap-2",children:[e.jsx(cs,{size:16})," Recordings History (",ve.length,")"]}),ve.length===0?e.jsx("div",{className:"text-center py-8 text-neutral-400 italic text-sm",children:"No recordings yet."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:ve.map(a=>{const j=fe===a.id;return e.jsxs("div",{className:"flex flex-col bg-white rounded-2xl border border-neutral-200 shadow-sm hover:border-neutral-300 transition-colors overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("button",{onClick:()=>B(a.url,null,a.id),className:`w-12 h-12 rounded-full transition-all flex-shrink-0 flex items-center justify-center ${j?"bg-indigo-600 text-white shadow-md":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:j?e.jsx(Xe,{size:20,fill:"currentColor"}):e.jsx(Oe,{size:20,fill:"currentColor"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:`text-sm font-bold truncate ${j?"text-indigo-800":"text-neutral-800"}`,children:new Date(a.timestamp).toLocaleString()}),e.jsx("p",{className:"text-xs font-medium text-neutral-500",children:Se(a.duration||0)})]})]}),e.jsx("button",{onClick:()=>Fe(a),className:"p-2.5 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all flex-shrink-0",children:e.jsx($e,{size:18})})]}),j&&e.jsxs("div",{className:"flex items-center gap-2 px-4 pb-3 pt-0 animate-in fade-in slide-in-from-top-1 bg-white",children:[e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-right",children:Se(ye)}),e.jsx("input",{type:"range",min:"0",max:ke||100,value:ye,onChange:K,className:"flex-1 h-1.5 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600"}),e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-left",children:Se(ke)})]})]},a.id)})})]})]})]})]})]}),e.jsx(et,{isOpen:!!Ce,title:"Delete Recording?",message:"This will permanently delete the audio file from the server.",confirmText:"Delete",isProcessing:!1,onConfirm:be,onClose:()=>Fe(null),confirmButtonClass:"bg-red-600 text-white hover:bg-red-700"})]})},wt="vocab_pro_speaking_card_view",nt=({score:o})=>o===void 0?null:e.jsxs("span",{className:`text-[10px] font-black px-1.5 py-0.5 rounded border ${o>=80?"bg-green-50 text-green-700 border-green-200":o>=50?"bg-yellow-50 text-yellow-700 border-yellow-200":"bg-red-50 text-red-700 border-red-200"}`,children:[o,"%"]}),Hs=({user:o,onNavigate:_})=>{const[i,s]=t.useState([]),[w,I]=t.useState(!0),[l,f]=t.useState(!1),[b,S]=t.useState(()=>Rt(wt,{showTags:!0,compact:!1,resourceType:"ALL"})),A=(n,m)=>S(D=>({...D,[n]:m})),[p,g]=t.useState(0),[y,U]=t.useState(12),[k,Y]=t.useState(""),[M,O]=t.useState(null),[q,u]=t.useState(!1),[C,R]=t.useState("all"),[v,te]=t.useState("all"),[me,oe]=t.useState(!1),[xe,le]=t.useState(!1),[E,P]=t.useState(!1),[ee,Q]=t.useState(null),[pe,Ne]=t.useState(null),[ie,c]=t.useState(null),[h,x]=t.useState(null),[V,T]=t.useState(!1),[d,F]=t.useState(null),[G,H]=t.useState(null),[he,je]=t.useState(null),{showToast:ce}=Ye(),L=async(n=!1)=>{n||I(!0);const[m,D,se]=await Promise.all([Dt(o.id),Ht(o.id),Kt(o.id)]),r=[...m.map(N=>({type:"card",data:N})),...D.map(N=>({type:"conversation",data:N})),...se.map(N=>({type:"free_talk",data:N}))];s(r.sort((N,$)=>$.data.createdAt-N.data.createdAt)),n||I(!1)};t.useEffect(()=>{L()},[o.id]),t.useEffect(()=>{g(0)},[M,y,C,v,b.resourceType,k]),t.useEffect(()=>{It(wt,b)},[b]);const ge=t.useMemo(()=>b.resourceType!=="ALL"||C!=="all"||v!=="all",[b.resourceType,C,v]),fe=t.useMemo(()=>{const n=k.toLowerCase().trim();return i.filter(m=>{var D,se;if(n){if(m.type==="card"){if(!m.data.standard.toLowerCase().includes(n))return!1}else if(m.type==="conversation"){if(!m.data.title.toLowerCase().includes(n)&&!(m.data.description||"").toLowerCase().includes(n))return!1}else if(!m.data.title.toLowerCase().includes(n)&&!m.data.content.toLowerCase().includes(n))return!1}if(b.resourceType!=="ALL"&&m.type.toUpperCase()!==b.resourceType||C==="focused"&&!m.data.isFocused||v!=="all"&&m.data.focusColor!==v)return!1;if(M){if(M==="Uncategorized"){if(m.data.path&&m.data.path!=="/")return!1}else if(!((D=m.data.path)!=null&&D.startsWith(M))&&!((se=m.data.tags)!=null&&se.includes(M)))return!1}return!0})},[i,M,C,v,b.resourceType,k]),Le=t.useMemo(()=>{const n=p*y;return fe.slice(n,n+y)},[fe,p,y]),ye=async n=>{const m=Date.now();ee&&ee.id?await We({...ee,...n,updatedAt:m}):await We({id:`ns-${m}-${Math.random()}`,userId:o.id,createdAt:m,updatedAt:m,...n}),oe(!1),L(),ce("Saved!","success")},ze=async n=>{const m=Date.now();pe&&pe.id?await qe({...pe,...n,updatedAt:m}):await qe({id:`conv-${m}-${Math.random()}`,userId:o.id,createdAt:m,updatedAt:m,title:n.title||"",description:n.description||"",speakers:n.speakers||[],sentences:n.sentences||[],tags:n.tags||[]}),le(!1),L(),ce("Saved!","success")},ke=async n=>{const m=Date.now();ie&&ie.id?await Pe({...ie,...n,updatedAt:m}):await Pe({id:`ft-${m}-${Math.random()}`,userId:o.id,createdAt:m,updatedAt:m,...n}),P(!1),L(),ce("Essay Saved!","success")},Te=n=>{n.type==="card"?(Q(n.data),oe(!0)):n.type==="conversation"?(Ne(n.data),le(!0)):n.type==="free_talk"&&(c(n.data),P(!0))},Me=async()=>{h&&(h.type==="card"?await Jt(h.id):h.type==="conversation"?await Yt(h.id):h.type==="free_talk"&&await Xt(h.id),x(null),L(),ce("Deleted!","success"))},ve=async(n,m)=>{const D={...n.data,focusColor:m||void 0,updatedAt:Date.now()};m||delete D.focusColor,n.type==="card"?await We(D):n.type==="conversation"?await qe(D):n.type==="free_talk"&&await Pe(D),L()},Ae=async n=>{const m={...n.data,isFocused:!n.data.isFocused,updatedAt:Date.now()};n.type==="card"?await We(m):n.type==="conversation"?await qe(m):n.type==="free_talk"&&await Pe(m),L()},Ce=n=>{Ne(m=>({...m||{},title:n.title,description:n.description,speakers:n.speakers,sentences:n.sentences,tags:n.tags})),T(!1),ce("Conversation generated!","success")},Fe=()=>{s(n=>[...n].sort(()=>Math.random()-.5)),ce("Deck shuffled!","success")};return e.jsxs(e.Fragment,{children:[e.jsx(Qt,{title:"Listen & Speak",subtitle:"Master listening comprehension and speaking skills.",icon:e.jsx("img",{src:"https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Microphone.png",className:"w-8 h-8 object-contain",alt:"Speaking"}),query:k,onQueryChange:Y,searchPlaceholder:"Search phrases, conversations...",config:{},isLoading:w,isEmpty:fe.length===0,emptyMessage:"No items found.",activeFilters:{},onFilterChange:()=>{},pagination:{page:p,totalPages:Math.ceil(fe.length/y),onPageChange:g,pageSize:y,onPageSizeChange:U,totalItems:fe.length},aboveGrid:e.jsx(e.Fragment,{children:q&&e.jsx(es,{items:i.map(n=>n.data),selectedTag:M,onSelectTag:O,forcedView:"tags",title:"Browse Tags",icon:e.jsx(pt,{size:16})})}),actions:e.jsx(Zt,{viewMenu:e.jsx(ts,{isOpen:l,setIsOpen:f,hasActiveFilters:ge,filterOptions:[{label:"All",value:"ALL",isActive:b.resourceType==="ALL",onClick:()=>A("resourceType","ALL")},{label:"Card",value:"CARD",isActive:b.resourceType==="CARD",onClick:()=>A("resourceType","CARD")},{label:"Conv.",value:"CONVERSATION",isActive:b.resourceType==="CONVERSATION",onClick:()=>A("resourceType","CONVERSATION")},{label:"Essay",value:"FREE_TALK",isActive:b.resourceType==="FREE_TALK",onClick:()=>A("resourceType","FREE_TALK")}],customSection:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-3 py-2 text-[9px] font-black text-neutral-400 uppercase tracking-widest border-b border-neutral-50 flex items-center gap-2",children:[e.jsx(Tt,{size:10})," Focus & Status"]}),e.jsxs("div",{className:"p-1 flex flex-col gap-1 bg-neutral-100 rounded-xl mb-2",children:[e.jsx("button",{onClick:()=>R(C==="all"?"focused":"all"),className:`w-full py-1.5 text-[9px] font-black rounded-lg transition-all ${C==="focused"?"bg-white shadow-sm text-red-600":"text-neutral-500 hover:text-neutral-700"}`,children:C==="focused"?"Focused Only":"All Items"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>te(v==="green"?"all":"green"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${v==="green"?"bg-emerald-500 border-emerald-600":"bg-white border-neutral-200 hover:bg-emerald-50"}`}),e.jsx("button",{onClick:()=>te(v==="yellow"?"all":"yellow"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${v==="yellow"?"bg-amber-400 border-amber-500":"bg-white border-neutral-200 hover:bg-amber-50"}`}),e.jsx("button",{onClick:()=>te(v==="red"?"all":"red"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${v==="red"?"bg-rose-500 border-rose-600":"bg-white border-neutral-200 hover:bg-rose-50"}`})]})]})]}),viewOptions:[{label:"Show Tags",checked:b.showTags,onChange:()=>S(n=>({...n,showTags:!n.showTags}))},{label:"Compact",checked:b.compact,onChange:()=>S(n=>({...n,compact:!n.compact}))}]}),browseTags:{isOpen:q,onToggle:()=>{u(!q)}},addActions:[{label:"New Native Expression",icon:Ke,onClick:()=>{Q(null),oe(!0)}},{label:"New Conversation",icon:at,onClick:()=>{Ne(null),le(!0)}},{label:"New Essay",icon:vt,onClick:()=>{c(null),P(!0)}}],extraActions:e.jsx(e.Fragment,{children:e.jsx("button",{onClick:Fe,disabled:i.length<2,className:"p-3 bg-white border border-neutral-200 text-neutral-600 rounded-xl hover:bg-neutral-50 active:scale-95 transition-all shadow-sm disabled:opacity-50",title:"Randomize",children:e.jsx(qt,{size:16})})})}),children:()=>e.jsx(e.Fragment,{children:Le.map(n=>{var m;if(n.type==="card")return e.jsx(st,{title:e.jsx("div",{className:"flex items-center gap-2 font-black text-neutral-900",children:n.data.standard}),badge:{label:"Native Expression",colorClass:"bg-teal-50 text-teal-700 border-teal-100",icon:Wt},tags:b.showTags?n.data.tags:void 0,compact:b.compact,onClick:()=>F(n.data),focusColor:n.data.focusColor,onFocusChange:D=>ve(n,D),isFocused:n.data.isFocused,onToggleFocus:Ae.bind(null,n),isCompleted:n.data.focusColor==="green",actions:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:D=>{D.stopPropagation(),Te(n)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",children:e.jsx(Qe,{size:14})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),x({id:n.data.id,type:"card"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",children:e.jsx($e,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[n.data.answers.length," variations"]}),e.jsx(nt,{score:n.data.bestScore})]})})},n.data.id);if(n.type==="conversation")return e.jsx(st,{title:n.data.title,badge:{label:"Conversation",colorClass:"bg-indigo-50 text-indigo-700 border-indigo-100",icon:at},tags:b.showTags?n.data.tags:void 0,compact:b.compact,onClick:()=>H(n.data),focusColor:n.data.focusColor,onFocusChange:D=>ve(n,D),isFocused:n.data.isFocused,onToggleFocus:Ae.bind(null,n),actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:D=>{D.stopPropagation(),Te(n)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",title:"Edit",children:e.jsx(Qe,{size:14})}),e.jsx("button",{onClick:D=>{D.stopPropagation(),x({id:n.data.id,type:"conversation"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",title:"Delete",children:e.jsx($e,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[n.data.sentences.length," lines"]}),e.jsx(nt,{score:n.data.bestScore})]})})},n.data.id);{const D=((m=n.data.content.match(/[^.!?]+[.!?]+["']?|[^.!?]+$/g))==null?void 0:m.length)||0,se=n.data.bestScore;return e.jsx(st,{title:n.data.title,badge:{label:"Essay",colorClass:"bg-cyan-50 text-cyan-700 border-cyan-100",icon:vt},tags:b.showTags?n.data.tags:void 0,compact:b.compact,onClick:()=>je(n.data),focusColor:n.data.focusColor,onFocusChange:r=>ve(n,r),isFocused:n.data.isFocused,onToggleFocus:Ae.bind(null,n),actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:r=>{r.stopPropagation(),Te(n)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",title:"Edit",children:e.jsx(Qe,{size:14})}),e.jsx("button",{onClick:r=>{r.stopPropagation(),x({id:n.data.id,type:"free_talk"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",title:"Delete",children:e.jsx($e,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[D," Sentences"]}),e.jsx(nt,{score:se})]})})},n.data.id)}})})}),e.jsx(bs,{isOpen:me,onClose:()=>oe(!1),onSave:ye,initialData:ee}),e.jsx(vs,{isOpen:xe,onClose:()=>le(!1),onSave:ze,initialData:pe,onOpenAiGen:()=>T(!0)}),e.jsx(js,{isOpen:E,onClose:()=>P(!1),onSave:ke,initialData:ie}),e.jsx(et,{isOpen:!!h,title:"Delete Item?",message:"This action cannot be undone.",confirmText:"Delete",isProcessing:!1,onConfirm:Me,onClose:()=>x(null),icon:e.jsx($e,{size:40,className:"text-red-500"})}),V&&e.jsx(xt,{isOpen:V,onClose:()=>T(!1),type:"GENERATE_UNIT",title:"AI Conversation Creator",description:"Enter a topic to generate a dialogue.",initialData:{},onGeneratePrompt:n=>gs(n.request),onJsonReceived:Ce,actionLabel:"Generate",closeOnSuccess:!0}),e.jsx(ws,{isOpen:!!d,onClose:()=>{F(null),L(!0)},item:d}),e.jsx(ks,{isOpen:!!G,onClose:()=>{H(null),L(!0)},item:G}),e.jsx(As,{isOpen:!!he,onClose:()=>{je(null),L(!0)},item:he})]})};export{Hs as SpeakingCardPage,Hs as default};
