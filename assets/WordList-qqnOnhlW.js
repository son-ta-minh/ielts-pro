import{r,a0 as ue,u as U,a4 as he,j as T,O as pe,Q as ge,a5 as we,a6 as fe,a7 as Se,a8 as me,a9 as ye,a2 as We,aa as Ce,ab as Ee,ac as be}from"./index-Bqy58GPU.js";import{W as ve}from"./WordTable-CDdBbkIS.js";import"./WordTable_UI-R6zmPl7i.js";import"./TagBrowser--XpOShEY.js";import"./tag-BDLg-zv4.js";import"./columns-2-DNRiPCR6.js";import"./calendar-BCQKNS-1.js";import"./square-check-big-Cj3jOEK2.js";import"./chevron-left-DYfdAwkU.js";const Ie="vocab_pro_library_filters_v2",_e=({user:E,onDelete:q,onBulkDelete:_,onUpdate:j,onStartSession:Q,initialFilter:K,onInitialFilterApplied:Pe,forceExpandAdd:Y,onExpandAddConsumed:J,onNavigate:F})=>{const[N,X]=r.useState([]),D=r.useMemo(()=>ue(Ie,{}),[]),[k,x]=r.useState(D.page||0),[A,Z]=r.useState(D.pageSize||25),[H,$]=r.useState(0),[ee,O]=r.useState(!0),[V,te]=r.useState(D.query||""),[l,se]=r.useState({types:new Set(["all"]),refined:"all",status:"all",register:"all",source:"all",composition:"all",book:"all",specificBookId:""}),[B,oe]=r.useState(null),[z,b]=r.useState(null),[G,v]=r.useState(null),[ae,re]=r.useState([]),{id:I}=E,L=r.useCallback(()=>{const t="Uncategorized",i=U().filter(e=>e.userId===E.id),u=new Map;i.forEach(e=>u.set(e.word.toLowerCase(),e));const h=new Map,y=new Set,S=[];i.forEach(e=>{e.groups&&e.groups.length>0?e.groups.forEach(s=>{y.add(s),h.has(s)||h.set(s,new Set),h.get(s).add(e)}):S.push(e)});const o=new Map,W=e=>{o.has(e)||o.set(e,{name:e,children:new Set,parents:new Set})};y.forEach(e=>{const s=e.split("/");for(let a=0;a<s.length;a++){const d=s.slice(0,a+1).join("/");if(W(d),a>0){const p=s.slice(0,a).join("/");o.get(p).children.add(d),o.get(d).parents.add(p)}}}),o.forEach((e,s)=>{const a=u.get(s.toLowerCase());a!=null&&a.groups&&a.groups.forEach(d=>{const p=d.split("/");for(let f=0;f<p.length;f++){const C=p.slice(0,f+1).join("/");if(W(C),f>0){const g=p.slice(0,f).join("/");o.get(g).children.add(C),o.get(C).parents.add(g)}}o.get(d).children.add(s),e.parents.add(d)})});const m=new Map,P=e=>{var C;if(m.has(e))return m.get(e);const s=new Set,a=[e],d=new Set;for(;a.length>0;){const g=a.shift();d.has(g)||(d.add(g),s.add(g),(((C=o.get(g))==null?void 0:C.children)||new Set).forEach(R=>a.push(R)))}const p=new Set;s.forEach(g=>{(h.get(g)||new Set).forEach(R=>p.add(R.id))});const f=p.size;return m.set(e,f),f},w=e=>{const s=o.get(e),a=Array.from(s.children).sort();return{name:e.split("/").pop(),path:e,children:a.map(w),unitCount:P(e)}};let n=Array.from(o.keys()).filter(e=>{var s;return(((s=o.get(e))==null?void 0:s.parents.size)||0)===0}).sort().map(e=>w(e));S.length>0&&n.unshift({name:t,path:t,children:[],unitCount:S.length}),re(n)},[E.id]),M=r.useCallback(()=>{O(!0);try{const t=Array.from(l.types),{words:i,totalCount:u}=he(I,k,A,V,t,l.refined,l.status,l.register,l.source,B,l.composition,l.book,l.specificBookId);$(u),X(i)}catch(t){console.error("Failed to load words from store:",t)}finally{O(!1)}},[I,k,A,V,l,B]);r.useEffect(()=>{M(),L();const t=()=>{M(),L()};return window.addEventListener("datastore-updated",t),()=>{window.removeEventListener("datastore-updated",t)}},[M,L]);const ne=t=>{oe(t),x(0)},ie=async(t,i)=>{const u=we(t),h=[],y=i.has("idiom"),S=i.has("phrasal"),o=i.has("collocation"),W=i.has("phrase"),m=i.has("archive");let P=new Map;try{(await fe(u)).forEach(c=>{P.set(c.word.toLowerCase().trim(),c)})}catch(w){console.warn("Server lookup failed in WordList:",w)}for(const w of u){const c=await Se(I);if(c){const n={...c};n.isIdiom=y||c.isIdiom,n.isPhrasalVerb=S||c.isPhrasalVerb,n.isCollocation=o||c.isCollocation,n.isStandardPhrase=W||c.isStandardPhrase,n.isPassive=m,n.updatedAt=Date.now(),h.push(n)}else{const n=w.toLowerCase().trim();let e;if(P.has(n)){const s=P.get(n);e={...s,id:crypto.randomUUID?crypto.randomUUID():"id-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),userId:I,createdAt:Date.now(),updatedAt:Date.now(),quality:me.REFINED,source:"refine",nextReview:Date.now(),interval:0,easeFactor:2.5,consecutiveCorrect:0,forgotCount:0,lastReview:void 0,lastGrade:void 0,lastTestResults:{},isIdiom:y||s.isIdiom,isPhrasalVerb:S||s.isPhrasalVerb,isCollocation:o||s.isCollocation,isStandardPhrase:W||s.isStandardPhrase,isPassive:m},e.complexity=ye(e),e.masteryScore=We(e),e.gameEligibility=Ce(e)}else e=Ee(w,"","","","",[],y,S,o,W,m),e.userId=I;h.push(e)}}h.length>0&&await be(h)},ce=t=>{const i=U().filter(u=>t.has(u.id));Q(i)},de=async t=>{await _(Array.from(t))},le=t=>{j(t),v(null)};return T.jsxs(T.Fragment,{children:[T.jsx(ve,{user:E,words:N,total:H,loading:ee,page:k,pageSize:A,onPageChange:x,onPageSizeChange:Z,onSearch:te,onFilterChange:t=>{se({types:t.types,refined:t.refined,status:t.status,register:t.register,source:t.source,composition:t.composition,book:t.book,specificBookId:t.specificBookId}),x(0)},onAddWords:ie,onViewWord:b,onEditWord:v,onDelete:async t=>{await q(t.id)},onBulkDelete:_?de:void 0,onPractice:ce,settingsKey:"vocab_pro_word_table_settings",context:"library",initialFilter:K,forceExpandAdd:Y,onExpandAddConsumed:J,showTagBrowserButton:!0,tagTree:ae,selectedTag:B,onSelectTag:ne,onOpenWordBook:()=>F&&F("WORDBOOK")}),z&&T.jsx(pe,{word:z,onClose:()=>b(null),onNavigateToWord:b,onEditRequest:t=>{b(null),v(t)},onUpdate:j,onGainXp:async()=>0}),G&&T.jsx(ge,{user:E,word:G,onSave:le,onClose:()=>v(null),onSwitchToView:t=>{v(null),b(t)}})]})};export{_e as default};
