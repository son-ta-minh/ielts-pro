import{r,G as ue,K as U,M as he,j as T,w as pe,x as fe,N as ge,O as we,Q as Se,U as me,Y as ye,I as We,_ as Ce,$ as Ee,a0 as Pe}from"./index-3pjVYRSv.js";import{W as Ie}from"./WordTable-DjF5rbRT.js";import"./WordTable_UI-BD9HcyXG.js";import"./TagBrowser-Bl4tIa4I.js";import"./square-check-big-BWEgzkFA.js";import"./chevron-left-DqsrHeqw.js";const be="vocab_pro_library_filters_v2",Me=({user:E,onDelete:z,onBulkDelete:q,onUpdate:R,onStartSession:K,initialFilter:Q,onInitialFilterApplied:ve,forceExpandAdd:Y,onExpandAddConsumed:J,onNavigate:D})=>{const[X,Z]=r.useState([]),x=r.useMemo(()=>ue(be,{}),[]),[A,_]=r.useState(x.page||0),[F,$]=r.useState(x.pageSize||25),[H,N]=r.useState(0),[ee,j]=r.useState(!0),[O,te]=r.useState(x.query||""),[l,se]=r.useState({types:new Set(["all"]),refined:"all",status:"all",register:"all",source:"all",composition:"all",book:"all",specificBookId:""}),[k,oe]=r.useState(null),[V,P]=r.useState(null),[G,I]=r.useState(null),[ae,re]=r.useState([]),{id:b}=E,M=r.useCallback(()=>{const s="Uncategorized",n=U().filter(e=>e.userId===E.id),d=new Map;n.forEach(e=>d.set(e.word.toLowerCase(),e));const u=new Map,m=new Set,g=[];n.forEach(e=>{e.groups&&e.groups.length>0?e.groups.forEach(t=>{m.add(t),u.has(t)||u.set(t,new Set),u.get(t).add(e)}):g.push(e)});const a=new Map,y=e=>{a.has(e)||a.set(e,{name:e,children:new Set,parents:new Set})};m.forEach(e=>{const t=e.split("/");for(let o=0;o<t.length;o++){const c=t.slice(0,o+1).join("/");if(y(c),o>0){const h=t.slice(0,o).join("/");a.get(h).children.add(c),a.get(c).parents.add(h)}}}),a.forEach((e,t)=>{const o=d.get(t.toLowerCase());o!=null&&o.groups&&o.groups.forEach(c=>{const h=c.split("/");for(let f=0;f<h.length;f++){const C=h.slice(0,f+1).join("/");if(y(C),f>0){const p=h.slice(0,f).join("/");a.get(p).children.add(C),a.get(C).parents.add(p)}}a.get(c).children.add(t),e.parents.add(c)})});const w=new Map,v=e=>{var C;if(w.has(e))return w.get(e);const t=new Set,o=[e],c=new Set;for(;o.length>0;){const p=o.shift();c.has(p)||(c.add(p),t.add(p),(((C=a.get(p))==null?void 0:C.children)||new Set).forEach(L=>o.push(L)))}const h=new Set;t.forEach(p=>{(u.get(p)||new Set).forEach(L=>h.add(L.id))});const f=h.size;return w.set(e,f),f},W=e=>{const t=a.get(e),o=Array.from(t.children).sort();return{name:e.split("/").pop(),path:e,children:o.map(W),unitCount:v(e)}};let i=Array.from(a.keys()).filter(e=>{var t;return(((t=a.get(e))==null?void 0:t.parents.size)||0)===0}).sort().map(e=>W(e));g.length>0&&i.unshift({name:s,path:s,children:[],unitCount:g.length}),re(i)},[E.id]),B=r.useCallback(()=>{j(!0);try{const s=Array.from(l.types),{words:n,totalCount:d}=he(b,A,F,O,s,l.refined,l.status,l.register,l.source,k,l.composition,l.book,l.specificBookId);N(d),Z(n)}catch(s){console.error("Failed to load words from store:",s)}finally{j(!1)}},[b,A,F,O,l,k]);r.useEffect(()=>{B(),M();const s=()=>{B(),M()};return window.addEventListener("datastore-updated",s),()=>{window.removeEventListener("datastore-updated",s)}},[B,M]);const ne=s=>{oe(s),_(0)},ie=async(s,n)=>{const d=ge(s),u=[],m=n.has("idiom"),g=n.has("phrasal"),a=n.has("collocation"),y=n.has("phrase"),w=n.has("pronun"),v=n.has("archive");let W=new Map;try{(await we(d)).forEach(i=>{W.set(i.word.toLowerCase().trim(),i)})}catch(S){console.warn("Server lookup failed in WordList:",S)}for(const S of d){const i=await Se(b,S);if(i){const e={...i};e.isIdiom=m||i.isIdiom,e.isPhrasalVerb=g||i.isPhrasalVerb,e.isCollocation=a||i.isCollocation,e.isStandardPhrase=y||i.isStandardPhrase,e.needsPronunciationFocus=w||i.needsPronunciationFocus,e.isPassive=v,e.updatedAt=Date.now(),u.push(e)}else{const e=S.toLowerCase().trim();let t;if(W.has(e)){const o=W.get(e);t={...o,id:crypto.randomUUID?crypto.randomUUID():"id-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),userId:b,createdAt:Date.now(),updatedAt:Date.now(),quality:me.REFINED,source:"refine",nextReview:Date.now(),interval:0,easeFactor:2.5,consecutiveCorrect:0,forgotCount:0,lastReview:void 0,lastGrade:void 0,lastTestResults:{},isIdiom:m||o.isIdiom,isPhrasalVerb:g||o.isPhrasalVerb,isCollocation:a||o.isCollocation,isStandardPhrase:y||o.isStandardPhrase,needsPronunciationFocus:w||o.needsPronunciationFocus,isPassive:v},t.complexity=ye(t),t.masteryScore=We(t),t.gameEligibility=Ce(t)}else t=Ee(S,"","","","",[],m,w,g,a,y,v),t.userId=b;u.push(t)}}u.length>0&&await Pe(u)},ce=s=>{const n=U().filter(d=>s.has(d.id));K(n)},le=async s=>{await q(Array.from(s))},de=s=>{R(s),I(null)};return T.jsxs(T.Fragment,{children:[T.jsx(Ie,{user:E,words:X,total:H,loading:ee,page:A,pageSize:F,onPageChange:_,onPageSizeChange:$,onSearch:te,onFilterChange:se,onAddWords:ie,onViewWord:P,onEditWord:I,onDelete:async s=>{await z(s.id)},onBulkDelete:le,onPractice:ce,settingsKey:"ielts_pro_library_view_settings",context:"library",initialFilter:Q,forceExpandAdd:Y,onExpandAddConsumed:J,showTagBrowserButton:!0,tagTree:ae,selectedTag:k,onSelectTag:ne,onOpenWordBook:()=>D==null?void 0:D("WORDBOOK")}),V&&T.jsx(pe,{word:V,onClose:()=>P(null),onNavigateToWord:P,onUpdate:R,onGainXp:async()=>0,isViewOnly:!1,onEditRequest:s=>{P(null),I(s)}}),G&&T.jsx(fe,{user:E,word:G,onSave:de,onClose:()=>I(null),onSwitchToView:s=>{I(null),P(s)}})]})};export{Me as default};
