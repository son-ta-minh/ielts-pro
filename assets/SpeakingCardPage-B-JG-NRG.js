import{c as Oe,r as s,a0 as Be,j as e,S as qe,X as Se,ag as Ve,az as Ee,at as st,aw as nt,aK as Pe,l as Le,aO as yt,aJ as Nt,I as Me,b as kt,b5 as Ye,au as lt,aA as We,bM as Ct,J as St,V as He,M as _e,bN as xt,bO as Ue,aM as pt,bx as ht,aj as Ge,T as mt,i as ot,bP as Tt,b7 as gt,H as Qe,bA as Xe,bQ as $e,aV as Ze,aW as et,by as ft,a1 as bt,ai as vt,y as At,h as Rt,bR as ze,A as It,P as Je,bb as Et,p as zt,q as Mt,s as Ft,bS as Pt,bT as Ot,bU as Ut}from"./index-a2ud5-rM.js";import{R as $t,a as Lt}from"./ResourceActions-DlRm0IPI.js";import{T as _t}from"./TagBrowser-SCJeFWzZ.js";import{V as Vt}from"./ViewMenu-CMvscc5-.js";import{U as De}from"./UniversalCard-hD9bLSG4.js";import{T as at}from"./tag-C07mVcyZ.js";import{F as Bt}from"./FileSelector-DXNgju6H.js";import{F as jt}from"./file-audio-BKL5EdAL.js";import{H as it}from"./headphones-lMf8ciPC.js";import{P as tt}from"./pause-DTrpErzD.js";import{L as Gt}from"./layout-grid-k1aKBHjF.js";import{C as ct}from"./chevron-left-C2kYWApf.js";import{E as qt}from"./ear-muNSiaKg.js";import{D as Wt}from"./download-EJHzAP9W.js";import{M as Jt}from"./MimicPractice_UI-BRtaig6U.js";import{A as Dt}from"./AudioTrimmer-BJvDOmU1.js";import{C as Kt}from"./calendar-eIEvEQ4w.js";import"./filter-BT4u-FTt.js";import"./folder-TjjL-OJf.js";import"./server-DXi1O_i7.js";import"./list-todo-CZCdUqFB.js";import"./pen-BFnuzyAc.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=Oe("ChevronsLeft",[["path",{d:"m11 17-5-5 5-5",key:"13zhaf"}],["path",{d:"m18 17-5-5 5-5",key:"h8a8et"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=Oe("CircleUser",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}],["path",{d:"M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662",key:"154egf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=Oe("LayoutList",[["rect",{width:"7",height:"7",x:"3",y:"3",rx:"1",key:"1g98yp"}],["rect",{width:"7",height:"7",x:"3",y:"14",rx:"1",key:"1bb6yr"}],["path",{d:"M14 4h7",key:"3xa0d5"}],["path",{d:"M14 9h7",key:"1icrd9"}],["path",{d:"M14 15h7",key:"1mj8o2"}],["path",{d:"M14 20h7",key:"11slyb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const dt=Oe("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xt=Oe("MicVocal",[["path",{d:"m11 7.601-5.994 8.19a1 1 0 0 0 .1 1.298l.817.818a1 1 0 0 0 1.314.087L15.09 12",key:"80a601"}],["path",{d:"M16.5 21.174C15.5 20.5 14.372 20 13 20c-2.058 0-3.928 2.356-6 2-2.072-.356-2.775-3.369-1.5-4.5",key:"j0ngtp"}],["circle",{cx:"16",cy:"7",r:"5",key:"d08jfb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=Oe("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);function es(x,L,l=[]){const n=l.map(S=>{const m=S.sentence.match(/\{(.*?)\}/);return m?`"${m[1]}"`:`"${S.anchor}"`}).join(", ");return`You are an expert English linguist and communication coach.
    
    TASK: Analyze a user's input/context to generate high-quality native expressions.
    
    ${n?`EXISTING EXPRESSIONS (DO NOT DUPLICATE THESE): [${n}]`:""}

    CONTEXT / CORE CONCEPT:
    "${x}"

    USER REQUEST: "${L||"Generate a variety of expressions."}"

    INSTRUCTIONS:
    1.  **Analyze**: Understand the core concept (e.g., "Disagreeing", "Showing excitement").
    2.  **Generate NEW Expressions**: Create 3-5 NEW, distinct, and natural expressions for this concept.
        -   **IMPORTANT**: If "EXISTING EXPRESSIONS" are provided, you MUST NOT repeat them. You must find *alternatives* or *variations*.
    3.  **Tones**: Try to provide a mix of 'casual', 'semi-academic', and 'academic' tones if possible.
    4.  **Format**:
        -   **Anchor (Situation/Context)**: A short, natural phrase describing the *specific situation* or *intent* where this expression is used (e.g., 'Disagreeing with a boss', 'Refusing an invitation').
            -   **DO NOT** put the expression itself here. This is the cue for the user to guess the expression.
            -   Use **English** for simple situations.
            -   Use **Vietnamese** if the situation is nuanced, abstract, or hard to describe simply in English.
        -   **Sentence**: Write a full example sentence containing the expression. Use curly braces \`{}\` to highlight the target expression.
        -   **Note**: Brief usage tip.
    5.  **Standard (Context) Field**: 
        -   Keep it **EXTREMELY CONCISE (MAX 8 WORDS)**.
        -   Make it descriptive and visual. Avoid long, explanatory sentences. 
        -   Example: Use "Sick and symptoms" instead of "Different ways to describe being sick or having a headache".
        -   If the core concept is simple, use **English**. If abstract/complex, use **Vietnamese**.

    STRICT JSON OUTPUT FORMAT:
    {
      "standard": "string (Concise Context/Title - Max 8 words)",
      "answers": [
        {
          "tone": "casual" | "semi-academic" | "academic",
          "anchor": "string (The situation cue - EN or VI)",
          "sentence": "string (e.g., 'Honestly, I'm {not buying it}.')",
          "note": "string"
        }
      ]
    }
    `}function ts(x){return`You are an expert IELTS coach and scenario designer.
    
    TASK: Generate a natural, realistic English conversation based on the topic: "${x}".
    
    CONSTRAINTS:
    1.  The conversation must involve 2 to 3 distinct speakers.
    2.  Assign each speaker a name and a sex (male or female).
    3.  The conversation should have 10 to 15 sentences in total.
    4.  The language should be appropriate for an IELTS candidate (ranging from casual to semi-formal depending on the topic).
    5.  Use high-value vocabulary and natural lexical chunks.
    6.  Assign an "icon" (emoji string) to EVERY single sentence representing the speaker's specific emotion or tone at that moment. Use emojis exclusively from the "Smiley and Emotion" fluent group.
    
    STRICT JSON OUTPUT FORMAT:
    Return a single JSON object. Do not include any text outside the JSON block.
    
    {
      "title": "string (A catchy title for the conversation)",
      "description": "string (Short context for the conversation)",
      "speakers": [
        { "name": "string (e.g., 'Alice')", "sex": "male" | "female" }
      ],
      "sentences": [
        { "speakerName": "string", "text": "string (verbatim what they say)", "icon": "string (emotional emoji)" }
      ],
      "tags": ["string (3-5 relevant IELTS tags)"]
    }
    `}function ss(x,L){return`You are an expert IELTS Speaking coach.
    
    TASK: Refine and upgrade the following speech draft to achieve a higher Band Score (8.0+).

    CURRENT DRAFT:
    "${x}"

    USER REQUEST: "${L||"Improve vocabulary, grammar, and flow."}"

    INSTRUCTIONS:
    1.  **Upgrade Vocabulary**: Replace simple words with more precise, less common lexical resources (idioms, collocations).
    2.  **Fix Grammar**: Ensure complex structures are used correctly.
    3.  **Improve Flow**: Use natural discourse markers and linking words.
    4.  **Maintain Voice**: Keep it sounding like a natural spoken response, not a written essay.

    STRICT JSON OUTPUT FORMAT:
    Return a single JSON object.
    {
      "content": "string (The fully rewritten, improved paragraph)"
    }
    `}const ns=({isOpen:x,onClose:L,onSave:l,initialData:n})=>{const[A,S]=s.useState(""),[m,g]=s.useState(""),[b,v]=s.useState(""),[N,o]=s.useState([]),[i,E]=s.useState(!1),{showToast:P}=Be();s.useEffect(()=>{var k;x&&(S((n==null?void 0:n.standard)||""),v((n==null?void 0:n.note)||""),g(((k=n==null?void 0:n.tags)==null?void 0:k.join(", "))||""),o((n==null?void 0:n.answers)||[]))},[x,n]);const $=k=>{k.preventDefault(),A.trim()&&l({standard:A.trim(),tags:m.split(",").map(M=>M.trim()).filter(Boolean),note:b.trim(),answers:N})},Z=k=>{const M=k.result||k;M.answers&&Array.isArray(M.answers)?(o(z=>[...z,...M.answers]),M.standard&&!A&&S(M.standard),P(`Added ${M.answers.length} new expressions!`,"success"),E(!1)):P("AI response format invalid.","error")};return x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300",children:e.jsxs("form",{onSubmit:$,className:"bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:n?"Edit Expression":"New Expression"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Define context and generate expressions."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>E(!0),className:"p-2 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-100 transition-colors",title:"Refine/Expand with AI",children:e.jsx(qe,{size:18})}),e.jsx("button",{type:"button",onClick:L,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full",children:e.jsx(Se,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Context / Meaning"}),e.jsx("textarea",{value:A,onChange:k=>S(k.target.value),placeholder:"e.g., Disagreeing politely",rows:2,className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium focus:ring-2 focus:ring-neutral-900 outline-none resize-none",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(at,{size:12})," Tags"]}),e.jsx("input",{value:m,onChange:k=>g(k.target.value),placeholder:"linking, academic...",className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium text-sm"})]}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Answers"}),e.jsx("button",{type:"button",onClick:()=>o([...N,{tone:"semi-academic",anchor:"",sentence:""}]),className:"p-1.5 bg-neutral-100 rounded-lg text-neutral-600 hover:bg-neutral-200 transition-colors",children:e.jsx(Ve,{size:14})})]}),N.map((k,M)=>e.jsxs("div",{className:"p-3 bg-neutral-50 rounded-xl border border-neutral-200 space-y-2 relative group",children:[e.jsx("button",{type:"button",onClick:()=>o(N.filter((z,c)=>c!==M)),className:"absolute top-2 right-2 text-neutral-300 hover:text-red-500 opacity-0 group-hover:opacity-100",children:e.jsx(Ee,{size:12})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:k.tone,onChange:z=>{const c=[...N];c[M].tone=z.target.value,o(c)},className:"px-2 py-1 bg-white border border-neutral-200 rounded-lg text-[10px] font-bold outline-none",children:[e.jsx("option",{value:"casual",children:"Casual"}),e.jsx("option",{value:"semi-academic",children:"Semi-Academic"}),e.jsx("option",{value:"academic",children:"Academic"})]}),e.jsx("input",{value:k.anchor,onChange:z=>{const c=[...N];c[M].anchor=z.target.value,o(c)},placeholder:"Situation / Context (e.g. Refusing politey)",className:"flex-1 px-2 py-1 bg-white border border-neutral-200 rounded-lg text-xs font-bold outline-none"})]}),e.jsx("textarea",{value:k.sentence,onChange:z=>{const c=[...N];c[M].sentence=z.target.value,o(c)},placeholder:"Example sentence with {curly braces}",className:"w-full p-2 bg-white border border-neutral-200 rounded-lg text-xs font-medium resize-none outline-none",rows:2}),e.jsx("input",{value:k.note||"",onChange:z=>{const c=[...N];c[M].note=z.target.value,o(c)},placeholder:"Note (optional)",className:"w-full px-2 py-1 bg-white border border-neutral-200 rounded-lg text-[10px] font-medium text-neutral-500 outline-none"})]},M))]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-6 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest",children:[e.jsx(st,{size:14})," Save"]})})]})}),i&&e.jsx(nt,{isOpen:i,onClose:()=>E(!1),type:"REFINE_UNIT",title:"Expand Expressions",description:"Generate additional variations (duplicates are excluded).",initialData:{},onGeneratePrompt:k=>es(A,k.request,N),onJsonReceived:Z,actionLabel:"Generate"})]}):null},as=({isOpen:x,onClose:L,onSave:l,initialData:n,onOpenAiGen:A})=>{const[S,m]=s.useState(""),[g,b]=s.useState(""),[v,N]=s.useState([]),[o,i]=s.useState([]),[E,P]=s.useState(""),[$,Z]=s.useState(null);s.useEffect(()=>{var c;if(x){m((n==null?void 0:n.title)||""),b((n==null?void 0:n.description)||""),N((n==null?void 0:n.speakers)||[]),i((n==null?void 0:n.sentences)||[]),P(((c=n==null?void 0:n.tags)==null?void 0:c.join(", "))||"");const C=Pe(Le());yt(C).then(Z).catch(()=>Z(null))}},[x,n]);const k=c=>{c.preventDefault(),S.trim()&&l({title:S.trim(),description:g,speakers:v,sentences:o,tags:E.split(",").map(C=>C.trim()).filter(Boolean)})},M=(c,C)=>{N(T=>T.map((h,Y)=>Y===c?{...h,...C}:h))},z=s.useMemo(()=>$?$.voices.filter(c=>c.language.startsWith("en")&&(c.name.toLowerCase().includes("enhanced")||c.name.toLowerCase().includes("premium"))):[],[$]);return x?e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("form",{onSubmit:k,className:"bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:n?"Edit Conversation":"New Conversation"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Create interactive multi-speaker dialogues."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:A,className:"p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors",title:"Generate with AI",children:e.jsx(qe,{size:18})}),e.jsx("button",{type:"button",onClick:L,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(Se,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black uppercase text-neutral-400",children:"Title"}),e.jsx("input",{value:S,onChange:c=>m(c.target.value),className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold focus:ring-2 focus:ring-neutral-900 outline-none",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black uppercase text-neutral-400",children:"Tags"}),e.jsx("input",{value:E,onChange:c=>P(c.target.value),className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium text-sm focus:ring-1 focus:ring-neutral-300 outline-none"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-bold text-neutral-500 uppercase flex items-center gap-2",children:[e.jsx(Nt,{size:14})," Speakers (",v.length,"/3)"]}),e.jsx("button",{type:"button",onClick:()=>N([...v,{name:"",sex:"female"}]),disabled:v.length>=3,className:"p-1.5 bg-neutral-100 rounded-lg text-neutral-600 hover:bg-neutral-200 transition-colors disabled:opacity-50",children:e.jsx(Ve,{size:14})})]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:v.map((c,C)=>e.jsxs("div",{className:"p-4 bg-neutral-50 rounded-2xl border border-neutral-200 relative group animate-in zoom-in-95 grid grid-cols-1 sm:grid-cols-[1fr,auto,2fr] gap-4 items-center",children:[e.jsx("button",{type:"button",onClick:()=>N(v.filter((T,h)=>h!==C)),className:"absolute -top-1.5 -right-1.5 p-1 bg-white text-neutral-300 hover:text-red-500 border border-neutral-200 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity z-10",children:e.jsx(Se,{size:10})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"Speaker Name"}),e.jsx("input",{value:c.name,onChange:T=>M(C,{name:T.target.value}),placeholder:"Name",className:"w-full bg-white border border-neutral-200 rounded-lg px-3 py-1.5 font-bold text-xs outline-none focus:border-neutral-900"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"Sex"}),e.jsxs("div",{className:"flex bg-white rounded-lg p-0.5 border border-neutral-200 h-[32px]",children:[e.jsx("button",{type:"button",onClick:()=>M(C,{sex:"male"}),className:`flex-1 px-3 py-1 text-[8px] font-black uppercase rounded ${c.sex==="male"?"bg-blue-50 text-white shadow-sm":"text-neutral-400"}`,children:"Male"}),e.jsx("button",{type:"button",onClick:()=>M(C,{sex:"female"}),className:`flex-1 px-3 py-1 text-[8px] font-black uppercase rounded ${c.sex==="female"?"bg-pink-50 text-white shadow-sm":"text-neutral-400"}`,children:"Female"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"High Quality Voice"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:c.voiceName||"",onChange:T=>{const h=z.find(Y=>Y.name===T.target.value);M(C,{voiceName:T.target.value,accentCode:h==null?void 0:h.accent}),T.target.value&&Me(`Hello, this is ${T.target.value}`,!1,"en",T.target.value,h==null?void 0:h.accent)},className:"w-full bg-white border border-neutral-200 rounded-xl px-4 py-3 pr-10 text-[10px] font-bold outline-none focus:border-neutral-900 appearance-none",children:[e.jsx("option",{value:"",children:"Auto Select"}),z.map(T=>e.jsxs("option",{value:T.name,children:[T.name," (",T.accent,")"]},T.name))]}),e.jsx(kt,{size:12,className:"absolute right-2 top-1/2 -translate-y-1/2 text-neutral-400 pointer-events-none"})]})]})]},C))})]}),e.jsxs("div",{className:"space-y-3 pt-4 border-t border-neutral-100",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-bold text-neutral-500 uppercase flex items-center gap-2",children:[e.jsx(Ye,{size:14})," Script (",o.length,")"]}),e.jsxs("button",{type:"button",onClick:()=>{var c;return i([...o,{speakerName:((c=v[0])==null?void 0:c.name)||"",text:""}])},disabled:v.length===0,className:"px-3 py-1.5 bg-neutral-900 text-white rounded-lg font-bold text-xs flex items-center gap-1.5 hover:bg-neutral-800 disabled:opacity-50 transition-colors",children:[e.jsx(Ve,{size:14})," Add Line"]})]}),e.jsx("div",{className:"space-y-2",children:o.map((c,C)=>e.jsxs("div",{className:"flex gap-2 items-start animate-in slide-in-from-top-2",children:[e.jsx("select",{value:c.speakerName,onChange:T=>{const h=[...o];h[C].speakerName=T.target.value,i(h)},className:"w-24 shrink-0 px-2 py-2 bg-neutral-50 border border-neutral-200 rounded-lg text-[10px] font-black uppercase tracking-wider outline-none focus:ring-1 focus:ring-neutral-900",children:v.map(T=>e.jsx("option",{value:T.name,children:T.name||"?"},T.name))}),e.jsxs("div",{className:"flex-1 flex flex-col gap-1",children:[e.jsx("textarea",{value:c.text,onChange:T=>{const h=[...o];h[C].text=T.target.value,i(h)},rows:2,placeholder:"Speech...",className:"w-full px-3 py-2 bg-neutral-50 border border-neutral-200 rounded-xl text-xs font-medium focus:ring-1 focus:ring-neutral-900 outline-none resize-none"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("label",{className:"text-[8px] font-black text-neutral-400 uppercase",children:"Emoji"}),e.jsx("input",{value:c.icon||"",onChange:T=>{const h=[...o];h[C].icon=T.target.value,i(h)},className:"bg-neutral-50 border border-neutral-100 rounded px-2 py-1 text-xs w-12",placeholder:"ðŸ˜Š"})]})]}),e.jsx("button",{type:"button",onClick:i.bind(null,o.filter((T,h)=>h!==C)),className:"p-2 text-neutral-300 hover:text-red-500",children:e.jsx(Ee,{size:14})})]},C))})]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-8 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest",children:[e.jsx(st,{size:14})," Save Conversation"]})})]})}):null},rs=({isOpen:x,onClose:L,onSave:l,initialData:n})=>{const[A,S]=s.useState(""),[m,g]=s.useState(""),[b,v]=s.useState(""),[N,o]=s.useState([]),[i,E]=s.useState(!1),[P,$]=s.useState(!1),[Z,k]=s.useState(null),[M,z]=s.useState(!1),{showToast:c}=Be();s.useEffect(()=>{var y;x&&(S((n==null?void 0:n.title)||""),g((n==null?void 0:n.content)||""),v(((y=n==null?void 0:n.tags)==null?void 0:y.join(", "))||""),o((n==null?void 0:n.audioLinks)||[]))},[x,n]);const C=y=>{y.preventDefault(),!(!A.trim()||!m.trim())&&l({title:A.trim(),content:m.trim(),tags:b.split(",").map(G=>G.trim()).filter(Boolean),audioLinks:N})},T=y=>{const G=y.result||y,q=G.content||G.rewritten||G.text;q&&typeof q=="string"?(g(q),E(!1),c("Content refined!","success")):(console.error("Invalid AI response for Free Talk:",y),c("Could not parse AI response.","error"))},h=y=>{const{url:G,transcript:q}=y;o(de=>[...de,G]),q&&(m.trim()?(k(q),z(!0)):g(q))},Y=()=>{Z&&g(Z),k(null),z(!1)},be=y=>{o(G=>G.filter((q,de)=>de!==y))};return x?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300",children:e.jsxs("form",{onSubmit:C,className:"bg-white w-full max-w-3xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col h-[85vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:n?"Edit Free Talk":"New Free Talk"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Practice speaking natural paragraphs."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>E(!0),className:"p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors",title:"Refine with AI",children:e.jsx(qe,{size:18})}),e.jsx("button",{type:"button",onClick:L,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full",children:e.jsx(Se,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar flex-1",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Title / Topic"}),e.jsx("input",{value:A,onChange:y=>S(y.target.value),placeholder:"e.g., My Hometown",className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium focus:ring-2 focus:ring-neutral-900 outline-none",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Reference Audio"}),e.jsxs("button",{type:"button",onClick:()=>$(!0),className:"flex items-center gap-1 text-[10px] font-bold text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded-lg transition-colors",children:[e.jsx(Ve,{size:12})," From Server"]})]}),e.jsxs("div",{className:"space-y-2",children:[N.length===0&&e.jsx("p",{className:"text-[10px] text-neutral-400 italic px-2",children:"No reference audio attached."}),N.map((y,G)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-neutral-50 rounded-lg border border-neutral-200",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(jt,{size:14,className:"text-emerald-500 shrink-0"}),e.jsx("span",{className:"text-xs font-mono text-neutral-600 truncate",children:decodeURIComponent(y.split("/").pop()||"file")})]}),e.jsx("button",{type:"button",onClick:()=>be(G),className:"p-1 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-full",children:e.jsx(Se,{size:14})})]},G))]})]}),e.jsxs("div",{className:"space-y-1 flex flex-col flex-1 h-full min-h-[300px]",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(lt,{size:12})," Speech Content"]}),e.jsx("textarea",{value:m,onChange:y=>g(y.target.value),placeholder:"Enter the full paragraph you want to practice...",className:"w-full flex-1 p-4 bg-neutral-50 border border-neutral-200 rounded-xl font-medium focus:ring-2 focus:ring-neutral-900 outline-none resize-none leading-relaxed",required:!0}),e.jsx("p",{className:"text-[10px] text-neutral-400 italic text-right mt-1",children:"The app will split this into sentences for practice."})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(at,{size:12})," Tags"]}),e.jsx("input",{value:b,onChange:y=>v(y.target.value),placeholder:"part1, personal...",className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium text-sm"})]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-6 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest",children:[e.jsx(st,{size:14})," Save"]})})]})}),i&&e.jsx(nt,{isOpen:i,onClose:()=>E(!1),type:"REFINE_UNIT",title:"Refine Free Talk",description:"Improve vocabulary and grammar for a higher band score.",initialData:{request:""},onGeneratePrompt:y=>ss(m,y.request),onJsonReceived:T,actionLabel:"Refine",closeOnSuccess:!0}),e.jsx(Bt,{isOpen:P,onClose:()=>$(!1),onSelect:h,type:"audio",title:"Select Audio"}),e.jsx(We,{isOpen:M,title:"Replace Content?",message:"This audio file comes with a linked transcript. Do you want to replace your current speech content with it?",confirmText:"Replace",isProcessing:!1,onConfirm:Y,onClose:()=>z(!1),icon:e.jsx(lt,{size:40,className:"text-indigo-500"}),confirmButtonClass:"bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200"})]}):null},ls=({text:x})=>{const L=x.split(/({.*?}|\[.*?\]|<.*?>)/g);return e.jsx(e.Fragment,{children:L.map((l,n)=>l.startsWith("{")&&l.endsWith("}")?e.jsx("span",{className:"mx-0.5 px-1 py-0.5 rounded bg-amber-100 text-amber-800 font-bold font-mono text-[0.9em] border border-amber-200 inline-block shadow-sm",children:l.slice(1,-1)},n):l.startsWith("[")&&l.endsWith("]")?e.jsxs("span",{className:"mx-1 inline-flex items-center gap-1.5 text-[10px] text-sky-700 bg-sky-100 border border-sky-200 px-2 py-1 rounded-full font-medium",children:[e.jsx(pt,{size:12}),l.slice(1,-1)]},n):e.jsx("span",{children:l},n))})},os=({isOpen:x,onClose:L,item:l})=>{const[n,A]=s.useState(new Set),[S,m]=s.useState(null),g=s.useRef([]);if(!x||!l)return null;const b=i=>{A(E=>{const P=new Set(E);return P.has(i)?P.delete(i):P.add(i),P})},v=i=>{const E=i.replace(/{|}/g,"");m(E)},N=i=>{g.current.push(i)},o=async()=>{if(g.current.length>0){const i=Math.round(g.current.reduce((E,P)=>E+P,0)/g.current.length);await Ue({...l,bestScore:i,updatedAt:Date.now()})}L(),g.current=[]};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[85vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-center shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:l.standard}),e.jsx("p",{className:"text-xs text-neutral-500 font-bold mt-1",children:"Native Expressions Practice"})]}),e.jsx("button",{type:"button",onClick:o,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(Se,{size:24})})]}),e.jsx("main",{className:"flex-1 overflow-y-auto p-8 space-y-4 custom-scrollbar bg-neutral-50/30",children:l.answers.map((i,E)=>{const P=n.has(E);return e.jsxs("div",{className:"bg-white p-5 rounded-3xl border border-neutral-200 shadow-sm space-y-3 relative overflow-hidden group",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:`px-2 py-0.5 rounded text-[8px] font-black uppercase border ${i.tone==="academic"?"bg-purple-50 text-purple-700 border-purple-100":i.tone==="semi-academic"?"bg-blue-50 text-blue-700 border-blue-100":"bg-neutral-50 text-neutral-600 border-neutral-100"}`,children:i.tone})}),e.jsx("span",{className:"text-sm font-bold text-neutral-700 leading-snug",children:i.anchor})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>b(E),className:`p-2 rounded-lg transition-all ${P?"text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:P?e.jsx(Ct,{size:16}):e.jsx(St,{size:16})}),P&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Me(i.sentence.replace(/{|}/g,"")),className:"p-2 text-neutral-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all",title:"Listen",children:e.jsx(He,{size:16})}),e.jsx("button",{onClick:()=>v(i.sentence),className:"p-2 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all",title:"Practice Speaking",children:e.jsx(_e,{size:16})})]})]})]}),e.jsx("div",{className:"min-h-[1.5rem] flex items-center pt-2 border-t border-neutral-50",children:P?e.jsx("div",{className:"text-base font-medium text-neutral-800 animate-in fade-in slide-in-from-top-1",children:e.jsx(ls,{text:i.sentence})}):e.jsxs("div",{className:"flex gap-1 items-center opacity-30 w-full",children:[e.jsx("div",{className:"h-2 w-12 bg-neutral-200 rounded-full"}),e.jsx("div",{className:"h-2 w-24 bg-neutral-200 rounded-full"}),e.jsx("div",{className:"h-2 w-8 bg-neutral-200 rounded-full"})]})}),i.note&&P&&e.jsxs("div",{className:"text-[10px] text-neutral-400 font-medium italic",children:['"',i.note,'"']})]},E)})}),e.jsx("footer",{className:"px-8 py-4 border-t border-neutral-100 bg-white rounded-b-[2.5rem] flex justify-end",children:e.jsx("button",{onClick:o,className:"px-6 py-2.5 bg-neutral-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-md",children:"Done"})})]}),S&&e.jsx(xt,{target:S,onClose:()=>m(null),onSaveScore:N})]})};function is(x){const L=x.numberOfChannels,l=x.length*L*2+44,n=new ArrayBuffer(l),A=new DataView(n),S=[];let m,g,b=0,v=0;for(o(1179011410),o(l-8),o(1163280727),o(544501094),o(16),N(1),N(L),o(x.sampleRate),o(x.sampleRate*2*L),N(L*2),N(16),o(1635017060),o(l-v-4),m=0;m<x.numberOfChannels;m++)S.push(x.getChannelData(m));for(;v<l;){for(m=0;m<L;m++)g=Math.max(-1,Math.min(1,S[m][b])),g=(g<0?g*32768:g*32767)|0,A.setInt16(v,g,!0),v+=2;b++}return new Blob([n],{type:"audio/wav"});function N(i){A.setUint16(v,i,!0),v+=2}function o(i){A.setUint32(v,i,!0),v+=4}}const cs=({isOpen:x,onClose:L,item:l})=>{const[n,A]=s.useState(0),[S,m]=s.useState(!1),[g,b]=s.useState(!1),[v,N]=s.useState(null),[o,i]=s.useState(!1),[E,P]=s.useState(!1),[$,Z]=s.useState(!0),[k,M]=s.useState(null),[z,c]=s.useState({}),[C,T]=s.useState({}),[h,Y]=s.useState(!1),[be,y]=s.useState(""),[G,q]=s.useState(null),[de,ve]=s.useState("audio/webm"),[pe,Te]=s.useState(!1),[he,se]=s.useState(null),ee=s.useRef([]),[ie,J]=s.useState(!1),[re]=s.useState(()=>Le()),ue=s.useRef(null),je=s.useRef({}),le=s.useRef(new ht),H=s.useRef(null),{showToast:ne}=Be(),B=()=>{H.current&&(H.current.pause(),H.current.src="",H.current=null),Xe()},Ne=async()=>{if(B(),le.current.stop(),l&&ee.current.length>0){const a=Math.round(ee.current.reduce((j,w)=>j+w,0)/ee.current.length);await $e({...l,bestScore:a,updatedAt:Date.now()})}T({}),c({}),q(null),ee.current=[],L()};s.useEffect(()=>{if(!(S||g)||!l)return;let a=!1;return(async()=>{if(n>=l.sentences.length||a)return;const w=l.sentences[n];if(!g&&v&&w.speakerName===v){m(!1),i(!0);return}const R=z[n];if(R&&g)B(),await new Promise(_=>{const I=new Audio(`data:${R.mime};base64,${R.base64}`);H.current=I,I.onended=()=>_(!0),I.onerror=()=>_(!1),I.play().catch(()=>_(!1)),a&&(I.pause(),_(!1))});else{const _=C[n];if(_)B(),await new Promise(I=>{const U=new Audio(`data:${_.mime};base64,${_.base64}`);H.current=U,U.onended=()=>I(!0),U.onerror=()=>I(!1),U.play().catch(()=>I(!1)),a&&(U.pause(),I(!1))});else{const I=l.speakers.find(F=>F.name===w.speakerName);let U=I==null?void 0:I.voiceName,K=I==null?void 0:I.accentCode;if(!U){const F=(I==null?void 0:I.sex)==="male"?"male":"female",r=re.audioCoach.coaches[F];U=r.enVoice,K=r.enAccent}try{const F=Pe(re),r={text:w.text,language:"en",accent:K,voice:U},u=await fetch(`${F}/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(u.ok){const p=await u.blob(),f=new FileReader,V=new Promise(oe=>{f.onloadend=()=>oe(f.result.split(",")[1])});f.readAsDataURL(p);const X=await V,ye=u.headers.get("Content-Type")||"audio/aiff";if(T(oe=>({...oe,[n]:{base64:X,mime:ye}})),!a){B();const oe=new Audio(`data:${ye};base64,${X}`);H.current=oe,await new Promise(Ce=>{oe.onended=()=>Ce(!0),oe.onerror=()=>Ce(!1),oe.play().catch(()=>Ce(!1)),a&&(oe.pause(),Ce(!1))})}}else await Me(w.text,!0,"en",U,K)}catch(F){console.error("Playback error",F)}}}!a&&(S||g)&&(n<l.sentences.length-1?A(_=>_+1):(m(!1),b(!1)))})(),()=>{a=!0}},[S,g,n,l,v]),s.useEffect(()=>{const a=je.current[n];a&&ue.current&&a.scrollIntoView({behavior:"smooth",block:"center"})},[n,S,g,o,$]);const Ae=n>0||Object.keys(z).length>0,ce=a=>{Ae?M(a):D(a)},D=a=>{B(),m(!1),b(!1),i(!1),A(0),c({}),ee.current=[],N(a),M(null),ne(a?`Role changed to ${a}. Practice reset.`:"Role changed to Spectator. Practice reset.","info")};if(!x||!l||!l.sentences||l.sentences.length===0)return null;const ae=l.sentences,te=ae[n],Fe=()=>{B(),i(!1),A(0)},me=()=>{n>0&&(B(),i(!1),A(a=>a-1))},ke=()=>{n<ae.length-1&&(B(),i(!1),A(a=>a+1))},we=async()=>{if(h){le.current.stop(),Te(!1);const a=await Ze();a&&(q(a.base64),ve(a.mimeType)),Y(!1)}else{B(),y(""),q(null);try{await et(),Y(!0),Te(!0),le.current.start((a,j)=>y(a+j),a=>y(a))}catch(a){console.error("Failed to start recording",a),Y(!1)}}},ge=a=>{const j=a!==void 0?z[a]:G?{base64:G,mime:de}:null;if(j){B();const w=new Audio(`data:${j.mime};base64,${j.base64}`);H.current=w,w.play()}},Re=()=>{if(G&&(c(a=>({...a,[n]:{base64:G,mime:de}})),te)){const a=ft(te.text,be);ee.current.push(a.score)}i(!1),y(""),q(null),n<ae.length-1?(A(a=>a+1),m(!0)):m(!1)},Q=async(a,j)=>{B();const w=C[j];if(w){const F=new Audio(`data:${w.mime};base64,${w.base64}`);H.current=F,F.play();return}const R=l.speakers.find(F=>F.name===a.speakerName);let _=R==null?void 0:R.voiceName,I=R==null?void 0:R.accentCode;if(!_){const F=(R==null?void 0:R.sex)==="male"?"male":"female",r=re.audioCoach.coaches[F];_=r.enVoice,I=r.enAccent}const U=Pe(re),K={text:a.text,language:"en",accent:I,voice:_};try{const F=await fetch(`${U}/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(K)});if(F.ok){const r=await F.blob(),u=new FileReader;u.onloadend=()=>{const f=u.result.split(",")[1],V=F.headers.get("Content-Type")||"audio/aiff";T(X=>({...X,[j]:{base64:f,mime:V}}))},u.readAsDataURL(r);const p=new Audio(URL.createObjectURL(r));H.current=p,p.play()}else Me(a.text,!1,"en",_,I)}catch{Me(a.text,!1,"en",_,I)}},xe=()=>{g?(b(!1),B()):(B(),m(!1),i(!1),b(!0),A(0))},W=async()=>{const a=new(window.AudioContext||window.webkitAudioContext),j=[];let w=!1;for(let U=0;U<l.sentences.length;U++){const K=z[U],F=C[U],r=K||F;if(!r)continue;w=!0;const u=atob(r.base64),p=new Uint8Array(u.length);for(let f=0;f<u.length;f++)p[f]=u.charCodeAt(f);try{const f=await a.decodeAudioData(p.buffer);j.push(f)}catch(f){console.warn(`Failed to decode segment ${U}`,f)}}if(!w||j.length===0)return null;const R=j.reduce((U,K)=>U+K.length,0),_=a.createBuffer(j[0].numberOfChannels,R,j[0].sampleRate);let I=0;return j.forEach(U=>{for(let K=0;K<U.numberOfChannels;K++)_.getChannelData(K).set(U.getChannelData(K),I);I+=U.length}),_},Ie=async()=>{if(!ie){J(!0),B();try{const a=await W();if(!a){ne("No audio segments available to play.","info"),J(!1);return}const j=new(window.AudioContext||window.webkitAudioContext),w=j.createBufferSource();w.buffer=a,w.connect(j.destination),w.onended=()=>J(!1),w.start(0)}catch(a){console.error("Preview failed",a),ne("Failed to preview audio.","error"),J(!1)}}},t=async()=>{if(!E){P(!0),ne("Generating full audio file...","info");try{const a=await W();if(!a){ne("No audio segments available to save.","info"),P(!1);return}const j=is(a),w=URL.createObjectURL(j),R=document.createElement("a");R.href=w,R.download=`Full_Dialogue_${l.title.replace(/\s+/g,"_")}.wav`,document.body.appendChild(R),R.click(),document.body.removeChild(R),URL.revokeObjectURL(w),ne("Audio file saved!","success")}catch(a){console.error("Save All failed",a),ne("Error generating audio file.","error")}finally{P(!1)}}},d=Object.keys(z).length>0||Object.keys(C).length>0,O=$?[ae[n]]:ae,fe=a=>{ee.current.push(a)};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-4xl rounded-[3rem] shadow-2xl border border-neutral-200 flex flex-col h-[85vh] overflow-hidden",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-center shrink-0 bg-white z-10",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900 tracking-tight leading-none",children:l.title}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1 text-[9px] font-black uppercase text-neutral-400",children:[e.jsx(Ht,{size:10})," Role Play:"]}),e.jsxs("div",{className:"flex bg-neutral-100 p-0.5 rounded-lg",children:[e.jsx("button",{onClick:()=>ce(null),className:`px-2 py-1 rounded-md text-[9px] font-black uppercase transition-all ${!v&&!g?"bg-white text-neutral-900 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,children:"Spectator"}),l.speakers.map(a=>e.jsxs("button",{onClick:()=>ce(a.name),className:`px-2 py-1 rounded-md text-[9px] font-black uppercase transition-all ${v===a.name?"bg-indigo-600 text-white shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,children:["Act as ",a.name]},a.name))]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl gap-1",children:[e.jsxs("button",{onClick:xe,className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${g?"bg-indigo-600 text-white shadow-lg":"text-neutral-500 hover:text-neutral-900"}`,title:"Play whole conversation non-stop",children:[e.jsx(it,{size:14}),g?"Stop":"Play All"]}),!g&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{B(),m(!0),b(!1)},className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${S?"bg-neutral-900 text-white shadow-lg":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Ge,{size:14,fill:"currentColor"})," Play"]}),e.jsxs("button",{onClick:()=>{m(!1),B()},className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${S?"text-neutral-500 hover:text-neutral-900":"bg-neutral-900 text-white shadow-lg"}`,children:[e.jsx(tt,{size:14,fill:"currentColor"})," Pause"]})]})]}),e.jsx("button",{type:"button",onClick:Ne,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(Se,{size:24})})]})]}),e.jsx("div",{className:"bg-neutral-50/50 py-6 px-8 border-b border-neutral-100 shrink-0",children:e.jsx("div",{className:"flex justify-center items-end gap-10 md:gap-20",children:l.speakers.map((a,j)=>{const w=te.speakerName===a.name,R=v===a.name;return e.jsxs("div",{className:"flex flex-col items-center relative group",children:[w&&e.jsxs("div",{className:"absolute -top-12 left-1/2 -translate-x-1/2 bg-neutral-900 text-white px-3 py-1.5 rounded-xl text-lg animate-bounce shadow-xl whitespace-nowrap z-20",children:[te.icon||"ðŸ’¬",e.jsx("div",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-neutral-900 rotate-45"})]}),e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center text-3xl md:text-4xl transition-all duration-300 ${w?"bg-white scale-110 shadow-2xl ring-4 ring-indigo-500/20":"bg-neutral-200/50 grayscale opacity-40"} ${R?"border-2 border-indigo-500":""}`,children:a.sex==="male"?"ðŸ‘¨":"ðŸ‘©"}),e.jsx("div",{className:`mt-2 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest transition-colors ${w?"bg-neutral-900 text-white":"text-neutral-400 bg-neutral-100"} ${R?"ring-1 ring-indigo-500":""}`,children:R?"YOU":a.name})]},j)})})}),e.jsxs("div",{className:"px-6 py-2 bg-white border-b border-neutral-100 flex items-center justify-between",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-lg gap-1",children:[e.jsxs("button",{onClick:()=>Z(!0),className:`px-3 py-1.5 rounded-md text-[9px] font-black uppercase flex items-center gap-1.5 transition-all ${$?"bg-white text-neutral-900 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,title:"Show current turn only",children:[e.jsx(mt,{size:12})," Focus"]}),e.jsxs("button",{onClick:()=>Z(!1),className:`px-3 py-1.5 rounded-md text-[9px] font-black uppercase flex items-center gap-1.5 transition-all ${$?"text-neutral-400 hover:text-neutral-600":"bg-white text-neutral-900 shadow-sm"}`,title:"Show full script",children:[e.jsx(Gt,{size:12})," Script"]})]}),$&&e.jsxs("div",{className:"flex items-center gap-1 bg-neutral-50 p-1 rounded-lg border border-neutral-100 animate-in fade-in slide-in-from-right-2",children:[e.jsx("button",{onClick:Fe,disabled:n===0||o,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(Yt,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-neutral-200"}),e.jsx("button",{onClick:me,disabled:n===0||o,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(ct,{size:16})}),e.jsx("button",{onClick:ke,disabled:n===ae.length-1||o,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(ot,{size:16})})]})]}),e.jsx("main",{ref:ue,className:"flex-1 overflow-y-auto p-6 md:p-8 space-y-4 custom-scrollbar bg-white scroll-smooth pb-32",children:O.map((a,j)=>{const w=$?n:j,R=$?!0:j===n,_=v===a.speakerName,I=l.speakers.find(r=>r.name===a.speakerName),U=(I==null?void 0:I.sex)==="male",K=z[w]!==void 0,F=o&&w===n;return e.jsxs("div",{ref:r=>{R&&(je.current[w]=r)},onClick:()=>{!S&&!g&&!o&&!$&&(A(j),B())},className:`flex items-start gap-4 p-4 rounded-[2rem] transition-all border-2 ${R?"bg-indigo-50/30 border-indigo-200 shadow-sm":"border-transparent hover:bg-neutral-50"} ${S||g||o||$?"cursor-default":"cursor-pointer"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-2xl shrink-0 flex items-center justify-center text-xl shadow-sm ${U?"bg-blue-100":"bg-pink-100"} ${R?"scale-110 ring-2 ring-white":""}`,children:_?"ðŸŒŸ":a.icon||(U?"ðŸ‘¨":"ðŸ‘©")}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`text-[10px] font-black uppercase tracking-widest ${R?"text-indigo-600":"text-neutral-400"}`,children:_?`YOU (as ${a.speakerName})`:a.speakerName}),e.jsxs("div",{className:"flex items-center gap-1",children:[K&&e.jsx("button",{onClick:r=>{r.stopPropagation(),ge(w)},className:"p-2 bg-rose-50 text-rose-600 rounded-xl hover:bg-rose-100 transition-all",title:"Listen back to your attempt",children:e.jsx(_e,{size:14})}),R&&!S&&!g&&!o&&e.jsxs("div",{className:"flex items-center gap-2 animate-in fade-in zoom-in-95",children:[e.jsx("button",{onClick:r=>{r.stopPropagation(),Q(a,w)},className:"p-2 bg-neutral-900 text-white rounded-xl hover:scale-105 transition-transform",children:e.jsx(He,{size:14})}),e.jsx("button",{onClick:r=>{r.stopPropagation(),se(a.text)},className:"p-2 bg-rose-500 text-white rounded-xl hover:scale-105 transition-transform",children:e.jsx(_e,{size:14})})]})]})]}),e.jsx("p",{className:`text-sm md:text-lg leading-relaxed font-bold transition-colors ${R?"text-neutral-900":"text-neutral-500"}`,children:a.text}),F&&e.jsxs("div",{className:"mt-4 p-6 bg-white border-2 border-indigo-500 rounded-[2rem] shadow-xl animate-in zoom-in-95 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-600",children:[e.jsx(Tt,{size:18}),e.jsx("span",{className:"text-xs font-black uppercase tracking-widest",children:"Your Turn to Speak"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Q(a,w),className:"p-2 bg-neutral-100 text-neutral-600 rounded-lg hover:text-neutral-900 transition-all",title:"Listen to Model",children:e.jsx(He,{size:16})}),pe&&e.jsx("span",{className:"flex h-2 w-2 rounded-full bg-red-500 animate-ping"})]})]}),e.jsx("div",{className:"min-h-[60px] p-4 bg-neutral-50 rounded-2xl border border-neutral-100 flex flex-col items-center justify-center text-center",children:be?e.jsxs("p",{className:"text-sm font-medium italic text-neutral-800 leading-relaxed",children:['"',be,'"']}):e.jsx("p",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:"Tap mic and read the sentence aloud"})}),e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:we,className:`w-14 h-14 rounded-full flex items-center justify-center transition-all transform active:scale-90 ${h?"bg-red-500 text-white animate-pulse ring-8 ring-red-100":"bg-neutral-900 text-white hover:bg-neutral-800"}`,children:h?e.jsx(gt,{size:24,fill:"white"}):e.jsx(_e,{size:24})}),G&&e.jsx("button",{onClick:()=>ge(),className:"p-4 bg-white border border-neutral-200 text-neutral-600 rounded-2xl hover:text-indigo-600 hover:border-indigo-300 transition-all",children:e.jsx(Ge,{size:20,fill:"currentColor"})}),e.jsx("button",{onClick:Re,disabled:h,className:"px-6 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 disabled:opacity-50",children:"Confirm & Continue"})]})]})]})]},`${w}-${j}`)})}),e.jsxs("footer",{className:"px-8 py-6 border-t border-neutral-100 bg-white/80 backdrop-blur-md flex justify-between items-center shrink-0 absolute bottom-0 left-0 right-0 z-20",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:me,disabled:n===0||o,className:"p-3 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all",children:e.jsx(ct,{size:20})}),e.jsxs("div",{className:"flex flex-col items-center min-w-[80px]",children:[e.jsx("span",{className:"text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-1",children:"Sentence"}),e.jsxs("span",{className:"text-sm font-black text-neutral-900",children:[n+1," / ",ae.length]})]}),e.jsx("button",{onClick:ke,disabled:n===ae.length-1||o,className:"p-3 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all",children:e.jsx(ot,{size:20})})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[g?e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-2xl shadow-lg animate-in fade-in",children:[e.jsx(it,{size:14}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Full Playback Mode"})]}):o?e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-indigo-50 rounded-2xl border border-indigo-100 animate-in slide-in-from-right-2",children:[e.jsx(qe,{size:14,className:"text-indigo-600"}),e.jsx("span",{className:"text-[10px] font-black text-indigo-700 uppercase tracking-widest",children:"Waiting for User"})]}):!S&&e.jsxs("div",{className:"hidden sm:flex items-center gap-2 px-4 py-2 bg-neutral-50 rounded-2xl border border-indigo-100 animate-in fade-in",children:[e.jsx(pt,{size:14,className:"text-neutral-400"}),e.jsx("span",{className:"text-[10px] font-bold text-neutral-500 uppercase tracking-widest",children:"Manual Mode Active"})]}),e.jsxs("button",{onClick:Ie,disabled:ie||!d,className:`px-5 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all shadow-md active:scale-95 flex items-center gap-2 disabled:opacity-50 ${ie?"bg-amber-100 text-amber-700":"bg-white border border-neutral-200 text-neutral-600 hover:bg-neutral-50"}`,title:"Listen to full audio without downloading",children:[ie?e.jsx(Qe,{size:14,className:"animate-spin"}):e.jsx(qt,{size:14}),e.jsx("span",{className:"hidden sm:inline",children:ie?"Playing...":"Listen Full"})]}),e.jsxs("button",{onClick:t,disabled:E||!d,className:"px-5 py-3 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-lg active:scale-95 flex items-center gap-2 disabled:opacity-50",title:"Save all audio (User & AI) to one file",children:[E?e.jsx(Qe,{size:14,className:"animate-spin"}):e.jsx(Wt,{size:14}),e.jsx("span",{className:"hidden sm:inline",children:"Save All"})]}),e.jsx("button",{onClick:Ne,className:"px-8 py-3 bg-neutral-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-lg active:scale-95",children:"Finish Session"})]})]})]}),he&&e.jsx(xt,{target:he,onClose:()=>se(null),onSaveScore:fe}),e.jsx(We,{isOpen:!!k,title:"Switch Role?",message:"Changing roles will reset your current practice progress. Recordings will be lost.",confirmText:"Switch & Reset",isProcessing:!1,onConfirm:()=>D(k),onClose:()=>M(null)})]})},ds=({isOpen:x,onClose:L,item:l})=>{const{showToast:n}=Be(),[A,S]=s.useState("RECORDING"),[m,g]=s.useState([]),[b,v]=s.useState(0),[N,o]=s.useState(0),[i,E]=s.useState(10),[P,$]=s.useState(!1),[Z,k]=s.useState(!1),[M,z]=s.useState(""),[c,C]=s.useState(null),[T,h]=s.useState(null),[Y,be]=s.useState(!1),[y,G]=s.useState(()=>bt("vocab_pro_mimic_autoreveal",!0)),[q,de]=s.useState(null),[ve,pe]=s.useState(!1),[Te,he]=s.useState(!1),[se,ee]=s.useState(!1),[ie,J]=s.useState(0),[re,ue]=s.useState(null),[je,le]=s.useState(null),[H,ne]=s.useState(!1),[B,Ne]=s.useState(null),[Ae,ce]=s.useState(null),[D,ae]=s.useState(0),[te,Fe]=s.useState(0),[me,ke]=s.useState([]),[we,ge]=s.useState(null),Re=s.useRef(new ht),Q=s.useRef(null),xe=s.useRef(null);s.useEffect(()=>{vt("vocab_pro_mimic_autoreveal",y)},[y]),s.useEffect(()=>{if(x&&l){const u=(l.content.match(/[^.!?]+[.!?]+["']?|[^.!?]+$/g)||[l.content]).map(p=>p.trim()).filter(Boolean).map((p,f)=>{var V;return{id:`ft-${l.id}-${f}`,text:p,sourceWord:l.title,type:"Free Talk",lastScore:(V=l.sentenceScores)==null?void 0:V[f]}});g(u),v(0),o(0),ke(l.userRecordings||[]),Ie()}else Xe(),t(),Re.current.stop(),xe.current&&clearInterval(xe.current),ue(null),le(null)},[x,l]);const W=m[b]||null;s.useEffect(()=>{if(A==="MIMIC"&&(Ie(),Y&&W)){const r=setTimeout(()=>Me(W.text),500);return()=>clearTimeout(r)}},[W==null?void 0:W.id,A]),s.useEffect(()=>()=>{Q.current&&(Q.current.pause(),Q.current.src="",Q.current=null)},[]);const Ie=()=>{$(!1),k(y),z(""),C(null),h(null),de(null),pe(!1)},t=()=>{Q.current&&(Q.current.pause(),Q.current=null),Ne(null),ce(null),ae(0),Fe(0),Xe()},d=async r=>{if(!l)return;const u={},p=[];r.forEach((V,X)=>{V.lastScore!==void 0&&(u[X]=V.lastScore,p.push(V.lastScore))});let f=l.bestScore||0;if(p.length>0){const V=p.reduce((X,ye)=>X+ye,0);f=Math.round(V/p.length)}await ze({...l,bestScore:f,sentenceScores:u,updatedAt:Date.now()})},O=async()=>{if(W)if(P){$(!1),Re.current.stop();try{const r=await Ze();r&&C(r.base64);const u=ft(W.text,M);h(u);const p=m.map((f,V)=>V===b?{...f,lastScore:u.score}:f);g(p),await d(p)}catch(r){console.error(r)}}else{Ie();try{await et(),$(!0),Re.current.start((r,u)=>z(r+u),r=>z(r))}catch(r){console.error("Mic error",r),$(!1)}}},fe=async()=>{if(W){if(q){pe(!ve);return}he(!0);try{const r=Le(),u=Pe(r),p=await fetch(`${u}/api/convert/ipa?text=${encodeURIComponent(W.text)}`);if(p.ok){const f=await p.json();de(f.ipa),pe(!0)}else n("IPA server unavailable","error")}catch{n("Failed to fetch IPA","error")}finally{he(!1)}}},a=(r,u,p)=>{if(u&&B===u||p&&Ae===p){t();return}t();const f=new Audio(r);Q.current=f,f.addEventListener("loadedmetadata",()=>{Fe(f.duration)}),f.addEventListener("timeupdate",()=>{ae(f.currentTime)}),f.addEventListener("ended",()=>{t()}),f.addEventListener("error",()=>{n("Failed to play audio.","error"),t()}),u&&Ne(u),p&&ce(p),f.play().catch(V=>{console.error("Play error",V),t()})},j=r=>{const u=Number(r.target.value);ae(u),Q.current&&(Q.current.currentTime=u)},w=async()=>{if(se){xe.current&&clearInterval(xe.current),ee(!1);try{const r=await Ze();if(r){const u=atob(r.base64),p=new Array(u.length);for(let X=0;X<u.length;X++)p[X]=u.charCodeAt(X);const f=new Uint8Array(p),V=new Blob([f],{type:r.mimeType});ue(V),le(V)}}catch(r){console.error("Recording error",r),n("Failed to process recording.","error")}}else{t(),ue(null),le(null);try{await et(),ee(!0),J(0),xe.current=setInterval(()=>{J(r=>r+1)},1e3)}catch{n("Could not access microphone.","error")}}},R=()=>{ue(null),le(null),J(0)},_=async()=>{if(!(!je||!l)){ne(!0);try{const r=Le(),u=Pe(r);let p="Recordings";try{const ye=await fetch(`${u}/api/audio/mappings`);if(ye.ok){const oe=await ye.json(),Ce=Object.keys(oe);Ce.length>0&&(p=Ce[0])}}catch{}const f=`rec_${Date.now()}.webm`,V=new FormData;V.append("mapName",p),V.append("filename",f),V.append("audio",je,f);const X=await fetch(`${u}/api/audio/upload`,{method:"POST",body:V});if(X.ok){const ye=await X.json(),oe=ie,rt=[{id:`rec-${Date.now()}`,url:`${u}/api/audio/stream/${p}/${f}`,mapName:p,filename:f,timestamp:Date.now(),duration:oe},...me];ke(rt);const wt={...l,userRecordings:rt,updatedAt:Date.now()};await ze(wt),n("Recording saved!","success"),ue(null),le(null),J(0)}else n("Upload failed.","error")}catch(r){console.error("Save error",r),n("Failed to save recording.","error")}finally{ne(!1)}}},I=async()=>{if(!we||!l)return;const r=Le(),u=Pe(r);try{await fetch(`${u}/api/audio/file?mapName=${encodeURIComponent(we.mapName)}&filename=${encodeURIComponent(we.filename)}`,{method:"DELETE"})}catch{console.warn("Server delete failed, removing local reference anyway.")}const p=me.filter(f=>f.id!==we.id);ke(p),await ze({...l,userRecordings:p,updatedAt:Date.now()}),n("Recording deleted.","success"),ge(null)};if(!x||!l)return null;const U=Math.ceil(m.length/i),K=m.slice(N*i,(N+1)*i),F=r=>{const u=Math.floor(r/60),p=Math.floor(r%60);return`${u}:${p.toString().padStart(2,"0")}`};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-5xl rounded-[3rem] shadow-2xl border border-neutral-200 flex flex-col h-[85vh] overflow-hidden relative",children:[e.jsxs("div",{className:"px-8 py-4 border-b border-neutral-100 flex items-center justify-between bg-white z-10",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl",children:[e.jsxs("button",{onClick:()=>{S("MIMIC"),t()},className:`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 ${A==="MIMIC"?"bg-white shadow-sm text-indigo-600":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Qt,{size:14})," Mimic"]}),e.jsxs("button",{onClick:()=>{S("RECORDING"),t()},className:`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 ${A==="RECORDING"?"bg-white shadow-sm text-rose-600":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Xt,{size:14})," Recording"]})]}),e.jsx("h3",{className:"text-sm font-black text-neutral-900 truncate max-w-md hidden md:block",children:l.title})]}),e.jsx("div",{className:"flex-1 overflow-hidden relative",children:A==="MIMIC"?e.jsx("div",{className:"h-full flex",children:e.jsx(Jt,{targetText:(W==null?void 0:W.text)||null,sourceWord:l.title,type:"Free Talk",isEmpty:m.length===0,isRecording:P,isRevealed:Z,userTranscript:M,matchStatus:null,userAudioUrl:c,localAnalysis:T,aiAnalysis:null,isAnalyzing:!1,onAnalyze:()=>{},ipa:q,showIpa:ve,isIpaLoading:Te,onToggleIpa:fe,onToggleRecord:O,onPlayTarget:()=>W&&Me(W.text),onPlayUser:()=>{c&&new Audio(`data:audio/webm;base64,${c}`).play()},onToggleReveal:()=>k(!Z),onNext:()=>b<m.length-1&&v(r=>r+1),onClearTranscript:()=>z(""),onClose:L,pagedItems:K,page:N,pageSize:i,totalPages:U,onPageChange:o,onPageSizeChange:r=>{E(r),o(0)},onSelect:r=>v(N*i+r),currentAbsoluteIndex:b,autoSpeak:Y,onToggleAutoSpeak:()=>be(!Y),autoReveal:y,onToggleAutoReveal:()=>G(!y),isGlobalMode:!0,onAddItem:()=>n("Editing not available in practice mode","info"),onEditItem:()=>{},onDeleteItem:()=>{},onRandomize:()=>{},isModalOpen:!1,editingItem:null,onCloseModal:()=>{},onSaveItem:()=>{}})}):e.jsxs("div",{className:"h-full flex flex-col p-8 overflow-y-auto custom-scrollbar bg-neutral-50/50",children:[e.jsx("button",{onClick:L,className:"absolute top-4 right-4 p-2 text-neutral-400 hover:bg-neutral-100 rounded-full z-50",children:e.jsx(Se,{size:20})}),e.jsxs("div",{className:"max-w-2xl mx-auto w-full space-y-6 pb-20",children:[e.jsx("div",{className:"flex flex-col items-center justify-center py-4 bg-white rounded-3xl border border-neutral-200 shadow-sm overflow-hidden",children:re?e.jsxs("div",{className:"w-full p-4 space-y-6 animate-in fade-in",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center justify-between px-2",children:[e.jsx("h4",{className:"text-xs font-black uppercase text-neutral-400 tracking-widest",children:"Review Recording"}),e.jsx("span",{className:"text-xs font-bold text-neutral-500",children:F(ie)})]}),e.jsx(Dt,{audioBlob:re,onTrim:r=>{le(r),n("Trimmed! Ready to save.","success")},onCancel:()=>{}})]}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsxs("button",{onClick:R,className:"px-6 py-3 bg-white border border-neutral-200 text-neutral-500 rounded-xl font-bold text-xs hover:bg-neutral-50 hover:text-neutral-900 transition-all flex items-center gap-2",children:[e.jsx(Zt,{size:16})," Discard"]}),e.jsxs("button",{onClick:_,disabled:H,className:"px-8 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-lg flex items-center gap-2",children:[H?e.jsx(Qe,{size:16,className:"animate-spin"}):e.jsx(At,{size:16}),e.jsx("span",{children:H?"Saving...":"Save Recording"})]})]})]}):e.jsxs("div",{className:"py-8 flex flex-col items-center",children:[e.jsxs("div",{className:`relative w-24 h-24 rounded-full flex items-center justify-center transition-all duration-500 ${se?"bg-rose-50 shadow-[0_0_50px_rgba(244,63,94,0.3)]":"bg-white shadow-xl border border-neutral-100"}`,children:[se&&e.jsx("div",{className:"absolute inset-0 rounded-full border-4 border-rose-500 animate-ping opacity-20"}),e.jsx("button",{onClick:w,className:`w-20 h-20 rounded-full flex items-center justify-center transition-all transform active:scale-95 ${se?"bg-rose-600 text-white scale-110 shadow-inner":"bg-neutral-900 text-white hover:bg-neutral-800"}`,children:se?e.jsx(gt,{size:24,fill:"currentColor"}):e.jsx(_e,{size:32})})]}),e.jsxs("div",{className:"mt-4 text-center space-y-1",children:[e.jsx("p",{className:`text-xl font-black font-mono tracking-widest ${se?"text-rose-600":"text-neutral-300"}`,children:F(ie)}),e.jsx("p",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:se?"Recording...":"Tap to Record"})]})]})}),e.jsxs("div",{className:"bg-white p-6 rounded-3xl border border-neutral-200 shadow-sm",children:[e.jsxs("h4",{className:"text-xs font-black uppercase text-neutral-400 tracking-widest mb-3 flex items-center gap-2",children:[e.jsx(Rt,{size:14})," Script"]}),e.jsx("div",{className:"text-lg font-medium text-neutral-800 leading-relaxed whitespace-pre-wrap",children:l.content})]}),l.audioLinks&&l.audioLinks.length>0&&e.jsxs("div",{className:"bg-white p-6 rounded-3xl border border-neutral-200 shadow-sm space-y-4",children:[e.jsxs("h4",{className:"text-xs font-black uppercase text-neutral-400 tracking-widest flex items-center gap-2",children:[e.jsx(jt,{size:14})," Reference Audio"]}),e.jsx("div",{className:"space-y-2 max-h-32 overflow-y-auto custom-scrollbar pr-2",children:l.audioLinks.map((r,u)=>{const p=B===r;return e.jsxs("div",{children:[e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-xl border transition-colors ${p?"bg-indigo-50 border-indigo-100":"bg-neutral-50 border-neutral-100"}`,children:[e.jsx("span",{className:`text-xs font-bold truncate max-w-[200px] ${p?"text-indigo-700":"text-neutral-600"}`,children:decodeURIComponent(r.split("/").pop()||`Track ${u+1}`)}),e.jsx("button",{onClick:()=>a(r,r,null),className:`p-2 rounded-full transition-all ${p?"bg-indigo-600 text-white":"bg-white text-indigo-600 border border-indigo-100 hover:bg-indigo-50"}`,children:p?e.jsx(tt,{size:14,fill:"currentColor"}):e.jsx(Ge,{size:14,fill:"currentColor"})})]}),p&&e.jsxs("div",{className:"flex items-center gap-3 px-2 pt-2 animate-in fade-in slide-in-from-top-1",children:[e.jsx("span",{className:"text-[10px] font-mono font-bold text-neutral-400 w-8 text-right",children:F(D)}),e.jsx("input",{type:"range",min:"0",max:te||100,value:D,onChange:j,className:"flex-1 h-1 bg-neutral-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"}),e.jsx("span",{className:"text-[10px] font-mono font-bold text-neutral-400 w-8 text-left",children:F(te)})]})]},u)})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-xs font-black uppercase text-neutral-400 tracking-widest flex items-center gap-2",children:[e.jsx(Kt,{size:14})," Recordings History (",me.length,")"]}),me.length===0?e.jsx("div",{className:"text-center py-8 text-neutral-300 italic text-xs",children:"No recordings yet."}):e.jsx("div",{className:"grid gap-3",children:me.map(r=>{const u=Ae===r.id;return e.jsxs("div",{className:"flex flex-col bg-white rounded-2xl border border-neutral-200 shadow-sm hover:border-neutral-300 transition-colors overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>a(r.url,null,r.id),className:`p-3 rounded-full transition-all ${u?"bg-indigo-600 text-white shadow-md":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:u?e.jsx(tt,{size:16,fill:"currentColor"}):e.jsx(Ge,{size:16,fill:"currentColor"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-bold text-neutral-800",children:new Date(r.timestamp).toLocaleString()}),e.jsx("p",{className:"text-[10px] font-medium text-neutral-400",children:F(r.duration||0)})]})]}),e.jsx("button",{onClick:()=>ge(r),className:"p-2 text-neutral-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all",children:e.jsx(Ee,{size:16})})]}),u&&e.jsxs("div",{className:"px-4 pb-4 pt-0 flex items-center gap-3 animate-in fade-in slide-in-from-top-1 bg-white",children:[e.jsx("span",{className:"text-[10px] font-mono font-bold text-neutral-400 w-8 text-right",children:F(D)}),e.jsx("input",{type:"range",min:"0",max:te||100,value:D,onChange:j,className:"flex-1 h-1.5 bg-neutral-100 rounded-lg appearance-none cursor-pointer accent-indigo-600"}),e.jsx("span",{className:"text-[10px] font-mono font-bold text-neutral-400 w-8 text-left",children:F(te)})]})]},r.id)})})]})]})]})})]}),e.jsx(We,{isOpen:!!we,title:"Delete Recording?",message:"This will permanently delete the audio file from the server.",confirmText:"Delete",isProcessing:!1,onConfirm:I,onClose:()=>ge(null),confirmButtonClass:"bg-red-600 text-white hover:bg-red-700"})]})},ut="vocab_pro_speaking_card_view",Ke=({score:x})=>x===void 0?null:e.jsxs("span",{className:`text-[10px] font-black px-1.5 py-0.5 rounded border ${x>=80?"bg-green-50 text-green-700 border-green-200":x>=50?"bg-yellow-50 text-yellow-700 border-yellow-200":"bg-red-50 text-red-700 border-red-200"}`,children:[x,"%"]}),Ms=({user:x,onNavigate:L})=>{const[l,n]=s.useState([]),[A,S]=s.useState(!0),[m,g]=s.useState(!1),[b,v]=s.useState(()=>bt(ut,{showTags:!0,compact:!1,resourceType:"ALL"})),N=(t,d)=>v(O=>({...O,[t]:d})),[o,i]=s.useState(0),[E,P]=s.useState(12),[$,Z]=s.useState(""),[k,M]=s.useState(null),[z,c]=s.useState(!1),[C,T]=s.useState("all"),[h,Y]=s.useState("all"),[be,y]=s.useState(!1),[G,q]=s.useState(!1),[de,ve]=s.useState(!1),[pe,Te]=s.useState(null),[he,se]=s.useState(null),[ee,ie]=s.useState(null),[J,re]=s.useState(null),[ue,je]=s.useState(!1),[le,H]=s.useState(null),[ne,B]=s.useState(null),[Ne,Ae]=s.useState(null),{showToast:ce}=Be(),D=async(t=!1)=>{t||S(!0);const[d,O,fe]=await Promise.all([zt(x.id),Mt(x.id),Ft(x.id)]),a=[...d.map(j=>({type:"card",data:j})),...O.map(j=>({type:"conversation",data:j})),...fe.map(j=>({type:"free_talk",data:j}))];n(a.sort((j,w)=>w.data.createdAt-j.data.createdAt)),t||S(!1)};s.useEffect(()=>{D()},[x.id]),s.useEffect(()=>{i(0)},[k,E,C,h,b.resourceType,$]),s.useEffect(()=>{vt(ut,b)},[b]);const ae=s.useMemo(()=>b.resourceType!=="ALL"||C!=="all"||h!=="all",[b.resourceType,C,h]),te=s.useMemo(()=>{const t=$.toLowerCase().trim();return l.filter(d=>{var O,fe;if(t){if(d.type==="card"){if(!d.data.standard.toLowerCase().includes(t))return!1}else if(d.type==="conversation"){if(!d.data.title.toLowerCase().includes(t)&&!(d.data.description||"").toLowerCase().includes(t))return!1}else if(!d.data.title.toLowerCase().includes(t)&&!d.data.content.toLowerCase().includes(t))return!1}if(b.resourceType!=="ALL"&&d.type.toUpperCase()!==b.resourceType||C==="focused"&&!d.data.isFocused||h!=="all"&&d.data.focusColor!==h)return!1;if(k){if(k==="Uncategorized"){if(d.data.path&&d.data.path!=="/")return!1}else if(!((O=d.data.path)!=null&&O.startsWith(k))&&!((fe=d.data.tags)!=null&&fe.includes(k)))return!1}return!0})},[l,k,C,h,b.resourceType,$]),Fe=s.useMemo(()=>{const t=o*E;return te.slice(t,t+E)},[te,o,E]),me=async t=>{const d=Date.now();pe&&pe.id?await Ue({...pe,...t,updatedAt:d}):await Ue({id:`ns-${d}-${Math.random()}`,userId:x.id,createdAt:d,updatedAt:d,...t}),y(!1),D(),ce("Saved!","success")},ke=async t=>{const d=Date.now();he&&he.id?await $e({...he,...t,updatedAt:d}):await $e({id:`conv-${d}-${Math.random()}`,userId:x.id,createdAt:d,updatedAt:d,title:t.title||"",description:t.description||"",speakers:t.speakers||[],sentences:t.sentences||[],tags:t.tags||[]}),q(!1),D(),ce("Saved!","success")},we=async t=>{const d=Date.now();ee&&ee.id?await ze({...ee,...t,updatedAt:d}):await ze({id:`ft-${d}-${Math.random()}`,userId:x.id,createdAt:d,updatedAt:d,...t}),ve(!1),D(),ce("Free Talk Saved!","success")},ge=t=>{t.type==="card"?(Te(t.data),y(!0)):t.type==="conversation"?(se(t.data),q(!0)):t.type==="free_talk"&&(ie(t.data),ve(!0))},Re=async()=>{J&&(J.type==="card"?await Pt(J.id):J.type==="conversation"?await Ot(J.id):J.type==="free_talk"&&await Ut(J.id),re(null),D(),ce("Deleted!","success"))},Q=async(t,d)=>{const O={...t.data,focusColor:d||void 0,updatedAt:Date.now()};d||delete O.focusColor,t.type==="card"?await Ue(O):t.type==="conversation"?await $e(O):t.type==="free_talk"&&await ze(O),D()},xe=async t=>{const d={...t.data,isFocused:!t.data.isFocused,updatedAt:Date.now()};t.type==="card"?await Ue(d):t.type==="conversation"?await $e(d):t.type==="free_talk"&&await ze(d),D()},W=t=>{se(d=>({...d||{},title:t.title,description:t.description,speakers:t.speakers,sentences:t.sentences,tags:t.tags})),je(!1),ce("Conversation generated!","success")},Ie=()=>{n(t=>[...t].sort(()=>Math.random()-.5)),ce("Deck shuffled!","success")};return e.jsxs(e.Fragment,{children:[e.jsx($t,{title:"Speaking Library",subtitle:"Master natural phrases.",icon:e.jsx("img",{src:"https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Microphone.png",className:"w-8 h-8 object-contain",alt:"Speaking"}),query:$,onQueryChange:Z,searchPlaceholder:"Search phrases, conversations...",config:{},isLoading:A,isEmpty:te.length===0,emptyMessage:"No items found.",activeFilters:{},onFilterChange:()=>{},pagination:{page:o,totalPages:Math.ceil(te.length/E),onPageChange:i,pageSize:E,onPageSizeChange:P,totalItems:te.length},aboveGrid:e.jsx(e.Fragment,{children:z&&e.jsx(_t,{items:l.map(t=>t.data),selectedTag:k,onSelectTag:M,forcedView:"tags",title:"Browse Tags",icon:e.jsx(at,{size:16})})}),actions:e.jsx(Lt,{viewMenu:e.jsx(Vt,{isOpen:m,setIsOpen:g,hasActiveFilters:ae,filterOptions:[{label:"All",value:"ALL",isActive:b.resourceType==="ALL",onClick:()=>N("resourceType","ALL")},{label:"Card",value:"CARD",isActive:b.resourceType==="CARD",onClick:()=>N("resourceType","CARD")},{label:"Conv.",value:"CONVERSATION",isActive:b.resourceType==="CONVERSATION",onClick:()=>N("resourceType","CONVERSATION")},{label:"Free Talk",value:"FREE_TALK",isActive:b.resourceType==="FREE_TALK",onClick:()=>N("resourceType","FREE_TALK")}],customSection:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-3 py-2 text-[9px] font-black text-neutral-400 uppercase tracking-widest border-b border-neutral-50 flex items-center gap-2",children:[e.jsx(mt,{size:10})," Focus & Status"]}),e.jsxs("div",{className:"p-1 flex flex-col gap-1 bg-neutral-100 rounded-xl mb-2",children:[e.jsx("button",{onClick:()=>T(C==="all"?"focused":"all"),className:`w-full py-1.5 text-[9px] font-black rounded-lg transition-all ${C==="focused"?"bg-white shadow-sm text-red-600":"text-neutral-500 hover:text-neutral-700"}`,children:C==="focused"?"Focused Only":"All Items"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>Y(h==="green"?"all":"green"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${h==="green"?"bg-emerald-500 border-emerald-600":"bg-white border-neutral-200 hover:bg-emerald-50"}`}),e.jsx("button",{onClick:()=>Y(h==="yellow"?"all":"yellow"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${h==="yellow"?"bg-amber-400 border-amber-500":"bg-white border-neutral-200 hover:bg-amber-50"}`}),e.jsx("button",{onClick:()=>Y(h==="red"?"all":"red"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${h==="red"?"bg-rose-500 border-rose-600":"bg-white border-neutral-200 hover:bg-rose-50"}`})]})]})]}),viewOptions:[{label:"Show Tags",checked:b.showTags,onChange:()=>v(t=>({...t,showTags:!t.showTags}))},{label:"Compact",checked:b.compact,onChange:()=>v(t=>({...t,compact:!t.compact}))}]}),browseTags:{isOpen:z,onToggle:()=>{c(!z)}},addActions:[{label:"New Native Expression",icon:Ve,onClick:()=>{Te(null),y(!0)}},{label:"New Conversation",icon:Ye,onClick:()=>{se(null),q(!0)}},{label:"New Free Talk",icon:dt,onClick:()=>{ie(null),ve(!0)}}],extraActions:e.jsx(e.Fragment,{children:e.jsx("button",{onClick:Ie,disabled:l.length<2,className:"p-3 bg-white border border-neutral-200 text-neutral-600 rounded-xl hover:bg-neutral-50 active:scale-95 transition-all shadow-sm disabled:opacity-50",title:"Randomize",children:e.jsx(Et,{size:16})})})}),children:()=>e.jsx(e.Fragment,{children:Fe.map(t=>{var d;if(t.type==="card")return e.jsx(De,{title:e.jsx("div",{className:"flex items-center gap-2 font-black text-neutral-900",children:t.data.standard}),badge:{label:"Native Expression",colorClass:"bg-teal-50 text-teal-700 border-teal-100",icon:It},tags:b.showTags?t.data.tags:void 0,compact:b.compact,onClick:()=>H(t.data),focusColor:t.data.focusColor,onFocusChange:O=>Q(t,O),isFocused:t.data.isFocused,onToggleFocus:xe.bind(null,t),isCompleted:t.data.focusColor==="green",actions:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:O=>{O.stopPropagation(),ge(t)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",children:e.jsx(Je,{size:14})}),e.jsx("button",{onClick:O=>{O.stopPropagation(),re({id:t.data.id,type:"card"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",children:e.jsx(Ee,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[t.data.answers.length," variations"]}),e.jsx(Ke,{score:t.data.bestScore})]})})},t.data.id);if(t.type==="conversation")return e.jsx(De,{title:t.data.title,badge:{label:"Conversation",colorClass:"bg-indigo-50 text-indigo-700 border-indigo-100",icon:Ye},tags:b.showTags?t.data.tags:void 0,compact:b.compact,onClick:()=>B(t.data),focusColor:t.data.focusColor,onFocusChange:O=>Q(t,O),isFocused:t.data.isFocused,onToggleFocus:xe.bind(null,t),actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:O=>{O.stopPropagation(),ge(t)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",title:"Edit",children:e.jsx(Je,{size:14})}),e.jsx("button",{onClick:O=>{O.stopPropagation(),re({id:t.data.id,type:"conversation"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",title:"Delete",children:e.jsx(Ee,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[t.data.sentences.length," lines"]}),e.jsx(Ke,{score:t.data.bestScore})]})})},t.data.id);{const O=((d=t.data.content.match(/[^.!?]+[.!?]+["']?|[^.!?]+$/g))==null?void 0:d.length)||0,fe=t.data.bestScore;return e.jsx(De,{title:t.data.title,badge:{label:"Free Talk",colorClass:"bg-cyan-50 text-cyan-700 border-cyan-100",icon:dt},tags:b.showTags?t.data.tags:void 0,compact:b.compact,onClick:()=>Ae(t.data),focusColor:t.data.focusColor,onFocusChange:a=>Q(t,a),isFocused:t.data.isFocused,onToggleFocus:xe.bind(null,t),actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:a=>{a.stopPropagation(),ge(t)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",title:"Edit",children:e.jsx(Je,{size:14})}),e.jsx("button",{onClick:a=>{a.stopPropagation(),re({id:t.data.id,type:"free_talk"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",title:"Delete",children:e.jsx(Ee,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[O," Sentences"]}),e.jsx(Ke,{score:fe})]})})},t.data.id)}})})}),e.jsx(ns,{isOpen:be,onClose:()=>y(!1),onSave:me,initialData:pe}),e.jsx(as,{isOpen:G,onClose:()=>q(!1),onSave:ke,initialData:he,onOpenAiGen:()=>je(!0)}),e.jsx(rs,{isOpen:de,onClose:()=>ve(!1),onSave:we,initialData:ee}),e.jsx(We,{isOpen:!!J,title:"Delete Item?",message:"This action cannot be undone.",confirmText:"Delete",isProcessing:!1,onConfirm:Re,onClose:()=>re(null),icon:e.jsx(Ee,{size:40,className:"text-red-500"})}),ue&&e.jsx(nt,{isOpen:ue,onClose:()=>je(!1),type:"GENERATE_UNIT",title:"AI Conversation Creator",description:"Enter a topic to generate a dialogue.",initialData:{},onGeneratePrompt:t=>ts(t.request),onJsonReceived:W,actionLabel:"Generate",closeOnSuccess:!0}),e.jsx(os,{isOpen:!!le,onClose:()=>{H(null),D(!0)},item:le}),e.jsx(cs,{isOpen:!!ne,onClose:()=>{B(null),D(!0)},item:ne}),e.jsx(ds,{isOpen:!!Ne,onClose:()=>{Ae(null),D(!0)},item:Ne})]})};export{Ms as SpeakingCardPage,Ms as default};
