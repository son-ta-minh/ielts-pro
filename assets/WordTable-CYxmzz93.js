import{r as t,G as de,D as Rt,a1 as ce,ar as Oe,j as h,am as be,ak as Re,af as Le,as as Ce,at as Lt,au as Ct,av as Bt,O as Be,aw as O,Q as Dt,ab as Et,U as ue,ax as xt,N as _t,K as Nt}from"./index-A7igoMaK.js";import{D as De,W as $t,U as Ht}from"./WordTable_UI-BBQA71Vh.js";function Pt(w){const m=w.map(T=>{const W={word:T.word},v=(T.collocationsArray||[]).filter(g=>!g.d).map(g=>g.text),b=(T.idiomsList||[]).filter(g=>!g.d).map(g=>g.text);return v.length>0&&(W.collocations=v),b.length>0&&(W.idioms=b),W}).filter(T=>T.collocations||T.idioms);return`You are an expert IELTS coach. Your task is to provide descriptive hints for collocations and idioms.

    TASK:
    Analyze the following JSON array. For each word, there is a list of its collocations and/or idioms that are missing a descriptive hint ("d").
    For EACH collocation and idiom string, you MUST generate a minimal descriptive cue that helps recall it. This cue should be 5-10 words.
    
    INPUT DATA:
    ${JSON.stringify(m,null,2)}

    INSTRUCTIONS:
    1.  Read the input data.
    2.  For each word, process its 'collocations' and/or 'idioms' lists.
    3.  Return a new JSON array. Each object in the array must contain:
        - "og": The original word.
        - "col": (if present in input) An array of objects, where each object has "text" (the original collocation) and "d" (your new descriptive hint).
        - "idm": (if present in input) An array of objects, where each object has "text" (the original idiom) and "d" (your new descriptive hint).
    4.  Do NOT modify the "text" of the items. Do NOT add any items that were not in the input.

    STRICT JSON OUTPUT FORMAT:
    [
      {
        "og": "original_word_1",
        "col": [
          { "text": "collocation_string_1", "d": "your new descriptive hint for it" }
        ],
        "idm": [
          { "text": "idiom_string_1", "d": "your new hint for this idiom" }
        ]
      },
      {
        "og": "original_word_2",
        "col": [
          { "text": "collocation_string_3", "d": "a hint for this collocation" }
        ]
      }
    ]
    `}const Ee="vocab_pro_library_filters_v2",xe=["vocab","idiom","phrasal","collocation","phrase"],_e=["pronun","archive"],Vt=({user:w,words:m,total:fe,loading:T,page:W,pageSize:v,onPageChange:b,onPageSizeChange:g,onSearch:Ne,onFilterChange:$e,onAddWords:He,onViewWord:Pe,onEditWord:Ue,onDelete:je,onHardDelete:ze,onBulkDelete:U,onBulkHardDelete:j,onPractice:Ve,settingsKey:z,context:k,initialFilter:R,forceExpandAdd:me,onExpandAddConsumed:G,onWordRenamed:pe,showTagBrowserButton:Ge,tagTree:Je,selectedTag:qe,onSelectTag:Qe,onOpenWordBook:Ye})=>{const p=t.useMemo(()=>de(Ee,{}),[]),{showToast:Ut}=Rt(),[L,Ke]=t.useState(p.query||""),[C,J]=t.useState(()=>Array.isArray(p.activeFilters)?new Set(p.activeFilters):new Set(["all"])),[B,q]=t.useState(p.refinedFilter||"all"),[D,Xe]=t.useState(p.statusFilter||"all"),[E,Ze]=t.useState(p.registerFilter||"all"),[x,et]=t.useState(p.sourceFilter||"all"),[_,tt]=t.useState(p.compositionFilter||"all"),[N,st]=t.useState(p.bookFilter||"all"),[$,ot]=t.useState(p.specificBookId||""),[nt,Q]=t.useState(!1),[Y,he]=t.useState(p.isFilterMenuOpen||!1),[K,we]=t.useState(""),[it,ge]=t.useState(!1),[at,ye]=t.useState(!1),Se=t.useRef(!0);t.useEffect(()=>{ce(Ee,{query:L,activeFilters:Array.from(C),refinedFilter:B,statusFilter:D,registerFilter:E,sourceFilter:x,compositionFilter:_,bookFilter:N,specificBookId:$,isFilterMenuOpen:Y,page:W,pageSize:v})},[L,C,B,D,E,x,_,N,$,Y,W,v]);const[Te,rt]=t.useState(new Set(["vocab"])),[u,y]=t.useState(new Set),[lt,dt]=t.useState(null),[Ae,X]=t.useState(!1),[ct,ut]=t.useState(null),[Ie,Z]=t.useState(!1),[ft,ee]=t.useState(!1),[mt,te]=t.useState(!1),[se,oe]=t.useState(!1),[We,ne]=t.useState(!1),[ie,f]=t.useState(null),[pt,V]=t.useState(!1),[ke,Me]=t.useState([]),ae=t.useRef(null),[re,ht]=t.useState(()=>{const e=de(z,null);return e?{...De,...e}:De});t.useEffect(()=>{ce(z,re)},[re,z]),t.useEffect(()=>{const e=s=>{ae.current&&!ae.current.contains(s.target)&&ye(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),t.useEffect(()=>{R&&(["raw","refined","verified","failed","not_refined"].includes(R)?(q(R),J(new Set(["all"]))):(J(new Set([R])),q("all")),he(!0))},[R]),t.useEffect(()=>{me&&(Q(!0),G==null||G())},[me]),t.useEffect(()=>{const e=setTimeout(()=>Ne(L),300);return()=>clearTimeout(e)},[L]),t.useEffect(()=>{$e({types:C,refined:B,status:D,register:E,source:x,composition:_,book:N,specificBookId:$}),Se.current?Se.current=!1:(b(0),y(new Set))},[C,B,D,E,x,_,N,$]),t.useEffect(()=>{if(ie){const e=setTimeout(()=>f(null),4e3);return()=>clearTimeout(e)}},[ie]);const wt=e=>{J(s=>{const o=new Set(s);return e==="all"?new Set(["all"]):(o.delete("all"),o.has(e)?o.delete(e):o.add(e),o.size===0?new Set(["all"]):o)})},gt=e=>{rt(s=>{const o=new Set(s),i=(d,l)=>{l.forEach(a=>d.delete(a))};return xe.includes(e)?o.has(e)?o.delete(e):(i(o,xe),o.add(e)):_e.includes(e)&&(o.has(e)?o.delete(e):(i(o,_e),o.add(e))),o})},yt=async()=>{if(K.trim()){ge(!0);try{await He(K,Te),f({type:"success",message:"Words added successfully."}),we(""),Q(!1)}catch{f({type:"error",message:"Failed to add words."})}finally{ge(!1)}}},H=t.useMemo(()=>m.filter(e=>u.has(e.id)),[m,u]),M=t.useMemo(()=>m.filter(e=>u.has(e.id)&&e.quality===Oe.RAW),[m,u]),P=t.useMemo(()=>m.filter(e=>u.has(e.id)&&(e.collocationsArray&&e.collocationsArray.some(s=>!s.d)||e.idiomsList&&e.idiomsList.some(s=>!s.d))),[m,u]),St=async()=>{if(!(!U||u.size===0)){X(!0);try{await U(u),f({type:"success",message:`${k==="unit"?"Unlinked":"Deleted"} ${u.size} item(s).`}),y(new Set)}catch{f({type:"error",message:"Failed to remove items."})}finally{X(!1),ee(!1)}}},Tt=async()=>{if(!(!j||M.length===0)){Z(!0);try{const e=new Set(M.map(s=>s.id));await j(e),f({type:"success",message:`Permanently deleted ${e.size} raw item(s).`}),y(s=>{const o=new Set(s);return e.forEach(i=>o.delete(i)),o})}catch{f({type:"error",message:"Failed to delete items."})}finally{Z(!1),te(!1)}}},At=async e=>{const o=Nt().filter(i=>e.has(i.id)).map(i=>({...i,quality:Oe.VERIFIED,updatedAt:Date.now()}));o.length>0&&(await ue(o),f({type:"success",message:`Marked ${o.length} item(s) as Verified.`}),y(new Set))},It=()=>{const e=m.filter(l=>u.has(l.id));if(e.length===0)return;const s=de("vocab_pro_mimic_practice_queue",[]),o=new Set(s.map(l=>l.text.toLowerCase().trim()));let i=0;const d=[];if(e.forEach(l=>{const a=l.word;o.has(a.toLowerCase().trim())||(d.push({id:`pronun-${Date.now()}-${Math.random()}`,text:a,sourceWord:l.word,type:"Library Word"}),o.add(a.toLowerCase().trim()),i++)}),i>0){const l=[...s,...d];ce("vocab_pro_mimic_practice_queue",l),f({type:"success",message:`Added ${i} words to Pronunciation.`}),y(new Set)}else f({type:"info",message:"Selected words are already in Pronunciation queue."})},ve=async e=>{if(!Array.isArray(e))throw new Error("Response must be an array.");const s=new Map;e.forEach(a=>{var c;const n=(a.og||a.original||a.hw||a.headword||"").toLowerCase();n&&(s.has(n)||s.set(n,[]),(c=s.get(n))==null||c.push(a))});const o=new Map(H.map(a=>[a.word.toLowerCase(),a])),i=[],d=[],l=[];for(const[a,n]of o){const c=s.get(a);if(!c||c.length===0)continue;const r=c[0],A=Bt(r),S=(A.headword||A.word||"").trim();if(S){const Ot=n.word.trim().split(/\s+/).length,bt=S.trim().split(/\s+/).length;if(Ot!==bt){const le=await Be(n.userId,S);if(le){const I=O(le,r);i.push(I)}else{const I=Dt(S,"","","","",[],!1,!1,!1,!1,!1,!1,"refine");I.userId=n.userId;const F=O(I,r);i.push(F)}}else if(S.toLowerCase()!==n.word.toLowerCase()){const I=await Be(n.userId,S);if(I&&I.id!==n.id){const F=O(I,r);i.push(F),d.push(n.id),l.push({id:n.id,oldWord:n.word,newWord:S})}else{let F=O(n,r);F.word=S,i.push(F),l.push({id:n.id,oldWord:n.word,newWord:S})}}else i.push(O(n,r))}else i.push(O(n,r))}if(d.length>0&&await Et(d),i.length>0){await ue(i),l.length>0&&pe&&pe(l);let a=`Refined ${i.length} words.`;d.length>0?a+=` Merged ${d.length} duplicates.`:l.length>0&&(a+=` Renamed ${l.length} to base forms.`),f({type:"success",message:a}),y(new Set)}oe(!1)},Fe=e=>xt(_t(e.words),w.nativeLanguage||"Vietnamese"),Wt=e=>Pt(P),kt=async e=>{var i;if(!Array.isArray(e)){f({type:"error",message:"Invalid response from AI."});return}const s=[],o=new Map(P.map(d=>[d.word.toLowerCase(),d]));for(const d of e){const l=o.get((i=d.og)==null?void 0:i.toLowerCase());if(!l)continue;let a=!1;const n={...l};if(d.col&&l.collocationsArray){const c=new Map(d.col.map(r=>[r.text.toLowerCase(),r.d]));n.collocationsArray=(n.collocationsArray||[]).map(r=>{if(!r.d){const A=c.get(r.text.toLowerCase());if(A)return a=!0,{...r,d:String(A)}}return r})}if(d.idm&&l.idiomsList){const c=new Map(d.idm.map(r=>[r.text.toLowerCase(),r.d]));n.idiomsList=(n.idiomsList||[]).map(r=>{if(!r.d){const A=c.get(r.text.toLowerCase());if(A)return a=!0,{...r,d:String(A)}}return r})}a&&(n.updatedAt=Date.now(),s.push(n))}s.length>0?(await ue(s),f({type:"success",message:`Added hints to ${s.length} word(s).`}),y(new Set)):f({type:"info",message:"No new hints were added."}),ne(!1)},Mt=async()=>{const e=await Ce(w.id);Me(e),V(!0)},vt=async e=>{var n;const s=ke.find(c=>c.id===e);if(!s)return;const o=m.filter(c=>u.has(c.id)),i=new Set(s.words.map(c=>c.word.toLowerCase())),d=o.filter(c=>!i.has(c.word.toLowerCase())).map(c=>({word:c.word,definition:c.meaningVi}));if(d.length===0){f({type:"info",message:"All selected words are already in this book."}),V(!1);return}const l=[...s.words,...d].sort((c,r)=>c.word.toLowerCase().localeCompare(r.word.toLowerCase())),a={...s,words:l,updatedAt:Date.now()};await Lt(a),await Ct(w.id),f({type:"success",message:`Added ${d.length} words to "${(n=s.topic.split(":").pop())==null?void 0:n.trim()}".`}),V(!1),y(new Set)};t.useEffect(()=>{(async()=>{const s=await Ce(w.id);Me(s)})()},[w.id]);const Ft={words:m,total:fe,loading:T,page:W,pageSize:v,onPageChange:b,onPageSizeChange:g,onPractice:Ve,context:k,onDelete:je,onViewWord:Pe,onEditWord:Ue,query:L,setQuery:Ke,activeFilters:C,refinedFilter:B,statusFilter:D,registerFilter:E,sourceFilter:x,compositionFilter:_,bookFilter:N,specificBookId:$,onSpecificBookChange:ot,isAddExpanded:nt,isFilterMenuOpen:Y,quickAddInput:K,setQuickAddInput:we,isAdding:it,isViewMenuOpen:at,selectedIds:u,setSelectedIds:y,wordToDelete:lt,setWordToDelete:dt,isDeleting:Ae,setIsDeleting:X,wordToHardDelete:ct,setWordToHardDelete:ut,isHardDeleting:Ie,setIsHardDeleting:Z,onHardDelete:ze,isAiModalOpen:se,setIsAiModalOpen:oe,notification:ie,viewMenuRef:ae,visibility:re,setVisibility:ht,handleToggleFilter:wt,handleBatchAddSubmit:yt,onOpenBulkDeleteModal:U?()=>ee(!0):void 0,onBulkVerify:At,onOpenBulkHardDeleteModal:j&&M.length>0?()=>te(!0):void 0,selectedWordsToRefine:H,handleGenerateRefinePrompt:Fe,handleAiRefinementResult:ve,selectedRawWordsCount:M.length,selectedWordsMissingHintsCount:P.length,onOpenHintModal:()=>ne(!0),setStatusFilter:Xe,setRefinedFilter:q,setRegisterFilter:Ze,setSourceFilter:et,setCompositionFilter:tt,setBookFilter:st,setIsViewMenuOpen:ye,setIsFilterMenuOpen:he,setIsAddExpanded:Q,settingsKey:z,showTagBrowserButton:Ge,tagTree:Je,selectedTag:qe,onSelectTag:Qe,selectedTypes:Te,toggleType:gt,onOpenWordBook:Ye,onOpenAddToBookModal:Mt,isAddToBookModalOpen:pt,setIsAddToBookModalOpen:V,wordBooks:ke,onConfirmAddToBook:vt,onAddToPronunciation:It};return h.jsxs(h.Fragment,{children:[h.jsx($t,{...Ft}),U&&h.jsx(be,{isOpen:ft,title:k==="unit"?`Unlink ${u.size} Words?`:`Delete ${u.size} Words?`,message:k==="unit"?`Remove ${u.size} selected words from this unit? They will remain in your library.`:`Permanently delete ${u.size} selected words? This action cannot be undone.`,confirmText:k==="unit"?`UNLINK ${u.size}`:`DELETE ${u.size}`,isProcessing:Ae,onConfirm:St,onClose:()=>ee(!1),confirmButtonClass:k==="unit"?"bg-orange-600 text-white hover:bg-orange-700 shadow-orange-200":"bg-red-600 text-white hover:bg-red-700 shadow-red-200",icon:k==="unit"?h.jsx(Ht,{size:40,className:"text-orange-500"}):h.jsx(Re,{size:40,className:"text-red-500"})}),j&&h.jsx(be,{isOpen:mt,title:`Delete ${M.length} Raw Words?`,message:`Permanently delete ${M.length} selected RAW words from your entire library? This action cannot be undone.`,confirmText:`DELETE ${M.length} RAW WORDS`,isProcessing:Ie,onConfirm:Tt,onClose:()=>te(!1),confirmButtonClass:"bg-red-600 text-white hover:bg-red-700 shadow-red-200",icon:h.jsx(Re,{size:40,className:"text-red-500"})}),We&&P.length>0&&h.jsx(Le,{isOpen:We,onClose:()=>ne(!1),type:"REFINE_WORDS",title:"Refine Hints",description:`Generating hints for ${P.length} selected word(s).`,initialData:{},user:w,onGeneratePrompt:Wt,onJsonReceived:kt,actionLabel:"Apply Hints",hidePrimaryInput:!0}),se&&H.length>0&&h.jsx(Le,{isOpen:se,onClose:()=>oe(!1),type:"REFINE_WORDS",title:"Refine Selected Words",description:`Generating details for ${H.length} selected word(s).`,initialData:{words:H.map(e=>e.word).join("; ")},user:w,onGeneratePrompt:Fe,onJsonReceived:ve,actionLabel:"Apply to All"})]})};export{Vt as W};
