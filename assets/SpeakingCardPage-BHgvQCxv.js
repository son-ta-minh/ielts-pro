import{c as Re,r as s,_ as Le,j as e,S as Ge,X as je,ae as Me,ay as we,as as st,av as nt,aK as Ne,k as Te,aO as jt,aJ as wt,H as Ce,b as yt,b0 as Be,bM as pt,at as lt,ad as Nt,bN as kt,aA as We,N as Ct,bq as St,by as Tt,I as At,V as Fe,M as $e,bO as ht,bg as ze,aM as mt,bf as Rt,ah as Ae,bF as Ve,az as ft,ai as ot,bc as Et,b2 as gt,E as Qe,bd as Ze,bP as Ie,bC as et,bD as bt,bB as zt,bQ as it,bR as It,bS as $t,P as _e,w as Mt,g as Ft,bT as Lt,bU as Ot,bV as ke,$ as Pt,ag as Ut,A as ct,bz as Je,h as Bt,o as Vt,p as _t,q as Gt,aX as Wt,bW as qt,bX as Ht,bY as Dt}from"./index-BwRKWFLM.js";import{R as Kt,a as Jt}from"./ResourceActions-CzBOo883.js";import{T as Yt}from"./TagBrowser-H3qiQdXq.js";import{V as Xt}from"./ViewMenu-BX4zhXYR.js";import{U as Ye}from"./UniversalCard-daxbJbm1.js";import{T as at}from"./tag-Bwm_IIxr.js";import{F as Qt}from"./FileSelector-E2dKTcCP.js";import{G as Zt}from"./grip-vertical-Bvl38jm7.js";import{H as dt}from"./headphones-DDH1fijO.js";import{L as vt}from"./layout-grid-B5JiFAxt.js";import{C as ut}from"./chevron-left-BwQ0hhk-.js";import{E as es}from"./ear-CBM7kh83.js";import{D as ts}from"./list-todo-CiIAxsGe.js";import{C as ss}from"./calendar-BSAjvYOn.js";import"./filter-DvIK8o5z.js";import"./server-7OnuIKl-.js";import"./music-Bza6AuuG.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=Re("ChevronsLeft",[["path",{d:"m11 17-5-5 5-5",key:"13zhaf"}],["path",{d:"m18 17-5-5 5-5",key:"h8a8et"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=Re("CircleUser",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}],["path",{d:"M7 20.662V19a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1.662",key:"154egf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=Re("Highlighter",[["path",{d:"m9 11-6 6v3h9l3-3",key:"1a3l36"}],["path",{d:"m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4",key:"14a9rk"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=Re("MicVocal",[["path",{d:"m11 7.601-5.994 8.19a1 1 0 0 0 .1 1.298l.817.818a1 1 0 0 0 1.314.087L15.09 12",key:"80a601"}],["path",{d:"M16.5 21.174C15.5 20.5 14.372 20 13 20c-2.058 0-3.928 2.356-6 2-2.072-.356-2.775-3.369-1.5-4.5",key:"j0ngtp"}],["circle",{cx:"16",cy:"7",r:"5",key:"d08jfb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=Re("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const tt=Re("Settings2",[["path",{d:"M20 7h-9",key:"3s1dr2"}],["path",{d:"M14 17H5",key:"gfn3mx"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]]);function is(r,_,c=[]){const t=c.map($=>{const i=$.sentence.match(/\{(.*?)\}/);return i?`"${i[1]}"`:`"${$.anchor}"`}).join(", ");return`You are an expert English linguist and communication coach.
    
    TASK: Analyze a user's input/context to generate high-quality native expressions.
    
    ${t?`EXISTING EXPRESSIONS (DO NOT DUPLICATE THESE): [${t}]`:""}

    CONTEXT / CORE CONCEPT:
    "${r}"

    USER REQUEST: "${_||"Generate a variety of expressions."}"

    INSTRUCTIONS:
    1.  **Analyze**: Understand the core concept (e.g., "Disagreeing", "Showing excitement").
    2.  **Generate NEW Expressions**: Create 3-5 NEW, distinct, and natural expressions for this concept.
        -   **IMPORTANT**: If "EXISTING EXPRESSIONS" are provided, you MUST NOT repeat them. You must find *alternatives* or *variations*.
    3.  **Tones**: Try to provide a mix of 'casual', 'semi-academic', and 'academic' tones if possible.
    4.  **Format**:
        -   **Anchor (Situation/Context)**: A short, natural phrase describing the *specific situation* or *intent* where this expression is used (e.g., 'Disagreeing with a boss', 'Refusing an invitation').
            -   **DO NOT** put the expression itself here. This is the cue for the user to guess the expression.
            -   Use **English** for simple situations.
            -   Use **Vietnamese** if the situation is nuanced, abstract, or hard to describe simply in English.
        -   **Sentence**: Write a full example sentence containing the expression. Use curly braces \`{}\` to highlight the target expression.
        -   **Note**: Brief usage tip.
    5.  **Standard (Context) Field**: 
        -   Keep it **EXTREMELY CONCISE (MAX 8 WORDS)**.
        -   Make it descriptive and visual. Avoid long, explanatory sentences. 
        -   Example: Use "Sick and symptoms" instead of "Different ways to describe being sick or having a headache".
        -   If the core concept is simple, use **English**. If abstract/complex, use **Vietnamese**.

    Return in code block format STRICT JSON OUTPUT FORMAT:
    {
      "standard": "string (Concise Context/Title - Max 8 words)",
      "answers": [
        {
          "tone": "casual" | "semi-academic" | "academic",
          "anchor": "string (The situation cue - EN or VI)",
          "sentence": "string (e.g., 'Honestly, I'm {not buying it}.')",
          "note": "string"
        }
      ]
    }
    `}function cs(r){return`You are an expert IELTS coach and scenario designer.
    
    TASK: Generate a natural, realistic English conversation based on the topic: "${r}".
    
    CONSTRAINTS:
    1.  The conversation must involve 2 to 3 distinct speakers.
    2.  Assign each speaker a name and a sex (male or female).
    3.  The conversation should have 10 to 15 sentences in total.
    4.  The language should be appropriate for an IELTS candidate (ranging from casual to semi-formal depending on the topic).
    5.  Use high-value vocabulary and natural lexical chunks.
    6.  Assign an "icon" (emoji string) to EVERY single sentence representing the speaker's specific emotion or tone at that moment. Use emojis exclusively from the "Smiley and Emotion" fluent group.
    
    STRICT JSON OUTPUT FORMAT:
    Return in code block format a single JSON object. Do not include any text outside the JSON block.
    
    {
      "title": "string (A catchy title for the conversation)",
      "description": "string (Short context for the conversation)",
      "speakers": [
        { "name": "string (e.g., 'Alice')", "sex": "male" | "female" }
      ],
      "sentences": [
        { "speakerName": "string", "text": "string (verbatim what they say)", "icon": "string (emotional emoji)" }
      ],
      "tags": ["string (3-5 relevant IELTS tags)"]
    }
    `}function ds(r,_){return`You are an expert IELTS Speaking coach.
    
    TASK: Refine and upgrade the following speech draft to achieve a higher Band Score (8.0+).

    CURRENT DRAFT:
    "${r}"

    USER REQUEST: "${_||"Improve vocabulary, grammar, and flow."}"

    INSTRUCTIONS:
    1.  **Upgrade Vocabulary**: Replace simple words with more precise, less common lexical resources (idioms, collocations).
    2.  **Fix Grammar**: Ensure complex structures are used correctly.
    3.  **Improve Flow**: Use natural discourse markers and linking words.
    4.  **Maintain Voice**: Keep it sounding like a natural spoken response, not a written essay.

    STRICT JSON OUTPUT FORMAT:
    Return in code block format a single JSON object.
    {
      "content": "string (The fully rewritten, improved paragraph)"
    }
    `}const us=({isOpen:r,onClose:_,onSave:c,initialData:t})=>{const[A,$]=s.useState(""),[i,b]=s.useState(""),[f,S]=s.useState(""),[C,x]=s.useState([]),[h,j]=s.useState(!1),{showToast:O}=Le();s.useEffect(()=>{var M;r&&($((t==null?void 0:t.standard)||""),S((t==null?void 0:t.note)||""),b(((M=t==null?void 0:t.tags)==null?void 0:M.join(", "))||""),x((t==null?void 0:t.answers)||[]))},[r,t]);const w=M=>{M.preventDefault(),A.trim()&&c({standard:A.trim(),tags:i.split(",").map(U=>U.trim()).filter(Boolean),note:f.trim(),answers:C})},X=M=>{const U=M.result||M;U.answers&&Array.isArray(U.answers)?(x(B=>[...B,...U.answers]),U.standard&&!A&&$(U.standard),O(`Added ${U.answers.length} new expressions!`,"success"),j(!1)):O("AI response format invalid.","error")};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300",children:e.jsxs("form",{onSubmit:w,className:"bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:t?"Edit Expression":"New Expression"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Define context and generate expressions."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>j(!0),className:"p-2 bg-amber-50 text-amber-600 rounded-xl hover:bg-amber-100 transition-colors",title:"Refine/Expand with AI",children:e.jsx(Ge,{size:18})}),e.jsx("button",{type:"button",onClick:_,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full",children:e.jsx(je,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Context / Meaning"}),e.jsx("textarea",{value:A,onChange:M=>$(M.target.value),placeholder:"e.g., Disagreeing politely",rows:2,className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium focus:ring-2 focus:ring-neutral-900 outline-none resize-none",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(at,{size:12})," Tags"]}),e.jsx("input",{value:i,onChange:M=>b(M.target.value),placeholder:"linking, academic...",className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium text-sm"})]}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Answers"}),e.jsx("button",{type:"button",onClick:()=>x([...C,{tone:"semi-academic",anchor:"",sentence:""}]),className:"p-1.5 bg-neutral-100 rounded-lg text-neutral-600 hover:bg-neutral-200 transition-colors",children:e.jsx(Me,{size:14})})]}),C.map((M,U)=>e.jsxs("div",{className:"p-3 bg-neutral-50 rounded-xl border border-neutral-200 space-y-2 relative group",children:[e.jsx("button",{type:"button",onClick:()=>x(C.filter((B,o)=>o!==U)),className:"absolute top-2 right-2 text-neutral-300 hover:text-red-500 opacity-0 group-hover:opacity-100",children:e.jsx(we,{size:12})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{value:M.tone,onChange:B=>{const o=[...C];o[U].tone=B.target.value,x(o)},className:"px-2 py-1 bg-white border border-neutral-200 rounded-lg text-[10px] font-bold outline-none",children:[e.jsx("option",{value:"casual",children:"Casual"}),e.jsx("option",{value:"semi-academic",children:"Semi-Academic"}),e.jsx("option",{value:"academic",children:"Academic"})]}),e.jsx("input",{value:M.anchor,onChange:B=>{const o=[...C];o[U].anchor=B.target.value,x(o)},placeholder:"Situation / Context (e.g. Refusing politey)",className:"flex-1 px-2 py-1 bg-white border border-neutral-200 rounded-lg text-xs font-bold outline-none"})]}),e.jsx("textarea",{value:M.sentence,onChange:B=>{const o=[...C];o[U].sentence=B.target.value,x(o)},placeholder:"Example sentence with {curly braces}",className:"w-full p-2 bg-white border border-neutral-200 rounded-lg text-xs font-medium resize-none outline-none",rows:2}),e.jsx("input",{value:M.note||"",onChange:B=>{const o=[...C];o[U].note=B.target.value,x(o)},placeholder:"Note (optional)",className:"w-full px-2 py-1 bg-white border border-neutral-200 rounded-lg text-[10px] font-medium text-neutral-500 outline-none"})]},U))]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-6 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest",children:[e.jsx(st,{size:14})," Save"]})})]})}),h&&e.jsx(nt,{isOpen:h,onClose:()=>j(!1),type:"REFINE_UNIT",title:"Expand Expressions",description:"Generate additional variations (duplicates are excluded).",initialData:{},onGeneratePrompt:M=>is(A,M.request,C),onJsonReceived:X,actionLabel:"Generate"})]}):null},xs=({isOpen:r,onClose:_,onSave:c,initialData:t,onOpenAiGen:A})=>{const[$,i]=s.useState(""),[b,f]=s.useState(""),[S,C]=s.useState([]),[x,h]=s.useState([]),[j,O]=s.useState(""),[w,X]=s.useState(null);s.useEffect(()=>{var o;if(r){i((t==null?void 0:t.title)||""),f((t==null?void 0:t.description)||""),C((t==null?void 0:t.speakers)||[]),h((t==null?void 0:t.sentences)||[]),O(((o=t==null?void 0:t.tags)==null?void 0:o.join(", "))||"");const N=Ne(Te());jt(N).then(X).catch(()=>X(null))}},[r,t]);const M=o=>{o.preventDefault(),$.trim()&&c({title:$.trim(),description:b,speakers:S,sentences:x,tags:j.split(",").map(N=>N.trim()).filter(Boolean)})},U=(o,N)=>{C(E=>E.map((g,q)=>q===o?{...g,...N}:g))},B=s.useMemo(()=>w?w.voices.filter(o=>o.language.startsWith("en")&&(o.name.toLowerCase().includes("enhanced")||o.name.toLowerCase().includes("premium"))):[],[w]);return r?e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:e.jsxs("form",{onSubmit:M,className:"bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:t?"Edit Conversation":"New Conversation"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Create interactive multi-speaker dialogues."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:A,className:"p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors",title:"Generate with AI",children:e.jsx(Ge,{size:18})}),e.jsx("button",{type:"button",onClick:_,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(je,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black uppercase text-neutral-400",children:"Title"}),e.jsx("input",{value:$,onChange:o=>i(o.target.value),className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-bold focus:ring-2 focus:ring-neutral-900 outline-none",required:!0})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black uppercase text-neutral-400",children:"Tags"}),e.jsx("input",{value:j,onChange:o=>O(o.target.value),className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl font-medium text-sm focus:ring-1 focus:ring-neutral-300 outline-none"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-bold text-neutral-500 uppercase flex items-center gap-2",children:[e.jsx(wt,{size:14})," Speakers (",S.length,"/3)"]}),e.jsx("button",{type:"button",onClick:()=>C([...S,{name:"",sex:"female"}]),disabled:S.length>=3,className:"p-1.5 bg-neutral-100 rounded-lg text-neutral-600 hover:bg-neutral-200 transition-colors disabled:opacity-50",children:e.jsx(Me,{size:14})})]}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:S.map((o,N)=>e.jsxs("div",{className:"p-4 bg-neutral-50 rounded-2xl border border-neutral-200 relative group animate-in zoom-in-95 grid grid-cols-1 sm:grid-cols-[1fr,auto,2fr] gap-4 items-center",children:[e.jsx("button",{type:"button",onClick:()=>C(S.filter((E,g)=>g!==N)),className:"absolute -top-1.5 -right-1.5 p-1 bg-white text-neutral-300 hover:text-red-500 border border-neutral-200 rounded-full shadow-sm opacity-0 group-hover:opacity-100 transition-opacity z-10",children:e.jsx(je,{size:10})}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"Speaker Name"}),e.jsx("input",{value:o.name,onChange:E=>U(N,{name:E.target.value}),placeholder:"Name",className:"w-full bg-white border border-neutral-200 rounded-lg px-3 py-1.5 font-bold text-xs outline-none focus:border-neutral-900"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"Sex"}),e.jsxs("div",{className:"flex bg-white rounded-lg p-0.5 border border-neutral-200 h-[32px]",children:[e.jsx("button",{type:"button",onClick:()=>U(N,{sex:"male"}),className:`flex-1 px-3 py-1 text-[8px] font-black uppercase rounded ${o.sex==="male"?"bg-blue-50 text-white shadow-sm":"text-neutral-400"}`,children:"Male"}),e.jsx("button",{type:"button",onClick:()=>U(N,{sex:"female"}),className:`flex-1 px-3 py-1 text-[8px] font-black uppercase rounded ${o.sex==="female"?"bg-pink-50 text-white shadow-sm":"text-neutral-400"}`,children:"Female"})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[8px] font-black uppercase text-neutral-400",children:"High Quality Voice"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{value:o.voiceName||"",onChange:E=>{const g=B.find(q=>q.name===E.target.value);U(N,{voiceName:E.target.value,accentCode:g==null?void 0:g.accent}),E.target.value&&Ce(`Hello, this is ${E.target.value}`,!1,"en",E.target.value,g==null?void 0:g.accent)},className:"w-full bg-white border border-neutral-200 rounded-xl px-4 py-3 pr-10 text-[10px] font-bold outline-none focus:border-neutral-900 appearance-none",children:[e.jsx("option",{value:"",children:"Auto Select"}),B.map(E=>e.jsxs("option",{value:E.name,children:[E.name," (",E.accent,")"]},E.name))]}),e.jsx(yt,{size:12,className:"absolute right-2 top-1/2 -translate-y-1/2 text-neutral-400 pointer-events-none"})]})]})]},N))})]}),e.jsxs("div",{className:"space-y-3 pt-4 border-t border-neutral-100",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("label",{className:"text-xs font-bold text-neutral-500 uppercase flex items-center gap-2",children:[e.jsx(Be,{size:14})," Script (",x.length,")"]}),e.jsxs("button",{type:"button",onClick:()=>{var o;return h([...x,{speakerName:((o=S[0])==null?void 0:o.name)||"",text:""}])},disabled:S.length===0,className:"px-3 py-1.5 bg-neutral-900 text-white rounded-lg font-bold text-xs flex items-center gap-1.5 hover:bg-neutral-800 disabled:opacity-50 transition-colors",children:[e.jsx(Me,{size:14})," Add Line"]})]}),e.jsx("div",{className:"space-y-2",children:x.map((o,N)=>e.jsxs("div",{className:"flex gap-2 items-start animate-in slide-in-from-top-2",children:[e.jsx("select",{value:o.speakerName,onChange:E=>{const g=[...x];g[N].speakerName=E.target.value,h(g)},className:"w-24 shrink-0 px-2 py-2 bg-neutral-50 border border-neutral-200 rounded-lg text-[10px] font-black uppercase tracking-wider outline-none focus:ring-1 focus:ring-neutral-900",children:S.map(E=>e.jsx("option",{value:E.name,children:E.name||"?"},E.name))}),e.jsxs("div",{className:"flex-1 flex flex-col gap-1",children:[e.jsx("textarea",{value:o.text,onChange:E=>{const g=[...x];g[N].text=E.target.value,h(g)},rows:2,placeholder:"Speech...",className:"w-full px-3 py-2 bg-neutral-50 border border-neutral-200 rounded-xl text-xs font-medium focus:ring-1 focus:ring-neutral-900 outline-none resize-none"}),e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("label",{className:"text-[8px] font-black text-neutral-400 uppercase",children:"Emoji"}),e.jsx("input",{value:o.icon||"",onChange:E=>{const g=[...x];g[N].icon=E.target.value,h(g)},className:"bg-neutral-50 border border-neutral-100 rounded px-2 py-1 text-xs w-12",placeholder:"ðŸ˜Š"})]})]}),e.jsx("button",{type:"button",onClick:h.bind(null,x.filter((E,g)=>g!==N)),className:"p-2 text-neutral-300 hover:text-red-500",children:e.jsx(we,{size:14})})]},N))})]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-8 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest",children:[e.jsx(st,{size:14})," Save Conversation"]})})]})}):null},ps=({isOpen:r,onClose:_,onSave:c,initialData:t})=>{const[A,$]=s.useState(""),[i,b]=s.useState([]),[f,S]=s.useState(""),[C,x]=s.useState([]),[h,j]=s.useState(!1),[O,w]=s.useState(!1),[X,M]=s.useState(null),[U,B]=s.useState(!1),{showToast:o}=Le();s.useEffect(()=>{var T;r&&($((t==null?void 0:t.title)||""),S(((T=t==null?void 0:t.tags)==null?void 0:T.join(", "))||""),x((t==null?void 0:t.audioLinks)||[]),t!=null&&t.scriptItems&&t.scriptItems.length>0?b(t.scriptItems):t!=null&&t.content?b([{id:Date.now().toString(),type:"script",content:t.content}]):b([{id:Date.now().toString(),type:"script",content:""}]))},[r,t]);const N=T=>{if(T.preventDefault(),!A.trim()){o("Title is required","error");return}const F=i.filter(J=>J.content.trim());if(F.length===0){o("At least one script item is required","error");return}const D=F.filter(J=>J.type==="script").map(J=>J.content).join(`

`);c({title:A.trim(),content:D,scriptItems:F,tags:f.split(",").map(J=>J.trim()).filter(Boolean),audioLinks:C})},E=T=>{b(F=>[...F,{id:Date.now().toString()+Math.random(),type:T,content:""}])},g=T=>{b(F=>F.filter((D,J)=>J!==T))},q=(T,F)=>{b(D=>D.map((J,te)=>te===T?{...J,...F}:J))},de=T=>{const F=T.result||T,D=F.content||F.rewritten||F.text;D&&typeof D=="string"?(b([{id:Date.now().toString(),type:"script",content:D}]),j(!1),o("Content refined!","success")):o("Could not parse AI response.","error")},se=T=>{const{url:F,transcript:D}=T;x(J=>[...J,F]),D&&(M(D),B(!0))},oe=()=>{X&&b(T=>[...T,{id:Date.now().toString(),type:"script",content:X}]),M(null),B(!1)},ce=T=>{x(F=>F.filter((D,J)=>J!==T))};return r?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-300",children:e.jsxs("form",{onSubmit:N,className:"bg-white w-full max-w-4xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col h-[90vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-start shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:t?"Edit Free Talk":"New Free Talk"}),e.jsx("p",{className:"text-sm text-neutral-500",children:"Practice speaking natural paragraphs."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>j(!0),className:"p-2 bg-indigo-50 text-indigo-600 rounded-xl hover:bg-indigo-100 transition-colors",title:"Refine with AI",children:e.jsx(Ge,{size:18})}),e.jsx("button",{type:"button",onClick:_,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full",children:e.jsx(je,{size:20})})]})]}),e.jsxs("main",{className:"p-8 space-y-6 overflow-y-auto custom-scrollbar flex-1 bg-neutral-50/30",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Title / Topic"}),e.jsx("input",{value:A,onChange:T=>$(T.target.value),placeholder:"e.g., My Hometown",className:"w-full px-4 py-3 bg-white border border-neutral-200 rounded-xl font-medium focus:ring-2 focus:ring-neutral-900 outline-none shadow-sm",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("label",{className:"block text-xs font-bold text-neutral-500",children:"Reference Audio"}),e.jsxs("button",{type:"button",onClick:()=>w(!0),className:"flex items-center gap-1 text-[10px] font-bold text-indigo-600 hover:bg-indigo-50 px-2 py-1 rounded-lg transition-colors",children:[e.jsx(Me,{size:12})," From Server"]})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[C.length===0&&e.jsx("p",{className:"text-[10px] text-neutral-400 italic px-2 col-span-full",children:"No reference audio attached."}),C.map((T,F)=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-white rounded-lg border border-neutral-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 overflow-hidden",children:[e.jsx(pt,{size:14,className:"text-emerald-500 shrink-0"}),e.jsx("span",{className:"text-xs font-mono text-neutral-600 truncate",children:decodeURIComponent(T.split("/").pop()||"file")})]}),e.jsx("button",{type:"button",onClick:()=>ce(F),className:"p-1 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-full",children:e.jsx(je,{size:14})})]},F))]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(lt,{size:12})," Content Blocks"]}),e.jsx("div",{className:"space-y-3",children:i.map((T,F)=>e.jsxs("div",{className:`group relative p-4 rounded-2xl border transition-all ${T.type==="note"?"bg-yellow-50/50 border-yellow-200":"bg-white border-neutral-200 shadow-sm"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"p-1.5 bg-neutral-100 rounded-md cursor-move text-neutral-400",children:e.jsx(Zt,{size:12})}),e.jsxs("div",{className:"flex bg-neutral-100 p-0.5 rounded-lg",children:[e.jsx("button",{type:"button",onClick:()=>q(F,{type:"script"}),className:`px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-all ${T.type==="script"?"bg-white shadow-sm text-neutral-900":"text-neutral-400 hover:text-neutral-600"}`,children:"Script"}),e.jsx("button",{type:"button",onClick:()=>q(F,{type:"note"}),className:`px-2 py-1 rounded-md text-[10px] font-bold uppercase transition-all ${T.type==="note"?"bg-white shadow-sm text-yellow-600":"text-neutral-400 hover:text-neutral-600"}`,children:"Note"})]})]}),e.jsx("button",{type:"button",onClick:()=>g(F),className:"p-1.5 text-neutral-300 hover:text-red-500 hover:bg-red-50 rounded-lg opacity-0 group-hover:opacity-100 transition-all",children:e.jsx(we,{size:14})})]}),e.jsx("textarea",{value:T.content,onChange:D=>q(F,{content:D.target.value}),placeholder:T.type==="script"?"Enter speech text...":"Enter notes, cues, or reminders...",className:`w-full p-3 rounded-xl outline-none resize-none text-sm leading-relaxed min-h-[100px] ${T.type==="note"?"bg-yellow-50/50 placeholder:text-yellow-300/50 text-yellow-900 italic":"bg-neutral-50 focus:bg-white focus:ring-2 focus:ring-neutral-900 placeholder:text-neutral-300"}`})]},T.id))}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{type:"button",onClick:()=>E("script"),className:"flex-1 py-3 border-2 border-dashed border-neutral-200 rounded-xl text-neutral-400 font-bold text-xs hover:border-neutral-400 hover:text-neutral-600 transition-all flex items-center justify-center gap-2",children:[e.jsx(Nt,{size:14})," Add Script"]}),e.jsxs("button",{type:"button",onClick:()=>E("note"),className:"flex-1 py-3 border-2 border-dashed border-yellow-200 rounded-xl text-yellow-600/50 font-bold text-xs hover:border-yellow-400 hover:text-yellow-700 transition-all flex items-center justify-center gap-2 bg-yellow-50/30",children:[e.jsx(kt,{size:14})," Add Note"]})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"block text-xs font-bold text-neutral-500 flex items-center gap-1",children:[e.jsx(at,{size:12})," Tags"]}),e.jsx("input",{value:f,onChange:T=>S(T.target.value),placeholder:"part1, personal...",className:"w-full px-4 py-3 bg-white border border-neutral-200 rounded-xl font-medium text-sm shadow-sm"})]})]}),e.jsx("footer",{className:"px-8 py-6 border-t border-neutral-100 flex justify-end shrink-0 bg-neutral-50/50 rounded-b-[2.5rem]",children:e.jsxs("button",{type:"submit",className:"px-6 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-lg",children:[e.jsx(st,{size:14})," Save"]})})]})}),h&&e.jsx(nt,{isOpen:h,onClose:()=>j(!1),type:"REFINE_UNIT",title:"Refine Free Talk",description:"Improve vocabulary and grammar for a higher band score.",initialData:{request:""},onGeneratePrompt:T=>ds(i.map(F=>F.content).join(`
`),T.request),onJsonReceived:de,actionLabel:"Refine",closeOnSuccess:!0}),e.jsx(Qt,{isOpen:O,onClose:()=>w(!1),onSelect:se,type:"audio",title:"Select Audio"}),e.jsx(We,{isOpen:U,title:"Create Script From Audio?",message:"This audio file includes a transcript. Do you want to create a new script block from it?",confirmText:"Create Script",isProcessing:!1,onConfirm:oe,onClose:()=>B(!1),icon:e.jsx(lt,{size:40,className:"text-indigo-500"}),confirmButtonClass:"bg-indigo-600 text-white hover:bg-indigo-700 shadow-indigo-200"})]}):null},hs=({text:r})=>{const _=r.split(/({.*?}|\[.*?\]|<.*?>)/g);return e.jsx(e.Fragment,{children:_.map((c,t)=>c.startsWith("{")&&c.endsWith("}")?e.jsx("span",{className:"mx-0.5 px-1 py-0.5 rounded bg-amber-100 text-amber-800 font-bold font-mono text-[0.9em] border border-amber-200 inline-block shadow-sm",children:c.slice(1,-1)},t):c.startsWith("[")&&c.endsWith("]")?e.jsxs("span",{className:"mx-1 inline-flex items-center gap-1.5 text-[10px] text-sky-700 bg-sky-100 border border-sky-200 px-2 py-1 rounded-full font-medium",children:[e.jsx(mt,{size:12}),c.slice(1,-1)]},t):e.jsx("span",{children:c},t))})},ms=({isOpen:r,onClose:_,item:c})=>{const[t,A]=s.useState(new Set),[$,i]=s.useState(null),b=s.useRef([]);if(!r||!c)return null;const f=h=>{A(j=>{const O=new Set(j);return O.has(h)?O.delete(h):O.add(h),O})},S=h=>{const j=h.replace(/{|}/g,"");i(j)},C=h=>{b.current.push(h)},x=async()=>{if(b.current.length>0){const h=Math.round(b.current.reduce((j,O)=>j+O,0)/b.current.length);await ze({...c,bestScore:h,updatedAt:Date.now()})}_(),b.current=[]};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-2xl rounded-[2.5rem] shadow-2xl border border-neutral-200 flex flex-col max-h-[85vh]",children:[e.jsxs("header",{className:"px-8 py-6 border-b border-neutral-100 flex justify-between items-center shrink-0",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900",children:c.standard}),e.jsx("p",{className:"text-xs text-neutral-500 font-bold mt-1",children:"Native Expressions Practice"})]}),e.jsx("button",{type:"button",onClick:x,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(je,{size:24})})]}),e.jsx("main",{className:"flex-1 overflow-y-auto p-8 space-y-4 custom-scrollbar bg-neutral-50/30",children:c.answers.map((h,j)=>{const O=t.has(j);return e.jsxs("div",{className:"bg-white p-5 rounded-3xl border border-neutral-200 shadow-sm space-y-3 relative overflow-hidden group",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[h.lastResult==="correct"&&e.jsx("div",{className:"bg-green-100 text-green-600 p-1 rounded-full",title:"Mastered in Game",children:e.jsx(Ct,{size:12})}),h.lastResult==="incorrect"&&e.jsx("div",{className:"bg-red-100 text-red-600 p-1 rounded-full",title:"Needs Practice",children:e.jsx(St,{size:12})}),e.jsx("span",{className:`px-2 py-0.5 rounded text-[8px] font-black uppercase border ${h.tone==="academic"?"bg-purple-50 text-purple-700 border-purple-100":h.tone==="semi-academic"?"bg-blue-50 text-blue-700 border-blue-100":"bg-neutral-50 text-neutral-600 border-neutral-100"}`,children:h.tone})]}),e.jsx("span",{className:"text-sm font-bold text-neutral-700 leading-snug",children:h.anchor})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:()=>f(j),className:`p-2 rounded-lg transition-all ${O?"text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:O?e.jsx(Tt,{size:16}):e.jsx(At,{size:16})}),O&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>Ce(h.sentence.replace(/{|}/g,"")),className:"p-2 text-neutral-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all",title:"Listen",children:e.jsx(Fe,{size:16})}),e.jsx("button",{onClick:()=>S(h.sentence),className:"p-2 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-all",title:"Practice Speaking",children:e.jsx($e,{size:16})})]})]})]}),e.jsx("div",{className:"min-h-[1.5rem] flex items-center pt-2 border-t border-neutral-50",children:O?e.jsx("div",{className:"text-base font-medium text-neutral-800 animate-in fade-in slide-in-from-top-1",children:e.jsx(hs,{text:h.sentence})}):e.jsxs("div",{className:"flex gap-1 items-center opacity-30 w-full",children:[e.jsx("div",{className:"h-2 w-12 bg-neutral-200 rounded-full"}),e.jsx("div",{className:"h-2 w-24 bg-neutral-200 rounded-full"}),e.jsx("div",{className:"h-2 w-8 bg-neutral-200 rounded-full"})]})}),h.note&&O&&e.jsxs("div",{className:"text-[10px] text-neutral-400 font-medium italic",children:['"',h.note,'"']})]},j)})}),e.jsx("footer",{className:"px-8 py-4 border-t border-neutral-100 bg-white rounded-b-[2.5rem] flex justify-end",children:e.jsx("button",{onClick:x,className:"px-6 py-2.5 bg-neutral-900 text-white rounded-xl font-black text-[10px] uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-md",children:"Done"})})]}),$&&e.jsx(ht,{target:$,onClose:()=>i(null),onSaveScore:C})]})};function fs(r){const _=r.numberOfChannels,c=r.length*_*2+44,t=new ArrayBuffer(c),A=new DataView(t),$=[];let i,b,f=0,S=0;for(x(1179011410),x(c-8),x(1163280727),x(544501094),x(16),C(1),C(_),x(r.sampleRate),x(r.sampleRate*2*_),C(_*2),C(16),x(1635017060),x(c-S-4),i=0;i<r.numberOfChannels;i++)$.push(r.getChannelData(i));for(;S<c;){for(i=0;i<_;i++)b=Math.max(-1,Math.min(1,$[i][f])),b=(b<0?b*32768:b*32767)|0,A.setInt16(S,b,!0),S+=2;f++}return new Blob([t],{type:"audio/wav"});function C(h){A.setUint16(S,h,!0),S+=2}function x(h){A.setUint32(S,h,!0),S+=4}}const gs=({isOpen:r,onClose:_,item:c})=>{const[t,A]=s.useState(0),[$,i]=s.useState(!1),[b,f]=s.useState(!1),[S,C]=s.useState(null),[x,h]=s.useState(!1),[j,O]=s.useState(!1),[w,X]=s.useState(!0),[M,U]=s.useState(null),[B,o]=s.useState({}),[N,E]=s.useState({}),[g,q]=s.useState(!1),[de,se]=s.useState(""),[oe,ce]=s.useState(null),[T,F]=s.useState("audio/webm"),[D,J]=s.useState(!1),[te,xe]=s.useState(null),Q=s.useRef([]),[d,p]=s.useState(!1),[m]=s.useState(()=>Te()),W=s.useRef(null),I=s.useRef({}),u=s.useRef(new Rt),P=s.useRef(null),{showToast:Y}=Le(),V=()=>{P.current&&(P.current.pause(),P.current.src="",P.current=null),Ze()},l=async()=>{if(V(),u.current.stop(),c&&Q.current.length>0){const a=Math.round(Q.current.reduce((L,z)=>L+z,0)/Q.current.length);await Ie({...c,bestScore:a,updatedAt:Date.now()})}E({}),o({}),ce(null),Q.current=[],_()};s.useEffect(()=>{if(!($||b)||!c)return;let a=!1;return(async()=>{if(t>=c.sentences.length||a)return;const z=c.sentences[t];if(!b&&S&&z.speakerName===S){i(!1),h(!0);return}const G=B[t];if(G&&b)V(),await new Promise(le=>{const H=new Audio(`data:${G.mime};base64,${G.base64}`);P.current=H,H.onended=()=>le(!0),H.onerror=()=>le(!1),H.play().catch(()=>le(!1)),a&&(H.pause(),le(!1))});else{const le=N[t];if(le)V(),await new Promise(H=>{const ee=new Audio(`data:${le.mime};base64,${le.base64}`);P.current=ee,ee.onended=()=>H(!0),ee.onerror=()=>H(!1),ee.play().catch(()=>H(!1)),a&&(ee.pause(),H(!1))});else{const H=c.speakers.find(ae=>ae.name===z.speakerName);let ee=H==null?void 0:H.voiceName,ue=H==null?void 0:H.accentCode;if(!ee){const ae=(H==null?void 0:H.sex)==="male"?"male":"female",re=m.audioCoach.coaches[ae];ee=re.enVoice,ue=re.enAccent}try{const ae=Ne(m),re={text:z.text,language:"en",accent:ue,voice:ee},me=await fetch(`${ae}/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(re)});if(me.ok){const ye=await me.blob(),he=new FileReader,Ke=new Promise(ve=>{he.onloadend=()=>ve(he.result.split(",")[1])});he.readAsDataURL(ye);const Pe=await Ke,rt=me.headers.get("Content-Type")||"audio/aiff";if(E(ve=>({...ve,[t]:{base64:Pe,mime:rt}})),!a){V();const ve=new Audio(`data:${rt};base64,${Pe}`);P.current=ve,await new Promise(Ue=>{ve.onended=()=>Ue(!0),ve.onerror=()=>Ue(!1),ve.play().catch(()=>Ue(!1)),a&&(ve.pause(),Ue(!1))})}}else await Ce(z.text,!0,"en",ee,ue)}catch(ae){console.error("Playback error",ae)}}}!a&&($||b)&&(t<c.sentences.length-1?A(le=>le+1):(i(!1),f(!1)))})(),()=>{a=!0}},[$,b,t,c,S]),s.useEffect(()=>{const a=I.current[t];a&&W.current&&a.scrollIntoView({behavior:"smooth",block:"center"})},[t,$,b,x,w]);const v=t>0||Object.keys(B).length>0,k=a=>{v?U(a):y(a)},y=a=>{V(),i(!1),f(!1),h(!1),A(0),o({}),Q.current=[],C(a),U(null),Y(a?`Role changed to ${a}. Practice reset.`:"Role changed to Spectator. Practice reset.","info")};if(!r||!c||!c.sentences||c.sentences.length===0)return null;const K=c.sentences,ne=K[t],ie=()=>{V(),h(!1),A(0)},pe=()=>{t>0&&(V(),h(!1),A(a=>a-1))},fe=()=>{t<K.length-1&&(V(),h(!1),A(a=>a+1))},ge=async()=>{if(g){u.current.stop(),J(!1);const a=await et();a&&(ce(a.base64),F(a.mimeType)),q(!1)}else{V(),se(""),ce(null);try{await bt(),q(!0),J(!0),u.current.start((a,L)=>se(a+L),a=>se(a))}catch(a){console.error("Failed to start recording",a),q(!1)}}},be=a=>{const L=a!==void 0?B[a]:oe?{base64:oe,mime:T}:null;if(L){V();const z=new Audio(`data:${L.mime};base64,${L.base64}`);P.current=z,z.play()}},qe=()=>{if(oe&&(o(a=>({...a,[t]:{base64:oe,mime:T}})),ne)){const a=zt(ne.text,de);Q.current.push(a.score)}h(!1),se(""),ce(null),t<K.length-1?(A(a=>a+1),i(!0)):i(!1)},Se=async(a,L)=>{V();const z=N[L];if(z){const ae=new Audio(`data:${z.mime};base64,${z.base64}`);P.current=ae,ae.play();return}const G=c.speakers.find(ae=>ae.name===a.speakerName);let le=G==null?void 0:G.voiceName,H=G==null?void 0:G.accentCode;if(!le){const ae=(G==null?void 0:G.sex)==="male"?"male":"female",re=m.audioCoach.coaches[ae];le=re.enVoice,H=re.enAccent}const ee=Ne(m),ue={text:a.text,language:"en",accent:H,voice:le};try{const ae=await fetch(`${ee}/speak`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ue)});if(ae.ok){const re=await ae.blob(),me=new FileReader;me.onloadend=()=>{const he=me.result.split(",")[1],Ke=ae.headers.get("Content-Type")||"audio/aiff";E(Pe=>({...Pe,[L]:{base64:he,mime:Ke}}))},me.readAsDataURL(re);const ye=new Audio(URL.createObjectURL(re));P.current=ye,ye.play()}else Ce(a.text,!1,"en",le,H)}catch{Ce(a.text,!1,"en",le,H)}},Ee=()=>{b?(f(!1),V()):(V(),i(!1),h(!1),f(!0),A(0))},Oe=async()=>{const a=new(window.AudioContext||window.webkitAudioContext),L=[];let z=!1;for(let ee=0;ee<c.sentences.length;ee++){const ue=B[ee],ae=N[ee],re=ue||ae;if(!re)continue;z=!0;const me=atob(re.base64),ye=new Uint8Array(me.length);for(let he=0;he<me.length;he++)ye[he]=me.charCodeAt(he);try{const he=await a.decodeAudioData(ye.buffer);L.push(he)}catch(he){console.warn(`Failed to decode segment ${ee}`,he)}}if(!z||L.length===0)return null;const G=L.reduce((ee,ue)=>ee+ue.length,0),le=a.createBuffer(L[0].numberOfChannels,G,L[0].sampleRate);let H=0;return L.forEach(ee=>{for(let ue=0;ue<ee.numberOfChannels;ue++)le.getChannelData(ue).set(ee.getChannelData(ue),H);H+=ee.length}),le},He=async()=>{if(!d){p(!0),V();try{const a=await Oe();if(!a){Y("No audio segments available to play.","info"),p(!1);return}const L=new(window.AudioContext||window.webkitAudioContext),z=L.createBufferSource();z.buffer=a,z.connect(L.destination),z.onended=()=>p(!1),z.start(0)}catch(a){console.error("Preview failed",a),Y("Failed to preview audio.","error"),p(!1)}}},De=async()=>{if(!j){O(!0),Y("Generating full audio file...","info");try{const a=await Oe();if(!a){Y("No audio segments available to save.","info"),O(!1);return}const L=fs(a),z=URL.createObjectURL(L),G=document.createElement("a");G.href=z,G.download=`Full_Dialogue_${c.title.replace(/\s+/g,"_")}.wav`,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(z),Y("Audio file saved!","success")}catch(a){console.error("Save All failed",a),Y("Error generating audio file.","error")}finally{O(!1)}}},n=Object.keys(B).length>0||Object.keys(N).length>0,R=w?[K[t]]:K,Z=a=>{Q.current.push(a)};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-4xl rounded-[3rem] shadow-2xl border border-neutral-200 flex flex-col h-[85vh] overflow-hidden",children:[e.jsxs("header",{className:"px-4 sm:px-8 py-4 sm:py-6 border-b border-neutral-100 flex flex-col sm:flex-row gap-4 sm:gap-0 sm:justify-between sm:items-center shrink-0 bg-white z-10",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h3",{className:"text-xl font-black text-neutral-900 tracking-tight leading-none",children:c.title}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1 text-[9px] font-black uppercase text-neutral-400",children:[e.jsx(as,{size:10})," Role Play:"]}),e.jsxs("div",{className:"flex bg-neutral-100 p-0.5 rounded-lg",children:[e.jsx("button",{onClick:()=>k(null),className:`px-2 py-1 rounded-md text-[9px] font-black uppercase transition-all ${!S&&!b?"bg-white text-neutral-900 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,children:"Spectator"}),c.speakers.map(a=>e.jsxs("button",{onClick:()=>k(a.name),className:`px-2 py-1 rounded-md text-[9px] font-black uppercase transition-all ${S===a.name?"bg-indigo-600 text-white shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,children:["Act as ",a.name]},a.name))]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-4 w-full sm:w-auto justify-between sm:justify-end",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl gap-1",children:[e.jsxs("button",{onClick:Ee,className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${b?"bg-indigo-600 text-white shadow-lg":"text-neutral-500 hover:text-neutral-900"}`,title:"Play whole conversation non-stop",children:[e.jsx(dt,{size:14}),b?"Stop":"Play All"]}),!b&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:()=>{V(),i(!0),f(!1)},className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${$?"bg-neutral-900 text-white shadow-lg":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Ae,{size:14,fill:"currentColor"})," Play"]}),e.jsxs("button",{onClick:()=>{i(!1),V()},className:`px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all ${$?"text-neutral-500 hover:text-neutral-900":"bg-neutral-900 text-white shadow-lg"}`,children:[e.jsx(Ve,{size:14,fill:"currentColor"})," Pause"]})]})]}),e.jsx("button",{type:"button",onClick:l,className:"p-2 text-neutral-400 hover:bg-neutral-100 rounded-full transition-colors",children:e.jsx(je,{size:24})})]})]}),e.jsx("div",{className:"bg-neutral-50/50 py-6 px-8 border-b border-neutral-100 shrink-0",children:e.jsx("div",{className:"flex justify-center items-end gap-10 md:gap-20",children:c.speakers.map((a,L)=>{const z=ne.speakerName===a.name,G=S===a.name;return e.jsxs("div",{className:"flex flex-col items-center relative group",children:[z&&e.jsxs("div",{className:"absolute -top-12 left-1/2 -translate-x-1/2 bg-neutral-900 text-white px-3 py-1.5 rounded-xl text-lg animate-bounce shadow-xl whitespace-nowrap z-20",children:[ne.icon||"ðŸ’¬",e.jsx("div",{className:"absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-neutral-900 rotate-45"})]}),e.jsx("div",{className:`w-16 h-16 md:w-20 md:h-20 rounded-full flex items-center justify-center text-3xl md:text-4xl transition-all duration-300 ${z?"bg-white scale-110 shadow-2xl ring-4 ring-indigo-500/20":"bg-neutral-200/50 grayscale opacity-40"} ${G?"border-2 border-indigo-500":""}`,children:a.sex==="male"?"ðŸ‘¨":"ðŸ‘©"}),e.jsx("div",{className:`mt-2 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest transition-colors ${z?"bg-neutral-900 text-white":"text-neutral-400 bg-neutral-100"} ${G?"ring-1 ring-indigo-500":""}`,children:G?"YOU":a.name})]},L)})})}),e.jsxs("div",{className:"px-6 py-2 bg-white border-b border-neutral-100 flex items-center justify-between",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-lg gap-1",children:[e.jsxs("button",{onClick:()=>X(!0),className:`px-3 py-1.5 rounded-md text-[9px] font-black uppercase flex items-center gap-1.5 transition-all ${w?"bg-white text-neutral-900 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,title:"Show current turn only",children:[e.jsx(ft,{size:12})," Focus"]}),e.jsxs("button",{onClick:()=>X(!1),className:`px-3 py-1.5 rounded-md text-[9px] font-black uppercase flex items-center gap-1.5 transition-all ${w?"text-neutral-400 hover:text-neutral-600":"bg-white text-neutral-900 shadow-sm"}`,title:"Show full script",children:[e.jsx(vt,{size:12})," Script"]})]}),w&&e.jsxs("div",{className:"flex items-center gap-1 bg-neutral-50 p-1 rounded-lg border border-neutral-100 animate-in fade-in slide-in-from-right-2",children:[e.jsx("button",{onClick:ie,disabled:t===0||x,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(ns,{size:16})}),e.jsx("div",{className:"w-px h-4 bg-neutral-200"}),e.jsx("button",{onClick:pe,disabled:t===0||x,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(ut,{size:16})}),e.jsx("button",{onClick:fe,disabled:t===K.length-1||x,className:"p-1.5 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all rounded hover:bg-white",children:e.jsx(ot,{size:16})})]})]}),e.jsx("main",{ref:W,className:"flex-1 overflow-y-auto p-4 sm:p-6 md:p-8 space-y-4 custom-scrollbar bg-white scroll-smooth pb-48 sm:pb-32",children:R.map((a,L)=>{const z=w?t:L,G=w?!0:L===t,le=S===a.speakerName,H=c.speakers.find(re=>re.name===a.speakerName),ee=(H==null?void 0:H.sex)==="male",ue=B[z]!==void 0,ae=x&&z===t;return e.jsxs("div",{ref:re=>{G&&(I.current[z]=re)},onClick:()=>{!$&&!b&&!x&&!w&&(A(L),V())},className:`flex items-start gap-4 p-4 rounded-[2rem] transition-all border-2 ${G?"bg-indigo-50/30 border-indigo-200 shadow-sm":"border-transparent hover:bg-neutral-50"} ${$||b||x||w?"cursor-default":"cursor-pointer"}`,children:[e.jsx("div",{className:`w-10 h-10 rounded-2xl shrink-0 flex items-center justify-center text-xl shadow-sm ${ee?"bg-blue-100":"bg-pink-100"} ${G?"scale-110 ring-2 ring-white":""}`,children:le?"ðŸŒŸ":a.icon||(ee?"ðŸ‘¨":"ðŸ‘©")}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`text-[10px] font-black uppercase tracking-widest ${G?"text-indigo-600":"text-neutral-400"}`,children:le?`YOU (as ${a.speakerName})`:a.speakerName}),e.jsxs("div",{className:"flex items-center gap-1",children:[ue&&e.jsx("button",{onClick:re=>{re.stopPropagation(),be(z)},className:"p-2 bg-rose-50 text-rose-600 rounded-xl hover:bg-rose-100 transition-all",title:"Listen back to your attempt",children:e.jsx($e,{size:14})}),G&&!$&&!b&&!x&&e.jsxs("div",{className:"flex items-center gap-2 animate-in fade-in zoom-in-95",children:[e.jsx("button",{onClick:re=>{re.stopPropagation(),Se(a,z)},className:"p-2 bg-neutral-900 text-white rounded-xl hover:scale-105 transition-transform",children:e.jsx(Fe,{size:14})}),e.jsx("button",{onClick:re=>{re.stopPropagation(),xe(a.text)},className:"p-2 bg-rose-500 text-white rounded-xl hover:scale-105 transition-transform",children:e.jsx($e,{size:14})})]})]})]}),e.jsx("p",{className:`text-sm md:text-lg leading-relaxed font-bold transition-colors ${G?"text-neutral-900":"text-neutral-500"}`,children:a.text}),ae&&e.jsxs("div",{className:"mt-4 p-6 bg-white border-2 border-indigo-500 rounded-[2rem] shadow-xl animate-in zoom-in-95 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-indigo-600",children:[e.jsx(Et,{size:18}),e.jsx("span",{className:"text-xs font-black uppercase tracking-widest",children:"Your Turn to Speak"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Se(a,z),className:"p-2 bg-neutral-100 text-neutral-600 rounded-lg hover:text-neutral-900 transition-all",title:"Listen to Model",children:e.jsx(Fe,{size:16})}),D&&e.jsx("span",{className:"flex h-2 w-2 rounded-full bg-red-500 animate-ping"})]})]}),e.jsx("div",{className:"min-h-[60px] p-4 bg-neutral-50 rounded-2xl border border-neutral-100 flex flex-col items-center justify-center text-center",children:de?e.jsxs("p",{className:"text-sm font-medium italic text-neutral-800 leading-relaxed",children:['"',de,'"']}):e.jsx("p",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:"Tap mic and read the sentence aloud"})}),e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx("button",{onClick:ge,className:`w-14 h-14 rounded-full flex items-center justify-center transition-all transform active:scale-90 ${g?"bg-red-500 text-white animate-pulse ring-8 ring-red-100":"bg-neutral-900 text-white hover:bg-neutral-800"}`,children:g?e.jsx(gt,{size:24,fill:"white"}):e.jsx($e,{size:24})}),oe&&e.jsx("button",{onClick:()=>be(),className:"p-4 bg-white border border-neutral-200 text-neutral-600 rounded-2xl hover:text-indigo-600 hover:border-indigo-300 transition-all",children:e.jsx(Ae,{size:20,fill:"currentColor"})}),e.jsx("button",{onClick:qe,disabled:g,className:"px-6 py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 disabled:opacity-50",children:"Confirm & Continue"})]})]})]})]},`${z}-${L}`)})}),e.jsxs("footer",{className:"px-4 sm:px-8 py-4 sm:py-6 border-t border-neutral-100 bg-white/80 backdrop-blur-md flex flex-col sm:flex-row gap-4 sm:gap-0 sm:justify-between sm:items-center shrink-0 absolute bottom-0 left-0 right-0 z-20",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:pe,disabled:t===0||x,className:"p-3 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all",children:e.jsx(ut,{size:20})}),e.jsxs("div",{className:"flex flex-col items-center min-w-[80px]",children:[e.jsx("span",{className:"text-[10px] font-black text-neutral-400 uppercase tracking-[0.2em] mb-1",children:"Sentence"}),e.jsxs("span",{className:"text-sm font-black text-neutral-900",children:[t+1," / ",K.length]})]}),e.jsx("button",{onClick:fe,disabled:t===K.length-1||x,className:"p-3 rounded-xl border border-neutral-200 text-neutral-400 hover:text-neutral-900 disabled:opacity-30 transition-all",children:e.jsx(ot,{size:20})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 sm:gap-3 w-full sm:w-auto justify-between sm:justify-end",children:[b?e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-2xl shadow-lg animate-in fade-in",children:[e.jsx(dt,{size:14}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-widest",children:"Full Playback Mode"})]}):x?e.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 bg-indigo-50 rounded-2xl border border-indigo-100 animate-in slide-in-from-right-2",children:[e.jsx(Ge,{size:14,className:"text-indigo-600"}),e.jsx("span",{className:"text-[10px] font-black text-indigo-700 uppercase tracking-widest",children:"Waiting for User"})]}):!$&&e.jsxs("div",{className:"hidden sm:flex items-center gap-2 px-4 py-2 bg-neutral-50 rounded-2xl border border-indigo-100 animate-in fade-in",children:[e.jsx(mt,{size:14,className:"text-neutral-400"}),e.jsx("span",{className:"text-[10px] font-bold text-neutral-500 uppercase tracking-widest",children:"Manual Mode Active"})]}),e.jsxs("button",{onClick:He,disabled:d||!n,className:`px-5 py-3 rounded-2xl font-black text-[10px] uppercase tracking-widest transition-all shadow-md active:scale-95 flex items-center gap-2 disabled:opacity-50 ${d?"bg-amber-100 text-amber-700":"bg-white border border-neutral-200 text-neutral-600 hover:bg-neutral-50"}`,title:"Listen to full audio without downloading",children:[d?e.jsx(Qe,{size:14,className:"animate-spin"}):e.jsx(es,{size:14}),e.jsx("span",{className:"hidden sm:inline",children:d?"Playing...":"Listen Full"})]}),e.jsxs("button",{onClick:De,disabled:j||!n,className:"px-5 py-3 bg-emerald-600 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-emerald-700 transition-all shadow-lg active:scale-95 flex items-center gap-2 disabled:opacity-50",title:"Save all audio (User & AI) to one file",children:[j?e.jsx(Qe,{size:14,className:"animate-spin"}):e.jsx(ts,{size:14}),e.jsx("span",{className:"hidden sm:inline",children:"Save All"})]}),e.jsx("button",{onClick:l,className:"px-8 py-3 bg-neutral-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-neutral-800 transition-all shadow-lg active:scale-95",children:"Finish Session"})]})]})]}),te&&e.jsx(ht,{target:te,onClose:()=>xe(null),onSaveScore:Z}),e.jsx(We,{isOpen:!!M,title:"Switch Role?",message:"Changing roles will reset your current practice progress. Recordings will be lost.",confirmText:"Switch & Reset",isProcessing:!1,onConfirm:()=>y(M),onClose:()=>U(null)})]})},bs=({isOpen:r,onClose:_,onConfirm:c,audioFiles:t,initialData:A})=>{const[$,i]=s.useState(""),[b,f]=s.useState(""),[S,C]=s.useState("");if(s.useEffect(()=>{if(r)if(A){const j=A.filename&&t.includes(A.filename)?A.filename:A.filename||(t.length>0?t[0]:"");i(j),f(A.start||""),C(A.duration||"")}else i(t.length>0?t[0]:""),f(""),C("")},[r,t,A]),!r)return null;const x=j=>{j.preventDefault(),c({filename:$,start:b.trim(),duration:S.trim()})},h=j=>decodeURIComponent(j.split("/").pop()||"");return e.jsx("div",{className:"fixed inset-0 z-[300] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in",children:e.jsxs("div",{className:"bg-white w-full max-w-sm rounded-2xl shadow-2xl border border-neutral-200 p-6",children:[e.jsxs("h3",{className:"text-lg font-black text-neutral-900 mb-4 flex items-center gap-2",children:[A?e.jsx(tt,{size:20,className:"text-indigo-600"}):e.jsx(Fe,{size:20,className:"text-indigo-600"}),A?"Edit Audio Settings":"Mark Audio Segment"]}),e.jsxs("form",{onSubmit:x,className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Source Audio (Optional)"}),e.jsxs("select",{value:$,onChange:j=>i(j.target.value),className:"w-full p-2 bg-neutral-50 border border-neutral-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-neutral-900 outline-none",children:[e.jsx("option",{value:"",children:"None (Use Text-to-Speech)"}),t.map((j,O)=>e.jsx("option",{value:j,children:h(j)},O))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Start (Sec)"}),e.jsx("input",{type:"number",step:"0.1",min:"0",value:b,onChange:j=>f(j.target.value),placeholder:"e.g. 5.5",className:"w-full p-2 bg-neutral-50 border border-neutral-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-neutral-900 outline-none"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-xs font-bold text-neutral-500 uppercase",children:"Duration (Sec)"}),e.jsx("input",{type:"number",step:"0.1",min:"0",value:S,onChange:j=>C(j.target.value),placeholder:"e.g. 10",className:"w-full p-2 bg-neutral-50 border border-neutral-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-neutral-900 outline-none"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-2",children:[e.jsx("button",{type:"button",onClick:_,className:"px-4 py-2 text-neutral-500 font-bold text-xs hover:bg-neutral-100 rounded-lg transition-colors",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-neutral-900 text-white font-bold text-xs rounded-lg hover:bg-neutral-800 transition-colors",children:"Apply"})]})]})]})})},vs=({text:r})=>{const _=r.split(/({.*?}|\[.*?\]\(.*?\)|\[.*?\])/g);return e.jsx("span",{className:"leading-relaxed",children:_.map((c,t)=>c.startsWith("{")&&c.endsWith("}")?e.jsx("span",{className:"text-red-600 font-bold mx-0.5",children:c.slice(1,-1)},t):e.jsx("span",{children:c},t))})},js=({rawText:r,onUpdate:_,readOnly:c=!1,showDash:t=!0,audioLinks:A=[],onPlaySegment:$,fontSize:i="text-lg",compact:b=!1})=>{const[f,S]=s.useState(!1),[C,x]=s.useState(r);s.useEffect(()=>{x(r)},[r]);const h=()=>{_(C),S(!1)},j=()=>{x(r),S(!1)},O=s.useRef(null),[w,X]=s.useState(null),[M,U]=s.useState(!1),[B,o]=s.useState(null),[N,E]=s.useState(null),g=s.useRef(null),q=s.useMemo(()=>{const d=[],p=/({[\s\S]*?}|\[[\s\S]*?\]\([\s\S]*?\)|\[[\s\S]*?\])/g;let m,W=0;for(;(m=p.exec(r))!==null;){m.index>W&&d.push({text:r.slice(W,m.index),type:"text",start:W,end:m.index});let I="text",u=m[0];if(m[0].startsWith("{"))I="highlight",u=m[0].slice(1,-1);else if(m[0].startsWith("["))if(I="audio",m[0].includes("](")){const P=m[0].match(/^\[(.*?)\]/);u=P?P[1]:"error"}else u=m[0].slice(1,-1);d.push({text:m[0],type:I,start:m.index,end:p.lastIndex,displayContent:u}),W=p.lastIndex}return W<r.length&&d.push({text:r.slice(W),type:"text",start:W,end:r.length}),d},[r]),de=()=>{var d;X(null),(d=window.getSelection())==null||d.removeAllRanges(),S(!0)},se=()=>{if(c||f)return;const d=window.getSelection(),p=I=>{if(!I)return null;let u=I.nodeType===3?I.parentElement:I;for(;u&&u!==O.current&&!u.hasAttribute("data-index");)u=u.parentElement;return u&&u.hasAttribute("data-index")?parseInt(u.getAttribute("data-index"),10):null};if(!d||!d.anchorNode||!d.focusNode||d.isCollapsed){X(null);return}const m=p(d.anchorNode),W=p(d.focusNode);if(m===null||W===null){X(null);return}if(m===W&&q[m].type==="text"){let I=d.anchorOffset,u=d.focusOffset;I>u&&([I,u]=[u,I]),X({start:q[m].start+I,end:q[m].start+u,currentType:"text"})}else{const I=Math.min(m,W),u=Math.max(m,W);let P=!1;for(let Y=I;Y<=u;Y++)q[Y].type==="audio"&&(P=!0);X(P?null:{start:q[I].start,end:q[u].end,currentType:"text"})}},oe=d=>{var W,I;if(!w)return;const{start:p,end:m}=w;if(d==="audio"){o(null),U(!0);return}if(d==="clear"){const u=r.slice(0,p),P=r.slice(p,m);let Y=P;P.startsWith("{")?Y=P.slice(1,-1):P.startsWith("[")&&(P.includes("](")?Y=((W=P.match(/^\[(.*?)\]/))==null?void 0:W[1])||"":Y=P.slice(1,-1));const V=r.slice(m);_(u+Y+V)}else{const u=r.slice(0,p),P=r.slice(p,m),Y=r.slice(m);_(`${u}{${P}}${Y}`)}X(null),(I=window.getSelection())==null||I.removeAllRanges()},ce=()=>{if(!w||w.currentType!=="audio")return;const p=r.slice(w.start,w.end).match(/\((.*?)\)$/);if(p){const m=p[1].split("|");o({filename:m[0]||"",start:m[1]||"",duration:m[2]||""})}else o(null);U(!0)},T=d=>{var k;if(!w)return;const{start:p,end:m,currentType:W}=w,I=r.slice(0,p);let u=r.slice(p,m);if(W==="audio"){const y=u.match(/^\[(.*?)\]/);y?u=y[1]:u=u.replace(/^\[/,"").replace(/\](\(.*?\))?$/,"")}const P=r.slice(m);let Y=`[${u}]`;const V=d.filename,l=d.start,v=d.duration;if(V||l||v){const y=[];for(V?y.push(V):y.push(""),l?y.push(l):v&&y.push(""),v&&y.push(v);y.length>0&&!y[y.length-1];)y.pop();y.length>0&&(Y+=`(${y.join("|")})`)}_(`${I}${Y}${P}`),U(!1),o(null),X(null),(k=window.getSelection())==null||k.removeAllRanges()},F=(d,p)=>{var W;if(d.stopPropagation(),p.text.includes("](")){const I=p.text.match(/\((.*?)\)$/);if(I){const u=I[1].split("|"),P=u[0]?u[0]:void 0,Y=u[1]?parseFloat(u[1]):void 0,V=u[2]?parseFloat(u[2]):void 0,l=((W=p.displayContent)==null?void 0:W.replace(/[{}]/g,""))||"";$(P,Y,V,l);return}}const m=(p.displayContent||p.text.slice(1,-1)).replace(/[{}]/g,"");Ce(m)},D=(d,p,m)=>{if(c||m==="text")return;g.current&&(clearTimeout(g.current),g.current=null);const W=d.currentTarget.getBoundingClientRect();E(I=>(I==null?void 0:I.idx)===p?I:{idx:p,rect:W,type:m})},J=()=>{c||(g.current=setTimeout(()=>{E(null)},600))},te=()=>{g.current&&(clearTimeout(g.current),g.current=null)},xe=()=>{g.current=setTimeout(()=>{E(null)},600)},Q=d=>{var W;if(!N)return;const p=q[N.idx],m={start:p.start,end:p.end,currentType:p.type};if(X(m),E(null),d==="unmark"){const I=r.slice(0,p.start);let u=p.text;u.startsWith("{")?u=u.slice(1,-1):u.startsWith("[")&&(u.includes("](")?u=((W=u.match(/^\[(.*?)\]/))==null?void 0:W[1])||"":u=u.slice(1,-1));const P=r.slice(p.end);_(I+u+P),X(null)}else if(d==="edit"){const I=p.text.match(/\((.*?)\)$/);if(I){const u=I[1].split("|");o({filename:u[0]||"",start:u[1]||"",duration:u[2]||""})}else o(null);U(!0)}};return e.jsxs("div",{className:"relative h-full flex flex-col group",children:[!c&&e.jsx("div",{className:`absolute top-4 right-6 z-10 flex items-center gap-2 transition-opacity duration-200 ${f?"opacity-100":"opacity-0 group-hover:opacity-100"}`,children:f?e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:h,className:"px-4 py-2 text-xs font-bold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors",children:"Save"}),e.jsx("button",{onClick:j,className:"px-4 py-2 text-xs font-bold text-neutral-700 bg-neutral-200 rounded-lg hover:bg-neutral-300 transition-colors",children:"Cancel"})]}):e.jsx("button",{onClick:de,className:"px-4 py-2 text-xs font-bold text-neutral-700 bg-neutral-100 rounded-lg hover:bg-neutral-200 transition-colors border border-neutral-200 shadow-sm",children:"Edit"})}),e.jsx(bs,{isOpen:M,onClose:()=>{U(!1),o(null),X(null)},onConfirm:T,audioFiles:A,initialData:B}),e.jsxs("div",{className:"sticky top-4 z-50 h-0 flex justify-center pointer-events-none overflow-visible gap-2",children:[(w==null?void 0:w.currentType)==="text"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:d=>{d.preventDefault(),oe("highlight")},className:"pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-neutral-900 text-white shadow-neutral-200 hover:scale-105 active:scale-95",children:[e.jsx(rs,{size:14}),e.jsx("span",{children:"Highlight"})]}),e.jsxs("button",{onClick:d=>{d.preventDefault(),oe("audio")},className:"pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-indigo-600 text-white shadow-indigo-200 hover:scale-105 active:scale-95",children:[e.jsx(Fe,{size:14}),e.jsx("span",{children:"Mark Audio"})]})]}),(w==null?void 0:w.currentType)!=="text"&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:d=>{d.preventDefault(),oe("clear")},className:`pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-white text-rose-600 shadow-rose-100 hover:bg-rose-50 ${w?"translate-y-0 opacity-100 scale-100":"-translate-y-4 opacity-0 scale-95 pointer-events-none"}`,children:[e.jsx(it,{size:14}),e.jsx("span",{children:(w==null?void 0:w.currentType)==="highlight"?"Unhighlight":"Unmark Audio"})]}),(w==null?void 0:w.currentType)==="audio"&&e.jsxs("button",{onClick:d=>{d.preventDefault(),ce()},className:`pointer-events-auto flex items-center gap-1.5 px-4 py-2.5 rounded-full text-xs font-black shadow-xl transition-all transform duration-200 border-2 border-white ring-1 ring-black/5 bg-white text-indigo-600 shadow-indigo-100 hover:bg-indigo-50 ${w?"translate-y-0 opacity-100 scale-100":"-translate-y-4 opacity-0 scale-95 pointer-events-none"}`,children:[e.jsx(tt,{size:14}),e.jsx("span",{children:"Edit Audio"})]})]})]}),N&&e.jsxs("div",{className:"fixed z-[60] flex items-center gap-1 p-1 bg-neutral-900 rounded-lg shadow-xl animate-in fade-in zoom-in-95",style:{top:N.rect.top-40,left:N.rect.left+N.rect.width/2-(N.type==="audio"?60:35)},onMouseEnter:te,onMouseLeave:xe,children:[N.type==="audio"&&e.jsx("button",{onClick:()=>Q("edit"),className:"p-2 text-white hover:bg-white/20 rounded-md transition-colors",title:"Edit",children:e.jsx(tt,{size:14})}),e.jsx("button",{onClick:()=>Q("unmark"),className:"p-2 text-rose-400 hover:bg-white/20 rounded-md transition-colors",title:"Unmark",children:e.jsx(it,{size:14})}),e.jsx("div",{className:"absolute top-full left-1/2 -translate-x-1/2 -mt-1 border-4 border-transparent border-t-neutral-900"})]}),f?e.jsx("textarea",{value:C,onChange:d=>x(d.target.value),className:`flex-1 w-full font-mono bg-neutral-50 border-0 focus:ring-0 resize-none ${b?"p-4":"p-6"} ${i}`}):e.jsx("div",{ref:O,className:`font-medium text-neutral-800 leading-relaxed whitespace-pre-wrap select-text cursor-text font-mono ${b?"px-4 py-4":"px-6 pb-8 pt-8"} ${i}`,onMouseUp:se,onKeyUp:se,children:q.map((d,p)=>d.type==="highlight"?e.jsx("span",{"data-index":p,onMouseEnter:m=>D(m,p,"highlight"),onMouseLeave:J,className:"text-red-600 font-bold cursor-pointer hover:bg-red-50 transition-colors rounded mx-0.5 border border-transparent hover:border-red-100",children:d.displayContent},`${p}-${d.start}`):d.type==="audio"?e.jsx("span",{"data-index":p,onClick:m=>F(m,d),onMouseEnter:m=>D(m,p,"audio"),onMouseLeave:J,className:"text-indigo-900 cursor-pointer hover:bg-indigo-100 transition-colors mx-0.5 relative group/audio py-0.5 rounded",title:"Click to listen",children:e.jsx(vs,{text:d.displayContent||"error"})},`${p}-${d.start}`):e.jsx("span",{"data-index":p,children:d.text},`${p}-${d.start}`))})]})},ws=({isOpen:r,onClose:_,item:c})=>{const{showToast:t}=Le(),[A,$]=s.useState("RECORDING"),[i,b]=s.useState(null);s.useEffect(()=>{r&&c?b(c):r||b(null)},[r,c==null?void 0:c.id]);const[f,S]=s.useState(!1),[C,x]=s.useState(0),[h,j]=s.useState(null),[O,w]=s.useState(null),[X,M]=s.useState(!1),[U,B]=s.useState(!1),[o,N]=s.useState(null),[E,g]=s.useState(null),[q,de]=s.useState(0),[se,oe]=s.useState(0),ce=s.useRef(null),[T,F]=s.useState([]),[D,J]=s.useState(null),te=s.useRef(null),xe=s.useRef(null);s.useEffect(()=>{if(!(r&&i)){if(Ze(),Q(),xe.current&&clearInterval(xe.current),j(null),w(null),f){try{et()}catch{}S(!1)}}},[r,i==null?void 0:i.id]),s.useEffect(()=>()=>{te.current&&(te.current.pause(),te.current.src="",te.current=null)},[]);const Q=()=>{te.current&&(te.current.pause(),te.current=null),N(null),g(null),de(0),oe(0),ce.current=null,Ze()},d=(l,v,k,y,K)=>{const ne=l.startsWith("blob:");if(!ne)try{const pe=Te(),fe=Ne(pe);if(l.startsWith("http://")||l.startsWith("https://")){const ge=new URL(l);l=ge.pathname+ge.search}l.startsWith("/")&&(l=`${fe}${l}`)}catch(pe){console.warn("[FreeTalkPracticeModal] URL normalization failed:",pe)}if(!ne){if((v&&o===v||k&&E===k)&&(Q(),!y&&!K))return;Q(),v&&N(v),k&&g(k),de(0),oe(0),ce.current=null,Lt(l,y,K).then(()=>{N(null),g(null),de(0),oe(0)}).catch(()=>{t("Failed to play audio.","error"),N(null),g(null),de(0),oe(0)});return}if((v&&o===v||k&&E===k)&&(Q(),!y&&!K))return;Q();const ie=new Audio(l);te.current=ie,ie.addEventListener("loadedmetadata",()=>{oe(ie.duration),y&&(ie.currentTime=y)}),ie.addEventListener("timeupdate",()=>{de(ie.currentTime),ce.current!==null&&ie.currentTime>=ce.current&&(ie.pause(),Q())}),ie.addEventListener("ended",()=>{Q()}),ie.addEventListener("error",()=>{t("Failed to play audio.","error"),Q()}),v&&N(v),k&&g(k),y&&K&&(ce.current=y+K),ie.play().catch(pe=>{console.error("Play error",pe),Q()})},p=l=>{const v=Number(l.target.value);de(v),te.current?(te.current.currentTime=v,o===null&&h&&(te.current.play().catch(()=>{t("Failed to play audio.","error")}),N("preview"))):Ot(v)};s.useEffect(()=>{if(te.current||!o&&!E)return;const l=window.setInterval(()=>{const v=It();v&&(de(v.currentTime||0),oe(v.duration||0))},100);return()=>window.clearInterval(l)},[o,E]);const m=async()=>{if(f){xe.current&&clearInterval(xe.current),S(!1);try{const l=await et();if(l){const v=atob(l.base64),k=new Array(v.length);for(let ne=0;ne<v.length;ne++)k[ne]=v.charCodeAt(ne);const y=new Uint8Array(k),K=new Blob([y],{type:l.mimeType});j(K),w(K)}}catch(l){console.error("Recording error",l),t("Failed to process recording.","error")}}else{Q(),j(null),w(null);try{await bt(),S(!0),x(0),xe.current=setInterval(()=>{x(l=>l+1)},1e3)}catch{t("Could not access microphone.","error")}}},W=()=>{Q(),j(null),w(null),x(0),B(!1)},I=async()=>{if(!(!O||!i)){M(!0);try{const l=Te(),v=Ne(l);let k="Recordings";try{const ie=await fetch(`${v}/api/audio/mappings`);if(ie.ok){const pe=await ie.json(),fe=Object.keys(pe);fe.length>0&&(k=fe[0])}}catch{}const y=`rec_${Date.now()}.webm`,K=new FormData;K.append("mapName",k),K.append("filename",y),K.append("audio",O,y);const ne=await fetch(`${v}/api/audio/upload`,{method:"POST",body:K});if(ne.ok){const ie=await ne.json(),pe=C,ge=[{id:`rec-${Date.now()}`,url:`/api/audio/stream/${k}/${y}`,mapName:k,filename:y,timestamp:Date.now(),duration:pe},...T];F(ge);const be={...i,userRecordings:ge,updatedAt:Date.now()};b(be),await ke(be),t("Recording saved!","success"),j(null),w(null),x(0)}else t("Upload failed.","error")}catch(l){console.error("Save error",l),t("Failed to save recording.","error")}finally{M(!1)}}},u=async()=>{if(!D||!i)return;const l=Te(),v=Ne(l);try{await fetch(`${v}/api/audio/file?mapName=${encodeURIComponent(D.mapName)}&filename=${encodeURIComponent(D.filename)}`,{method:"DELETE"})}catch{console.warn("Server delete failed, removing local reference anyway.")}const k=T.filter(K=>K.id!==D.id);F(k);const y={...i,userRecordings:k,updatedAt:Date.now()};b(y),await ke(y),t("Recording deleted.","success"),J(null)},P=async(l,v)=>{if(!i)return;const k=i.scriptItems?[...i.scriptItems]:[];if(k[l]){k[l]={...k[l],content:v};const y={...i,scriptItems:k,updatedAt:Date.now()};b(y),await ke(y)}},Y=(l,v,k,y)=>{if(l&&(i!=null&&i.audioLinks)){const K=i.audioLinks.find(ne=>ne.endsWith(l))||l;d(K,K,null,v,k)}else Ce(y)};if(!r||!i)return null;const V=l=>{if(!l||isNaN(l))return"0:00";const v=Math.floor(l/60),k=Math.floor(l%60);return`${v}:${k.toString().padStart(2,"0")}`};return e.jsxs("div",{className:"fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",children:[e.jsxs("div",{className:"bg-white w-full max-w-6xl rounded-[3rem] shadow-2xl border border-neutral-200 flex flex-col h-[85vh] overflow-hidden relative",children:[e.jsxs("div",{className:"px-8 py-4 border-b border-neutral-100 flex items-center justify-between bg-white z-10",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl",children:[e.jsxs("button",{onClick:()=>{$("RECORDING")},className:`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 ${A==="RECORDING"?"bg-white shadow-sm text-rose-600":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(ls,{size:14})," Essay"]}),e.jsxs("button",{onClick:()=>{$("PLAYBACK")},className:`px-4 py-2 rounded-lg text-xs font-black uppercase tracking-wider transition-all flex items-center gap-2 ${A==="PLAYBACK"?"bg-white shadow-sm text-emerald-600":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Ae,{size:14})," Playback"]})]}),e.jsx("h3",{className:"text-xs font-black text-neutral-900 truncate max-w-md hidden md:block",children:i.title})]}),e.jsxs("div",{className:"flex-1 overflow-hidden relative",children:[A==="RECORDING"&&e.jsxs("div",{className:"h-full flex flex-col p-8 overflow-y-auto custom-scrollbar bg-neutral-50/50",children:[e.jsx("button",{onClick:_,className:"absolute top-4 right-4 p-2 text-neutral-400 hover:bg-neutral-100 rounded-full z-50",children:e.jsx(je,{size:20})}),e.jsxs("div",{className:"max-w-5xl mx-auto w-full space-y-6 pb-20",children:[e.jsx("div",{className:"bg-white rounded-2xl border border-neutral-200 shadow-sm overflow-hidden transition-all",children:h?U?e.jsxs("div",{className:"p-4 flex flex-col gap-4 animate-in fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h4",{className:"text-[10px] font-black uppercase text-neutral-400 tracking-widest",children:"Edit Recording"}),e.jsx("button",{onClick:()=>B(!1),className:"text-xs font-bold text-neutral-500 hover:text-neutral-800",children:"Cancel"})]}),e.jsx("div",{className:"flex-1 min-h-[10rem]",children:e.jsx($t,{audioBlob:h,onTrim:l=>{w(l),B(!1),t("Trimmed!","success")},onCancel:()=>B(!1)})})]}):e.jsxs("div",{className:"p-3 flex items-center gap-3 animate-in fade-in",children:[e.jsx("button",{onClick:()=>{if(o==="preview")te.current&&te.current.pause(),N(null);else{const l=URL.createObjectURL(O||h);d(l,"preview",null,q)}},className:`p-2 rounded-full transition-all flex-shrink-0 ${o==="preview"?"bg-indigo-600 text-white":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:o==="preview"?e.jsx(Ve,{size:14,fill:"currentColor"}):e.jsx(Ae,{size:14,fill:"currentColor"})}),e.jsxs("div",{className:"flex-1 flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:"text-[9px] font-mono font-bold text-neutral-400 w-8 text-right flex-shrink-0",children:V(o==="preview"?q:0)}),e.jsx("input",{type:"range",min:"0",max:o==="preview"&&se>0?se:C,value:h||O?q:0,onChange:p,className:"flex-1 h-1.5 bg-neutral-100 rounded-lg appearance-none cursor-pointer accent-indigo-600 min-w-0",disabled:h==null&&O==null}),e.jsx("span",{className:"text-[9px] font-mono font-bold text-neutral-400 w-8 text-left flex-shrink-0",children:V(o==="preview"&&se>0?se:C)})]}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0 border-l border-neutral-100 pl-2 ml-1",children:[e.jsx("button",{onClick:()=>B(!0),className:"p-2 text-neutral-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-all",title:"Edit",children:e.jsx(_e,{size:16})}),e.jsx("button",{onClick:W,className:"p-2 text-neutral-400 hover:text-rose-500 hover:bg-rose-50 rounded-lg transition-all",title:"Discard",children:e.jsx(os,{size:16})}),e.jsx("button",{onClick:I,disabled:X,className:"p-2 text-neutral-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all",title:"Save",children:X?e.jsx(Qe,{size:16,className:"animate-spin"}):e.jsx(Mt,{size:16})})]})]}):e.jsxs("div",{className:"p-4 flex items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("button",{onClick:m,className:`w-12 h-12 rounded-full flex items-center justify-center transition-all transform active:scale-95 shadow-lg ${f?"bg-rose-600 text-white animate-pulse ring-4 ring-rose-100":"bg-rose-600 text-white hover:bg-rose-700"}`,children:f?e.jsx(gt,{size:16,fill:"currentColor"}):e.jsx($e,{size:20})}),e.jsx("div",{children:e.jsx("p",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:f?"Recording...":"Tap to Record"})})]}),f&&e.jsx("div",{className:"flex gap-1 h-4 items-end",children:[...Array(5)].map((l,v)=>e.jsx("div",{className:"w-1 bg-rose-400 rounded-full animate-bounce",style:{height:"100%",animationDelay:`${v*.1}s`}},v))})]})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-[10px] font-black uppercase text-neutral-400 tracking-widest flex items-center gap-2",children:[e.jsx(Ft,{size:14})," Script & Notes"]}),i.scriptItems&&i.scriptItems.length>0?e.jsx("div",{className:"space-y-4",children:i.scriptItems.map((l,v)=>e.jsxs("div",{className:`rounded-3xl border shadow-sm transition-all overflow-hidden ${l.type==="note"?"bg-yellow-50/50 border-yellow-100 text-yellow-900 italic relative":"bg-white border-neutral-200 text-neutral-800"}`,children:[l.type==="note"&&e.jsx("div",{className:"absolute top-0 left-0 w-1 h-full bg-yellow-300/50"}),l.type==="script"?e.jsx(js,{rawText:l.content,onUpdate:k=>P(v,k),audioLinks:i.audioLinks||[],onPlaySegment:Y,showDash:!0,fontSize:"text-xs",compact:!0}):e.jsx("div",{className:"p-4 text-xs font-medium leading-relaxed whitespace-pre-wrap font-mono",children:l.content})]},l.id||v))}):e.jsx("div",{className:"bg-white p-4 rounded-3xl border border-neutral-200 shadow-sm",children:e.jsx("div",{className:"text-xs font-medium text-neutral-800 leading-relaxed whitespace-pre-wrap font-mono",children:i.content})})]})]})]}),A==="PLAYBACK"&&e.jsxs("div",{className:"h-full flex flex-col p-8 overflow-y-auto custom-scrollbar bg-neutral-50/50",children:[e.jsx("button",{onClick:_,className:"absolute top-4 right-4 p-2 text-neutral-400 hover:bg-neutral-100 rounded-full z-50",children:e.jsx(je,{size:20})}),e.jsxs("div",{className:"max-w-5xl mx-auto w-full space-y-8 pb-20",children:[i.audioLinks&&i.audioLinks.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-xs font-black uppercase text-neutral-500 tracking-widest flex items-center gap-2",children:[e.jsx(pt,{size:16})," Reference Audio"]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:i.audioLinks.map((l,v)=>{const k=o===l;return e.jsxs("div",{className:`rounded-2xl border transition-all overflow-hidden ${k?"bg-indigo-50 border-indigo-200 shadow-lg":"bg-white border-neutral-200 hover:border-neutral-300"}`,children:[e.jsx("div",{className:"flex items-center justify-between p-3 gap-3",children:e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("button",{onClick:()=>d(l,l,null),className:`w-12 h-12 rounded-full transition-all flex-shrink-0 flex items-center justify-center ${k?"bg-indigo-600 text-white shadow-md":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:k?e.jsx(Ve,{size:20,fill:"currentColor"}):e.jsx(Ae,{size:20,fill:"currentColor"})}),e.jsx("span",{className:`text-sm font-bold truncate ${k?"text-indigo-800":"text-neutral-800"}`,children:decodeURIComponent(l.split("/").pop()||`Track ${v+1}`)})]})}),k&&e.jsxs("div",{className:"flex items-center gap-2 px-4 pb-3 pt-0 animate-in fade-in slide-in-from-top-1",children:[e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-right",children:V(q)}),e.jsx("input",{type:"range",min:"0",max:se||100,value:q,onChange:p,className:"flex-1 h-1.5 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600"}),e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-left",children:V(se)})]})]},v)})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("h4",{className:"text-xs font-black uppercase text-neutral-500 tracking-widest flex items-center gap-2",children:[e.jsx(ss,{size:16})," Recordings History (",T.length,")"]}),T.length===0?e.jsx("div",{className:"text-center py-8 text-neutral-400 italic text-sm",children:"No recordings yet."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:T.map(l=>{const v=E===l.id;return e.jsxs("div",{className:"flex flex-col bg-white rounded-2xl border border-neutral-200 shadow-sm hover:border-neutral-300 transition-colors overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("button",{onClick:()=>{const k=Te(),y=Ne(k);d(`${y}${l.url}`,null,l.id)},className:`w-12 h-12 rounded-full transition-all flex-shrink-0 flex items-center justify-center ${v?"bg-indigo-600 text-white shadow-md":"bg-indigo-50 text-indigo-600 hover:bg-indigo-100"}`,children:v?e.jsx(Ve,{size:20,fill:"currentColor"}):e.jsx(Ae,{size:20,fill:"currentColor"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:`text-sm font-bold truncate ${v?"text-indigo-800":"text-neutral-800"}`,children:new Date(l.timestamp).toLocaleString()}),e.jsx("p",{className:"text-xs font-medium text-neutral-500",children:V(l.duration||0)})]})]}),e.jsx("button",{onClick:()=>J(l),className:"p-2.5 text-neutral-400 hover:text-red-500 hover:bg-red-50 rounded-full transition-all flex-shrink-0",children:e.jsx(we,{size:18})})]}),v&&e.jsxs("div",{className:"flex items-center gap-2 px-4 pb-3 pt-0 animate-in fade-in slide-in-from-top-1 bg-white",children:[e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-right",children:V(q)}),e.jsx("input",{type:"range",min:"0",max:se||100,value:q,onChange:p,className:"flex-1 h-1.5 bg-indigo-100 rounded-lg appearance-none cursor-pointer accent-indigo-600"}),e.jsx("span",{className:"text-xs font-mono font-bold text-neutral-500 w-10 text-left",children:V(se)})]})]},l.id)})})]})]})]})]})]}),e.jsx(We,{isOpen:!!D,title:"Delete Recording?",message:"This will permanently delete the audio file from the server.",confirmText:"Delete",isProcessing:!1,onConfirm:u,onClose:()=>J(null),confirmButtonClass:"bg-red-600 text-white hover:bg-red-700"})]})},xt="vocab_pro_speaking_card_view",Xe=({score:r})=>r===void 0?null:e.jsxs("span",{className:`text-[10px] font-black px-1.5 py-0.5 rounded border ${r>=80?"bg-green-50 text-green-700 border-green-200":r>=50?"bg-yellow-50 text-yellow-700 border-yellow-200":"bg-red-50 text-red-700 border-red-200"}`,children:[r,"%"]}),Us=({user:r,onNavigate:_})=>{const[c,t]=s.useState([]),[A,$]=s.useState(!0),[i,b]=s.useState(!1),[f,S]=s.useState(()=>Pt(xt,{showTags:!0,compact:!1,resourceType:"ALL"})),C=(n,R)=>S(Z=>({...Z,[n]:R})),[x,h]=s.useState(0),[j,O]=s.useState(12),[w,X]=s.useState(""),[M,U]=s.useState(null),[B,o]=s.useState(!1),[N,E]=s.useState("all"),[g,q]=s.useState("all"),[de,se]=s.useState(!1),[oe,ce]=s.useState(!1),[T,F]=s.useState(!1),[D,J]=s.useState(null),[te,xe]=s.useState(null),[Q,d]=s.useState(null),[p,m]=s.useState(null),[W,I]=s.useState(!1),[u,P]=s.useState(null),[Y,V]=s.useState(null),[l,v]=s.useState(null),{showToast:k}=Le(),y=async(n=!1)=>{n||$(!0);const[R,Z,a]=await Promise.all([Vt(r.id),_t(r.id),Gt(r.id)]),L=[...R.map(z=>({type:"card",data:z})),...Z.map(z=>({type:"conversation",data:z})),...a.map(z=>({type:"free_talk",data:z}))];t(L.sort((z,G)=>G.data.createdAt-z.data.createdAt)),n||$(!1)};s.useEffect(()=>{y()},[r.id]),s.useEffect(()=>{h(0)},[M,j,N,g,f.resourceType,w]),s.useEffect(()=>{Ut(xt,f)},[f]);const K=s.useMemo(()=>f.resourceType!=="ALL"||N!=="all"||g!=="all",[f.resourceType,N,g]),ne=s.useMemo(()=>{const n=w.toLowerCase().trim();return c.filter(R=>{var Z,a;if(n){if(R.type==="card"){if(!R.data.standard.toLowerCase().includes(n))return!1}else if(R.type==="conversation"){if(!R.data.title.toLowerCase().includes(n)&&!(R.data.description||"").toLowerCase().includes(n))return!1}else if(!R.data.title.toLowerCase().includes(n)&&!R.data.content.toLowerCase().includes(n))return!1}if(f.resourceType!=="ALL"&&R.type.toUpperCase()!==f.resourceType||N==="focused"&&!R.data.isFocused||g!=="all"&&R.data.focusColor!==g)return!1;if(M){if(M==="Uncategorized"){if(R.data.path&&R.data.path!=="/")return!1}else if(!((Z=R.data.path)!=null&&Z.startsWith(M))&&!((a=R.data.tags)!=null&&a.includes(M)))return!1}return!0})},[c,M,N,g,f.resourceType,w]),ie=s.useMemo(()=>{const n=x*j;return ne.slice(n,n+j)},[ne,x,j]),pe=async n=>{const R=Date.now();D&&D.id?await ze({...D,...n,updatedAt:R}):await ze({id:`ns-${R}-${Math.random()}`,userId:r.id,createdAt:R,updatedAt:R,...n}),se(!1),y(),k("Saved!","success")},fe=async n=>{const R=Date.now();te&&te.id?await Ie({...te,...n,updatedAt:R}):await Ie({id:`conv-${R}-${Math.random()}`,userId:r.id,createdAt:R,updatedAt:R,title:n.title||"",description:n.description||"",speakers:n.speakers||[],sentences:n.sentences||[],tags:n.tags||[]}),ce(!1),y(),k("Saved!","success")},ge=async n=>{const R=Date.now();Q&&Q.id?await ke({...Q,...n,updatedAt:R}):await ke({id:`ft-${R}-${Math.random()}`,userId:r.id,createdAt:R,updatedAt:R,...n}),F(!1),y(),k("Essay Saved!","success")},be=n=>{n.type==="card"?(J(n.data),se(!0)):n.type==="conversation"?(xe(n.data),ce(!0)):n.type==="free_talk"&&(d(n.data),F(!0))},qe=async()=>{p&&(p.type==="card"?await qt(p.id):p.type==="conversation"?await Ht(p.id):p.type==="free_talk"&&await Dt(p.id),m(null),y(),k("Deleted!","success"))},Se=async(n,R)=>{const Z={...n.data,focusColor:R||void 0,updatedAt:Date.now()};R||delete Z.focusColor,n.type==="card"?await ze(Z):n.type==="conversation"?await Ie(Z):n.type==="free_talk"&&await ke(Z),y()},Ee=async n=>{const R={...n.data,isFocused:!n.data.isFocused,updatedAt:Date.now()};n.type==="card"?await ze(R):n.type==="conversation"?await Ie(R):n.type==="free_talk"&&await ke(R),y()},Oe=n=>{xe(R=>({...R||{},title:n.title,description:n.description,speakers:n.speakers,sentences:n.sentences,tags:n.tags})),I(!1),k("Conversation generated!","success")},He=()=>{t(n=>[...n].sort(()=>Math.random()-.5)),k("Deck shuffled!","success")},De=()=>e.jsxs("div",{className:"flex flex-col gap-4 mb-6",children:[B&&e.jsx(Yt,{items:c.map(n=>n.data),selectedTag:M,onSelectTag:U,forcedView:"tags",title:"Browse Tags",icon:e.jsx(at,{size:16})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center gap-4",children:[e.jsxs("div",{className:"relative w-full sm:w-auto sm:flex-1 max-w-sm",children:[e.jsx(Wt,{className:"absolute left-3.5 top-1/2 -translate-y-1/2 text-neutral-400",size:16}),e.jsx("input",{type:"text",value:w,onChange:n=>X(n.target.value),placeholder:"Search phrases, conversations...",className:"w-full pl-10 pr-4 py-2.5 bg-white border border-neutral-200 rounded-xl text-xs font-bold focus:outline-none focus:ring-2 focus:ring-neutral-900 transition-all shadow-sm"})]}),e.jsxs("div",{className:"flex items-center gap-2 overflow-x-auto w-full sm:w-auto pb-2 sm:pb-0 no-scrollbar",children:[e.jsxs("button",{onClick:()=>C("resourceType","ALL"),className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${f.resourceType==="ALL"?"bg-neutral-900 text-white shadow-md":"bg-white border border-neutral-200 text-neutral-500 hover:text-neutral-900"}`,children:[e.jsx(vt,{size:12})," All"]}),e.jsxs("button",{onClick:()=>C("resourceType","CARD"),className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${f.resourceType==="CARD"?"bg-teal-600 text-white shadow-md":"bg-white border border-neutral-200 text-neutral-500 hover:text-teal-600"}`,children:[e.jsx(ct,{size:12})," Expression"]}),e.jsxs("button",{onClick:()=>C("resourceType","CONVERSATION"),className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${f.resourceType==="CONVERSATION"?"bg-indigo-600 text-white shadow-md":"bg-white border border-neutral-200 text-neutral-500 hover:text-indigo-600"}`,children:[e.jsx(Be,{size:12})," Conversation"]}),e.jsxs("button",{onClick:()=>C("resourceType","FREE_TALK"),className:`flex items-center gap-1.5 px-3 py-2 rounded-lg text-[10px] font-black uppercase tracking-widest transition-all ${f.resourceType==="FREE_TALK"?"bg-cyan-600 text-white shadow-md":"bg-white border border-neutral-200 text-neutral-500 hover:text-cyan-600"}`,children:[e.jsx(Je,{size:12})," Essay"]})]})]})]});return e.jsxs(e.Fragment,{children:[e.jsx(Kt,{title:"Listen & Speak",subtitle:"Master listening comprehension and speaking skills.",icon:e.jsx("img",{src:"https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Microphone.png",className:"w-8 h-8 object-contain",alt:"Speaking"}),config:{},isLoading:A,isEmpty:ne.length===0,emptyMessage:"No items found.",activeFilters:{},onFilterChange:()=>{},pagination:{page:x,totalPages:Math.ceil(ne.length/j),onPageChange:h,pageSize:j,onPageSizeChange:O,totalItems:ne.length},aboveGrid:e.jsx(De,{}),actions:e.jsx(Jt,{viewMenu:e.jsx(Xt,{isOpen:i,setIsOpen:b,hasActiveFilters:K,filterOptions:[{label:"All",value:"ALL",isActive:f.resourceType==="ALL",onClick:()=>C("resourceType","ALL")},{label:"Card",value:"CARD",isActive:f.resourceType==="CARD",onClick:()=>C("resourceType","CARD")},{label:"Conv.",value:"CONVERSATION",isActive:f.resourceType==="CONVERSATION",onClick:()=>C("resourceType","CONVERSATION")},{label:"Essay",value:"FREE_TALK",isActive:f.resourceType==="FREE_TALK",onClick:()=>C("resourceType","FREE_TALK")}],customSection:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-3 py-2 text-[9px] font-black text-neutral-400 uppercase tracking-widest border-b border-neutral-50 flex items-center gap-2",children:[e.jsx(ft,{size:10})," Focus & Status"]}),e.jsxs("div",{className:"p-1 flex flex-col gap-1 bg-neutral-100 rounded-xl mb-2",children:[e.jsx("button",{onClick:()=>E(N==="all"?"focused":"all"),className:`w-full py-1.5 text-[9px] font-black rounded-lg transition-all ${N==="focused"?"bg-white shadow-sm text-red-600":"text-neutral-500 hover:text-neutral-700"}`,children:N==="focused"?"Focused Only":"All Items"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>q(g==="green"?"all":"green"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${g==="green"?"bg-emerald-500 border-emerald-600":"bg-white border-neutral-200 hover:bg-emerald-50"}`}),e.jsx("button",{onClick:()=>q(g==="yellow"?"all":"yellow"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${g==="yellow"?"bg-amber-400 border-amber-500":"bg-white border-neutral-200 hover:bg-amber-50"}`}),e.jsx("button",{onClick:()=>q(g==="red"?"all":"red"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${g==="red"?"bg-rose-500 border-rose-600":"bg-white border-neutral-200 hover:bg-rose-50"}`})]})]})]}),viewOptions:[{label:"Show Tags",checked:f.showTags,onChange:()=>S(n=>({...n,showTags:!n.showTags}))},{label:"Compact",checked:f.compact,onChange:()=>S(n=>({...n,compact:!n.compact}))}]}),browseTags:{isOpen:B,onToggle:()=>{o(!B)}},addActions:[{label:"New Native Expression",icon:Me,onClick:()=>{J(null),se(!0)}},{label:"New Conversation",icon:Be,onClick:()=>{xe(null),ce(!0)}},{label:"New Essay",icon:Je,onClick:()=>{d(null),F(!0)}}],extraActions:e.jsx(e.Fragment,{children:e.jsx("button",{onClick:He,disabled:c.length<2,className:"p-3 bg-white border border-neutral-200 text-neutral-600 rounded-xl hover:bg-neutral-50 active:scale-95 transition-all shadow-sm disabled:opacity-50",title:"Randomize",children:e.jsx(Bt,{size:16})})})}),children:()=>e.jsx(e.Fragment,{children:ie.map(n=>{var R;if(n.type==="card")return e.jsx(Ye,{title:e.jsx("div",{className:"flex items-center gap-2 font-black text-neutral-900",children:n.data.standard}),badge:{label:"Native Expression",colorClass:"bg-teal-50 text-teal-700 border-teal-100",icon:ct},tags:f.showTags?n.data.tags:void 0,compact:f.compact,onClick:()=>P(n.data),focusColor:n.data.focusColor,onFocusChange:Z=>Se(n,Z),isFocused:n.data.isFocused,onToggleFocus:Ee.bind(null,n),isCompleted:n.data.focusColor==="green",actions:e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{onClick:Z=>{Z.stopPropagation(),be(n)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",children:e.jsx(_e,{size:14})}),e.jsx("button",{onClick:Z=>{Z.stopPropagation(),m({id:n.data.id,type:"card"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",children:e.jsx(we,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[n.data.answers.length," variations"]}),e.jsx(Xe,{score:n.data.bestScore})]})})},n.data.id);if(n.type==="conversation")return e.jsx(Ye,{title:n.data.title,badge:{label:"Conversation",colorClass:"bg-indigo-50 text-indigo-700 border-indigo-100",icon:Be},tags:f.showTags?n.data.tags:void 0,compact:f.compact,onClick:()=>V(n.data),focusColor:n.data.focusColor,onFocusChange:Z=>Se(n,Z),isFocused:n.data.isFocused,onToggleFocus:Ee.bind(null,n),actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Z=>{Z.stopPropagation(),be(n)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",title:"Edit",children:e.jsx(_e,{size:14})}),e.jsx("button",{onClick:Z=>{Z.stopPropagation(),m({id:n.data.id,type:"conversation"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",title:"Delete",children:e.jsx(we,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[n.data.sentences.length," lines"]}),e.jsx(Xe,{score:n.data.bestScore})]})})},n.data.id);{const Z=((R=n.data.content.match(/[^.!?]+[.!?]+["']?|[^.!?]+$/g))==null?void 0:R.length)||0,a=n.data.bestScore;return e.jsx(Ye,{title:n.data.title,badge:{label:"Essay",colorClass:"bg-cyan-50 text-cyan-700 border-cyan-100",icon:Je},tags:f.showTags?n.data.tags:void 0,compact:f.compact,onClick:()=>v(n.data),focusColor:n.data.focusColor,onFocusChange:L=>Se(n,L),isFocused:n.data.isFocused,onToggleFocus:Ee.bind(null,n),actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:L=>{L.stopPropagation(),be(n)},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",title:"Edit",children:e.jsx(_e,{size:14})}),e.jsx("button",{onClick:L=>{L.stopPropagation(),m({id:n.data.id,type:"free_talk"})},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",title:"Delete",children:e.jsx(we,{size:14})})]}),children:e.jsx("div",{className:"flex justify-between items-center mt-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-[10px] font-bold text-neutral-400 uppercase tracking-widest",children:[Z," Sentences"]}),e.jsx(Xe,{score:a})]})})},n.data.id)}})})}),e.jsx(us,{isOpen:de,onClose:()=>se(!1),onSave:pe,initialData:D}),e.jsx(xs,{isOpen:oe,onClose:()=>ce(!1),onSave:fe,initialData:te,onOpenAiGen:()=>I(!0)}),e.jsx(ps,{isOpen:T,onClose:()=>F(!1),onSave:ge,initialData:Q}),e.jsx(We,{isOpen:!!p,title:"Delete Item?",message:"This action cannot be undone.",confirmText:"Delete",isProcessing:!1,onConfirm:qe,onClose:()=>m(null),icon:e.jsx(we,{size:40,className:"text-red-500"})}),W&&e.jsx(nt,{isOpen:W,onClose:()=>I(!1),type:"GENERATE_UNIT",title:"AI Conversation Creator",description:"Enter a topic to generate a dialogue.",initialData:{},onGeneratePrompt:n=>cs(n.request),onJsonReceived:Oe,actionLabel:"Generate",closeOnSuccess:!0}),e.jsx(ms,{isOpen:!!u,onClose:()=>{P(null),y(!0)},item:u}),e.jsx(gs,{isOpen:!!Y,onClose:()=>{V(null),y(!0)},item:Y}),e.jsx(ws,{isOpen:!!l,onClose:()=>{v(null),y(!0)},item:l})]})};export{Us as SpeakingCardPage,Us as default};
