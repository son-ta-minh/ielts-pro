import{c as ve,r as n,t as be,j as e,A as Ce,q as ae,s as We,ad as ft,a3 as Ve,i as ie,P as Te,E as bt,D as Ae,af as re,m as le,bI as fe,a2 as Pe,b6 as Ue,bJ as Nt,a as wt,bK as St,bL as oe,G as vt,a1 as Ct,bM as Tt,bN as At,K as Et,bO as ee,ak as ne,$ as Ge,am as ze,bP as jt,l as kt,an as yt,bQ as It}from"./index-D4pHSgEb.js";import{R as Lt,a as Ot}from"./ResourceActions-DfA_7wcy.js";import{T as Rt}from"./TagBrowser-DzOGKL3u.js";import{U as Mt}from"./UniversalCard-C1SprpPo.js";import{p as Ne,W as Dt}from"./markdownParser-YwiAv6Kd.js";import{B as _e}from"./book-text-BLqsTNkK.js";import{H as we,P as Fe}from"./pause-D7hRoiaA.js";import{C as Pt}from"./chevron-left-DpxbAqSw.js";import{u as Ut,G as Gt,S as Be,V as zt}from"./ShelfSearchBar-Brp8ZcDm.js";import{F as Ft,U as Bt,a as $t,M as Wt,A as Vt,R as _t}from"./ShelfModals-Ds_Co6pP.js";import{M as Yt}from"./move-LKd4fC-t.js";import{P as Ht}from"./pen-BrvmOX32.js";import{L as Qt}from"./library-CJ_T5vxG.js";import{F as qt}from"./file-clock-lKYq0Nw8.js";import"./square-check-big-CPjvH1Iu.js";import"./circle-BFYMC2TF.js";import"./palette-Dbh42VXo.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=ve("ClipboardList",[["rect",{width:"8",height:"4",x:"8",y:"2",rx:"1",ry:"1",key:"tgr4d6"}],["path",{d:"M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2",key:"116196"}],["path",{d:"M12 11h4",key:"1jrz19"}],["path",{d:"M12 16h4",key:"n85exb"}],["path",{d:"M8 11h.01",key:"1dfujw"}],["path",{d:"M8 16h.01",key:"18s6g9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=ve("GalleryHorizontalEnd",[["path",{d:"M2 7v10",key:"a2pl2d"}],["path",{d:"M6 5v14",key:"1kq3d7"}],["rect",{width:"12",height:"18",x:"10",y:"3",rx:"2",key:"13i7bc"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=ve("ScrollText",[["path",{d:"M15 12h-5",key:"r7krc0"}],["path",{d:"M15 8h-5",key:"1khuty"}],["path",{d:"M19 17V5a2 2 0 0 0-2-2H4",key:"zz82l3"}],["path",{d:"M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v1a2 2 0 1 1-4 0V5a2 2 0 1 0-4 0v2a1 1 0 0 0 1 1h3",key:"1ph1d7"}]]);function Ee(s){const{currentLesson:d,userRequest:A,language:k,tone:C,coachName:l,task:g,topic:S}=s,R=k==="Vietnamese",T=R?"Vietnamese":"English",m=R?"[Audio-VN]":"[Audio-EN]";let p="",u="",o="",I="";return g==="create_reading"?(p=`Create an immersive, high-impact lesson for a ${s.targetAudience} on: "${S}".`,u=`
       STYLE: COMPACT RICH ARTICLE (READING)
       - **COMPACT FORMAT**: Minimize vertical space. **NO double newlines (

)**. **NO horizontal rules (---)**. Keep the layout dense.
       - Use Markdown Headers (###) to separate sections.
       - **RICH ELEMENTS**: 
         1. **TABLES**: Use strictly for **Comparative Matrices** or **System Maps** at the end. âŒ **PROHIBITED**: Do NOT use tables to enumerate words without contrast or explanation per cell. Use bullet points for lists.
         2. Use **[Tip: ...]** blocks for "Did you know?" or "Examiner Tip".
         3. Use **[HIDDEN: ...]** tags ONLY for **Interactive Q&A**. 
            - **RULE**: The QUESTION must be visible OUTSIDE the tag. Only the ANSWER is inside.
            - Format: "Question? [HIDDEN: Answer]"
         4. Use **[Formula: Part | Part]** for grammar patterns. Format: "[Formula: If | S | V(past)]".
         5. Use **Emojis** to engage the ${s.targetAudience} audience.
       - **EXAMPLES**: Use Markdown Blockquotes (>) for examples.`,I=`
      PEDAGOGICAL FLOW:
      1. **TEACHING**: Teach concepts clearly with nuance and examples.
      2. **CONSOLIDATION**: End with a summary or comparison table.
      
      CRITICAL FORMATTING RULES:
      1. **NO META LABELS**: DO NOT use labels like "Nuance:", "Scenario Change:", "Context:", "Meaning:", "Definition:".
      2. **NATURAL WRITING**: Weave the nuance and context *into* the sentence naturally.
      3. **HEADERS**: Use standard Markdown headers (###) for the specific content topics.

      STRICT TEACHING RULES:
      1. **EXPLAIN EVERY ITEM**: For every vocabulary item, collocation, or idiom:
         - You MUST explain the **Nuance** (Why this word? What does it imply that others don't?).
         - You MUST provide a natural **Example Sentence**.
      2. **COMPARE PARAPHRASES**: Do not just list synonyms. Explain the **Scenario Change**. 
      3. **COACHING FLOW**: Structure the lesson as a guided walkthrough.
      `):g==="convert_to_listening"?(p="TRANSFORM the provided Reading Lesson into a high-quality NATURAL AUDIO SCRIPT.",o=`SOURCE: ${d==null?void 0:d.title}
${d==null?void 0:d.content}`,u=`
    - **Narrative Style**: Convert bullet points into natural spoken sentences.
    - **Context Focus**: For every term, explain 'When' and 'Why'.
    - **Individual Examples**: Provide an example sentence for every phrase mentioned.
    - **Language**: All coaching in ${T}.
    - **Audio Strategy (CRITICAL)**: 
      1. Wrap EVERY sentence in audio tags. 
      2. **NO MIXED LANGUAGES**: Do NOT put English words inside ${m} tags. Split them out into [Audio-EN] tags.
         - âŒ Bad: ${m}Tá»« hello nghÄ©a lÃ  xin chÃ o[/]
         - âœ… Good: ${m}Tá»«[/] [Audio-EN]hello[/] ${m}nghÄ©a lÃ  xin chÃ o[/]`):(p="REFINE the lesson to focus on Contextual Nuance and Visual Clarity.",o=`CURRENT: ${d==null?void 0:d.title}
${d==null?void 0:d.content}
REQUEST: "${A||"Improve layout and examples."}"`,u=`
    - **Teach, Don't List**: Convert any bulleted lists of words into guided explanations.
    - **COMPACT FORMAT**: Minimize vertical space. **NO double newlines (

)**. **NO horizontal rules (---)**.
    - **Rich Formatting**: Incorporate Markdown Tables ONLY for Comparisons/Matrices. âŒ **PROHIBITED**: Do NOT use tables for simple word lists without contrast. Use **[HIDDEN: ...]** ONLY for Q&A reveals (Question outside, Answer inside).
    - **Nuance Mapping**: Explain the difference between similar paraphrases or collocations.
    - **REMOVE QUIZZES**: Strictly remove any [Quiz:], [Select:], or [Multi:] tags. This content is for reading only.`,I=`
    PEDAGOGICAL FLOW:
    1. **TEACHING**: Ensure concepts are explained separately first with nuance and examples.
    2. **SUMMARY**: Ensure the lesson ends with a structural summary. Use a table if applicable.
    
    CRITICAL FORMATTING RULES:
    1. **NO META LABELS**: DO NOT use labels like "Nuance:", "Scenario Change:", "Context:", "Meaning:".
    2. **NATURAL WRITING**: Weave the nuance and context *into* the sentence naturally.
    3. **HEADERS**: Use standard Markdown headers (###).
    `),`You are expert IELTS coach '${l}', acting as a ${C==="friendly_elementary"?"friendly mentor":"professor"}.
    
  TASK: ${p}

  ${o}

  ${I}

  ${u}

  STRICT CONTENT RULES:
  1. NO generic introductions.
  2. MANDATORY: All coaching text in ${T}.
  3. **NO QUIZZES**: Absolutely NO interactive tags ([Quiz], [Select], [Multi]). Provide pure educational content.
  4. **TAGS**: Select tags ONLY from: ["Grammar", "Pattern", "Speaking", "Listening", "Reading", "Writing", "General", "Comparison", "Vocabulary"].
  5. **QUANTITY**: Return EXACTLY ONE tag. Choose the most primary skill only.

  CRITICAL OUTPUT RULES:
  1. **MARKDOWN CODE BLOCK**: You MUST wrap your entire JSON response in a markdown code block (e.g. \`\`\`json { ... } \`\`\`).
  2. **VALID JSON**: The content inside the code block must be valid, parsable JSON.
  3. **NO RAW NEWLINES IN STRINGS**: Inside the "content" string, you MUST use literal '\\n' for line breaks. Do NOT use actual newline characters.
  4. **ESCAPE CHARACTERS**: Properly escape all double quotes and backslashes within strings.

  OUTPUT TEMPLATE:
  \`\`\`json
  {
    "title": "string",
    "description": "string",
    "content": "string",
    "tags": ["string"]
  }
  \`\`\``}function Xt(s,d,A){var T,m,p,u;const k=d.language||"English",l=(d.format||"reading")==="listening",g=k==="Vietnamese"?"[Audio-VN]":"[Audio-EN]",S={word:s.word,meaning:s.meaningVi,family:s.wordFamily,collocations:(T=s.collocationsArray)==null?void 0:T.filter(o=>!o.isIgnored).map(o=>({text:o.text,hint:o.d})),idioms:(m=s.idiomsList)==null?void 0:m.filter(o=>!o.isIgnored).map(o=>({text:o.text,hint:o.d})),paraphrases:(p=s.paraphrases)==null?void 0:p.filter(o=>!o.isIgnored).map(o=>({word:o.word,tone:o.tone,context:o.context})),prepositions:(u=s.prepositions)==null?void 0:u.filter(o=>!o.isIgnored)},R=l?`STYLE: NATURAL SPOKEN AUDIO SCRIPT
       - Structure the content as a natural spoken narrative or conversation.
       - **EVERY SENTENCE** must be wrapped in audio tags.
       - **AUDIO STRATEGY (CRITICAL)**: 
         1. **NO MIXED LANGUAGES**: Do NOT put English words inside ${g} tags. Split them out into [Audio-EN] tags.
            - âŒ Bad: ${g}Tá»« hello nghÄ©a lÃ  xin chÃ o[/]
            - âœ… Good: ${g}Tá»«[/] [Audio-EN]hello[/] ${g}nghÄ©a lÃ  xin chÃ o[/]
       - No Markdown headers (###). Use transitional phrases instead.`:`STYLE: COMPACT RICH TEXTBOOK (READING)
       - **COMPACT FORMAT**: Minimize vertical space. **NO double newlines (

)**. **NO horizontal rules (---)**.
       - Structure the content with Markdown Headers (###) for sections.
       - **RICH ELEMENTS**: 
         1. **TABLES**: Use Markdown Tables strictly for **comparing data** (e.g. Columns: Phrase | Nuance | Context) or **System Maps**. âŒ **PROHIBITED**: Do NOT use tables to enumerate words without contrast or explanation per cell.
         2. Use **[Tip: ...]** blocks for pronunciation tips or common mistakes.
         3. Use **[HIDDEN: ...]** tags ONLY for **Interactive Q&A**. 
            - **RULE**: The QUESTION must be visible OUTSIDE the tag. Only the ANSWER is inside.
            - Format: "Question? [HIDDEN: Answer]"
         4. Use **[Formula: Part | Part]** for grammar patterns. 
            - Format: "[Formula: Subject | Verb | Object]".
         5. Use **Emojis** liberally to make sections distinct.
       - **VISUALS**: Use Blockquotes (>) for ALL example sentences. Never use nested bullets.`;return`You are expert IELTS Coach '${A}'.
  
  TASK: Generate a high-quality ${l?"AUDIO SCRIPT":"READING"} lesson for the word: "${s.word}".
  
  DATA: ${JSON.stringify(S)}

  PEDAGOGICAL FLOW:
  1. **TEACHING**: Teach the word's family, collocations, and nuances.
  2. **SUMMARY**: End with a **System Map** or **Comparison Matrix** (Table) to summarize the word's ecosystem (e.g., Collocation types vs Tones).
  
  CRITICAL FORMATTING RULES:
  1. **NO META LABELS**: DO NOT use labels like "Nuance:", "Scenario Change:", "Context:", "Meaning:", "Definition:", or "Phase 1".
  2. **NATURAL WRITING**: Weave the nuance and context *into* the sentence. 
     - âŒ Bad: "Nuance: Used for formal events."
     - âœ… Good: "This phrase is specifically reserved for formal events..."
  3. **HEADERS**: Use standard Markdown headers (###) for content topics.

  ${R}

  STRICT RULES:
  1. **NO SIMPLE LISTS**: Do not just list the data. Teach it with context and nuance.
  2. **EXAMPLE MANDATE**: Every key term MUST have an example sentence.
  3. **NO QUIZZES**: Do NOT generate [Select:], [Quiz:], or [Multi:] tags. This content is for explanation only.
  4. **TAGS**: Select tags ONLY from: ["Grammar", "Pattern", "Speaking", "Listening", "Reading", "writing", "General", "Comparison", "Vocabulary"].
  5. **QUANTITY**: Return EXACTLY ONE tag. Choose the most primary skill only.

  CRITICAL OUTPUT RULES:
  1. **MARKDOWN CODE BLOCK**: You MUST wrap your entire JSON response in a markdown code block (e.g. \`\`\`json { ... } \`\`\`).
  2. **VALID JSON**: The content inside the code block must be valid, parsable JSON.
  3. **NO RAW NEWLINES IN STRINGS**: Inside the "content" string, you MUST use literal '\\n' for line breaks. Do NOT use actual newline characters.
  4. **ESCAPE CHARACTERS**: Properly escape all double quotes and backslashes within strings.

  OUTPUT TEMPLATE:
  \`\`\`json
  {
    "title": "Mastering: ${s.word}",
    "description": "string (Strategic usage overview)",
    "content": "string (Markdown formatted with \\n for newlines)",
    "tags": ["Vocabulary"]
  }
  \`\`\``}function Ye(s,d,A,k=[]){const C=k.join(", ");return`You are an expert IELTS examiner. 
  
  TASK: Generate a creative and comprehensive PRACTICE TEST based on the following lesson content.
  
  LESSON TITLE: "${s}"
  LESSON CONTENT: "${d}"
  USER REQUEST: "${A||""}"
  TAGS: "${C}"

  AVAILABLE INTERACTIVE TAGS:
  1. **Dropdown**: [Select: Correct | Distractor 1 | Distractor 2]
     - Use for sentence completion, synonyms, or choosing the best fit.
  2. **Multiple Choice**: [Multi: Correct | Distractor 1 | Distractor 2]
     - Use for checking definitions, tones, or concepts.
  3. **Fill-in-the-blank**: [Quiz: Answer]
     - **CONSTRAINT**: Use this ONLY if the answer is absolutely unambiguous (e.g. spelling check, specific term recall) OR if the User Request specifically asks for fill-in/typing questions.

  STRUCTURE STRATEGY:
  Analyze the content and tags.

  **CASE A: VOCABULARY LESSON** (e.g. tags include "Vocabulary", "Vocab", or content is a list of words/phrases)
  If this is primarily a vocabulary lesson, follow this structure:
  1. **Section 1: Vocabulary Selection (3-5 items)**: Use [Select: Correct | Wrong 1 | Wrong 2] to test the nuance of collocations or specific words from the lesson.
  2. **Section 2: Meaning Matching (2-4 items)**: Use [Multi: Correct | Option 2 | Option 3] to match a term to its definition.
  3. **Section 3: Contextual Use (2-4 items)**: Provide short sentences with blanks using [Select: ...] where the user chooses the best synonym for a specific tone.

  **CASE B: OTHER LESSONS** (Grammar, General, Skills, etc.)
  - **Creative Flow**: Design a test flow that best suits the specific concepts taught (e.g., rewriting sentences, identifying errors, filling gaps).
  - Do NOT follow the fixed 3-section structure of Case A unless it fits perfectly.
  - **Contextual**: Focus on testing application in context.

  GENERAL GUIDELINES:
  - **No Repetition**: Do not simply repeat the essay text. Create new sentences or scenarios to test the knowledge.
  - **Language**: Instructions in the same language as the lesson's explanations (Vietnamese/English). Target material in English.

  Return a JSON object:
  {
    "content": "string (Markdown with interactive test components)"
  }`}const Zt=s=>{const{title:d,setTitle:A,description:k,setDescription:C,tagsInput:l,setTagsInput:g,content:S,setContent:R,listeningContent:T,setListeningContent:m,testContent:p,setTestContent:u,isSaving:o,onSave:I,onPractice:F,onCancel:$,onOpenAiRefine:V}=s,[f,B]=n.useState("READING"),[y,j]=n.useState(!1),v=n.useMemo(()=>{let h="";return f==="READING"?h=S:f==="LISTENING"?h=T:h=p,Ne(h)},[S,T,p,f]);return n.useEffect(()=>(window.handleLessonSpeak=h=>{be(h)},()=>{delete window.handleLessonSpeak}),[]),e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 animate-in fade-in duration-300 pb-20",children:[e.jsxs("header",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("button",{onClick:$,className:"flex items-center space-x-2 text-sm font-bold text-neutral-400 hover:text-neutral-900 transition-colors mb-1",children:[e.jsx(Ce,{size:16}),e.jsx("span",{children:"Back to Lesson Library"})]}),e.jsx("h2",{className:"text-3xl font-black text-neutral-900 tracking-tight",children:"Edit Lesson"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:F,disabled:o,className:"px-5 py-3 bg-white border border-neutral-200 text-neutral-600 rounded-xl font-black text-xs flex items-center space-x-2 active:scale-95 uppercase tracking-widest shadow-sm",children:[e.jsx(ae,{size:14}),e.jsx("span",{children:"Read Mode"})]}),e.jsxs("button",{onClick:I,disabled:o,className:"px-6 py-3 bg-neutral-900 text-white rounded-xl font-black text-xs flex items-center space-x-2 transition-all active:scale-95 hover:bg-neutral-800 disabled:opacity-50 uppercase tracking-widest shadow-sm",children:[o?e.jsx(We,{size:14,className:"animate-spin"}):e.jsx(ft,{size:14}),e.jsx("span",{children:o?"Saving...":"Save Lesson"})]})]})]}),e.jsxs("div",{className:"space-y-6 bg-white p-8 rounded-3xl border border-neutral-200 shadow-sm",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"text-[10px] font-black text-neutral-400 uppercase tracking-widest px-1",children:"Lesson Title"}),e.jsx("input",{type:"text",value:d,onChange:h=>A(h.target.value),className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-lg font-bold focus:ring-2 focus:ring-neutral-900 outline-none"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("label",{className:"text-[10px] font-black text-neutral-400 uppercase tracking-widest px-1 flex items-center gap-1",children:[e.jsx(Ve,{size:12})," Tags (Keywords)"]}),e.jsx("input",{type:"text",value:l,onChange:h=>g(h.target.value),placeholder:"e.g. Grammar, Writing Task 2",className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm font-medium focus:ring-2 focus:ring-neutral-900 outline-none"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-[10px] font-black text-neutral-400 uppercase tracking-widest px-1 mb-1",children:"Short Description"}),e.jsx("textarea",{value:k,onChange:h=>C(h.target.value),rows:2,className:"w-full px-4 py-3 bg-neutral-50 border border-neutral-200 rounded-xl text-sm leading-relaxed resize-y focus:ring-2 focus:ring-neutral-900 outline-none"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex justify-between items-center px-1",children:[e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl gap-1",children:[e.jsxs("button",{onClick:()=>{B("READING"),j(!1)},className:`px-4 py-2 text-[10px] font-black uppercase rounded-lg transition-all ${f==="READING"?"bg-white text-neutral-900 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(_e,{size:12,className:"inline mr-1"})," Reading"]}),e.jsxs("button",{onClick:()=>{B("LISTENING"),j(!1)},className:`px-4 py-2 text-[10px] font-black uppercase rounded-lg transition-all ${f==="LISTENING"?"bg-white text-indigo-600 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(we,{size:12,className:"inline mr-1"})," Audio Script"]}),e.jsxs("button",{onClick:()=>{B("TEST"),j(!1)},className:`px-4 py-2 text-[10px] font-black uppercase rounded-lg transition-all ${f==="TEST"?"bg-white text-emerald-600 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Se,{size:12,className:"inline mr-1"})," Test"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:()=>V(f==="READING"?"reading":f==="LISTENING"?"listening":"test"),className:"flex items-center space-x-1.5 px-3 py-1.5 rounded-lg bg-indigo-50 border border-indigo-100 hover:bg-indigo-100 transition-all text-[10px] font-black uppercase text-indigo-600 shadow-sm",children:[e.jsx(ie,{size:12}),e.jsxs("span",{children:["Generate ",f==="LISTENING"?"Audio Script":f]})]}),e.jsxs("button",{onClick:()=>j(!y),className:"flex items-center space-x-1.5 px-3 py-1.5 rounded-lg bg-white border border-neutral-200 hover:bg-neutral-50 transition-all text-[10px] font-black uppercase text-neutral-500 hover:text-neutral-900 shadow-sm",children:[y?e.jsx(Te,{size:12}):e.jsx(bt,{size:12}),e.jsx("span",{children:y?"Edit":"Preview"})]})]})]}),e.jsx("div",{className:"bg-white border border-neutral-200 rounded-2xl shadow-sm h-[500px] relative overflow-hidden",children:y?e.jsx("div",{className:"p-6 prose prose-sm max-w-none prose-headings:font-black prose-p:text-neutral-600 prose-img:rounded-xl prose-img:shadow-md prose-strong:text-neutral-900 prose-a:text-indigo-600 overflow-y-auto absolute inset-0 bg-neutral-50/30",dangerouslySetInnerHTML:{__html:v}}):e.jsx("textarea",{value:f==="READING"?S:f==="LISTENING"?T:p,onChange:h=>{f==="READING"?R(h.target.value):f==="LISTENING"?m(h.target.value):u(h.target.value)},className:"absolute inset-0 w-full h-full p-6 resize-none focus:outline-none text-sm leading-relaxed font-medium text-neutral-900 bg-white font-mono",placeholder:`Write ${f.toLowerCase()} content here...`,spellCheck:!1})})]})]})]})},es=({lesson:s,user:d,onSave:A,onPractice:k,onCancel:C})=>{const[l,g]=n.useState(s.title),[S,R]=n.useState(s.description||""),[T,m]=n.useState(s.path||"/"),[p,u]=n.useState((s.tags||[]).join(", ")),[o,I]=n.useState(s.content),[F,$]=n.useState(s.listeningContent||""),[V,f]=n.useState(s.testContent||""),[B,y]=n.useState(!1),[j,v]=n.useState(null),{showToast:h}=Ae(),P=s.topic1,_=s.topic2;n.useEffect(()=>{if(s.path===void 0&&s.tags){const i=s.tags||[],M=i.find(E=>E.startsWith("/")),b=i.filter(E=>!E.startsWith("/"));m(M||"/"),u(b.join(", "))}else m(s.path||"/"),u((s.tags||[]).join(", "))},[s]);const D=()=>{const i=p.split(",").map(M=>M.trim()).filter(Boolean);return{...s,title:l,description:S,topic1:P,topic2:_,path:T.trim(),tags:i,content:o,listeningContent:F,testContent:V,updatedAt:Date.now()}},J=()=>{y(!0);const i=D();A(i)},O=()=>{y(!0);const i=D();k(i)},K=i=>{var N,w,L;const M=le(),b=M.audioCoach.activeCoach,E=M.audioCoach.coaches[b].name,U=(j==null?void 0:j.format)||i.format;if(U==="test"){const G=p.split(",").map(q=>q.trim()).filter(Boolean);return Ye(l,o,i.request,G)}return Ee({task:U==="listening"?"convert_to_listening":"refine_reading",currentLesson:{title:l,description:S,content:o},userRequest:i.request,language:i.language||((N=d.lessonPreferences)==null?void 0:N.language)||"English",targetAudience:((w=d.lessonPreferences)==null?void 0:w.targetAudience)||"Adult",tone:i.tone||((L=d.lessonPreferences)==null?void 0:L.tone)||"professional_professor",coachName:E})},H=i=>{const{result:M}=i,b=M||i,E=j==null?void 0:j.format;E==="listening"?b.content?($(b.content),h("Listening script updated!","success")):h("Failed to generate listening content.","error"):E==="test"?b.content?(f(b.content),h("Practice test generated!","success")):h("Failed to generate test.","error"):(b.title&&g(b.title),b.description&&R(b.description),b.content&&I(b.content),!p.trim()&&b.tags&&b.tags.length>0&&u(b.tags.join(", ")),h("Lesson content refined!","success")),v(null)};return e.jsxs(e.Fragment,{children:[e.jsx(Zt,{title:l,setTitle:g,description:S,setDescription:R,path:T,setPath:m,tagsInput:p,setTagsInput:u,content:o,setContent:I,listeningContent:F,setListeningContent:$,testContent:V,setTestContent:f,isSaving:B,onSave:J,onPractice:O,onCancel:C,onOpenAiRefine:i=>v({format:i||"reading"})}),j&&e.jsx(re,{isOpen:!!j,onClose:()=>v(null),type:"REFINE_UNIT",title:`Generate ${j.format}`,description:`AI will create the ${j.format} component for this lesson.`,initialData:{...d.lessonPreferences,format:j.format},onGeneratePrompt:K,onJsonReceived:H,actionLabel:"Apply Changes"})]})},ts=s=>{if(!s)return[];const d=s.split(`
`),A=[];let k="Introduction",C=[];const l=()=>{(C.length>0||A.length===0&&k==="Introduction")&&(C.join(`
`).trim()||A.length>0)&&A.push({title:k,content:C.join(`
`)})};return d.forEach(g=>{const S=g.trim().match(/^(#{1,3})\s+(.+)/);S?(l(),k=S[2].trim(),C=[g]):C.push(g)}),l(),A.length>1&&A[0].title==="Introduction"&&!A[0].content.trim()&&A.shift(),A.length>0?A:[{title:"Lesson",content:s}]},ss=({lesson:s,onComplete:d,onEdit:A,onAddSound:k,onAddTest:C})=>{var U;const[l,g]=n.useState("READING"),[S,R]=n.useState("SCROLL"),[T,m]=n.useState(0),[p,u]=n.useState("IDLE"),[o,I]=n.useState(-1),[F,$]=n.useState(!1),[V,f]=n.useState(0),[B,y]=n.useState(!1),j=n.useRef(null),v=n.useRef(!1),h=n.useRef(new Map),P=n.useRef(new Map),_=n.useMemo(()=>l==="READING"?s.content||"":l==="LISTENING"?s.listeningContent||"":s.testContent||"",[s,l]),D=n.useMemo(()=>ts(_),[_]);n.useEffect(()=>{m(0)},[l]),n.useEffect(()=>{const N=w=>{j.current&&!j.current.contains(w.target)&&y(!1)};return document.addEventListener("mousedown",N),()=>document.removeEventListener("mousedown",N)},[]);const J=n.useMemo(()=>{if(S==="SCROLL")return Ne(_);{const N=D[T]||D[0];return Ne((N==null?void 0:N.content)||"")}},[_,S,D,T]),O=n.useMemo(()=>{if(!s.listeningContent)return[];const N=/\[Audio-(VN|EN)\]([\s\S]*?)\[\/\]/gi,w=[];let L;for(;(L=N.exec(s.listeningContent))!==null;)w.push({lang:L[1].toUpperCase()==="VN"?"vi":"en",text:L[2].replace(/\[.*?\]/g,"").trim()});return w},[s.listeningContent]),K=N=>{if(h.current.has(N))return Promise.resolve(h.current.get(N));if(P.current.has(N))return P.current.get(N);const w=O[N],L=St(w.text,w.lang).then(G=>(G&&(h.current.set(N,G),f(q=>q+1)),G));return P.current.set(N,L),L},H=async N=>{for(let w=N;w<O.length&&!v.current;w++)await K(w)},i=async()=>{p==="PAUSED"?(u("PLAYING"),v.current=!1):(v.current=!1,u("PLAYING"),H(0));const N=o===-1?0:o;for(let w=N;w<O.length&&!v.current;w++){I(w);const L=O[w];let G=h.current.get(w);if(G||($(!0),G=await K(w),$(!1)),v.current)break;try{await be(L.text,!0,L.lang,void 0,void 0,G||void 0)}catch(q){console.error("Speech playback error at index",w,q)}}v.current||(u("IDLE"),I(-1),f(0),h.current.clear(),P.current.clear())},M=()=>{v.current=!0,fe(),u("IDLE"),I(-1),f(0),h.current.clear(),P.current.clear(),$(!1)};n.useEffect(()=>(window.handleLessonSpeak=N=>{be(N)},()=>{M(),delete window.handleLessonSpeak}),[]);const b=O.length>0,E=V>=O.length;return n.useEffect(()=>{S==="PAGED"&&window.scrollTo({top:0,behavior:"smooth"})},[T,S]),e.jsxs("div",{className:"max-w-4xl mx-auto space-y-6 pb-40 animate-in fade-in duration-300 relative min-h-screen",children:[e.jsxs("header",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("button",{onClick:d,className:"w-fit flex items-center space-x-2 text-xs font-bold text-neutral-400 hover:text-neutral-900 transition-colors uppercase tracking-wider",children:[e.jsx(Ce,{size:14}),e.jsx("span",{children:"Back to Library"})]}),D.length>1&&e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl",children:[e.jsxs("button",{onClick:()=>R("SCROLL"),className:`p-2 rounded-lg transition-all flex items-center gap-2 text-[10px] font-black uppercase ${S==="SCROLL"?"bg-white text-neutral-900 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,title:"Scroll View",children:[e.jsx(Kt,{size:14})," ",e.jsx("span",{className:"hidden sm:inline",children:"Scroll"})]}),e.jsxs("button",{onClick:()=>R("PAGED"),className:`p-2 rounded-lg transition-all flex items-center gap-2 text-[10px] font-black uppercase ${S==="PAGED"?"bg-white text-indigo-600 shadow-sm":"text-neutral-400 hover:text-neutral-600"}`,title:"Chapter View",children:[e.jsx(Jt,{size:14})," ",e.jsx("span",{className:"hidden sm:inline",children:"Paged"})]})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h2",{className:"text-3xl font-black text-neutral-900 tracking-tight",children:s.title}),e.jsxs("div",{className:"flex bg-neutral-100 p-1 rounded-xl gap-1 w-fit mt-2",children:[e.jsxs("button",{onClick:()=>g("READING"),className:`px-4 py-1.5 text-[10px] font-black uppercase rounded-lg transition-all ${l==="READING"?"bg-white text-neutral-900 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(_e,{size:12,className:"inline mr-1"})," Read"]}),e.jsxs("button",{onClick:()=>g("LISTENING"),className:`px-4 py-1.5 text-[10px] font-black uppercase rounded-lg transition-all ${l==="LISTENING"?"bg-white text-indigo-600 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(we,{size:12,className:"inline mr-1"})," Listen"]}),e.jsxs("button",{onClick:()=>g("TEST"),className:`px-4 py-1.5 text-[10px] font-black uppercase rounded-lg transition-all ${l==="TEST"?"bg-white text-emerald-600 shadow-sm":"text-neutral-500 hover:text-neutral-700"}`,children:[e.jsx(Se,{size:12,className:"inline mr-1"})," Test"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l==="LISTENING"&&b&&e.jsxs("div",{className:"flex items-center gap-2 bg-indigo-50 border border-indigo-100 p-1.5 rounded-2xl shadow-sm animate-in zoom-in-95",children:[p==="PLAYING"?e.jsx("button",{onClick:()=>{u("PAUSED"),fe(),v.current=!0},className:"p-3 bg-white text-indigo-600 rounded-xl shadow-sm hover:bg-neutral-50 transition-all",children:e.jsx(Fe,{size:20,fill:"currentColor"})}):e.jsx("button",{onClick:i,className:"p-3 bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition-all active:scale-95",children:e.jsx(Pe,{size:20,fill:"currentColor"})}),p!=="IDLE"&&e.jsx("button",{onClick:M,className:"p-3 bg-white text-rose-500 rounded-xl hover:bg-rose-50 transition-all",children:e.jsx(Ue,{size:20,fill:"currentColor"})})]}),l==="LISTENING"&&!b&&k&&e.jsxs("button",{onClick:k,className:"flex items-center gap-2 px-6 py-3 bg-indigo-500 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-indigo-600 transition-all shadow-lg active:scale-95",children:[e.jsx(ie,{size:16}),e.jsx("span",{children:"Add Audio"})]}),l==="TEST"&&!s.testContent&&C&&e.jsxs("button",{onClick:C,className:"flex items-center gap-2 px-6 py-3 bg-emerald-500 text-white rounded-2xl font-black text-xs uppercase tracking-widest hover:bg-emerald-600 transition-all shadow-lg active:scale-95",children:[e.jsx(ie,{size:16}),e.jsx("span",{children:"Add Test"})]}),e.jsx("button",{onClick:A,className:"p-3 bg-white border border-neutral-200 text-neutral-600 rounded-2xl hover:bg-neutral-50 hover:text-neutral-900 transition-all shadow-sm active:scale-95",title:"Edit Lesson",children:e.jsx(Te,{size:20})})]})]})]}),e.jsx("div",{className:"bg-white p-8 rounded-[2.5rem] border border-neutral-200 shadow-sm min-h-[400px] relative",children:l==="TEST"&&!s.testContent?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center py-20 text-neutral-300",children:[e.jsx(Se,{size:48,className:"mb-4 opacity-20"}),e.jsx("p",{className:"font-bold text-neutral-400",children:"No practice test available for this lesson."})]}):l==="LISTENING"&&!s.listeningContent?e.jsxs("div",{className:"h-full flex flex-col items-center justify-center py-20 text-neutral-300",children:[e.jsx(we,{size:48,className:"mb-4 opacity-20"}),e.jsx("p",{className:"font-bold text-neutral-400",children:"No listening script available."}),e.jsx("p",{className:"text-xs text-neutral-300 mt-2",children:'Click "Add Audio" to generate one.'})]}):e.jsx("div",{className:"prose prose-sm max-w-none prose-headings:font-black prose-headings:text-neutral-900 prose-p:text-neutral-600 prose-p:leading-relaxed prose-img:rounded-xl prose-img:shadow-md prose-strong:text-neutral-900 prose-a:text-indigo-600",dangerouslySetInnerHTML:{__html:J}})}),S==="PAGED"&&D.length>1&&e.jsxs("div",{className:"fixed bottom-6 left-1/2 -translate-x-1/2 z-40 bg-white/90 backdrop-blur-md p-2 rounded-2xl shadow-xl border border-neutral-200 flex items-center gap-2 animate-in slide-in-from-bottom-4",children:[e.jsx("button",{onClick:()=>m(Math.max(0,T-1)),disabled:T===0,className:"p-3 bg-neutral-100 rounded-xl text-neutral-600 hover:bg-neutral-200 hover:text-neutral-900 disabled:opacity-30 disabled:hover:bg-neutral-100 transition-colors",children:e.jsx(Pt,{size:18})}),e.jsxs("div",{className:"relative px-2",ref:j,children:[e.jsxs("button",{onClick:()=>y(!B),className:"flex flex-col items-center hover:bg-neutral-100 rounded-lg px-2 py-1 transition-colors",children:[e.jsx("span",{className:"text-[9px] font-black uppercase text-neutral-400 tracking-widest",children:"Chapter"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-bold text-sm text-neutral-900 max-w-[120px] truncate",children:D[T].title}),e.jsx(Nt,{size:12,className:"text-neutral-400"})]})]}),B&&e.jsx("div",{className:"absolute bottom-full left-1/2 -translate-x-1/2 mb-3 w-56 bg-white rounded-xl shadow-2xl border border-neutral-100 p-1 animate-in fade-in zoom-in-95 origin-bottom",children:e.jsx("div",{className:"max-h-60 overflow-y-auto custom-scrollbar",children:D.map((N,w)=>e.jsx("button",{onClick:()=>{m(w),y(!1)},className:`w-full text-left px-3 py-2 rounded-lg text-xs font-bold truncate ${w===T?"bg-indigo-50 text-indigo-700":"text-neutral-600 hover:bg-neutral-50"}`,children:N.title},w))})})]}),e.jsx("button",{onClick:()=>m(Math.min(D.length-1,T+1)),disabled:T===D.length-1,className:"p-3 bg-neutral-100 rounded-xl text-neutral-600 hover:bg-neutral-200 hover:text-neutral-900 disabled:opacity-30 disabled:hover:bg-neutral-100 transition-colors",children:e.jsx(wt,{size:18})})]}),l==="LISTENING"&&p!=="IDLE"&&e.jsxs("div",{className:"fixed bottom-10 left-1/2 -translate-x-1/2 bg-neutral-900/95 backdrop-blur-md text-white px-8 py-6 rounded-[2.5rem] shadow-2xl flex flex-col md:flex-row items-center gap-8 animate-in slide-in-from-bottom-8 z-50 border border-neutral-800 ring-4 ring-black/10 w-[95%] max-w-4xl",children:[e.jsxs("div",{className:"flex-1 min-w-0 w-full",children:[e.jsx("div",{className:"flex items-center justify-between mb-3 shrink-0",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em]",children:["Narrating ",o+1," / ",O.length]}),F?e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-0.5 bg-amber-500/20 rounded-full",children:[e.jsx(We,{size:10,className:"animate-spin text-amber-400"}),e.jsx("span",{className:"text-[8px] font-black uppercase text-amber-400 tracking-wider",children:"Buffering..."})]}):!E&&e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-0.5 bg-white/10 rounded-full",children:[e.jsx("div",{className:"w-1 h-1 rounded-full bg-emerald-400"}),e.jsxs("span",{className:"text-[8px] font-black uppercase text-emerald-400 tracking-wider",children:["Downloaded ",V,"/",O.length]})]})]})}),e.jsxs("p",{className:"text-lg font-bold text-neutral-100 leading-relaxed italic line-clamp-2",children:['"',((U=O[o])==null?void 0:U.text)||"...",'"']})]}),e.jsxs("div",{className:"flex items-center gap-5 shrink-0 border-l border-white/10 pl-6 h-full self-stretch md:self-center",children:[e.jsx("button",{onClick:M,className:"p-4 text-neutral-400 hover:text-white transition-colors bg-white/5 rounded-full hover:bg-white/10",children:e.jsx(Ue,{size:24,fill:"currentColor"})}),p==="PLAYING"?e.jsx("button",{onClick:()=>{u("PAUSED"),fe(),v.current=!0},className:"w-16 h-16 bg-white text-neutral-900 rounded-full flex items-center justify-center shadow-lg hover:scale-105 transition-transform",children:e.jsx(Fe,{size:32,fill:"currentColor"})}):e.jsx("button",{onClick:i,className:"w-16 h-16 bg-indigo-500 text-white rounded-full flex items-center justify-center shadow-lg hover:scale-105 transition-transform",children:e.jsx(Pe,{size:32,fill:"currentColor"})})]})]})]})},ns=({user:s,lesson:d,onComplete:A,onEdit:k,onUpdate:C})=>{const[l,g]=n.useState(null),{showToast:S}=Ae(),R=m=>{var o,I,F;const p=le(),u=p.audioCoach.coaches[p.audioCoach.activeCoach].name;return m.format==="test"||l==="test"?Ye(d.title,d.content,m.request,d.tags):Ee({task:"convert_to_listening",currentLesson:{title:d.title,description:d.description,content:d.content},userRequest:m.request,language:m.language||((o=s.lessonPreferences)==null?void 0:o.language)||"English",targetAudience:((I=s.lessonPreferences)==null?void 0:I.targetAudience)||"Adult",tone:m.tone||((F=s.lessonPreferences)==null?void 0:F.tone)||"professional_professor",coachName:u})},T=async m=>{const p=m.result||m,u=m.format||l,o={...d,updatedAt:Date.now()};u==="listening"?(o.listeningContent=p.content,S("Audio script added successfully!","success")):(o.testContent=p.content,S("Practice test added successfully!","success")),await oe(o),C&&C(o),g(null)};return e.jsxs(e.Fragment,{children:[e.jsx(ss,{lesson:d,onComplete:A,onEdit:k,onAddSound:()=>g("listening"),onAddTest:()=>g("test")}),l&&e.jsx(re,{isOpen:!!l,onClose:()=>g(null),type:"GENERATE_AUDIO_SCRIPT",title:l==="listening"?"Add Lesson Sound":"Add Practice Test",description:l==="listening"?"AI will transform this lesson into a podcast script.":"AI will design a separate test based on lesson content.",initialData:{...s.lessonPreferences,format:l},onGeneratePrompt:R,onJsonReceived:T,actionLabel:"Apply Changes",closeOnSuccess:!0})]})},as={filterSchema:[],viewSchema:[]},$e="vocab_pro_lesson_view_settings",vs=({user:s,onStartSession:d,onNavigate:A,onUpdateUser:k})=>{var Me;const[C,l]=n.useState([]),[g,S]=n.useState([]),[R,T]=n.useState([]),[m,p]=n.useState(!0),[u,o]=n.useState(null),[I,F]=n.useState(!1),[$,V]=n.useState(!1),[f,B]=n.useState("ALL"),[y,j]=n.useState("all"),[v,h]=n.useState("all"),[P,_]=n.useState(()=>vt($e,{showDesc:!0,compact:!1})),[D,J]=n.useState(0),[O,K]=n.useState(12),[H,i]=n.useState("list"),[M,b]=n.useState(null),[E,U]=n.useState(null),[N,w]=n.useState(null),[L,G]=n.useState(null),[q,ce]=n.useState(!1),[He,de]=n.useState(!1),[je,ue]=n.useState(!1),[te,Qe]=n.useState(null),{currentShelfName:he,booksOnCurrentShelf:pe,allShelves:se,addShelf:qe,renameShelf:Je,removeShelf:Ke,nextShelf:Xe,prevShelf:Ze,selectShelf:et}=Ut(g,"lesson_books_shelves"),[tt,xe]=n.useState(!1),[st,ge]=n.useState(!1),[Y,me]=n.useState(null),{showToast:X}=Ae();n.useEffect(()=>{Ct($e,P)},[P]);const W=n.useCallback(async()=>{p(!0);try{const[t,c,x]=await Promise.all([Tt(s.id),At(s.id),Et()]),a=[...t.map(r=>({type:"ESSAY",data:r,path:r.path,tags:r.tags,date:r.createdAt}))];l(a.sort((r,z)=>z.date-r.date)),S(c.sort((r,z)=>z.createdAt-r.createdAt)),T(x)}finally{p(!1)}},[s.id]);n.useEffect(()=>{W()},[W]),n.useEffect(()=>{J(0)},[u,f,y,v,O]);const nt=n.useMemo(()=>f!=="ALL"||y!=="all"||v!=="all",[f,y,v]),Q=n.useMemo(()=>C.filter(t=>{var c,x;if(f!=="ALL"&&t.type!==f||y==="focused"&&!t.data.isFocused||v!=="all"&&t.data.focusColor!==v)return!1;if(u){if(u==="Uncategorized"){const a=t.path??(t.tags||[]).find(z=>z.startsWith("/"));if(a&&a!=="/")return!1}else if(!((c=t.path)!=null&&c.startsWith(u))&&!((x=t.tags)!=null&&x.includes(u)))return!1}return!0}),[C,u,f,y,v]),at=n.useMemo(()=>{const t=D*O;return Q.slice(t,t+O)},[Q,D,O]),ot=t=>{Je(t,async(x,a)=>{p(!0);const r=g.filter(z=>{const Z=z.title.split(":");return(Z.length>1?Z[0].trim():"General")===x});await Promise.all(r.map(z=>{const Z=z.title.split(":"),De=Z.length>1?Z.slice(1).join(":").trim():Z[0],mt=`${a}: ${De}`;return ee({...z,title:mt,updatedAt:Date.now()})})),await W()})&&ge(!1)},ke=async()=>{const t={id:`lb-${Date.now()}`,userId:s.id,title:`${he}: New Book`,itemIds:[],createdAt:Date.now(),updatedAt:Date.now(),color:"#1a237e",icon:"ðŸ“˜"};await ee(t),await W(),U(t),i("book_detail"),X("New book created.","success")},it=async t=>{if(!E)return;const c={...E,...t,updatedAt:Date.now()};S(x=>x.map(a=>a.id===c.id?c:a)),U(c),await ee(c)},rt=async t=>{if(!Y)return;const c=Y.title.split(":"),x=c.length>1?c.slice(1).join(":").trim():c[0],a=`${t}: ${x}`,r={...Y,title:a,updatedAt:Date.now()};await ee(r),me(null),await W(),X(`Moved to "${t}".`,"success")},lt=async()=>{N&&(await It(N.id),X("Lesson deleted.","success"),w(null),W())},ct=async t=>{await oe(t),X("Lesson saved!","success"),i(E?"book_detail":"list"),b(null),W()},dt=()=>{const t={id:`lesson-${Date.now()}`,userId:s.id,topic1:"",topic2:"",title:"New Lesson",description:"",content:"",tags:[],createdAt:Date.now(),updatedAt:Date.now()};b(t),i("edit_lesson")},ye=async t=>{const{result:c,preferences:x}=t;JSON.stringify(s.lessonPreferences)!==JSON.stringify(x)&&await k({...s,lessonPreferences:x});const a={id:`lesson-ai-${Date.now()}`,userId:s.id,title:c.title,description:c.description,content:c.content,tags:c.tags||[],createdAt:Date.now(),updatedAt:Date.now(),topic1:"",topic2:""};await oe(a),X("Lesson created with AI!","success"),ce(!1),de(!1),b(a),i("read_lesson"),W()},Ie=async(t,c)=>{const x={...t.data,focusColor:c||void 0,updatedAt:Date.now()};c||delete x.focusColor,await oe(x),l(a=>a.map(r=>r.data.id===t.data.id?{...r,data:{...r.data,focusColor:c||void 0,updatedAt:Date.now()}}:r))},Le=async t=>{const c={...t.data,isFocused:!t.data.isFocused,updatedAt:Date.now()};await oe(c),l(x=>x.map(a=>a.data.id===t.data.id?{...a,data:{...a.data,isFocused:!a.data.isFocused,updatedAt:Date.now()}}:a))},ut=()=>{if(Q.length===0){X("No items to randomize.","info");return}const t=Q[Math.floor(Math.random()*Q.length)];b(t.data),i("read_lesson")},Oe=t=>{et(t),i("shelf")},Re=t=>{U(t),i("book_detail")},ht=[{label:"Topic Lesson (AI)",icon:ie,onClick:()=>ce(!0)},{label:"Word Lesson (AI)",icon:ae,onClick:()=>ue(!0)},{label:"New Lesson (Manual)",icon:Ge,onClick:dt}],pt=t=>{const c=le(),x=c.audioCoach.activeCoach,a=c.audioCoach.coaches[x].name;return Ee({topic:t.topic,language:t.language,targetAudience:t.targetAudience,tone:t.tone,format:t.format,coachName:a,task:"create_reading"})},xt=t=>{if(!te)return"";const c=le(),x=c.audioCoach.activeCoach,a=c.audioCoach.coaches[x].name;return Xt(te,{language:t.language,targetAudience:t.targetAudience,tone:t.tone,format:t.format},a)},gt=t=>{if(t.length===0)return;const c=t[0],x=R.find(a=>a.word.toLowerCase()===c.toLowerCase());x&&(Qe(x),ue(!1),de(!0))};if(H==="read_lesson"&&M)return e.jsx(ns,{user:s,lesson:M,onComplete:()=>i(E?"book_detail":"list"),onEdit:()=>i("edit_lesson"),onUpdate:t=>b(t)});if(H==="edit_lesson"&&M)return e.jsx(es,{lesson:M,user:s,onSave:ct,onPractice:t=>{b(t),i("read_lesson")},onCancel:()=>i(E?"book_detail":"list")});if(H==="book_detail"&&E){const t=new Map(C.map(a=>[a.data.id,a])),c=E.itemIds.map(a=>{const r=t.get(a);return r?{id:a,title:r.data.title,subtitle:r.data.description,data:r.data,focusColor:r.data.focusColor,isFocused:r.data.isFocused}:null}).filter(a=>a!==null),x=C.map(a=>({id:a.data.id,title:a.data.title,subtitle:a.data.description,data:a.data}));return e.jsx(Gt,{book:E,items:c,availableItems:x,onBack:()=>{U(null),i("shelf"),W()},onUpdateBook:it,onAddItem:async a=>{const r={...E,itemIds:Array.from(new Set([...E.itemIds,...a]))};await ee(r),U(r)},onRemoveItem:async a=>{const r={...E,itemIds:E.itemIds.filter(z=>z!==a)};await ee(r),U(r)},onOpenItem:a=>{b(a.data),i("read_lesson")},onEditItem:a=>{b(a.data),i("edit_lesson")},onFocusChange:(a,r)=>Ie({data:a.data},r),onToggleFocus:a=>Le({data:a.data}),itemIcon:e.jsx(ae,{size:16})})}return H==="shelf"?e.jsxs("div",{className:"space-y-6 animate-in fade-in duration-300",children:[e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("button",{onClick:()=>i("list"),className:"w-fit flex items-center gap-2 text-sm font-bold text-neutral-500 hover:text-neutral-900 transition-colors group",children:[e.jsx(Ce,{size:18,className:"group-hover:-translate-x-1 transition-transform"}),e.jsx("span",{children:"Back to Main Library"})]}),e.jsxs("header",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[e.jsxs("div",{className:"shrink-0",children:[e.jsx("h2",{className:"text-3xl font-black text-neutral-900 tracking-tight",children:"Lesson Shelf"}),e.jsx("p",{className:"text-neutral-500 mt-1 font-medium",children:"Browse your lesson collections."})]}),e.jsx(Be,{shelves:se,books:g,onNavigateShelf:Oe,onNavigateBook:Re}),e.jsxs("button",{onClick:()=>xe(!0),className:"px-6 py-3 bg-white border border-neutral-200 text-neutral-600 rounded-xl font-black text-xs flex items-center gap-2 uppercase tracking-widest hover:bg-neutral-50 transition-all shadow-sm",children:[e.jsx(Ft,{size:14})," Add Shelf"]})]})]}),e.jsxs(Bt,{label:he,onNext:se.length>1?Xe:void 0,onPrev:se.length>1?Ze:void 0,actions:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>ge(!0),className:"p-2 bg-white/20 text-white/70 rounded-full hover:bg-white/40 hover:text-white",title:"Rename Shelf",children:e.jsx(Ht,{size:14})}),e.jsx("button",{onClick:Ke,disabled:pe.length>0,className:"p-2 bg-white/20 text-white/70 rounded-full hover:bg-white/40 hover:text-white disabled:opacity-30 disabled:hover:bg-white/20",title:"Remove Empty Shelf",children:e.jsx(ne,{size:14})})]}),isEmpty:pe.length===0,emptyAction:e.jsx("button",{onClick:ke,className:"px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-xl font-bold text-xs uppercase tracking-widest border border-white/20",children:"Create First Book"}),children:[pe.map(t=>{var x;const c=((x=t.title.split(":").pop())==null?void 0:x.trim())||t.title;return e.jsx($t,{id:t.id,title:c,subTitle:`${t.itemIds.length} Items`,icon:e.jsx(ae,{size:24}),color:t.color,titleColor:t.titleColor,titleSize:t.titleSize,titleTop:t.titleTop,titleLeft:t.titleLeft,iconTop:t.iconTop,iconLeft:t.iconLeft,onClick:()=>{U(t),i("book_detail")},actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:a=>{a.stopPropagation(),me(t)},className:"p-1.5 bg-black/30 text-white/60 rounded-full hover:bg-neutral-700 hover:text-white transition-all shadow-sm",title:"Move to Shelf",children:e.jsx(Yt,{size:16})}),e.jsx("button",{onClick:a=>{a.stopPropagation(),G(t)},className:"p-1.5 bg-black/30 text-white/60 rounded-full hover:bg-red-600 hover:text-white transition-all shadow-sm",title:"Delete",children:e.jsx(ne,{size:16})})]})},t.id)}),e.jsx("div",{className:"group translate-y-0",children:e.jsx("div",{className:"relative w-full aspect-[5/7] rounded-lg bg-neutral-800/50 border-2 border-dashed border-neutral-500/50 transition-all duration-300 group-hover:border-neutral-400 group-hover:bg-neutral-800/80 group-hover:shadow-xl flex flex-col items-stretch justify-center overflow-hidden",children:e.jsxs("button",{onClick:ke,className:"flex-1 flex flex-col items-center justify-center p-2 text-center text-neutral-400 hover:bg-white/5 transition-colors",children:[e.jsx(Ge,{size:32,className:"mb-2 text-neutral-500"}),e.jsx("h3",{className:"font-sans text-xs font-black uppercase tracking-wider",children:"New Book"})]})})})]}),e.jsx(ze,{isOpen:!!L,title:"Delete Book?",message:e.jsxs(e.Fragment,{children:["Are you sure you want to delete ",e.jsxs("strong",{children:['"',(Me=L==null?void 0:L.title.split(":").pop())==null?void 0:Me.trim(),'"']}),"? Items inside will not be deleted."]}),confirmText:"Delete",isProcessing:!1,onConfirm:async()=>{L&&await jt(L.id),G(null),W()},onClose:()=>G(null),icon:e.jsx(ne,{size:40,className:"text-red-500"})}),e.jsx(Wt,{isOpen:!!Y,onClose:()=>me(null),onConfirm:rt,shelves:se,currentShelf:Y?Y.title.split(":")[0].trim():"General",bookTitle:(Y==null?void 0:Y.title)||""}),e.jsx(Vt,{isOpen:tt,onClose:()=>xe(!1),onSave:t=>{qe(t)&&xe(!1)}}),e.jsx(_t,{isOpen:st,onClose:()=>ge(!1),onSave:ot,initialName:he})]}):e.jsxs(e.Fragment,{children:[e.jsx(Lt,{title:"Knowledge Library",subtitle:"Your collection of lessons and comparisons.",icon:e.jsx("img",{src:"https://raw.githubusercontent.com/Tarikul-Islam-Anik/Animated-Fluent-Emojis/master/Emojis/Objects/Notebook.png",className:"w-8 h-8 object-contain",alt:"Lessons"}),centerContent:e.jsx(Be,{shelves:se,books:g,onNavigateShelf:Oe,onNavigateBook:Re}),minorSkills:e.jsxs("button",{onClick:()=>A("IRREGULAR_VERBS"),className:"flex items-center gap-2 px-3 py-2 bg-orange-50 text-orange-700 rounded-lg text-xs font-bold hover:bg-orange-100 transition-colors",children:[e.jsx(qt,{size:16}),e.jsx("span",{className:"hidden sm:inline",children:"Irregular Verbs"})]}),pagination:{page:D,totalPages:Math.ceil(Q.length/O),onPageChange:J,pageSize:O,onPageSizeChange:K,totalItems:Q.length},actions:e.jsx(Ot,{viewMenu:e.jsx(zt,{isOpen:$,setIsOpen:V,hasActiveFilters:nt,filterOptions:[{label:"All",value:"ALL",isActive:f==="ALL",onClick:()=>B("ALL")},{label:"Lesson",value:"ESSAY",isActive:f==="ESSAY",onClick:()=>B("ESSAY")}],customSection:e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"px-3 py-2 text-[9px] font-black text-neutral-400 uppercase tracking-widest border-b border-neutral-50 flex items-center gap-2",children:[e.jsx(yt,{size:10})," Focus & Status"]}),e.jsxs("div",{className:"p-1 flex flex-col gap-1 bg-neutral-100 rounded-xl mb-2",children:[e.jsx("button",{onClick:()=>j(y==="all"?"focused":"all"),className:`w-full py-1.5 text-[9px] font-black rounded-lg transition-all ${y==="focused"?"bg-white shadow-sm text-red-600":"text-neutral-500 hover:text-neutral-700"}`,children:y==="focused"?"Focused Only":"All Items"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("button",{onClick:()=>h(v==="green"?"all":"green"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${v==="green"?"bg-emerald-500 border-emerald-600":"bg-white border-neutral-200 hover:bg-emerald-50"}`}),e.jsx("button",{onClick:()=>h(v==="yellow"?"all":"yellow"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${v==="yellow"?"bg-amber-400 border-amber-500":"bg-white border-neutral-200 hover:bg-amber-50"}`}),e.jsx("button",{onClick:()=>h(v==="red"?"all":"red"),className:`flex-1 h-6 rounded-lg border-2 transition-all ${v==="red"?"bg-rose-50 border-rose-600":"bg-white border-neutral-200 hover:bg-rose-50"}`})]})]})]}),viewOptions:[{label:"Show Description",checked:P.showDesc,onChange:()=>_(t=>({...t,showDesc:!t.showDesc}))},{label:"Compact",checked:P.compact,onChange:()=>_(t=>({...t,compact:!t.compact}))}]}),browseTags:{isOpen:I,onToggle:()=>{F(!I)}},addActions:ht,extraActions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:ut,disabled:C.length<2,className:"p-3 bg-white border border-neutral-200 text-neutral-600 rounded-xl hover:bg-neutral-50 active:scale-95 transition-all shadow-sm disabled:opacity-50",title:"Randomize",children:e.jsx(kt,{size:16})}),e.jsxs("button",{onClick:()=>i("shelf"),className:"px-5 py-3 bg-indigo-600 text-white rounded-xl font-black text-xs flex items-center gap-2 hover:bg-indigo-700 active:scale-95 transition-all shadow-lg shadow-indigo-200",title:"Bookshelf Mode",children:[e.jsx(Qt,{size:16}),e.jsx("span",{children:"Bookshelf"})]})]})}),aboveGrid:e.jsx(e.Fragment,{children:I&&e.jsx(Rt,{items:C,selectedTag:u,onSelectTag:o,forcedView:"tags",title:"Browse Tags",icon:e.jsx(Ve,{size:16})})}),config:as,activeFilters:{},onFilterChange:()=>{},isLoading:m,isEmpty:Q.length===0,emptyMessage:"No items found matching your criteria.",children:()=>e.jsx(e.Fragment,{children:at.map(t=>{const c=()=>{b(t.data),i("read_lesson")},x=()=>{b(t.data),i("edit_lesson")},a=()=>w(t.data);return e.jsx(Mt,{title:e.jsx("div",{className:"font-black text-lg text-neutral-900 tracking-tight leading-tight truncate",children:t.data.title}),tags:t.data.tags,compact:P.compact,onClick:c,focusColor:t.data.focusColor,onFocusChange:r=>Ie(t,r),isFocused:t.data.isFocused,onToggleFocus:()=>Le(t),isCompleted:t.data.focusColor==="green",actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:r=>{r.stopPropagation(),c()},className:"p-1.5 text-neutral-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors",title:"Read",children:e.jsx(ae,{size:14})}),e.jsx("button",{onClick:r=>{r.stopPropagation(),x()},className:"p-1.5 text-neutral-400 hover:text-neutral-900 hover:bg-neutral-100 rounded-lg transition-colors",title:"Edit",children:e.jsx(Te,{size:14})}),e.jsx("button",{onClick:r=>{r.stopPropagation(),a()},className:"p-1.5 text-neutral-400 hover:text-rose-600 hover:bg-rose-50 rounded-lg transition-colors",title:"Delete",children:e.jsx(ne,{size:14})})]}),children:P.showDesc&&t.data.description&&e.jsx("p",{className:"line-clamp-2",children:t.data.description})},`${t.type}-${t.data.id}`)})})}),e.jsx(ze,{isOpen:!!N,title:"Delete Lesson?",message:"Confirm delete?",confirmText:"Yes, Delete",isProcessing:!1,onConfirm:lt,onClose:()=>w(null),icon:e.jsx(ne,{size:40,className:"text-red-500"})}),e.jsx(re,{isOpen:q,onClose:()=>ce(!1),type:"GENERATE_LESSON",title:"AI Lesson Creator",description:"Design a custom lesson instantly.",initialData:s.lessonPreferences,onGeneratePrompt:pt,onJsonReceived:ye,actionLabel:"Create Lesson",closeOnSuccess:!0}),e.jsx(re,{isOpen:He,onClose:()=>de(!1),type:"GENERATE_WORD_LESSON",title:`AI Word Lesson: ${te==null?void 0:te.word}`,description:"Creating a deep-dive lesson based on your library data.",initialData:s.lessonPreferences,onGeneratePrompt:xt,onJsonReceived:ye,actionLabel:"Create Word Lesson",closeOnSuccess:!0}),je&&e.jsx(Dt,{isOpen:je,onClose:()=>ue(!1),onSelect:gt,allWords:R,wordsToExclude:new Set,loading:m})]})};export{vs as LessonLibraryV2,vs as default};
