import{r as t,_ as $,ag as q,bg as Ue,Y as ke,bz as Z,bA as ze,t as je,k as De,aK as Fe,E as ee,j as c,aA as Oe,bB as Le}from"./index-6QNaqlSf.js";import{M as Ne}from"./MimicPractice_UI-WdW5fmrE.js";import"./chevron-left-6byyStL7.js";const te="vocab_pro_mimic_practice_queue",Qe=({scopedWord:b,onClose:C})=>{const[o,W]=t.useState([]),[u,i]=t.useState(0),[se,B]=t.useState(!1),[f,v]=t.useState(0),[r,ne]=t.useState(10),[oe,g]=t.useState(!1),[E,_]=t.useState(null),[U,k]=t.useState(null),[d,ae]=t.useState(()=>$("vocab_pro_mimic_autospeak",!1)),[p,re]=t.useState(()=>$("vocab_pro_mimic_autoreveal",!0)),J=t.useRef(d);t.useEffect(()=>{q("vocab_pro_mimic_autospeak",d),J.current=d},[d]),t.useEffect(()=>{q("vocab_pro_mimic_autoreveal",p)},[p]);const s=o[u]||null,[h,z]=t.useState(!1),[K,Y]=t.useState(!1),[G,A]=t.useState(""),[le,j]=t.useState(0),[D,H]=t.useState(null),[ce,ue]=t.useState("audio/webm"),[ie,F]=t.useState(null),[R,O]=t.useState(null),[M,S]=t.useState(!1),[fe,L]=t.useState(!1),[w,I]=t.useState(null),de=!1,N=t.useRef(new Ue),m=t.useRef(null),l=t.useRef(null),V=t.useRef(()=>{}),{showToast:T}=ke(),y=G.substring(le).trimStart();t.useEffect(()=>{if(h&&s&&y){const e=Z(s.text,y);I(e)}},[y,h,s]);const x=e=>{W(e),q(te,e),B(e.length===0)};t.useEffect(()=>{const e=$(te,[]);W(e),B(e.length===0),i(0)},[]),t.useEffect(()=>{const e=Math.ceil(o.length/r);f>=e&&e>0&&v(e-1)},[o.length,r]),t.useEffect(()=>{const e=Math.floor(u/r);e!==f&&v(e)},[u,r]);const pe=e=>{const a=[{id:`mimic-${Date.now()}`,text:e,sourceWord:"Manual",type:"Phrase"},...o];x(a),i(0),g(!1)},me=(e,n)=>{x(o.map(a=>a.id===e?{...a,text:n}:a)),g(!1),_(null)},ge=e=>{k(e)},he=()=>{if(!U)return;const e=o.filter(a=>a.id!==U.id);let n=u;n>=e.length&&(n=Math.max(0,e.length-1)),i(n),x(e),k(null),T("Phrase removed.","success")},Se=()=>{if(o.length<2)return;const e=[...o].sort(()=>Math.random()-.5);x(e),i(0),T("Queue shuffled!","success")},Ie=e=>{ne(e),v(0)},Te=()=>{_(null),g(!0)},ye=e=>{_(e),g(!0)},xe=e=>{E?me(E.id,e):pe(e)},P=t.useCallback(async(e=!1)=>{l.current&&clearTimeout(l.current),z(!1),N.current.stop();try{const n=await ze();!e&&n&&(H(n.base64),ue(n.mimeType))}catch(n){console.error("Audio capture failed",n)}},[]);t.useEffect(()=>{V.current=P},[P]);const ve=t.useCallback(async()=>{if(s){if(R&&M){S(!1);return}if(R&&!M){S(!0);return}L(!0);try{const e=s.text.trim().toLowerCase(),n=je().find(a=>a.word.toLowerCase()===e);if(n&&n.ipaUs){O(n.ipaUs),S(!0),L(!1);return}else{const a=De(),Q=Fe(a),X=await fetch(`${Q}/api/convert/ipa?text=${encodeURIComponent(s.text)}`);if(X.ok){const _e=await X.json();O(_e.ipa),S(!0)}else T("IPA server unavailable","error")}}catch{T("Failed to fetch IPA","error")}finally{L(!1)}}},[s,R,M,T]);t.useEffect(()=>{if(h&&P(!0),Y(p),A(""),j(0),H(null),F(null),I(null),O(null),S(!1),m.current&&(m.current.pause(),m.current=null),J.current&&s){const e=setTimeout(()=>ee(s.text),500);return()=>clearTimeout(e)}},[s==null?void 0:s.id,p]),t.useEffect(()=>()=>{N.current.stop(),l.current&&clearTimeout(l.current)},[]);const Ae=async()=>{if(s)if(h){await P();const e=Z(s.text,y);I(e);const n=o.map((a,Q)=>Q===u?{...a,lastScore:e.score}:a);x(n)}else{A(""),j(0),F(null),I(null);try{await Le(),z(!0),l.current&&clearTimeout(l.current),l.current=setTimeout(()=>V.current(),1e4),N.current.start((e,n)=>A(e+n),e=>A(e))}catch(e){console.error("Failed to start recording",e),z(!1)}}},Re=()=>{j(G.length),F(null),I(null)},Me=()=>s&&ee(s.text),we=()=>{if(D){m.current&&m.current.pause();const e=new Audio(`data:${ce};base64,${D}`);m.current=e,e.play()}},Pe=()=>{o.length>0&&i(e=>(e+1)%o.length)},be=e=>{e>=0&&e<o.length&&i(e)},Ce=Math.ceil(o.length/r),Ee=o.slice(f*r,(f+1)*r);return c.jsxs(c.Fragment,{children:[c.jsx(Ne,{targetText:(s==null?void 0:s.text)||null,sourceWord:(s==null?void 0:s.sourceWord)||"",type:(s==null?void 0:s.type)||"",isRecording:h,isRevealed:K,userTranscript:y,matchStatus:ie,userAudioUrl:D,onToggleRecord:Ae,onPlayTarget:Me,onPlayUser:we,onToggleReveal:()=>Y(!K),onNext:Pe,onClearTranscript:Re,isEmpty:se,onClose:C,pagedItems:Ee,page:f,pageSize:r,totalPages:Ce,onPageChange:v,onPageSizeChange:Ie,onSelect:e=>be(f*r+e),currentAbsoluteIndex:u,autoSpeak:d,onToggleAutoSpeak:()=>ae(!d),autoReveal:p,onToggleAutoReveal:()=>re(!p),isGlobalMode:!b,isAnalyzing:de,onAnalyze:()=>{},aiAnalysis:w?{isCorrect:w.score>80,score:w.score,feedbackHtml:""}:null,localAnalysis:w,onAddItem:Te,onEditItem:ye,onDeleteItem:ge,onRandomize:Se,isModalOpen:oe,editingItem:E,onCloseModal:()=>g(!1),onSaveItem:xe,ipa:R,showIpa:M,isIpaLoading:fe,onToggleIpa:ve}),c.jsx(Oe,{isOpen:!!U,title:"Delete Phrase?",message:"Are you sure you want to remove this phrase from your pronunciation queue?",confirmText:"Delete",isProcessing:!1,onConfirm:he,onClose:()=>k(null),icon:null,confirmButtonClass:"bg-red-600 text-white hover:bg-red-700"})]})},Be=({scopedWord:b,onClose:C})=>c.jsx("div",{className:"flex flex-col h-full bg-white",children:c.jsx("div",{className:"flex-grow overflow-hidden",children:c.jsx(Qe,{scopedWord:b,onClose:C})})});export{Be as MimicPractice};
