import{r as t,a0 as Q,ai as $,bh as Ue,$ as ke,bA as V,bB as ze,u as De,k as Fe,aL as Le,H as X,j as P,aB as Oe,bC as je}from"./index-BtoOhDNg.js";import{M as Qe}from"./MimicPractice_UI-CJFigz2T.js";import"./ear-DAvKmsPb.js";import"./chevron-left-C57pLX8Y.js";const Z="vocab_pro_mimic_practice_queue",He=({scopedWord:ee,onClose:te})=>{const[a,q]=t.useState([]),[c,u]=t.useState(0),[se,N]=t.useState(!1),[i,A]=t.useState(0),[r,ne]=t.useState(10),[ae,m]=t.useState(!1),[b,w]=t.useState(null),[E,_]=t.useState(null),[f,oe]=t.useState(()=>Q("vocab_pro_mimic_autospeak",!1)),[d,re]=t.useState(()=>Q("vocab_pro_mimic_autoreveal",!0)),W=t.useRef(f);t.useEffect(()=>{$("vocab_pro_mimic_autospeak",f),W.current=f},[f]),t.useEffect(()=>{$("vocab_pro_mimic_autoreveal",d)},[d]);const s=a[c]||null,[g,U]=t.useState(!1),[B,H]=t.useState(!1),[J,R]=t.useState(""),[le,k]=t.useState(0),[z,G]=t.useState(null),[ce,ue]=t.useState("audio/webm"),[ie,D]=t.useState(null),[x,F]=t.useState(null),[v,h]=t.useState(!1),[fe,L]=t.useState(!1),[M,S]=t.useState(null),[de,$e]=t.useState(!1),O=t.useRef(new Ue),p=t.useRef(null),l=t.useRef(null),K=t.useRef(()=>{}),{showToast:I}=ke(),T=J.substring(le).trimStart();t.useEffect(()=>{if(g&&s&&T){const e=V(s.text,T);S(e)}},[T,g,s]);const y=e=>{q(e),$(Z,e),N(e.length===0)};t.useEffect(()=>{const e=Q(Z,[]);q(e),N(e.length===0),u(0)},[]),t.useEffect(()=>{const e=Math.ceil(a.length/r);i>=e&&e>0&&A(e-1)},[a.length,r]),t.useEffect(()=>{const e=Math.floor(c/r);e!==i&&A(e)},[c,r]);const pe=e=>{const o=[{id:`mimic-${Date.now()}`,text:e,sourceWord:"Manual",type:"Phrase"},...a];y(o),u(0),m(!1)},me=(e,n)=>{y(a.map(o=>o.id===e?{...o,text:n}:o)),m(!1),w(null)},ge=e=>{_(e)},he=()=>{if(!E)return;const e=a.filter(o=>o.id!==E.id);let n=c;n>=e.length&&(n=Math.max(0,e.length-1)),u(n),y(e),_(null),I("Phrase removed.","success")},Se=()=>{if(a.length<2)return;const e=[...a].sort(()=>Math.random()-.5);y(e),u(0),I("Queue shuffled!","success")},Ie=e=>{ne(e),A(0)},Te=()=>{w(null),m(!0)},ye=e=>{w(e),m(!0)},Ae=e=>{b?me(b.id,e):pe(e)},C=t.useCallback(async(e=!1)=>{l.current&&clearTimeout(l.current),U(!1),O.current.stop();try{const n=await ze();!e&&n&&(G(n.base64),ue(n.mimeType))}catch(n){console.error("Audio capture failed",n)}},[]);t.useEffect(()=>{K.current=C},[C]);const Re=t.useCallback(async()=>{if(s){if(x&&v){h(!1);return}if(x&&!v){h(!0);return}L(!0);try{const e=s.text.trim().toLowerCase(),n=De().find(o=>o.word.toLowerCase()===e);if(n&&n.ipaUs){F(n.ipaUs),h(!0),L(!1);return}else{const o=Fe(),j=Le(o),Y=await fetch(`${j}/api/convert/ipa?text=${encodeURIComponent(s.text)}`);if(Y.ok){const _e=await Y.json();F(_e.ipa),h(!0)}else I("IPA server unavailable","error")}}catch{I("Failed to fetch IPA","error")}finally{L(!1)}}},[s,x,v,I]);t.useEffect(()=>{if(g&&C(!0),H(d),R(""),k(0),G(null),D(null),S(null),F(null),h(!1),p.current&&(p.current.pause(),p.current=null),W.current&&s){const e=setTimeout(()=>X(s.text),500);return()=>clearTimeout(e)}},[s==null?void 0:s.id,d]),t.useEffect(()=>()=>{O.current.stop(),l.current&&clearTimeout(l.current)},[]);const xe=async()=>{if(s)if(g){await C();const e=V(s.text,T);S(e);const n=a.map((o,j)=>j===c?{...o,lastScore:e.score}:o);y(n)}else{R(""),k(0),D(null),S(null);try{await je(),U(!0),l.current&&clearTimeout(l.current),l.current=setTimeout(()=>K.current(),1e4),O.current.start((e,n)=>R(e+n),e=>R(e))}catch(e){console.error("Failed to start recording",e),U(!1)}}},ve=()=>{k(J.length),D(null),S(null)},Me=()=>s&&X(s.text),Ce=()=>{if(z){p.current&&p.current.pause();const e=new Audio(`data:${ce};base64,${z}`);p.current=e,e.play()}},Pe=()=>{a.length>0&&u(e=>(e+1)%a.length)},be=e=>{e>=0&&e<a.length&&u(e)},we=Math.ceil(a.length/r),Ee=a.slice(i*r,(i+1)*r);return P.jsxs(P.Fragment,{children:[P.jsx(Qe,{targetText:(s==null?void 0:s.text)||null,sourceWord:(s==null?void 0:s.sourceWord)||"",type:(s==null?void 0:s.type)||"",isRecording:g,isRevealed:B,userTranscript:T,matchStatus:ie,userAudioUrl:z,onToggleRecord:xe,onPlayTarget:Me,onPlayUser:Ce,onToggleReveal:()=>H(!B),onNext:Pe,onClearTranscript:ve,isEmpty:se,onClose:te,pagedItems:Ee,page:i,pageSize:r,totalPages:we,onPageChange:A,onPageSizeChange:Ie,onSelect:e=>be(i*r+e),currentAbsoluteIndex:c,autoSpeak:f,onToggleAutoSpeak:()=>oe(!f),autoReveal:d,onToggleAutoReveal:()=>re(!d),isGlobalMode:!ee,isAnalyzing:de,onAnalyze:()=>{},aiAnalysis:M?{isCorrect:M.score>80,score:M.score,feedbackHtml:""}:null,localAnalysis:M,onAddItem:Te,onEditItem:ye,onDeleteItem:ge,onRandomize:Se,isModalOpen:ae,editingItem:b,onCloseModal:()=>m(!1),onSaveItem:Ae,ipa:x,showIpa:v,isIpaLoading:fe,onToggleIpa:Re}),P.jsx(Oe,{isOpen:!!E,title:"Delete Phrase?",message:"Are you sure you want to remove this phrase from your pronunciation queue?",confirmText:"Delete",isProcessing:!1,onConfirm:he,onClose:()=>_(null),icon:null,confirmButtonClass:"bg-red-600 text-white hover:bg-red-700"})]})};export{He as MimicPractice};
