import{r,G as ue,K as z,M as he,j as T,w as pe,x as ge,N as we,O as fe,Q as Se,U as me,Y as ye,I as We,_ as Ce,$ as Ee,a0 as Pe}from"./index-DdabRH98.js";import{W as Ie}from"./WordTable-BTc4CCQU.js";import"./WordTable_UI-6DsaOP15.js";import"./TagBrowser-CZeR-F6L.js";import"./square-check-big--rgsfTx4.js";import"./chevron-left-DCjWekKt.js";const be="vocab_pro_library_filters_v2",Be=({user:E,onDelete:q,onBulkDelete:R,onUpdate:_,onStartSession:K,initialFilter:Q,onInitialFilterApplied:ve,forceExpandAdd:Y,onExpandAddConsumed:N,onNavigate:j})=>{const[J,X]=r.useState([]),D=r.useMemo(()=>ue(be,{}),[]),[k,x]=r.useState(D.page||0),[A,Z]=r.useState(D.pageSize||25),[$,H]=r.useState(0),[ee,G]=r.useState(!0),[O,te]=r.useState(D.query||""),[d,oe]=r.useState({types:new Set(["all"]),refined:"all",status:"all",register:"all",source:"all",composition:"all",book:"all",specificBookId:""}),[F,se]=r.useState(null),[U,P]=r.useState(null),[V,I]=r.useState(null),[ae,re]=r.useState([]),{id:b}=E,B=r.useCallback(()=>{const t="Uncategorized",n=z().filter(e=>e.userId===E.id),l=new Map;n.forEach(e=>l.set(e.word.toLowerCase(),e));const u=new Map,m=new Set,w=[];n.forEach(e=>{e.groups&&e.groups.length>0?e.groups.forEach(o=>{m.add(o),u.has(o)||u.set(o,new Set),u.get(o).add(e)}):w.push(e)});const a=new Map,y=e=>{a.has(e)||a.set(e,{name:e,children:new Set,parents:new Set})};m.forEach(e=>{const o=e.split("/");for(let s=0;s<o.length;s++){const c=o.slice(0,s+1).join("/");if(y(c),s>0){const h=o.slice(0,s).join("/");a.get(h).children.add(c),a.get(c).parents.add(h)}}}),a.forEach((e,o)=>{const s=l.get(o.toLowerCase());s!=null&&s.groups&&s.groups.forEach(c=>{const h=c.split("/");for(let g=0;g<h.length;g++){const C=h.slice(0,g+1).join("/");if(y(C),g>0){const p=h.slice(0,g).join("/");a.get(p).children.add(C),a.get(C).parents.add(p)}}a.get(c).children.add(o),e.parents.add(c)})});const f=new Map,v=e=>{var C;if(f.has(e))return f.get(e);const o=new Set,s=[e],c=new Set;for(;s.length>0;){const p=s.shift();c.has(p)||(c.add(p),o.add(p),(((C=a.get(p))==null?void 0:C.children)||new Set).forEach(L=>s.push(L)))}const h=new Set;o.forEach(p=>{(u.get(p)||new Set).forEach(L=>h.add(L.id))});const g=h.size;return f.set(e,g),g},W=e=>{const o=a.get(e),s=Array.from(o.children).sort();return{name:e.split("/").pop(),path:e,children:s.map(W),unitCount:v(e)}};let i=Array.from(a.keys()).filter(e=>{var o;return(((o=a.get(e))==null?void 0:o.parents.size)||0)===0}).sort().map(e=>W(e));w.length>0&&i.unshift({name:t,path:t,children:[],unitCount:w.length}),re(i)},[E.id]),M=r.useCallback(()=>{G(!0);try{const t=Array.from(d.types),{words:n,totalCount:l}=he(b,k,A,O,t,d.refined,d.status,d.register,d.source,F,d.composition,d.book,d.specificBookId);H(l),X(n)}catch(t){console.error("Failed to load words from store:",t)}finally{G(!1)}},[b,k,A,O,d,F]);r.useEffect(()=>{M(),B();const t=()=>{M(),B()};return window.addEventListener("datastore-updated",t),()=>{window.removeEventListener("datastore-updated",t)}},[M,B]);const ne=t=>{se(t),x(0)},ie=async(t,n)=>{const l=we(t),u=[],m=n.has("idiom"),w=n.has("phrasal"),a=n.has("collocation"),y=n.has("phrase"),f=n.has("pronun"),v=n.has("archive");let W=new Map;try{(await fe(l)).forEach(i=>{W.set(i.word.toLowerCase().trim(),i)})}catch(S){console.warn("Server lookup failed in WordList:",S)}for(const S of l){const i=await Se(b,S);if(i){const e={...i};e.isIdiom=m||i.isIdiom,e.isPhrasalVerb=w||i.isPhrasalVerb,e.isCollocation=a||i.isCollocation,e.isStandardPhrase=y||i.isStandardPhrase,e.needsPronunciationFocus=f||i.needsPronunciationFocus,e.isPassive=v,e.updatedAt=Date.now(),u.push(e)}else{const e=S.toLowerCase().trim();let o;if(W.has(e)){const s=W.get(e);o={...s,id:crypto.randomUUID?crypto.randomUUID():"id-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),userId:b,createdAt:Date.now(),updatedAt:Date.now(),quality:me.REFINED,source:"refine",nextReview:Date.now(),interval:0,easeFactor:2.5,consecutiveCorrect:0,forgotCount:0,lastReview:void 0,lastGrade:void 0,lastTestResults:{},isIdiom:m||s.isIdiom,isPhrasalVerb:w||s.isPhrasalVerb,isCollocation:a||s.isCollocation,isStandardPhrase:y||s.isStandardPhrase,needsPronunciationFocus:f||s.needsPronunciationFocus,isPassive:v},o.complexity=ye(o),o.masteryScore=We(o),o.gameEligibility=Ce(o)}else o=Ee(S,"","","","",[],m,f,w,a,y,v),o.userId=b;u.push(o)}}u.length>0&&await Pe(u)},ce=t=>{const n=z().filter(l=>t.has(l.id));K(n)},de=async t=>{await R(Array.from(t))},le=t=>{_(t),I(null)};return T.jsxs(T.Fragment,{children:[T.jsx(Ie,{user:E,words:J,total:$,loading:ee,page:k,pageSize:A,onPageChange:x,onPageSizeChange:Z,onSearch:te,onFilterChange:t=>{oe({types:t.types,refined:t.refined,status:t.status,register:t.register,source:t.source,composition:t.composition,book:t.book,specificBookId:t.specificBookId}),x(0)},onAddWords:ie,onViewWord:P,onEditWord:I,onDelete:async t=>{await q(t.id)},onBulkDelete:R?de:void 0,onPractice:ce,settingsKey:"vocab_pro_word_table_settings",context:"library",initialFilter:Q,forceExpandAdd:Y,onExpandAddConsumed:N,showTagBrowserButton:!0,tagTree:ae,selectedTag:F,onSelectTag:ne,onOpenWordBook:()=>j&&j("WORDBOOK")}),U&&T.jsx(pe,{word:U,onClose:()=>P(null),onNavigateToWord:P,onEditRequest:t=>{P(null),I(t)},onUpdate:_,onGainXp:async()=>0}),V&&T.jsx(ge,{user:E,word:V,onSave:le,onClose:()=>I(null),onSwitchToView:t=>{I(null),P(t)}})]})};export{Be as default};
