import{r,o as ue,p as G,q as he,j as P,V as pe,s as ge,t as fe,u as we,v as Se,w as We}from"./index-eAsI8bDC.js";import{W as me}from"./WordTable-Dqh3qP6J.js";import"./WordTable_UI-CJhhKlJ6.js";import"./TagBrowser-DOlPWT2B.js";import"./search-CAhr0Iop.js";import"./square-check-big-CqXQxDVB.js";import"./chevron-left-Cu_5X9vm.js";const Ee="vocab_pro_library_filters_v2",xe=({user:W,onDelete:q,onBulkDelete:U,onUpdate:k,onStartSession:K,initialFilter:Q,onInitialFilterApplied:Ce,forceExpandAdd:Y,onExpandAddConsumed:J,onNavigate:A})=>{const[X,Z]=r.useState([]),I=r.useMemo(()=>ue(Ee,{}),[]),[x,z]=r.useState(I.page||0),[D,H]=r.useState(I.pageSize||25),[$,N]=r.useState(0),[ee,L]=r.useState(!0),[M,te]=r.useState(I.query||""),[h,se]=r.useState({types:new Set(["all"]),refined:"all",status:"all",register:"all",source:"all",composition:"all",book:"all"}),[_,oe]=r.useState(null),[R,m]=r.useState(null),[V,E]=r.useState(null),[ne,re]=r.useState([]),{id:b}=W,j=r.useCallback(()=>{const t="Uncategorized",i=G().filter(e=>e.userId===W.id),p=new Map;i.forEach(e=>p.set(e.word.toLowerCase(),e));const d=new Map,C=new Set,f=[];i.forEach(e=>{e.groups&&e.groups.length>0?e.groups.forEach(s=>{C.add(s),d.has(s)||d.set(s,new Set),d.get(s).add(e)}):f.push(e)});const n=new Map,T=e=>{n.has(e)||n.set(e,{name:e,children:new Set,parents:new Set})};C.forEach(e=>{const s=e.split("/");for(let o=0;o<s.length;o++){const c=s.slice(0,o+1).join("/");if(T(c),o>0){const l=s.slice(0,o).join("/");n.get(l).children.add(c),n.get(c).parents.add(l)}}}),n.forEach((e,s)=>{const o=p.get(s.toLowerCase());o!=null&&o.groups&&o.groups.forEach(c=>{const l=c.split("/");for(let g=0;g<l.length;g++){const S=l.slice(0,g+1).join("/");if(T(S),g>0){const u=l.slice(0,g).join("/");n.get(u).children.add(S),n.get(S).parents.add(u)}}n.get(c).children.add(s),e.parents.add(c)})});const w=new Map,v=e=>{var S;if(w.has(e))return w.get(e);const s=new Set,o=[e],c=new Set;for(;o.length>0;){const u=o.shift();c.has(u)||(c.add(u),s.add(u),(((S=n.get(u))==null?void 0:S.children)||new Set).forEach(O=>o.push(O)))}const l=new Set;s.forEach(u=>{(d.get(u)||new Set).forEach(O=>l.add(O.id))});const g=l.size;return w.set(e,g),g},y=e=>{const s=n.get(e),o=Array.from(s.children).sort();return{name:e.split("/").pop(),path:e,children:o.map(y),unitCount:v(e)}};let a=Array.from(n.keys()).filter(e=>{var s;return(((s=n.get(e))==null?void 0:s.parents.size)||0)===0}).sort().map(e=>y(e));f.length>0&&a.unshift({name:t,path:t,children:[],unitCount:f.length}),re(a)},[W.id]),B=r.useCallback(()=>{L(!0);try{const t=Array.from(h.types),{words:i,totalCount:p}=he(b,x,D,M,t,h.refined,h.status,h.register,h.source,_,h.composition,h.book);N(p),Z(i)}catch(t){console.error("Failed to load words from store:",t)}finally{L(!1)}},[b,x,D,M,h,_]);r.useEffect(()=>{B(),j();const t=()=>{B(),j()};return window.addEventListener("datastore-updated",t),()=>{window.removeEventListener("datastore-updated",t)}},[B,j]);const ae=t=>{oe(t),z(0)},ie=async(t,i)=>{const p=fe(t),d=[],C=i.has("idiom"),f=i.has("phrasal"),n=i.has("collocation"),T=i.has("phrase"),w=i.has("pronun"),v=i.has("archive");for(const y of p){const F=await we(b,y);if(F){const a={...F};a.isIdiom=C,a.isPhrasalVerb=f,a.isCollocation=n,a.isStandardPhrase=T,a.needsPronunciationFocus=w,a.isPassive=v,a.updatedAt=Date.now(),d.push(a)}else{const a=Se(y,"","","","",[],C,w,f,n,T,v);a.userId=b,d.push(a)}}d.length>0&&await We(d)},ce=t=>{const i=G().filter(p=>t.has(p.id));K(i)},de=async t=>{await U(Array.from(t))},le=t=>{k(t),E(null)};return P.jsxs(P.Fragment,{children:[P.jsx(me,{user:W,words:X,total:$,loading:ee,page:x,pageSize:D,onPageChange:z,onPageSizeChange:H,onSearch:te,onFilterChange:se,onAddWords:ie,onViewWord:m,onEditWord:E,onDelete:async t=>{await q(t.id)},onBulkDelete:de,onPractice:ce,settingsKey:"ielts_pro_library_view_settings",context:"library",initialFilter:Q,forceExpandAdd:Y,onExpandAddConsumed:J,showTagBrowserButton:!0,tagTree:ne,selectedTag:_,onSelectTag:ae,onOpenWordBook:()=>A==null?void 0:A("WORDBOOK")}),R&&P.jsx(pe,{word:R,onClose:()=>m(null),onNavigateToWord:m,onUpdate:k,onGainXp:async()=>0,isViewOnly:!1,onEditRequest:t=>{m(null),E(t)}}),V&&P.jsx(ge,{user:W,word:V,onSave:le,onClose:()=>E(null),onSwitchToView:t=>{E(null),m(t)}})]})};export{xe as default};
