import{r,G as ue,K as G,M as he,j as P,w as fe,x as pe,N as ge,O as we,Q as Se,U as We}from"./index-D4pHSgEb.js";import{W as me}from"./WordTable-DxoMknGQ.js";import"./WordTable_UI-C-Wny0-m.js";import"./TagBrowser-DzOGKL3u.js";import"./square-check-big-CPjvH1Iu.js";import"./chevron-left-DpxbAqSw.js";const Ee="vocab_pro_library_filters_v2",Ae=({user:W,onDelete:U,onBulkDelete:K,onUpdate:F,onStartSession:q,initialFilter:Q,onInitialFilterApplied:Ce,forceExpandAdd:Y,onExpandAddConsumed:J,onNavigate:x})=>{const[X,Z]=r.useState([]),A=r.useMemo(()=>ue(Ee,{}),[]),[v,M]=r.useState(A.page||0),[B,H]=r.useState(A.pageSize||25),[$,N]=r.useState(0),[ee,z]=r.useState(!0),[L,te]=r.useState(A.query||""),[d,se]=r.useState({types:new Set(["all"]),refined:"all",status:"all",register:"all",source:"all",composition:"all",book:"all",specificBookId:""}),[D,oe]=r.useState(null),[R,m]=r.useState(null),[V,E]=r.useState(null),[ne,re]=r.useState([]),{id:b}=W,_=r.useCallback(()=>{const t="Uncategorized",i=G().filter(e=>e.userId===W.id),f=new Map;i.forEach(e=>f.set(e.word.toLowerCase(),e));const l=new Map,C=new Set,g=[];i.forEach(e=>{e.groups&&e.groups.length>0?e.groups.forEach(s=>{C.add(s),l.has(s)||l.set(s,new Set),l.get(s).add(e)}):g.push(e)});const n=new Map,T=e=>{n.has(e)||n.set(e,{name:e,children:new Set,parents:new Set})};C.forEach(e=>{const s=e.split("/");for(let o=0;o<s.length;o++){const c=s.slice(0,o+1).join("/");if(T(c),o>0){const u=s.slice(0,o).join("/");n.get(u).children.add(c),n.get(c).parents.add(u)}}}),n.forEach((e,s)=>{const o=f.get(s.toLowerCase());o!=null&&o.groups&&o.groups.forEach(c=>{const u=c.split("/");for(let p=0;p<u.length;p++){const S=u.slice(0,p+1).join("/");if(T(S),p>0){const h=u.slice(0,p).join("/");n.get(h).children.add(S),n.get(S).parents.add(h)}}n.get(c).children.add(s),e.parents.add(c)})});const w=new Map,I=e=>{var S;if(w.has(e))return w.get(e);const s=new Set,o=[e],c=new Set;for(;o.length>0;){const h=o.shift();c.has(h)||(c.add(h),s.add(h),(((S=n.get(h))==null?void 0:S.children)||new Set).forEach(O=>o.push(O)))}const u=new Set;s.forEach(h=>{(l.get(h)||new Set).forEach(O=>u.add(O.id))});const p=u.size;return w.set(e,p),p},y=e=>{const s=n.get(e),o=Array.from(s.children).sort();return{name:e.split("/").pop(),path:e,children:o.map(y),unitCount:I(e)}};let a=Array.from(n.keys()).filter(e=>{var s;return(((s=n.get(e))==null?void 0:s.parents.size)||0)===0}).sort().map(e=>y(e));g.length>0&&a.unshift({name:t,path:t,children:[],unitCount:g.length}),re(a)},[W.id]),j=r.useCallback(()=>{z(!0);try{const t=Array.from(d.types),{words:i,totalCount:f}=he(b,v,B,L,t,d.refined,d.status,d.register,d.source,D,d.composition,d.book,d.specificBookId);N(f),Z(i)}catch(t){console.error("Failed to load words from store:",t)}finally{z(!1)}},[b,v,B,L,d,D]);r.useEffect(()=>{j(),_();const t=()=>{j(),_()};return window.addEventListener("datastore-updated",t),()=>{window.removeEventListener("datastore-updated",t)}},[j,_]);const ae=t=>{oe(t),M(0)},ie=async(t,i)=>{const f=ge(t),l=[],C=i.has("idiom"),g=i.has("phrasal"),n=i.has("collocation"),T=i.has("phrase"),w=i.has("pronun"),I=i.has("archive");for(const y of f){const k=await we(b,y);if(k){const a={...k};a.isIdiom=C,a.isPhrasalVerb=g,a.isCollocation=n,a.isStandardPhrase=T,a.needsPronunciationFocus=w,a.isPassive=I,a.updatedAt=Date.now(),l.push(a)}else{const a=Se(y,"","","","",[],C,w,g,n,T,I);a.userId=b,l.push(a)}}l.length>0&&await We(l)},ce=t=>{const i=G().filter(f=>t.has(f.id));q(i)},de=async t=>{await K(Array.from(t))},le=t=>{F(t),E(null)};return P.jsxs(P.Fragment,{children:[P.jsx(me,{user:W,words:X,total:$,loading:ee,page:v,pageSize:B,onPageChange:M,onPageSizeChange:H,onSearch:te,onFilterChange:se,onAddWords:ie,onViewWord:m,onEditWord:E,onDelete:async t=>{await U(t.id)},onBulkDelete:de,onPractice:ce,settingsKey:"ielts_pro_library_view_settings",context:"library",initialFilter:Q,forceExpandAdd:Y,onExpandAddConsumed:J,showTagBrowserButton:!0,tagTree:ne,selectedTag:D,onSelectTag:ae,onOpenWordBook:()=>x==null?void 0:x("WORDBOOK")}),R&&P.jsx(fe,{word:R,onClose:()=>m(null),onNavigateToWord:m,onUpdate:F,onGainXp:async()=>0,isViewOnly:!1,onEditRequest:t=>{m(null),E(t)}}),V&&P.jsx(pe,{user:W,word:V,onSave:le,onClose:()=>E(null),onSwitchToView:t=>{E(null),m(t)}})]})};export{Ae as default};
