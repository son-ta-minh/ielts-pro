import{r as t,a1 as L,ai as Q,bt as _e,a0 as Ue,aT as ke,v as ze,l as De,aJ as Fe,I as V,j as M,az as Oe,bu as je,aU as Le}from"./index-C2HBAOCD.js";import{M as Qe}from"./MimicPractice_UI-DgZdVrxv.js";import"./ear-kC4CkrXD.js";import"./pen-Dh1CmiT_.js";import"./chevron-left-C7dR-E_S.js";const X="vocab_pro_mimic_practice_queue",Ge=({scopedWord:Z,onClose:ee})=>{const[a,$]=t.useState([]),[c,u]=t.useState(0),[te,q]=t.useState(!1),[i,I]=t.useState(0),[r,se]=t.useState(10),[ne,m]=t.useState(!1),[P,C]=t.useState(null),[w,b]=t.useState(null),[f,ae]=t.useState(()=>L("vocab_pro_mimic_autospeak",!1)),[d,oe]=t.useState(()=>L("vocab_pro_mimic_autoreveal",!0)),N=t.useRef(f);t.useEffect(()=>{Q("vocab_pro_mimic_autospeak",f),N.current=f},[f]),t.useEffect(()=>{Q("vocab_pro_mimic_autoreveal",d)},[d]);const s=a[c]||null,[E,_]=t.useState(!1),[W,J]=t.useState(!1),[B,T]=t.useState(""),[re,U]=t.useState(0),[k,G]=t.useState(null),[le,ce]=t.useState("audio/webm"),[ue,z]=t.useState(null),[y,D]=t.useState(null),[A,g]=t.useState(!1),[ie,F]=t.useState(!1),[fe,$e]=t.useState(!1),[R,v]=t.useState(null),O=t.useRef(new _e),p=t.useRef(null),l=t.useRef(null),H=t.useRef(()=>{}),{showToast:h}=Ue(),K=B.substring(re).trimStart(),S=e=>{$(e),Q(X,e),q(e.length===0)};t.useEffect(()=>{const e=L(X,[]);$(e),q(e.length===0),u(0)},[]),t.useEffect(()=>{const e=Math.ceil(a.length/r);i>=e&&e>0&&I(e-1)},[a.length,r]),t.useEffect(()=>{const e=Math.floor(c/r);e!==i&&I(e)},[c,r]);const de=e=>{const o=[{id:`mimic-${Date.now()}`,text:e,sourceWord:"Manual",type:"Phrase"},...a];S(o),u(0),m(!1)},pe=(e,n)=>{S(a.map(o=>o.id===e?{...o,text:n}:o)),m(!1),C(null)},me=e=>{b(e)},ge=()=>{if(!w)return;const e=a.filter(o=>o.id!==w.id);let n=c;n>=e.length&&(n=Math.max(0,e.length-1)),u(n),S(e),b(null),h("Phrase removed.","success")},he=()=>{if(a.length<2)return;const e=[...a].sort(()=>Math.random()-.5);S(e),u(0),h("Queue shuffled!","success")},Se=e=>{se(e),I(0)},Ie=()=>{C(null),m(!0)},Te=e=>{C(e),m(!0)},ye=e=>{P?pe(P.id,e):de(e)},x=t.useCallback(async(e=!1)=>{l.current&&clearTimeout(l.current),_(!1),O.current.stop();try{const n=await ke();!e&&n&&(G(n.base64),ce(n.mimeType))}catch(n){console.error("Audio capture failed",n)}},[]);t.useEffect(()=>{H.current=x},[x]);const Ae=t.useCallback(async()=>{if(s){if(y&&A){g(!1);return}if(y&&!A){g(!0);return}F(!0);try{const e=s.text.trim().toLowerCase(),n=ze().find(o=>o.word.toLowerCase()===e);if(n&&n.ipaUs){D(n.ipaUs),g(!0),F(!1);return}else{const o=De(),j=Fe(o),Y=await fetch(`${j}/api/convert/ipa?text=${encodeURIComponent(s.text)}`);if(Y.ok){const Ee=await Y.json();D(Ee.ipa),g(!0)}else h("IPA server unavailable","error")}}catch{h("Failed to fetch IPA","error")}finally{F(!1)}}},[s,y,A,h]);t.useEffect(()=>{if(E&&x(!0),J(d),T(""),U(0),G(null),z(null),v(null),D(null),g(!1),p.current&&(p.current.pause(),p.current=null),N.current&&s){const e=setTimeout(()=>V(s.text),500);return()=>clearTimeout(e)}},[s==null?void 0:s.id,d]),t.useEffect(()=>()=>{O.current.stop(),l.current&&clearTimeout(l.current)},[]);const Re=async()=>{if(s)if(E){await x();const e=je(s.text,K);v(e);const n=a.map((o,j)=>j===c?{...o,lastScore:e.score}:o);S(n)}else{T(""),U(0),z(null),v(null);try{await Le(),_(!0),l.current&&clearTimeout(l.current),l.current=setTimeout(()=>H.current(),1e4),O.current.start((e,n)=>T(e+n),e=>T(e))}catch(e){console.error("Failed to start recording",e),_(!1)}}},ve=()=>{U(B.length),z(null),v(null)},xe=()=>s&&V(s.text),Me=()=>{if(k){p.current&&p.current.pause();const e=new Audio(`data:${le};base64,${k}`);p.current=e,e.play()}},Pe=()=>{a.length>0&&u(e=>(e+1)%a.length)},Ce=e=>{e>=0&&e<a.length&&u(e)},we=Math.ceil(a.length/r),be=a.slice(i*r,(i+1)*r);return M.jsxs(M.Fragment,{children:[M.jsx(Qe,{targetText:(s==null?void 0:s.text)||null,sourceWord:(s==null?void 0:s.sourceWord)||"",type:(s==null?void 0:s.type)||"",isRecording:E,isRevealed:W,userTranscript:K,matchStatus:ue,userAudioUrl:k,onToggleRecord:Re,onPlayTarget:xe,onPlayUser:Me,onToggleReveal:()=>J(!W),onNext:Pe,onClearTranscript:ve,isEmpty:te,onClose:ee,pagedItems:be,page:i,pageSize:r,totalPages:we,onPageChange:I,onPageSizeChange:Se,onSelect:e=>Ce(i*r+e),currentAbsoluteIndex:c,autoSpeak:f,onToggleAutoSpeak:()=>ae(!f),autoReveal:d,onToggleAutoReveal:()=>oe(!d),isGlobalMode:!Z,isAnalyzing:fe,onAnalyze:()=>{},aiAnalysis:R?{isCorrect:R.score>80,score:R.score,feedbackHtml:""}:null,localAnalysis:R,onAddItem:Ie,onEditItem:Te,onDeleteItem:me,onRandomize:he,isModalOpen:ne,editingItem:P,onCloseModal:()=>m(!1),onSaveItem:ye,ipa:y,showIpa:A,isIpaLoading:ie,onToggleIpa:Ae}),M.jsx(Oe,{isOpen:!!w,title:"Delete Phrase?",message:"Are you sure you want to remove this phrase from your pronunciation queue?",confirmText:"Delete",isProcessing:!1,onConfirm:ge,onClose:()=>b(null),icon:null,confirmButtonClass:"bg-red-600 text-white hover:bg-red-700"})]})};export{Ge as MimicPractice};
