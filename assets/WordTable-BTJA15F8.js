import{r as t,o as le,K as bt,A as de,ag as Fe,j as h,ab as be,a9 as Oe,a3 as Re,ah as Ot,ai as Rt,aj as Lt,ak as kt,u as Le,al as O,v as Ct,_ as Dt,w as ce,am as Et,t as _t,p as xt}from"./index-BiHRfwln.js";import{D as ke,W as Bt,U as Nt}from"./WordTable_UI-PzbDo4H8.js";function $t(I){const m=I.map(S=>{const W={word:S.word},F=(S.collocationsArray||[]).filter(w=>!w.d).map(w=>w.text),R=(S.idiomsList||[]).filter(w=>!w.d).map(w=>w.text);return F.length>0&&(W.collocations=F),R.length>0&&(W.idioms=R),W}).filter(S=>S.collocations||S.idioms);return`You are an expert IELTS coach. Your task is to provide descriptive hints for collocations and idioms.

    TASK:
    Analyze the following JSON array. For each word, there is a list of its collocations and/or idioms that are missing a descriptive hint ("d").
    For EACH collocation and idiom string, you MUST generate a minimal descriptive cue that helps recall it. This cue should be 5-10 words.
    
    INPUT DATA:
    ${JSON.stringify(m,null,2)}

    INSTRUCTIONS:
    1.  Read the input data.
    2.  For each word, process its 'collocations' and/or 'idioms' lists.
    3.  Return a new JSON array. Each object in the array must contain:
        - "og": The original word.
        - "col": (if present in input) An array of objects, where each object has "text" (the original collocation) and "d" (your new descriptive hint).
        - "idm": (if present in input) An array of objects, where each object has "text" (the original idiom) and "d" (your new descriptive hint).
    4.  Do NOT modify the "text" of the items. Do NOT add any items that were not in the input.

    STRICT JSON OUTPUT FORMAT:
    [
      {
        "og": "original_word_1",
        "col": [
          { "text": "collocation_string_1", "d": "your new descriptive hint for it" }
        ],
        "idm": [
          { "text": "idiom_string_1", "d": "your new hint for this idiom" }
        ]
      },
      {
        "og": "original_word_2",
        "col": [
          { "text": "collocation_string_3", "d": "a hint for this collocation" }
        ]
      }
    ]
    `}const Ce="vocab_pro_library_filters_v2",De=["vocab","idiom","phrasal","collocation","phrase"],Ee=["pronun","archive"],jt=({user:I,words:m,total:ue,loading:S,page:W,pageSize:F,onPageChange:R,onPageSizeChange:w,onSearch:_e,onFilterChange:xe,onAddWords:Be,onViewWord:Ne,onEditWord:$e,onDelete:He,onHardDelete:Pe,onBulkDelete:P,onBulkHardDelete:U,onPractice:Ue,settingsKey:j,context:M,initialFilter:L,forceExpandAdd:fe,onExpandAddConsumed:V,onWordRenamed:me,showTagBrowserButton:je,tagTree:ze,selectedTag:Ve,onSelectTag:Je,onOpenWordBook:Ge})=>{const p=t.useMemo(()=>le(Ce,{}),[]),{showToast:Ht}=bt(),[k,qe]=t.useState(p.query||""),[C,J]=t.useState(()=>Array.isArray(p.activeFilters)?new Set(p.activeFilters):new Set(["all"])),[D,G]=t.useState(p.refinedFilter||"all"),[E,Qe]=t.useState(p.statusFilter||"all"),[_,Ye]=t.useState(p.registerFilter||"all"),[x,Ke]=t.useState(p.sourceFilter||"all"),[B,Xe]=t.useState(p.compositionFilter||"all"),[N,Ze]=t.useState(p.bookFilter||"all"),[et,q]=t.useState(!1),[Q,pe]=t.useState(p.isFilterMenuOpen||!1),[Y,he]=t.useState(""),[tt,we]=t.useState(!1),[st,ge]=t.useState(!1),ye=t.useRef(!0);t.useEffect(()=>{de(Ce,{query:k,activeFilters:Array.from(C),refinedFilter:D,statusFilter:E,registerFilter:_,sourceFilter:x,compositionFilter:B,bookFilter:N,isFilterMenuOpen:Q,page:W,pageSize:F})},[k,C,D,E,_,x,B,N,Q,W,F]);const[Se,ot]=t.useState(new Set(["vocab"])),[u,g]=t.useState(new Set),[nt,it]=t.useState(null),[Te,K]=t.useState(!1),[rt,at]=t.useState(null),[Ae,X]=t.useState(!1),[lt,Z]=t.useState(!1),[dt,ee]=t.useState(!1),[te,se]=t.useState(!1),[Ie,oe]=t.useState(!1),[ne,f]=t.useState(null),[ct,z]=t.useState(!1),[We,ut]=t.useState([]),ie=t.useRef(null),[re,ft]=t.useState(()=>{const e=le(j,null);return e?{...ke,...e}:ke});t.useEffect(()=>{de(j,re)},[re,j]),t.useEffect(()=>{const e=s=>{ie.current&&!ie.current.contains(s.target)&&ge(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),t.useEffect(()=>{L&&(["raw","refined","verified","failed","not_refined"].includes(L)?(G(L),J(new Set(["all"]))):(J(new Set([L])),G("all")),pe(!0))},[L]),t.useEffect(()=>{fe&&(q(!0),V==null||V())},[fe]),t.useEffect(()=>{const e=setTimeout(()=>_e(k),300);return()=>clearTimeout(e)},[k]),t.useEffect(()=>{xe({types:C,refined:D,status:E,register:_,source:x,composition:B,book:N}),ye.current?ye.current=!1:(R(0),g(new Set))},[C,D,E,_,x,B,N]),t.useEffect(()=>{if(ne){const e=setTimeout(()=>f(null),4e3);return()=>clearTimeout(e)}},[ne]);const mt=e=>{J(s=>{const o=new Set(s);return e==="all"?new Set(["all"]):(o.delete("all"),o.has(e)?o.delete(e):o.add(e),o.size===0?new Set(["all"]):o)})},pt=e=>{ot(s=>{const o=new Set(s),i=(d,l)=>{l.forEach(r=>d.delete(r))};return De.includes(e)?o.has(e)?o.delete(e):(i(o,De),o.add(e)):Ee.includes(e)&&(o.has(e)?o.delete(e):(i(o,Ee),o.add(e))),o})},ht=async()=>{if(Y.trim()){we(!0);try{await Be(Y,Se),f({type:"success",message:"Words added successfully."}),he(""),q(!1)}catch{f({type:"error",message:"Failed to add words."})}finally{we(!1)}}},$=t.useMemo(()=>m.filter(e=>u.has(e.id)),[m,u]),v=t.useMemo(()=>m.filter(e=>u.has(e.id)&&e.quality===Fe.RAW),[m,u]),H=t.useMemo(()=>m.filter(e=>u.has(e.id)&&(e.collocationsArray&&e.collocationsArray.some(s=>!s.d)||e.idiomsList&&e.idiomsList.some(s=>!s.d))),[m,u]),wt=async()=>{if(!(!P||u.size===0)){K(!0);try{await P(u),f({type:"success",message:`${M==="unit"?"Unlinked":"Deleted"} ${u.size} item(s).`}),g(new Set)}catch{f({type:"error",message:"Failed to remove items."})}finally{K(!1),Z(!1)}}},gt=async()=>{if(!(!U||v.length===0)){X(!0);try{const e=new Set(v.map(s=>s.id));await U(e),f({type:"success",message:`Permanently deleted ${e.size} raw item(s).`}),g(s=>{const o=new Set(s);return e.forEach(i=>o.delete(i)),o})}catch{f({type:"error",message:"Failed to delete items."})}finally{X(!1),ee(!1)}}},yt=async e=>{const o=xt().filter(i=>e.has(i.id)).map(i=>({...i,quality:Fe.VERIFIED,updatedAt:Date.now()}));o.length>0&&(await ce(o),f({type:"success",message:`Marked ${o.length} item(s) as Verified.`}),g(new Set))},St=()=>{const e=m.filter(l=>u.has(l.id));if(e.length===0)return;const s=le("vocab_pro_mimic_practice_queue",[]),o=new Set(s.map(l=>l.text.toLowerCase().trim()));let i=0;const d=[];if(e.forEach(l=>{const r=l.word;o.has(r.toLowerCase().trim())||(d.push({id:`pronun-${Date.now()}-${Math.random()}`,text:r,sourceWord:l.word,type:"Library Word"}),o.add(r.toLowerCase().trim()),i++)}),i>0){const l=[...s,...d];de("vocab_pro_mimic_practice_queue",l),f({type:"success",message:`Added ${i} words to Pronunciation.`}),g(new Set)}else f({type:"info",message:"Selected words are already in Pronunciation queue."})},Me=async e=>{if(!Array.isArray(e))throw new Error("Response must be an array.");const s=new Map;e.forEach(r=>{var c;const n=(r.og||r.original||r.hw||r.headword||"").toLowerCase();n&&(s.has(n)||s.set(n,[]),(c=s.get(n))==null||c.push(r))});const o=new Map($.map(r=>[r.word.toLowerCase(),r])),i=[],d=[],l=[];for(const[r,n]of o){const c=s.get(r);if(!c||c.length===0)continue;const a=c[0],T=kt(a),y=(T.headword||T.word||"").trim();if(y){const vt=n.word.trim().split(/\s+/).length,Ft=y.trim().split(/\s+/).length;if(vt!==Ft){const ae=await Le(n.userId,y);if(ae){const A=O(ae,a);i.push(A)}else{const A=Ct(y,"","","","",[],!1,!1,!1,!1,!1,!1,"refine");A.userId=n.userId;const b=O(A,a);i.push(b)}}else if(y.toLowerCase()!==n.word.toLowerCase()){const A=await Le(n.userId,y);if(A&&A.id!==n.id){const b=O(A,a);i.push(b),d.push(n.id),l.push({id:n.id,oldWord:n.word,newWord:y})}else{let b=O(n,a);b.word=y,i.push(b),l.push({id:n.id,oldWord:n.word,newWord:y})}}else i.push(O(n,a))}else i.push(O(n,a))}if(d.length>0&&await Dt(d),i.length>0){await ce(i),l.length>0&&me&&me(l);let r=`Refined ${i.length} words.`;d.length>0?r+=` Merged ${d.length} duplicates.`:l.length>0&&(r+=` Renamed ${l.length} to base forms.`),f({type:"success",message:r}),g(new Set)}se(!1)},ve=e=>Et(_t(e.words),I.nativeLanguage||"Vietnamese"),Tt=e=>$t(H),At=async e=>{var i;if(!Array.isArray(e)){f({type:"error",message:"Invalid response from AI."});return}const s=[],o=new Map(H.map(d=>[d.word.toLowerCase(),d]));for(const d of e){const l=o.get((i=d.og)==null?void 0:i.toLowerCase());if(!l)continue;let r=!1;const n={...l};if(d.col&&l.collocationsArray){const c=new Map(d.col.map(a=>[a.text.toLowerCase(),a.d]));n.collocationsArray=(n.collocationsArray||[]).map(a=>{if(!a.d){const T=c.get(a.text.toLowerCase());if(T)return r=!0,{...a,d:String(T)}}return a})}if(d.idm&&l.idiomsList){const c=new Map(d.idm.map(a=>[a.text.toLowerCase(),a.d]));n.idiomsList=(n.idiomsList||[]).map(a=>{if(!a.d){const T=c.get(a.text.toLowerCase());if(T)return r=!0,{...a,d:String(T)}}return a})}r&&(n.updatedAt=Date.now(),s.push(n))}s.length>0?(await ce(s),f({type:"success",message:`Added hints to ${s.length} word(s).`}),g(new Set)):f({type:"info",message:"No new hints were added."}),oe(!1)},It=async()=>{const e=await Lt(I.id);ut(e),z(!0)},Wt=async e=>{var n;const s=We.find(c=>c.id===e);if(!s)return;const o=m.filter(c=>u.has(c.id)),i=new Set(s.words.map(c=>c.word.toLowerCase())),d=o.filter(c=>!i.has(c.word.toLowerCase())).map(c=>({word:c.word,definition:c.meaningVi}));if(d.length===0){f({type:"info",message:"All selected words are already in this book."}),z(!1);return}const l=[...s.words,...d].sort((c,a)=>c.word.toLowerCase().localeCompare(a.word.toLowerCase())),r={...s,words:l,updatedAt:Date.now()};await Ot(r),await Rt(I.id),f({type:"success",message:`Added ${d.length} words to "${(n=s.topic.split(":").pop())==null?void 0:n.trim()}".`}),z(!1),g(new Set)},Mt={words:m,total:ue,loading:S,page:W,pageSize:F,onPageChange:R,onPageSizeChange:w,onPractice:Ue,context:M,onDelete:He,onViewWord:Ne,onEditWord:$e,query:k,setQuery:qe,activeFilters:C,refinedFilter:D,statusFilter:E,registerFilter:_,sourceFilter:x,compositionFilter:B,bookFilter:N,isAddExpanded:et,isFilterMenuOpen:Q,quickAddInput:Y,setQuickAddInput:he,isAdding:tt,isViewMenuOpen:st,selectedIds:u,setSelectedIds:g,wordToDelete:nt,setWordToDelete:it,isDeleting:Te,setIsDeleting:K,wordToHardDelete:rt,setWordToHardDelete:at,isHardDeleting:Ae,setIsHardDeleting:X,onHardDelete:Pe,isAiModalOpen:te,setIsAiModalOpen:se,notification:ne,viewMenuRef:ie,visibility:re,setVisibility:ft,handleToggleFilter:mt,handleBatchAddSubmit:ht,onOpenBulkDeleteModal:P?()=>Z(!0):void 0,onBulkVerify:yt,onOpenBulkHardDeleteModal:U&&v.length>0?()=>ee(!0):void 0,selectedWordsToRefine:$,handleGenerateRefinePrompt:ve,handleAiRefinementResult:Me,selectedRawWordsCount:v.length,selectedWordsMissingHintsCount:H.length,onOpenHintModal:()=>oe(!0),setStatusFilter:Qe,setRefinedFilter:G,setRegisterFilter:Ye,setSourceFilter:Ke,setCompositionFilter:Xe,setBookFilter:Ze,setIsViewMenuOpen:ge,setIsFilterMenuOpen:pe,setIsAddExpanded:q,settingsKey:j,showTagBrowserButton:je,tagTree:ze,selectedTag:Ve,onSelectTag:Je,selectedTypes:Se,toggleType:pt,onOpenWordBook:Ge,onOpenAddToBookModal:It,isAddToBookModalOpen:ct,setIsAddToBookModalOpen:z,wordBooks:We,onConfirmAddToBook:Wt,onAddToPronunciation:St};return h.jsxs(h.Fragment,{children:[h.jsx(Bt,{...Mt}),P&&h.jsx(be,{isOpen:lt,title:M==="unit"?`Unlink ${u.size} Words?`:`Delete ${u.size} Words?`,message:M==="unit"?`Remove ${u.size} selected words from this unit? They will remain in your library.`:`Permanently delete ${u.size} selected words? This action cannot be undone.`,confirmText:M==="unit"?`UNLINK ${u.size}`:`DELETE ${u.size}`,isProcessing:Te,onConfirm:wt,onClose:()=>Z(!1),confirmButtonClass:M==="unit"?"bg-orange-600 text-white hover:bg-orange-700 shadow-orange-200":"bg-red-600 text-white hover:bg-red-700 shadow-red-200",icon:M==="unit"?h.jsx(Nt,{size:40,className:"text-orange-500"}):h.jsx(Oe,{size:40,className:"text-red-500"})}),U&&h.jsx(be,{isOpen:dt,title:`Delete ${v.length} Raw Words?`,message:`Permanently delete ${v.length} selected RAW words from your entire library? This action cannot be undone.`,confirmText:`DELETE ${v.length} RAW WORDS`,isProcessing:Ae,onConfirm:gt,onClose:()=>ee(!1),confirmButtonClass:"bg-red-600 text-white hover:bg-red-700 shadow-red-200",icon:h.jsx(Oe,{size:40,className:"text-red-500"})}),Ie&&H.length>0&&h.jsx(Re,{isOpen:Ie,onClose:()=>oe(!1),type:"REFINE_WORDS",title:"Refine Hints",description:`Generating hints for ${H.length} selected word(s).`,initialData:{},user:I,onGeneratePrompt:Tt,onJsonReceived:At,actionLabel:"Apply Hints",hidePrimaryInput:!0}),te&&$.length>0&&h.jsx(Re,{isOpen:te,onClose:()=>se(!1),type:"REFINE_WORDS",title:"Refine Selected Words",description:`Generating details for ${$.length} selected word(s).`,initialData:{words:$.map(e=>e.word).join("; ")},user:I,onGeneratePrompt:ve,onJsonReceived:Me,actionLabel:"Apply to All"})]})};export{jt as W};
