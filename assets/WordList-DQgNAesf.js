import{r,h as ue,i as G,k as he,j as P,V as ge,l as pe,s as fe,m as we,n as Se,o as We}from"./index-CJGDCpC1.js";import{W as me}from"./WordTable-DYW5_V3L.js";import"./WordTable_UI-BFEj-3H6.js";import"./TagBrowser-COsUoaqT.js";import"./search-CBdd_bl3.js";import"./square-check-big-D1Qh2Wel.js";import"./chevron-left-BofXgtH6.js";const Ee="vocab_pro_library_filters_v2",xe=({user:W,onDelete:U,onBulkDelete:q,onUpdate:O,onStartSession:K,initialFilter:Q,onInitialFilterApplied:Ce,forceExpandAdd:Y,onExpandAddConsumed:J,onNavigate:I})=>{const[X,Z]=r.useState([]),v=r.useMemo(()=>ue(Ee,{}),[]),[x,z]=r.useState(v.page||0),[D,H]=r.useState(v.pageSize||25),[$,N]=r.useState(0),[ee,L]=r.useState(!0),[M,te]=r.useState(v.query||""),[h,se]=r.useState({types:new Set(["all"]),refined:"all",status:"all",register:"all",source:"all",composition:"all",book:"all"}),[_,oe]=r.useState(null),[R,m]=r.useState(null),[V,E]=r.useState(null),[ne,re]=r.useState([]),{id:b}=W,j=r.useCallback(()=>{const t="Uncategorized",i=G().filter(e=>e.userId===W.id),g=new Map;i.forEach(e=>g.set(e.word.toLowerCase(),e));const d=new Map,C=new Set,f=[];i.forEach(e=>{e.groups&&e.groups.length>0?e.groups.forEach(s=>{C.add(s),d.has(s)||d.set(s,new Set),d.get(s).add(e)}):f.push(e)});const n=new Map,T=e=>{n.has(e)||n.set(e,{name:e,children:new Set,parents:new Set})};C.forEach(e=>{const s=e.split("/");for(let o=0;o<s.length;o++){const c=s.slice(0,o+1).join("/");if(T(c),o>0){const l=s.slice(0,o).join("/");n.get(l).children.add(c),n.get(c).parents.add(l)}}}),n.forEach((e,s)=>{const o=g.get(s.toLowerCase());o!=null&&o.groups&&o.groups.forEach(c=>{const l=c.split("/");for(let p=0;p<l.length;p++){const S=l.slice(0,p+1).join("/");if(T(S),p>0){const u=l.slice(0,p).join("/");n.get(u).children.add(S),n.get(S).parents.add(u)}}n.get(c).children.add(s),e.parents.add(c)})});const w=new Map,A=e=>{var S;if(w.has(e))return w.get(e);const s=new Set,o=[e],c=new Set;for(;o.length>0;){const u=o.shift();c.has(u)||(c.add(u),s.add(u),(((S=n.get(u))==null?void 0:S.children)||new Set).forEach(F=>o.push(F)))}const l=new Set;s.forEach(u=>{(d.get(u)||new Set).forEach(F=>l.add(F.id))});const p=l.size;return w.set(e,p),p},y=e=>{const s=n.get(e),o=Array.from(s.children).sort();return{name:e.split("/").pop(),path:e,children:o.map(y),unitCount:A(e)}};let a=Array.from(n.keys()).filter(e=>{var s;return(((s=n.get(e))==null?void 0:s.parents.size)||0)===0}).sort().map(e=>y(e));f.length>0&&a.unshift({name:t,path:t,children:[],unitCount:f.length}),re(a)},[W.id]),B=r.useCallback(()=>{L(!0);try{const t=Array.from(h.types),{words:i,totalCount:g}=he(b,x,D,M,t,h.refined,h.status,h.register,h.source,_,h.composition,h.book);N(g),Z(i)}catch(t){console.error("Failed to load words from store:",t)}finally{L(!1)}},[b,x,D,M,h,_]);r.useEffect(()=>{B(),j();const t=()=>{B(),j()};return window.addEventListener("datastore-updated",t),()=>{window.removeEventListener("datastore-updated",t)}},[B,j]);const ae=t=>{oe(t),z(0)},ie=async(t,i)=>{const g=fe(t),d=[],C=i.has("idiom"),f=i.has("phrasal"),n=i.has("collocation"),T=i.has("phrase"),w=i.has("pronun"),A=i.has("archive");for(const y of g){const k=await we(b,y);if(k){const a={...k};a.isIdiom=C,a.isPhrasalVerb=f,a.isCollocation=n,a.isStandardPhrase=T,a.needsPronunciationFocus=w,a.isPassive=A,a.updatedAt=Date.now(),d.push(a)}else{const a=Se(y,"","","","",[],C,w,f,n,T,A);a.userId=b,d.push(a)}}d.length>0&&await We(d)},ce=t=>{const i=G().filter(g=>t.has(g.id));K(i)},de=async t=>{await q(Array.from(t))},le=t=>{O(t),E(null)};return P.jsxs(P.Fragment,{children:[P.jsx(me,{user:W,words:X,total:$,loading:ee,page:x,pageSize:D,onPageChange:z,onPageSizeChange:H,onSearch:te,onFilterChange:se,onAddWords:ie,onViewWord:m,onEditWord:E,onDelete:async t=>{await U(t.id)},onBulkDelete:de,onPractice:ce,settingsKey:"ielts_pro_library_view_settings",context:"library",initialFilter:Q,forceExpandAdd:Y,onExpandAddConsumed:J,showTagBrowserButton:!0,tagTree:ne,selectedTag:_,onSelectTag:ae,onOpenWordBook:()=>I==null?void 0:I("WORDBOOK")}),R&&P.jsx(ge,{word:R,onClose:()=>m(null),onNavigateToWord:m,onUpdate:O,onGainXp:async()=>0,isViewOnly:!1,onEditRequest:t=>{m(null),E(t)}}),V&&P.jsx(pe,{user:W,word:V,onSave:le,onClose:()=>E(null),onSwitchToView:t=>{E(null),m(t)}})]})};export{xe as default};
